<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SP-API Desktop App</title>
  <style>
    :root { --bg:#f8fafc; --panel:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --accent:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid var(--border); background:var(--panel); display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:5; }
    h1 { margin:0; font-size:18px; }
    .btn { border:none; background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .layout { padding:16px 20px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .panel h2 { margin:0; padding:14px 16px; border-bottom:1px solid var(--border); font-size:16px; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td { padding:8px 10px; border:1px solid var(--border); text-align:left; vertical-align: top; user-select: text; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    th, td { user-select: text; }
    tbody tr:hover { background:#f1f5f9; cursor:pointer; }
    .empty { padding:14px; color:var(--muted); text-align:center; }
    select.po-status-select { padding:8px 12px; border-radius:8px; font-size:15px; font-weight:700; min-width:170px; }
    input.po-date-input { padding:6px 10px; border-radius:8px; font-size:15px; font-weight:700; border:1px solid var(--border); }
    .rt-sales-sortable-header { cursor:pointer; user-select:none; transition: background-color 0.15s ease; }
    .rt-sales-sortable-header:hover { background-color:#f1f5f9; }
    .rt-sales-sort-arrow { display:inline-block; margin-left:4px; font-size:12px; transition:transform 0.2s ease, opacity 0.2s ease; }
    .rt-sales-window-info { font-size:12px; color:#666; margin-bottom:8px; }
    /* Row status colors */
    tr.po-status-preparing { background-color: #fef9c3; }
    tr.po-status-appointment { background-color: #e0f2fe; }
    tr.po-status-delivered { background-color: #dcfce7; }
    /* Vendor PO tab: larger, clearer text without changing layout spacing */
    #pos-tab { font-size:14px; }
    #pos-tab table { font-size:14px; }
    #pos-tab th, #pos-tab td { font-size:14px; }
    #pos-tab input, #pos-tab select, #pos-tab button { font-size:14px; }
    /* Endpoint tester */
    #tester-tab { font-size:14px; }
    .tester-controls { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:10px; margin-bottom:10px; }
    .tester-log { background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:320px; overflow:auto; font-family: "SFMono-Regular", Consolas, monospace; font-size:13px; white-space:pre-wrap; }
    .tester-run-btn { background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    .tester-run-btn:disabled { background:#4b5563; cursor:not-allowed; }
    .tabs { display:flex; gap:8px; margin:6px 0 0; }
    .tab-btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600; }
    .tab-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    /* modal */
    .backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:20; }
    .modal { background:#fff; width:90%; max-width:1100px; max-height:85vh; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
    .modal header { padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:12px 14px; overflow:auto; }
    .json-block { background:#f8fafc; border:1px solid var(--border); border-radius:8px; padding:10px; white-space:pre-wrap; word-break:break-word; font-family: monospace; font-size:12px; user-select:text; }
    </style>
  <style>
      .btn-fetch {
        background: #dc2626;
        color: #fff;
      }
      .btn-fetch:disabled {
        background: #9ca3af;
        color: #fff;
        cursor: not-allowed;
      }
      /* Conditional formatting for quantities */
      .qty-shortage { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
      .qty-pending { background-color: #fef3c7; color: #92400e; font-weight: 600; }
      .qty-good { background-color: #dcfce7; color: #166534; font-weight: 600; }
      .qty-neutral { color: #374151; }
      .shortage-icon::before { content: "⚠️ "; }
      .qty-detail-btn { background: #3b82f6; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
      .qty-detail-btn:hover { background: #2563eb; }
      /* PO items modal: rejected line highlighting */
      .po-line-rejected { background-color: #fee2e2; }
      /* PO items modal: received line highlighting */
      .po-line-received { background-color: #dcfce7; }
      /* PO items modal: summary row */
      .po-items-summary td { border-top: 2px solid #e5e7eb; background-color: #f9fafb; font-weight: 600; }
  </style>
</head>
<body>
  <header>
    <h1>Amazon SP-API Desktop</h1>
    <div style="display:flex; align-items:center; gap:10px;">
      <div id="sync-info" style="font-size:12px; color:#6b7280; display:flex; flex-direction:column; margin-right:12px;">
        <span id="sync-last">Last Sync: -</span>
        <span id="sync-next">Next Auto-Sync: -</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="sync-btn">Sync Vendor POs</button>
        <button class="btn" id="rebuild-btn" style="background:#111827;">Full Rebuild POs</button>
      </div>
    </div>
  </header>

  <div class="layout" style="padding-bottom:0;">
      <div class="tabs">
        <button class="tab-btn active" data-tab="pos" onclick="showTab('pos')">Vendor POs</button>
        <button class="tab-btn" data-tab="catalog" onclick="showTab('catalog')">Catalog Fetcher</button>
        <button class="tab-btn" data-tab="oos" onclick="showTab('oos')">Out-of-Stock Items</button>
        <button class="tab-btn" data-tab="vendor-rt-sales" onclick="showTab('vendor-rt-sales')">Vendor Real Time Sales</button>
        <button class="tab-btn" data-tab="tester" onclick="showTab('tester')">Endpoint Tester</button>
        <button class="tab-btn" data-tab="notifications" onclick="showTab('notifications')">Notifications</button>
      </div>
  </div>

  <div class="layout">
    <div class="panel" id="pos-tab">
      <h2>Vendor POs (raw Amazon fields)</h2>
      <div style="padding:10px 12px; display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="po-search" type="text" placeholder="Search PO / SKU / F/C / Status" style="flex:1; min-width:240px; padding:8px 10px; border-radius:8px; border:1px solid var(--border);" />
          <select id="po-start-days" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="60" selected>60 Days</option>
            <option value="30">30 Days</option>
            <option value="15">15 Days</option>
          </select>
          <select id="po-filter-fc" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="">All F/C</option>
          </select>
          <select id="po-filter-status" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Preparing">Preparing</option>
            <option value="Appointment Scheduled">Appointment Scheduled</option>
          </select>
          <button class="btn" id="picklist-btn" onclick="openPicklistPreview()" disabled style="background:#16a34a;">Export Pick List (PDF)</button>
        </div>
        <div id="inhouse-summary" style="font-size:12px; color:var(--muted); font-weight:600;"></div>
      </div>
      <div style="overflow:auto; max-height: calc(100vh - 200px);">
          <table>
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="po-select-all" onchange="toggleSelectAllPos(this)" /></th>
                <th>PO</th>
                <th style="text-align:center;">PO Items</th>
                <th>Order Date</th>
                <th style="text-align:center;">Requested Qty</th>
                <th style="text-align:center;">Accepted Qty</th>
                <th style="text-align:center;">Received Qty</th>
                <th style="text-align:center;">Remaining Qty</th>
                <th style="text-align:center;">Cancelled Qty</th>
                <th style="text-align:right;">Total Accepted Cost</th>
                <th>Status</th>
                <th>Status Date</th>
                <th>Amazon Status</th>
                <th>Ship To Location</th>
              </tr>
            </thead>
            <tbody id="po-rows"></tbody>
          </table>
        </div>
      </div>
    <div class="panel" id="catalog-tab" style="display:none; margin-top:14px;">
      <h2>ASIN Catalog Fetcher</h2>
      <div style="margin:10px 0; display:flex; gap:8px; align-items:center;">
        <input id="manual-asin-input" type="text" placeholder="Enter ASIN (e.g., B00XXXXXXX)" style="padding:8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px;" />
        <button class="btn" style="background:#111827" onclick="addManualAsin()">Add ASIN</button>
        <span id="manual-asin-msg" style="font-size:13px;color:#6b7280;"></span>
      </div>
      <div style="padding:12px; display:flex; gap:10px; align-items:center;">
        <button class="btn" onclick="loadAsinList(true)">Refresh</button>
        <button class="btn" style="background:#16a34a" onclick="fetchAllMissing()">Fetch All Missing</button>
        <input id="asin-search" type="text" placeholder="Search ASIN / SKU / Title" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--border);" oninput="filterAsins()" />
      </div>
      <div style="padding:0 12px 12px 12px;">
        <div style="overflow:auto; max-height: calc(100vh - 240px);">
          <table>
            <thead>
              <tr>
                <th style="width:22%;">ASIN</th>
                <th style="width:22%;">SKU</th>
                <th style="width:18%;">Barcode</th>
                <th style="width:26%;">Title</th>
                <th style="width:12%;">Image</th>
                <th style="width:10%;">Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="asin-rows">
              <tr><td colspan="7" class="empty">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="panel" id="oos-tab" style="display:none; margin-top:14px;">
      <h2>Out-of-Stock Items</h2>
      <div style="padding:12px;">
        <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <button class="btn" onclick="loadOosItems()">Reload</button>
          <button class="btn" style="background:#111827;" onclick="downloadOosXls()">Export OOS (XLS)</button>
          <span id="oos-status" style="font-size:12px; color:var(--muted); margin-left:8px;"></span>
        </div>
        <div style="overflow:auto; max-height: calc(100vh - 260px);">
          <table>
            <thead>
            <tr>
              <th style="display:none;">PO Number</th>
              <th style="display:none;">PO Date</th>
              <th style="display:none;">Ship To</th>
              <th>ASIN</th>
              <th>Image</th>
              <th>Vendor SKU</th>
              <th>Qty</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="oos-rows">
              <tr><td colspan="8" class="empty">No OOS items</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
    <div class="panel" id="tester-tab" style="display:none; margin-top:14px;">
      <h2>SP-API Endpoint Tester</h2>
      <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
        <div class="tester-controls">
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Preset Endpoint</label>
            <select id="tester-preset" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" onchange="applyTesterPreset()">
              <option value="">-- Select preset --</option>
            </select>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Method</label>
            <select id="tester-method" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
            </select>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Full GET Path (optional)</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="tester-fullpath" type="text" placeholder="/catalog/2022-04-01/items/{asin}?marketplaceIds=A2VIGQ35RCS4UG" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
              <button class="tester-run-btn" style="padding:10px 10px;" onclick="applyTesterFullPath()">Use</button>
            </div>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Endpoint Path (GET)</label>
            <input id="tester-endpoint" type="text" placeholder="/vendor/orders/v1/purchaseOrders" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Query string (key=value&key2=val)</label>
            <input id="tester-query" type="text" placeholder="marketplaceIds=A1F83G8C2ARO7P&limit=10" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="font-weight:700; display:block; margin-bottom:4px;">Request Body (JSON for POST)</label>
            <textarea id="tester-body" placeholder='{"example":"value"}' style="width:100%; min-height:140px; padding:10px; border-radius:8px; border:1px solid var(--border); font-family: monospace; font-size:13px;"></textarea>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="tester-run-btn" onclick="runTesterCall()">Run</button>
          <span id="tester-host" style="font-size:13px; color:#475569;"></span>
          <span id="tester-status" style="font-size:13px; color:#475569;"></span>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Amazon Response Log</div>
          <button class="tester-run-btn" style="margin-bottom:6px; padding:8px 12px;" onclick="copyTesterLog()">Copy Log</button>
          <pre id="tester-log" class="tester-log">No calls yet.</pre>
        </div>
      </div>
    </div>
  <div class="panel" id="notifications-tab" style="display:none; margin-top:14px;">
    <h2>Notifications</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" onclick="loadNotifications()">Reload Notifications</button>
        <span id="notifications-status" style="font-size:12px; color:#6b7280;"></span>
      </div>
      <div style="overflow:auto; max-height:60vh;">
        <table>
          <thead>
            <tr>
              <th>TS</th>
              <th>Type</th>
              <th>PO</th>
              <th>Summary</th>
            </tr>
          </thead>
          <tbody id="notifications-rows">
            <tr><td colspan="4" class="empty">No notifications</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="panel" id="vendor-rt-sales-tab" style="display:none; margin-top:14px;">
    <h2>Vendor Real Time Sales</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <select id="rt-sales-window" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px;" onchange="onRtSalesWindowChange()">
          <option value="last_1h">Last 1 hour</option>
          <option value="last_3h">Last 3 hours</option>
          <option value="last_24h" selected>Last 24 hours</option>
          <option value="today">Today (UTC)</option>
          <option value="yesterday">Yesterday (UTC)</option>
          <option value="custom">Custom range</option>
        </select>
        <input type="datetime-local" id="rt-sales-start" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px; display:none;" />
        <input type="datetime-local" id="rt-sales-end" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px; display:none;" />
        <button class="btn" onclick="refreshVendorRtSales()">Refresh Now</button>
        <span id="rt-sales-status" style="font-size:12px; color:#6b7280;"></span>
      </div>

      <div id="rt-sales-summary" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
        <div style="background:#f0f9ff; border:1px solid #0284c7; border-radius:8px; padding:12px;">
          <div style="font-size:12px; color:#0c4a6e; font-weight:600;">Total Units</div>
          <div id="rt-sales-total-units" style="font-size:24px; font-weight:700; color:#0369a1;">—</div>
        </div>
        <div style="background:#f0fdf4; border:1px solid #16a34a; border-radius:8px; padding:12px;">
          <div style="font-size:12px; color:#166534; font-weight:600;">Total Revenue</div>
          <div id="rt-sales-total-revenue" style="font-size:24px; font-weight:700; color:#15803d;">—</div>
        </div>
      </div>

      <div style="font-weight:600; margin-top:8px;">Top ASINs</div>
      <div id="rt-sales-window-info" class="rt-sales-window-info"></div>
      <div style="overflow:auto; max-height:50vh; border:1px solid var(--border); border-radius:8px;">
        <table style="table-layout:fixed; width:100%;">
          <thead>
            <tr>
              <th style="flex:1; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('asin')">ASIN <span id="rt-sales-sort-asin" class="rt-sales-sort-arrow"></span></th>
              <th style="flex:1; text-align:center; word-break:break-word;">Image</th>
              <th style="flex:1; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('units')">Units <span id="rt-sales-sort-units" class="rt-sales-sort-arrow"></span></th>
              <th style="flex:1; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('revenue')">Revenue <span id="rt-sales-sort-revenue" class="rt-sales-sort-arrow"></span></th>
            </tr>
          </thead>
          <tbody id="rt-sales-top-asins-rows">
            <tr><td colspan="4" class="empty">No data. Click "Refresh Now" to fetch.</td></tr>
          </tbody>
        </table>
      </div>

      <div id="rt-sales-asin-detail" style="margin-top:16px; display:none;">
        <div style="font-weight:600; margin-bottom:8px;">ASIN Hourly Detail: <span id="rt-sales-asin-detail-title">—</span></div>
        <div style="overflow:auto; max-height:35vh; border:1px solid var(--border); border-radius:8px;">
          <table>
            <thead>
              <tr>
                <th style="min-width:160px;">Hour (UTC)</th>
                <th style="text-align:right; width:80px;">Units</th>
                <th style="text-align:right; width:100px;">Revenue</th>
              </tr>
            </thead>
            <tbody id="rt-sales-asin-detail-rows">
              <tr><td colspan="3" class="empty">—</td></tr>
            </tbody>
          </table>
        </div>
        <button class="btn" style="margin-top:8px; background:#111827;" onclick="closeRtSalesAsinDetail()">Close Detail</button>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div class="backdrop" id="modal">
    <div class="modal">
      <header>
        <div id="modal-title">PO Items</div>
        <button class="btn" style="background:#111827" onclick="closeModal()">Close</button>
      </header>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Catalog detail modal -->
  <div class="backdrop" id="catalog-modal">
    <div class="modal" style="max-width:1000px;">
      <header>
        <div id="catalog-modal-title">Catalog Details</div>
        <button class="btn" style="background:#111827" onclick="closeCatalogModal()">Close</button>
      </header>
      <div class="modal-body" id="catalog-modal-body" style="font-family: monospace; white-space: pre-wrap; word-break: break-word; font-size:12px;"></div>
    </div>
  </div>

  <!-- PO Line Details Modal (NEW) -->
  <div class="backdrop" id="po-lines-modal">
    <div class="modal" style="max-width:1200px;">
      <header>
        <div id="po-lines-modal-title">PO Line Items - Inventory Breakdown</div>
        <button class="btn" style="background:#111827" onclick="closePoLinesModal()">Close</button>
      </header>
      <div class="modal-body" id="po-lines-modal-body" style="padding:0;"></div>
    </div>
  </div>

  <script>
    let vendorPOs = [];
    let filteredPOs = [];
    let asinList = [];
    let filteredAsins = [];
    let activeTab = "pos";
    let oosItems = [];
    let selectedPoNumbers = [];
    let lastSyncTime = null;
    let lastSyncFromSpapi = false;
    let nextAutoSyncAt = null;
    let autoSyncIntervalMs = 2 * 60 * 60 * 1000; // 2 hours
    let testerMetaLoaded = false;
    let testerPresets = [];
    let testerHost = "";
    let catalogImageCache = {};
    let recentNotifications = [];

    const INTERNAL_STATUS_OPTIONS = [
      "Pending",
      "Preparing",
      "Appointment Scheduled",
      "Delivered",
    ];

    function getRowColorForStatus(status) {
      switch (status) {
        case "Preparing":
          return "#fef9c3"; // light yellow
        case "Appointment Scheduled":
          return "#e0f2fe"; // light blue
        case "Delivered":
          return "#dcfce7"; // light green
        default:
          return ""; // Pending = no color
      }
    }

    function startDateIsoFromDays(days) {
      const d = new Date();
      d.setDate(d.getDate() - days);
      return d.toISOString().slice(0, 10);
    }

    function currentStartDateParam() {
      const sel = document.getElementById("po-start-days");
      const days = Number(sel?.value || 60);
      return startDateIsoFromDays(days);
    }

    async function loadPOs(sync = false) {
      const btn = document.getElementById("sync-btn");
      if (btn && sync) { btn.disabled = true; btn.textContent = "Syncing..."; }
      try {
        const createdAfter = currentStartDateParam();
        if (sync) {
          const respSync = await fetch(`/api/vendor-pos/sync`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ createdAfter }),
          });
          let fetched = 0;
          if (respSync.ok) {
            const syncData = await respSync.json();
            fetched = syncData.fetched || 0;
          }
          lastSyncTime = new Date();
          lastSyncFromSpapi = true;
          nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
          updateSyncInfo();
          const hh = String(lastSyncTime.getHours()).padStart(2, "0");
          const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
          showToast(`Sync completed at ${hh}:${mi}, ${fetched} POs updated.`);
        }
        const resp = await fetch(`/api/vendor-pos?enrich=1&include_lines=true&createdAfter=${encodeURIComponent(createdAfter)}`);
        const data = await resp.json();
        vendorPOs = (data.items || []).sort((a, b) => getPoDate(b).localeCompare(getPoDate(a)));
        filteredPOs = vendorPOs;
        const poSet = new Set(vendorPOs.map(p => p.purchaseOrderNumber).filter(Boolean));
        selectedPoNumbers = selectedPoNumbers.filter(p => poSet.has(p));
        renderTable();
        updateInhouseSummary();
        populateFcFilterOptions();
        updatePicklistButtonState();
        if (!sync) {
          lastSyncTime = new Date();
          lastSyncFromSpapi = data.source === "spapi";
          if (!nextAutoSyncAt) {
            nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
          }
        }
        updateSyncInfo();
      } catch (err) {
        console.error(err);
        alert("Failed to load POs");
      } finally {
        if (btn && sync) { btn.disabled = false; btn.textContent = "Sync Vendor POs"; }
      }
    }

    async function loadNotifications() {
      const statusEl = document.getElementById("notifications-status");
      const tbody = document.getElementById("notifications-rows");
      if (statusEl) statusEl.textContent = "Loading...";
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="empty">Loading...</td></tr>';
      try {
        const resp = await fetch("/api/vendor-notifications/recent");
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        recentNotifications = data.items || [];
        if (!recentNotifications.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="empty">No notifications</td></tr>';
        } else {
          tbody.innerHTML = recentNotifications.map(n => {
            const poLink = n.po
              ? `<a href="#" onclick="openNotificationPo('${n.po}'); return false;">${escapeHtml(n.po)}</a>`
              : "";
            return `<tr>
              <td>${formatTs(n.ts)}</td>
              <td>${escapeHtml(n.notificationType || "")}</td>
              <td>${poLink}</td>
              <td>${escapeHtml(n.summary || "")}</td>
            </tr>`;
          }).join("");
        }
        if (statusEl) statusEl.textContent = `Loaded ${recentNotifications.length} notifications`;
      } catch (err) {
        console.error("Failed to load notifications", err);
        if (statusEl) statusEl.textContent = "Failed to load notifications";
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="empty">Failed to load notifications</td></tr>';
      }
    }

    function openNotificationPo(poNumber) {
      const po = vendorPOs.find(p => p.purchaseOrderNumber === poNumber);
      if (po) {
        openModal(po);
      } else {
        alert(`PO ${poNumber} not found in current list. Please sync or search.`);
      }
    }

    async function rebuildPOs() {
      const btn = document.getElementById("rebuild-btn");
      const syncBtn = document.getElementById("sync-btn");
      if (btn) { btn.disabled = true; btn.textContent = "Rebuilding..."; }
      if (syncBtn) syncBtn.disabled = true;
      try {
        const resp = await fetch("/api/vendor-pos/rebuild", { method: "POST" });
        let fetched = 0;
        if (resp.ok) {
          const data = await resp.json();
          fetched = data.fetched || 0;
        } else {
          const txt = await resp.text();
          throw new Error(txt || `HTTP ${resp.status}`);
        }
        lastSyncTime = new Date();
        lastSyncFromSpapi = true;
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
        updateSyncInfo();
        const hh = String(lastSyncTime.getHours()).padStart(2, "0");
        const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
        showToast(`Full rebuild completed at ${hh}:${mi}, ${fetched} POs fetched.`);
        await loadPOs(false);
      } catch (err) {
        console.error(err);
        alert("Full rebuild failed");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Full Rebuild POs"; }
        if (syncBtn) syncBtn.disabled = false;
      }
    }

    function getPoDate(po) {
      return po.purchaseOrderDate || po.orderDetails?.purchaseOrderDate || "";
    }

    function formatQtyWithUnits(qty) {
      qty = Number(qty) || 0;
      return qty === 0 ? "0 units" : `${qty} units`;
    }

    function formatCost(costObj) {
      if (!costObj) return "";
      if (typeof costObj === "string") return costObj;
      if (typeof costObj === "number") return costObj;
      if (costObj.amount !== undefined) {
        return `${costObj.currencyCode || "AED"} ${costObj.amount}`;
      }
      return "";
    }

    function applyStatusRowClass(row, status) {
      row.classList.remove("po-status-preparing", "po-status-appointment", "po-status-delivered");
      const s = (status || "").toLowerCase();
      if (s === "preparing") {
        row.classList.add("po-status-preparing");
      } else if (s === "appointment scheduled") {
        row.classList.add("po-status-appointment");
      } else if (s === "delivered") {
        row.classList.add("po-status-delivered");
      }
    }

    function toDateInputValue(isoDateStr) {
      if (!isoDateStr) return "";
      return isoDateStr.substring(0, 10);
    }

    function todayAsYyyyMmDd() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function isAppointmentStatus(status) {
      const s = (status || "").toLowerCase();
      return s === "appointment scheduled" || s === "appointment taken";
    }

    function updateLocalPoStatusData(poNumber, status, statusDate) {
      const item = vendorPOs.find(p => p.purchaseOrderNumber === poNumber);
      if (!item) return;
      
      if (status !== undefined && status !== null) {
        item._internalStatus = status;
      }
      item._appointmentDate = statusDate || null;
    }

    // Listen for date input changes in Status Date column
    document.addEventListener("change", async (e) => {
      const inp = e.target;
      if (!inp.classList.contains("po-status-date-input")) return;

      const row = inp.closest("tr");
      if (!row) return;

      const po = inp.getAttribute("data-po");
      const newDate = inp.value;
      const statusSelect = row.querySelector(".po-status-select");
      const currentStatus = statusSelect ? statusSelect.value : null;

      if (!po || !currentStatus || !newDate) return;

      // Only valid if status is Appointment Scheduled / Taken
      const sLower = currentStatus.toLowerCase();
      if (sLower !== "appointment scheduled" && sLower !== "appointment taken") return;

      try {
        const res = await fetch(`/api/po-status/${encodeURIComponent(po)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: currentStatus,
            appointmentDate: newDate
          }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Keep input synced with backend value
        if (data.appointmentDate) {
          inp.value = toDateInputValue(data.appointmentDate);
        }

        // Update local PO data
        updateLocalPoStatusData(po, data.status || currentStatus, data.appointmentDate);

        updateInhouseSummary();
      } catch (err) {
        console.error("Failed to update appointment date", err);
        alert("Failed to save appointment date. Please try again.");
      }
    }, true);

    function renderTable() {
      const tbody = document.getElementById("po-rows");
      tbody.innerHTML = "";
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="14" class="empty">No POs</td></tr>';
        return;
      }

      list.forEach(po => {
        const poNumber = po.purchaseOrderNumber || "";
        const flags = po.notificationFlags || {};
        const notifBadge = flags.has_recent_notifications
          ? `<span style="margin-left:6px; padding:2px 6px; border-radius:6px; background:#fef3c7; color:#92400e; font-size:11px;" title="Last notification: ${escapeHtml(flags.last_notification_summary || "")} at ${formatTs(flags.last_notification_ts || "")}${flags.needs_refresh ? ' • Needs refresh' : ''}">${flags.needs_refresh ? "Update Ready" : "Updated"}</span>`
          : "";
        const isChecked = selectedPoNumbers.includes(poNumber);

        const poItemsCount = Number(po.poItemsCount) || 0;
        const requestedQty = formatQtyWithUnits(po.requestedQty);
        const acceptedQty = formatQtyWithUnits(po.acceptedQty);
        const receivedQty = formatQtyWithUnits(po.receivedQty);
        const remainingQty = formatQtyWithUnits(po.remainingQty);
        const cancelledQty = formatQtyWithUnits(po.cancelledQty);
        
        // FIXED: Use corrected total_accepted_cost (accepted_qty * unit_price)
        const costAmount = po.total_accepted_cost ? po.total_accepted_cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0.00";
        const costCurrency = po.total_accepted_cost_currency || po.totalAcceptedCostCurrency || "AED";
        const totalAcceptedCost = `${costCurrency} ${costAmount}`;
        
        const internalStatus = po._internalStatus || "Pending";
        const amazonStatus = po.amazonStatus || "—";
        const shipToLocation = po.shipToText || (po.orderDetails?.shipToParty?.partyId ? `${po.orderDetails.shipToParty.partyId}` : "");

        const tr = document.createElement("tr");
        tr.ondblclick = () => openModal(po);
        applyStatusRowClass(tr, internalStatus);

        // Status column: dropdown only
        const statusDropdown = `<select class="po-status-select" data-po="${escapeAttr(poNumber)}" onchange="handleStatusChange('${escapeAttr(poNumber)}', this)">
          ${INTERNAL_STATUS_OPTIONS.map(opt => `<option value="${escapeAttr(opt)}" ${opt === internalStatus ? "selected" : ""}>${escapeHtml(opt)}</option>`).join("")}
        </select>`;

        // Status Date column: depends on status
        const statusLower = internalStatus.toLowerCase();
        const hasDate = !!po._appointmentDate;
        let statusDateCellHtml = "";

        if (statusLower === "appointment scheduled" || statusLower === "appointment taken") {
          // Editable date input
          const dateValue = hasDate ? toDateInputValue(po._appointmentDate) : todayAsYyyyMmDd();
          statusDateCellHtml = `<input type="date" class="po-status-date-input" data-po="${escapeAttr(poNumber)}" value="${dateValue}" />`;
        } else if (statusLower === "delivered" && hasDate) {
          // Read-only text for Delivered
          statusDateCellHtml = `<span data-col="status-date">${escapeHtml(fmtDate(po._appointmentDate))}</span>`;
        } else {
          // Pending/Preparing or no date
          statusDateCellHtml = `<span data-col="status-date">—</span>`;
        }

        tr.innerHTML = `
      <td><input type="checkbox" ${isChecked ? "checked" : ""} onchange="toggleSelectPo('${poNumber}', this.checked)" /></td>
      <td><div style="display:flex; align-items:center; gap:6px;">${poNumber}${notifBadge}</div></td>
      <td style="text-align:center;">${poItemsCount}</td>
      <td>${fmtDate(getPoDate(po))}</td>
      <td style="text-align:center;">${requestedQty}</td>
      <td style="text-align:center;">${acceptedQty}</td>
      <td style="text-align:center;">${receivedQty}</td>
      <td style="text-align:center;">${remainingQty}</td>
      <td style="text-align:center;">${cancelledQty}</td>
      <td style="text-align:right; padding-right:16px;">${totalAcceptedCost}</td>
      <td>${statusDropdown}</td>
      <td>${statusDateCellHtml}</td>
      <td>${amazonStatus}</td>
      <td>${shipToLocation}</td>
    `;

        tbody.appendChild(tr);
      });
      updateSelectAllCheckbox();
    }

    async function syncRejectedLinesToOos(poNumber, items, poDate, shipTo) {
      if (!items || !items.length) return;
      const rejected = items.filter(it => {
        const ack = it.acknowledgementStatus || {};
        const conf = (ack.confirmationStatus || it.status || "").toUpperCase();
        return conf === "REJECTED";
      });
      if (!rejected.length) return;
      try {
        await Promise.all(rejected.map(it => {
          const qtyRaw = it.orderedQuantity || {};
          const qtyNum = toNum(qtyRaw.amount) || toNum(qtyRaw.value) || toNum(qtyRaw?.orderedQuantity?.amount);
          const payload = {
            poNumber,
            asin: it.amazonProductIdentifier || "",
            vendorSku: it.vendorProductIdentifier || "",
            purchaseOrderDate: poDate,
            shipToPartyId: shipTo,
            qty: qtyNum,
            image: resolveImage(it) || "",
          };
          if (!payload.poNumber || !payload.asin) return Promise.resolve();
          return fetch("/api/oos-items/mark", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }).catch(() => {});
        }));
      } catch (err) {
        console.warn("Failed syncing rejected lines to OOS", err);
      }
    }

    async function openModal(po) {
      const modal = document.getElementById("modal");
      const body = document.getElementById("modal-body");
      const titleEl = document.getElementById("modal-title");

      const poNumber = po.purchaseOrderNumber || po.poNumber || "";
      if (!poNumber) {
        console.error("No purchaseOrderNumber on PO", po);
        return;
      }

      let enrichedPo = po;
      try {
        const resp = await fetch(`/api/vendor-pos/${encodeURIComponent(poNumber)}?enrich=1`);
        if (resp.ok) {
          const data = await resp.json();
          if (data && data.item) {
            enrichedPo = data.item;
          }
        }
        else {
          console.error("Failed to fetch enriched PO", resp.status, await resp.text());
        }
      } catch (e) {
        console.error("Failed to fetch enriched PO", e);
      }

      const d = enrichedPo.orderDetails || {};
      const items = d.items || [];
      const notifFlags = enrichedPo.notificationFlags || {};
      const notifLine = notifFlags.has_recent_notifications
        ? `<div style="font-size:12px; color:#0ea5e9; margin-bottom:8px;">Last Amazon notification: ${escapeHtml(notifFlags.last_notification_summary || "")} at ${formatTs(notifFlags.last_notification_ts || "")}${notifFlags.needs_refresh ? " • refresh applied" : ""}</div>`
        : `<div style="font-size:12px; color:#6b7280; margin-bottom:8px;">No recent notifications</div>`;
      await syncRejectedLinesToOos(poNumber, items, getPoDate(enrichedPo), d.shipToParty?.partyId || "");
      const poDate = getPoDate(enrichedPo);
      const shipTo = d.shipToParty?.partyId || "";
      const rows = items.map(it => {
        const qtyRaw = it.orderedQuantity || {};
        const qtyNum = toNum(qtyRaw.amount) || toNum(qtyRaw.value) || toNum(qtyRaw?.orderedQuantity?.amount);
        const qtyAmount = qtyNum || 0;
        const { netAmount, netCurrency } = resolveNet(it);
        const netNum = netAmount;
        
        // FIX: Use accepted_line_amount if available (computed by backend), else fall back to manual calculation
        let acceptedLineAmount = 0;
        if (it.accepted_line_amount !== undefined) {
          acceptedLineAmount = it.accepted_line_amount;
        } else {
          // Fallback calculation if not provided by backend
          const accAmt = toNum((it.acknowledgementStatus?.acceptedQuantity || {}).amount) || 0;
          acceptedLineAmount = Number.isFinite(accAmt * netNum) ? accAmt * netNum : 0;
        }
        
        const rawAsin = it.amazonProductIdentifier || it.buyerProductIdentifier || it.vendorProductIdentifier || "";
        const asin = qualifyAsin(rawAsin);
        const vendorSku = it.vendorProductIdentifier || "";
        const seq = it.itemSequenceNumber || "";
        const ack = it.acknowledgementStatus || {};
        const currStatus = (ack.confirmationStatus || "ACCEPTED").toUpperCase();
        const accAmt = toNum((ack.acceptedQuantity || {}).amount) || (currStatus === "ACCEPTED" ? qtyAmount : 0);
        const rejAmt = toNum((ack.rejectedQuantity || {}).amount) || (currStatus === "REJECTED" ? qtyAmount : 0);
        
        // Get received quantity (from backend extraction of receivingStatus.receivedQuantity)
        const receivedQty = it.received_qty !== undefined ? it.received_qty : toNum(it.receivedQuantity?.amount) || 0;

        // Determine if this line is rejected or received
        const isRejected = (currStatus === "REJECTED") || (accAmt === 0 && rejAmt > 0);
        const isReceived = !isRejected && receivedQty > 0;
        let rowClass = '';
        if (isRejected) {
          rowClass = ' class="po-line-rejected"';
        } else if (isReceived) {
          rowClass = ' class="po-line-received"';
        }

        const rawImageUrl = resolveImage(it);
        const img = rawImageUrl
          ? `<img src="${rawImageUrl}" alt="" style="max-width:60px;max-height:60px;border-radius:6px;object-fit:contain;" />`
          : `<div class="img-placeholder" data-asin="${asin || ""}" data-sku="${vendorSku || ""}" style="width:60px; height:60px; background:#e5e7eb; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:11px;">No image</div>`;
        const encodedImage = encodeURIComponent(rawImageUrl || "");

        return `<tr${rowClass} oncontextmenu="markItemOos(event, '${poNumber}', '${asin}', '${vendorSku}', '${po.purchaseOrderDate || d.purchaseOrderDate || ""}', '${shipTo}', '${qtyAmount}', '${encodedImage}')">
          <td>${seq}</td>
          <td>${img}</td>
          <td data-col="ordered">${qtyAmount}</td>
          <td>${accAmt}</td>
          <td>${receivedQty}</td>
          <td>${rejAmt}</td>
          <td>${currStatus}</td>
          <td>${Number.isFinite(netNum) && netNum ? netNum.toFixed(2) : ""}</td>
          <td>${netCurrency || ""}</td>
          <td>${Number.isFinite(acceptedLineAmount) && acceptedLineAmount > 0 ? acceptedLineAmount.toFixed(2) : "0.00"}</td>
        </tr>`;
      }).join("");

      // Compute PO-level accepted total (from backend if available, else sum items)
      let poAcceptedTotal = 0;
      let poAcceptedCurrency = "AED";
      if (enrichedPo.accepted_total_amount !== undefined) {
        poAcceptedTotal = enrichedPo.accepted_total_amount;
        poAcceptedCurrency = enrichedPo.accepted_total_currency || "AED";
      } else {
        // Fallback: sum up accepted_line_amount from all items
        items.forEach(it => {
          if (it.accepted_line_amount !== undefined) {
            poAcceptedTotal += it.accepted_line_amount;
          }
        });
        poAcceptedCurrency = items.length > 0 && items[0].netCost?.currencyCode ? items[0].netCost.currencyCode : "AED";
      }

      const formattedTotal = Number.isFinite(poAcceptedTotal) && poAcceptedTotal > 0
        ? `${poAcceptedCurrency} ${poAcceptedTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
        : `${poAcceptedCurrency} 0.00`;

      // Build summary row
      const summaryRow = `<tr class="po-items-summary">
        <td colspan="8"></td>
        <td style="text-align: right;">Accepted Total:</td>
        <td style="text-align: right; font-weight: 700;">${formattedTotal}</td>
      </tr>`;

      titleEl.textContent = `PO ${poNumber} Items`;
      body.innerHTML = `
        <div style="overflow:auto; max-height:70vh;">
          ${notifLine}
          <table class="table">
            <thead>
              <tr>
                <th>Seq</th>
                <th>Image</th>
                <th>Ordered</th>
                <th>Accepted</th>
                <th>Received</th>
                <th>Rejected</th>
                <th>Status</th>
                <th>Net Amount</th>
                <th>Currency</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="10" class="empty">No items</td></tr>'}${rows ? summaryRow : ''}</tbody>
          </table>
        </div>
      `;
      modal.style.display = "flex";
      populateMissingImages(items);
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    async function populateMissingImages(items) {
      const placeholders = Array.from(document.querySelectorAll(".img-placeholder[data-asin]"));
      const uniqueAsins = Array.from(new Set(placeholders.map(p => p.dataset.asin).filter(Boolean)));
      if (!uniqueAsins.length) return;

      for (const asin of uniqueAsins) {
        if (catalogImageCache.hasOwnProperty(asin)) continue;
        try {
          const resp = await fetch(`/api/catalog/item/${asin}`);
          if (!resp.ok) {
            catalogImageCache[asin] = null;
            continue;
          }
          const data = await resp.json();
          const payload = data.item || data.payload || data || {};
          const direct = data.image || payload.image;
          const candidate = direct || resolveImage(payload);
          catalogImageCache[asin] = candidate || null;
        } catch {
          catalogImageCache[asin] = null;
        }
      }

      placeholders.forEach(ph => {
        const asin = ph.dataset.asin;
        const cached = catalogImageCache[asin];
        if (cached) {
          ph.outerHTML = `<img src="${cached}" alt="" style="max-width:60px;max-height:60px;border-radius:6px;object-fit:contain;" />`;
        }
      });
    }

    function qualifyAsin(val) {
      if (!val) return "";
      const v = String(val).trim();
      const re = /^[A-Z0-9]{8,15}$/i;
      if (re.test(v)) return v.toUpperCase();
      return "";
    }


    async function handleStatusChange(poNumber, selectEl) {
      const newStatus = selectEl.value;
      const row = selectEl.closest("tr");
      let statusDateToSend = null;

      const statusLower = newStatus.toLowerCase();

      if (statusLower === "appointment scheduled" || statusLower === "appointment taken") {
        // Appointment: use existing date or default to today
        const existingInput = row ? row.querySelector(".po-status-date-input") : null;
        if (existingInput && existingInput.value) {
          statusDateToSend = existingInput.value;
        } else {
          statusDateToSend = todayAsYyyyMmDd();
        }
      } else if (statusLower === "delivered") {
        // Delivered: keep existing date if present
        const existingInput = row ? row.querySelector(".po-status-date-input") : null;
        const existingSpan = row ? row.querySelector("[data-col='status-date']") : null;
        if (existingInput && existingInput.value) {
          statusDateToSend = existingInput.value;
        } else if (existingSpan && existingSpan.textContent && existingSpan.textContent !== "—") {
          statusDateToSend = toDateInputValue(existingSpan.textContent);
        } else {
          statusDateToSend = todayAsYyyyMmDd();
        }
      } else {
        // Pending / Preparing: no date
        statusDateToSend = null;
      }

      try {
        const res = await fetch(`/api/po-status/${encodeURIComponent(poNumber)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: newStatus,
            appointmentDate: statusDateToSend || null,
          }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Update Status Date cell based on returned status and date
        const statusDateCell = row ? row.querySelector("[data-col='status-date']") : null;
        if (statusDateCell || row) {
          const statusLower2 = (data.status || newStatus).toLowerCase();
          const hasDate = !!data.appointmentDate;
          let newCellHtml = "";

          if (statusLower2 === "appointment scheduled" || statusLower2 === "appointment taken") {
            // Render editable date input
            const dateValue = hasDate ? toDateInputValue(data.appointmentDate) : todayAsYyyyMmDd();
            newCellHtml = `<input type="date" class="po-status-date-input" data-po="${escapeAttr(poNumber)}" value="${dateValue}" />`;
          } else if (statusLower2 === "delivered" && hasDate) {
            // Render read-only text
            newCellHtml = `<span data-col="status-date">${escapeHtml(fmtDate(data.appointmentDate))}</span>`;
          } else {
            // Pending/Preparing or no date
            newCellHtml = `<span data-col="status-date">—</span>`;
          }

          // Find the Status Date cell and replace its content
          const cellIndex = 11; // Status Date is 12th column (0-indexed)
          const cells = row.querySelectorAll("td");
          if (cells[cellIndex]) {
            cells[cellIndex].innerHTML = newCellHtml;
          }
        }

        // Update local PO data
        updateLocalPoStatusData(poNumber, data.status || newStatus, data.appointmentDate);

        // Apply row highlight
        if (row) {
          applyStatusRowClass(row, data.status || newStatus);
        }

        // Update summary
        updateInhouseSummary();
        filterPOs();
      } catch (err) {
        console.error("Failed to save PO status", err);
        alert("Failed to update status. Please try again.");
      }
    }

    async function updateAppointmentDate(poNumber, inputEl) {
      const newDate = inputEl.value || null;
      const tr = inputEl.closest("tr");
      let status = "Pending";

      if (tr) {
        const select = tr.querySelector("select.po-status-select");
        if (select) {
          status = select.value;
        }
      }

      try {
        await fetch(`/api/po-status/${encodeURIComponent(poNumber)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: status,
            appointmentDate: newDate,
          }),
        });
        updateLocalPoStatus(poNumber, status, newDate);
        updateInhouseSummary();
        filterPOs();
      } catch (err) {
        console.error("Failed to save appointment date", err);
        alert("Failed to save appointment date. Check console for details.");
      }
    }

    function updateLocalPoStatus(poNumber, status, appointmentDate) {
      const lists = [vendorPOs, filteredPOs];
      lists.forEach(list => {
        if (!list) return;
        const po = list.find(p => p.purchaseOrderNumber === poNumber);
        if (po) {
          po._internalStatus = status;
          if (appointmentDate) {
            po._appointmentDate = appointmentDate;
          } else {
            delete po._appointmentDate;
          }
        }
      });
    }

    function filterPOs() {
      const searchInput = document.getElementById("po-search");
      const fcSelect    = document.getElementById("po-filter-fc");
      const statusSelect = document.getElementById("po-filter-status");
      const dateWindowSelect = document.getElementById("po-start-days");

      const qRaw = (searchInput?.value || "").trim().toLowerCase();
      const fcFilter = (fcSelect?.value || "").trim().toLowerCase();
      const statusFilter = (statusSelect?.value || "").trim();
      const daysWindow = Number(dateWindowSelect?.value || 60);

      // Calculate date cutoff
      const now = new Date();
      const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysWindow);

      filteredPOs = (vendorPOs || []).filter(po => {
        const d = po.orderDetails || {};
        const items = d.items || [];
        const shipTo = (d.shipToParty?.partyId || "").toLowerCase();
        const poNumber = (po.purchaseOrderNumber || "").toLowerCase();
        const state = (po.purchaseOrderState || "").toLowerCase();
        const inhouseStatus = (po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending").toLowerCase();

        // Date window filter
        const orderDateStr = po.purchaseOrderDate || d.purchaseOrderDate || "";
        if (orderDateStr) {
          const orderDate = new Date(orderDateStr);
          if (!Number.isNaN(orderDate.getTime()) && orderDate < cutoff) {
            return false;
          }
        }

        let asins = "";
        let skus = "";
        items.forEach(it => {
          asins += " " + String(it.amazonProductIdentifier || "").toLowerCase();
          skus  += " " + String(it.vendorProductIdentifier || "").toLowerCase();
        });

        const haystack = [
          poNumber,
          state,
          inhouseStatus,
          shipTo,
          asins,
          skus,
        ].join(" ");

        if (qRaw && !haystack.includes(qRaw)) {
          return false;
        }

        if (fcFilter && shipTo !== fcFilter) {
          return false;
        }

        const currentStatus = (po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending");
        if (statusFilter && currentStatus !== statusFilter) {
          return false;
        }

        return true;
      });

      renderTable();
      updateInhouseSummary();
    }

    function updateInhouseSummary() {
      const el = document.getElementById("inhouse-summary");
      if (!el) return;

      const list = filteredPOs && filteredPOs.length ? filteredPOs : vendorPOs;
      const counts = {
        "Pending": 0,
        "Preparing": 0,
        "Appointment Scheduled": 0,
        "Delivered": 0,
      };

      list.forEach(po => {
        const status = po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending";
        if (counts.hasOwnProperty(status)) {
          counts[status]++;
        }
      });

      el.textContent =
        `Pending: ${counts["Pending"]}  |  ` +
        `Preparing: ${counts["Preparing"]}  |  ` +
        `Appointment Scheduled: ${counts["Appointment Scheduled"]}  |  ` +
        `Delivered: ${counts["Delivered"]}`;
    }

    function populateFcFilterOptions() {
      const select = document.getElementById("po-filter-fc");
      if (!select) return;

      const values = new Set();
      (vendorPOs || []).forEach(po => {
        const d = po.orderDetails || {};
        const fc = d.shipToParty?.partyId || "";
        if (fc) values.add(fc);
      });

      const currentValue = select.value;
      select.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "All F/C";
      select.appendChild(optAll);

      Array.from(values).sort().forEach(fc => {
        const opt = document.createElement("option");
        opt.value = fc;
        opt.textContent = fc;
        select.appendChild(opt);
      });

      if (currentValue && values.has(currentValue)) {
        select.value = currentValue;
      }
    }

    async function showCatalogDetails(asin) {
      const modal = document.getElementById("catalog-modal");
      const body = document.getElementById("catalog-modal-body");
      const titleEl = document.getElementById("catalog-modal-title");
      titleEl.textContent = `Catalog Details: ${asin}`;
      body.innerHTML = '<div class="json-block">Loading...</div>';
      modal.style.display = "flex";
      try {
        const resp = await fetch(`/api/catalog/item/${asin}`);
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        body.innerHTML = `<pre id="catalog-json" class="json-block" ondblclick="copyCatalogJson()"></pre>`;
        document.getElementById("catalog-json").textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        body.innerHTML = `<div class="json-block">Failed to load catalog details: ${err}</div>`;
      }
    }

    function closeCatalogModal() {
      document.getElementById("catalog-modal").style.display = "none";
    }

    async function openPoLinesModal(poNumber) {
      const modal = document.getElementById("po-lines-modal");
      const titleEl = document.getElementById("po-lines-modal-title");
      const bodyEl = document.getElementById("po-lines-modal-body");

      titleEl.textContent = `PO ${poNumber} - Line Items Inventory Breakdown`;
      bodyEl.innerHTML = '<div style="padding:16px; text-align:center;">Loading line details...</div>';
      modal.style.display = "flex";

      try {
        const resp = await fetch(`/api/vendor-po-lines?po_number=${encodeURIComponent(poNumber)}`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const lines = data.items || [];

        if (!lines.length) {
          bodyEl.innerHTML = '<div style="padding:16px; text-align:center; color:#6b7280;">No line items found for this PO in the database.</div>';
          return;
        }

        // Build table
        const rows = lines.map(line => {
          const shortage = line.shortage_qty || 0;
          const pending = line.pending_qty || 0;
          const shortageClass = shortage > 0 ? "qty-shortage" : (pending > 0 ? "qty-pending" : "qty-good");
          
          return `<tr>
            <td>${line.asin || ""}</td>
            <td>${line.sku || ""}</td>
            <td style="text-align:center;">${line.ordered_qty || 0}</td>
            <td style="text-align:center;">${line.received_qty || 0}</td>
            <td class="${shortageClass}" style="text-align:center;">${line.pending_qty || 0}</td>
            <td class="${shortageClass}" style="text-align:center; font-weight:600;">${shortage > 0 ? '⚠️ ' + shortage : shortage}</td>
          </tr>`;
        }).join("");

        bodyEl.innerHTML = `
          <div style="padding:16px;">
            <div style="margin-bottom:16px; padding:12px; background:#f3f4f6; border-radius:8px;">
              <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Ordered</div>
                  <div style="font-size:18px; font-weight:700;">${lines.reduce((s, l) => s + (l.ordered_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Received</div>
                  <div style="font-size:18px; font-weight:700;">${lines.reduce((s, l) => s + (l.received_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Pending</div>
                  <div style="font-size:18px; font-weight:700; color:#b45309;">${lines.reduce((s, l) => s + (l.pending_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Shortage</div>
                  <div style="font-size:18px; font-weight:700; color:#dc2626;">${lines.reduce((s, l) => s + (l.shortage_qty || 0), 0)}</div>
                </div>
              </div>
            </div>
            <div style="overflow:auto; max-height:60vh;">
              <table>
                <thead>
                  <tr>
                    <th>ASIN</th>
                    <th>SKU</th>
                    <th style="text-align:center;">Ordered</th>
                    <th style="text-align:center;">Received</th>
                    <th style="text-align:center;">Pending</th>
                    <th style="text-align:center;">Shortage</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } catch (err) {
        console.error("Failed to load PO lines", err);
        bodyEl.innerHTML = `<div style="padding:16px; color:#dc2626;">⚠️ Failed to load line details: ${err.message || err}</div>`;
      }
    }

    function closePoLinesModal() {
      document.getElementById("po-lines-modal").style.display = "none";
    }

    function resolveImage(it) {
      const candidates = [];
      const pushCandidate = (obj) => {
        if (!obj || typeof obj !== "object") return;
        candidates.push(obj.image, obj.imageUrl, obj.detailPageImage, obj.thumbnail, obj.mainImage?.link, obj.mainImage?.url);
        if (Array.isArray(obj.summaries)) {
          obj.summaries.forEach(s => {
            if (!s || typeof s !== "object") return;
            candidates.push(s.mainImage?.link, s.mainImage?.url, s.image, s.imageUrl);
            if (Array.isArray(s.images)) {
              s.images.forEach(im => candidates.push(im && (im.link || im.url)));
            }
          });
        }
        if (Array.isArray(obj.images)) {
          obj.images.forEach(img => {
            if (!img) return;
            candidates.push(img.link, img.url);
            if (Array.isArray(img.variants)) {
              img.variants.forEach(v => candidates.push(v && (v.link || v.url)));
            }
            if (Array.isArray(img.images)) {
              img.images.forEach(v => candidates.push(v && (v.link || v.url)));
            }
          });
        }
      };

      pushCandidate(it);
      if (it && typeof it === "object") {
        pushCandidate(it.payload);
      }

      return candidates.find(Boolean) || "";
    }

    function resolveNet(it) {
      const nets = [it.netCost, it.listPrice, it.price, it.unitPrice];
      let amount = 0;
      let currency = "";
      for (const n of nets) {
        if (n && typeof n === "object") {
          amount = toNum(n.amount) || toNum(n.value) || toNum(n.price);
          currency = n.currencyCode || n.currency || n.code || currency;
          if (amount) break;
        }
      }
      if (!currency) {
        currency = it.currencyCode || it.currency || it.orderedQuantity?.currencyCode || "";
      }
      if (!currency && amount) {
        currency = "AED";
      }
      return { netAmount: amount, netCurrency: currency };
    }


    function copyCatalogJson() {
      const pre = document.getElementById("catalog-json");
      if (!pre) return;
      const text = pre.textContent || "";
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const range = document.createRange();
        range.selectNode(pre);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try { document.execCommand("copy"); } catch (e) {}
        sel.removeAllRanges();
      }
    }

    let toastTimeoutId = null;
    function showToast(message) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = message;
      el.style.opacity = "1";
      if (toastTimeoutId) clearTimeout(toastTimeoutId);
      toastTimeoutId = setTimeout(() => {
        el.style.opacity = "0";
      }, 4000);
    }

    function toggleSelectPo(poNumber, checked) {
      if (!poNumber) return;
      if (checked) {
        if (!selectedPoNumbers.includes(poNumber)) {
          selectedPoNumbers.push(poNumber);
        }
      } else {
        selectedPoNumbers = selectedPoNumbers.filter(p => p !== poNumber);
      }
      updateSelectAllCheckbox();
      updatePicklistButtonState();
    }

    function toggleSelectAllPos(headerCheckbox) {
      const checked = headerCheckbox?.checked;
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      if (checked) {
        selectedPoNumbers = Array.from(new Set([...selectedPoNumbers, ...list.map(p => p.purchaseOrderNumber).filter(Boolean)]));
      } else {
        const visibleSet = new Set(list.map(p => p.purchaseOrderNumber).filter(Boolean));
        selectedPoNumbers = selectedPoNumbers.filter(p => !visibleSet.has(p));
      }
      renderTable();
      updatePicklistButtonState();
    }

    function updateSelectAllCheckbox() {
      const headerCheckbox = document.getElementById("po-select-all");
      if (!headerCheckbox) return;
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      const visiblePos = list.map(p => p.purchaseOrderNumber).filter(Boolean);
      if (!visiblePos.length) {
        headerCheckbox.checked = false;
        headerCheckbox.indeterminate = false;
        return;
      }
      const selectedVisible = visiblePos.filter(p => selectedPoNumbers.includes(p));
      headerCheckbox.checked = selectedVisible.length === visiblePos.length;
      headerCheckbox.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visiblePos.length;
    }

    function updatePicklistButtonState() {
      const btn = document.getElementById("picklist-btn");
      if (!btn) return;
      btn.disabled = !selectedPoNumbers.length;
    }

    function aggregate(items) {
      let totalCost = 0;
      let currency = "";
      items.forEach(it => {
        const qty = toNum(it?.orderedQuantity?.amount);
        const unitCost = toNum(it?.netCost?.amount);
        totalCost += qty * unitCost;
        if (it?.netCost?.currencyCode) currency = it.netCost.currencyCode;
      });
      return { totalCost, currency };
    }

    function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function formatNum(v, cur = "") {
      const n = Number(v);
      if (!Number.isFinite(n)) return "";
      return (cur ? cur + " " : "") + n.toFixed(2);
    }

    function fmtDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function formatTs(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeAttr(str) {
      if (str === undefined || str === null) return "";
      return String(str).replace(/"/g, "&quot;");
    }

    function formatSyncTime(d) {
      if (!d) return "—";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}-${mm}-${yyyy} ${hh}:${mi}`;
    }

    function formatEta(msDiff) {
      if (msDiff <= 0) return "soon";
      const totalMinutes = Math.floor(msDiff / 60000);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      if (h <= 0) return `in ${m}m`;
      return `in ${h}h ${m}m`;
    }

    function updateSyncInfo() {
      const lastEl = document.getElementById("sync-last");
      const nextEl = document.getElementById("sync-next");
      if (!lastEl || !nextEl) return;

      if (!lastSyncTime) {
        lastEl.textContent = "Last Sync: —";
      } else {
        const src = lastSyncFromSpapi ? "(from SP-API)" : "(from cache)";
        lastEl.textContent = `Last Sync: ${formatSyncTime(lastSyncTime)} ${src}`;
      }

      if (!nextAutoSyncAt) {
        nextEl.textContent = "Next Auto-Sync: —";
      } else {
        const diff = nextAutoSyncAt - Date.now();
        nextEl.textContent = `Next Auto-Sync: ${formatEta(diff)}`;
      }
    }

    function showTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      document.getElementById("pos-tab").style.display = tab === "pos" ? "block" : "none";
      document.getElementById("catalog-tab").style.display = tab === "catalog" ? "block" : "none";
      document.getElementById("oos-tab").style.display = tab === "oos" ? "block" : "none";
      const testerEl = document.getElementById("tester-tab");
      if (testerEl) {
        testerEl.style.display = tab === "tester" ? "block" : "none";
      }
      const notifEl = document.getElementById("notifications-tab");
      if (notifEl) {
        notifEl.style.display = tab === "notifications" ? "block" : "none";
        if (tab === "notifications") {
          loadNotifications();
        }
      }
      const rtSalesEl = document.getElementById("vendor-rt-sales-tab");
      if (rtSalesEl) {
        rtSalesEl.style.display = tab === "vendor-rt-sales" ? "block" : "none";
        if (tab === "vendor-rt-sales") {
          loadRtSalesWindowSelection();
          loadVendorRtSalesSummary();
        }
      }
      if (tab === "catalog" && !asinList.length) {
        loadAsinList();
      }
      if (tab === "oos") {
        loadOosItems();
      }
      if (tab === "tester") {
        loadTesterMeta();
      }
    }

    async function loadTesterMeta() {
      if (testerMetaLoaded) return;
      try {
        const resp = await fetch("/api/spapi-tester/meta");
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        testerPresets = data.presets || [];
        testerHost = data.host || "";
        const presetSelect = document.getElementById("tester-preset");
        if (presetSelect) {
          testerPresets.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.group} — ${p.label}`;
            opt.dataset.path = p.path || "";
            opt.dataset.method = p.method || "GET";
            opt.dataset.defaultQuery = p.default_query || "";
            opt.dataset.defaultBody = p.default_body ? JSON.stringify(p.default_body, null, 2) : "";
            opt.dataset.notes = p.notes || "";
            presetSelect.appendChild(opt);
          });
        }
        const hostLabel = document.getElementById("tester-host");
        if (hostLabel) {
          hostLabel.textContent = testerHost ? `Host: ${testerHost}` : "";
        }
        testerMetaLoaded = true;
      } catch (err) {
        const statusEl = document.getElementById("tester-status");
        if (statusEl) {
          statusEl.textContent = `Failed to load presets: ${err}`;
          statusEl.style.color = "#dc2626";
        }
      }
    }

    function applyTesterPreset() {
      const presetSelect = document.getElementById("tester-preset");
      const endpointInput = document.getElementById("tester-endpoint");
      const methodSelect = document.getElementById("tester-method");
      const statusEl = document.getElementById("tester-status");
      const queryInput = document.getElementById("tester-query");
      const bodyInput = document.getElementById("tester-body");
      if (!presetSelect || !endpointInput) return;
      const selectedOpt = presetSelect.options[presetSelect.selectedIndex];
      const path = selectedOpt?.dataset?.path || "";
      const method = selectedOpt?.dataset?.method || "GET";
      const defaultQuery = selectedOpt?.dataset?.defaultQuery || "";
      const defaultBody = selectedOpt?.dataset?.defaultBody || "";
      const notes = selectedOpt?.dataset?.notes || "";
      endpointInput.value = path;
      if (methodSelect) methodSelect.value = method;
      if (queryInput) queryInput.value = defaultQuery;
      if (bodyInput) bodyInput.value = defaultBody;
      if (statusEl) {
        statusEl.textContent = notes || "Preset applied";
        statusEl.style.color = "#475569";
      }
    }

    function parseFullPath(full) {
      if (!full) return { endpoint: "", query: "" };
      full = full.trim();
      try {
        if (full.startsWith("http")) {
          const u = new URL(full);
          return { endpoint: u.pathname, query: u.search ? u.search.substring(1) : "" };
        }
      } catch (e) {
        // fall through to manual split
      }
      const parts = full.split("?");
      const endpoint = parts[0] || "";
      const query = parts.slice(1).join("?") || "";
      return { endpoint, query };
    }

    function applyTesterFullPath() {
      const fullInput = document.getElementById("tester-fullpath");
      const endpointInput = document.getElementById("tester-endpoint");
      const queryInput = document.getElementById("tester-query");
      const statusEl = document.getElementById("tester-status");
      if (!fullInput || !endpointInput || !queryInput) return;
      const parsed = parseFullPath(fullInput.value || "");
      endpointInput.value = parsed.endpoint;
      queryInput.value = parsed.query;
      if (statusEl) {
        statusEl.textContent = parsed.endpoint ? "Applied full path" : "";
        statusEl.style.color = "#475569";
      }
    }

    async function runTesterCall() {
      const endpointInput = document.getElementById("tester-endpoint");
      const queryInput = document.getElementById("tester-query");
      const methodSelect = document.getElementById("tester-method");
      const bodyInput = document.getElementById("tester-body");
      const logEl = document.getElementById("tester-log");
      const statusEl = document.getElementById("tester-status");
      const btns = document.getElementsByClassName("tester-run-btn");
      if (!endpointInput || !logEl) return;
      const fullInput = document.getElementById("tester-fullpath");
      const fullVal = (fullInput?.value || "").trim();
      const method = (methodSelect?.value || "GET").toUpperCase();
      let endpoint = (endpointInput.value || "").trim();
      let query = (queryInput?.value || "").trim();
      if (fullVal) {
        const parsed = parseFullPath(fullVal);
        endpoint = parsed.endpoint || endpoint;
        query = parsed.query || query;
      }
      if (!endpoint) {
        alert("Please enter an endpoint path starting with /");
        return;
      }
      let bodyPayload = null;
      const bodyText = bodyInput?.value?.trim();
      if (method !== "GET" && bodyText) {
        try {
          bodyPayload = JSON.parse(bodyText);
        } catch (e) {
          if (statusEl) {
            statusEl.textContent = `Invalid JSON body: ${e}`;
            statusEl.style.color = "#dc2626";
          }
          return;
        }
      }
      if (statusEl) {
        statusEl.textContent = "Running...";
        statusEl.style.color = "#475569";
      }
      logEl.textContent = "Loading...";
      Array.from(btns).forEach(b => (b.disabled = true));
      try {
        const resp = await fetch("/api/spapi-tester/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            method,
            path: endpoint,
            query_string: query,
            body_json: bodyPayload,
          }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const body = data?.response?.body;
        const statusCode = data?.response?.status_code;
        const display = typeof body === "string" ? body : JSON.stringify(body, null, 2);
        logEl.textContent = display || "(empty body)";
        if (statusEl) {
          statusEl.textContent = `Status: ${statusCode ?? "?"} | ${method} ${endpoint}`;
          statusEl.style.color = "#166534";
        }
      } catch (err) {
        logEl.textContent = `Error: ${err}`;
        if (statusEl) {
          statusEl.textContent = `Error: ${err}`;
          statusEl.style.color = "#dc2626";
        }
      } finally {
        Array.from(btns).forEach(b => (b.disabled = false));
      }
    }

    function copyTesterLog() {
      const logEl = document.getElementById("tester-log");
      if (!logEl) return;
      const text = logEl.textContent || "";
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const range = document.createRange();
        range.selectNode(logEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try { document.execCommand("copy"); } catch (e) {}
        sel.removeAllRanges();
      }
      const statusEl = document.getElementById("tester-status");
      if (statusEl) {
        statusEl.textContent = "Log copied";
        statusEl.style.color = "#166534";
      }
    }

    async function loadAsinList(force = false) {
      const tbody = document.getElementById("asin-rows");
      tbody.innerHTML = '<tr><td colspan="6" class="empty">Loading...</td></tr>';
      try {
        const resp = await fetch("/api/catalog/asins");
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        asinList = data.items || [];
        filteredAsins = asinList;
        renderAsinList();
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Failed to load ASINs: ${err}</td></tr>`;
      }
    }

    function filterAsins() {
      const q = (document.getElementById("asin-search").value || "").toLowerCase();
      if (!q) {
        filteredAsins = asinList;
      } else {
        filteredAsins = asinList.filter(item => {
          return (item.asin || "").toLowerCase().includes(q) ||
                 (item.sku || "").toLowerCase().includes(q) ||
                 (item.model || "").toLowerCase().includes(q) ||
                 (item.title || "").toLowerCase().includes(q);
        });
      }
      renderAsinList();
    }

    async function fetchAllMissing() {
      const tbody = document.getElementById("asin-rows");
      tbody.innerHTML = '<tr><td colspan="6" class="empty">Fetching all missing... this may take time.</td></tr>';
      try {
        const resp = await fetch("/api/catalog/fetch-all", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        await loadAsinList(true);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Fetch-all failed: ${err}</td></tr>`;
      }
    }

    async function loadOosItems() {
      const tbody = document.getElementById("oos-rows");
      const statusEl = document.getElementById("oos-status");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Loading...</td></tr>';
      }
      try {
        const resp = await fetch("/api/oos-items");
        const data = await resp.json();
        oosItems = data.items || [];
        renderOosTable();
        if (statusEl) statusEl.textContent = `Loaded ${oosItems.length} OOS items`;
      } catch (err) {
        if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Failed to load: ${err}</td></tr>`;
        if (statusEl) statusEl.textContent = "Error loading OOS items";
      }
    }

    function downloadOosXls() {
      window.open("/api/oos-items/export", "_blank");
    }

    function renderOosTable() {
      const tbody = document.getElementById("oos-rows");
      if (!tbody) return;
      if (!oosItems.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">No OOS items</td></tr>';
        return;
      }
      tbody.innerHTML = oosItems.map(it => {
        const poNumber = Array.isArray(it.poNumbers) ? it.poNumbers.join(", ") : (it.poNumber || "");
        const poDate = fmtDate(it.purchaseOrderDate || "");
        const shipTo = it.shipToPartyId || "";
        const asin = it.asin || "";
        const sku = it.vendorSku || "";
        const qty = it.qty ?? "";
        const img = it.image
          ? `<img src="${it.image}" alt="" style="max-width:50px;max-height:50px;object-fit:contain;border-radius:6px;" />`
          : "";
        return `
          <tr>
            <td style="display:none;">${poNumber}</td>
            <td style="display:none;">${poDate}</td>
            <td style="display:none;">${shipTo}</td>
            <td>${asin}</td>
            <td>${img}</td>
            <td>${sku}</td>
            <td>${qty}</td>
            <td>
              <button class="btn" style="background:#16a34a"
                      onclick="restockOosItem('${poNumber}','${asin}')">
                Restocked
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    async function restockOosItem(poNumber, asin) {
      if (!asin) return;
      const statusEl = document.getElementById("oos-status");
      if (statusEl) statusEl.textContent = "Updating...";
      try {
        await fetch("/api/oos-items/restock", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ poNumber, asin }),
        });
        await loadOosItems();
        if (statusEl) statusEl.textContent = `Restocked ${asin}`;
      } catch (err) {
        if (statusEl) statusEl.textContent = `Failed to restock: ${err}`;
      }
    }

    function renderAsinList() {
      const tbody = document.getElementById("asin-rows");
      if (!filteredAsins.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">No ASINs found in Vendor POs</td></tr>';
        return;
      }
      tbody.innerHTML = filteredAsins.map(item => {
        const disabled = item.fetched ? "disabled" : "";
        const label = item.fetched ? "Fetched" : "Fetch";
        const img = item.image ? `<img src="${item.image}" alt="" style="max-width:50px;max-height:50px;object-fit:contain;border-radius:6px;" />` : "";
        const bc = item.barcode || "";
        const bcDisplay = bc || "—";
        return `<tr ondblclick="showCatalogDetails('${item.asin}')">
          <td>${item.asin}</td>
          <td>${item.sku || ""}</td>
          <td>
            <div style="display:flex; align-items:center; gap:6px;">
              <span id="bc-${item.asin}">${bcDisplay}</span>
              <button class="btn" style="padding:4px 8px; background:#0f172a;" onclick="editBarcode('${item.asin}', '${bc}')">Edit</button>
            </div>
          </td>
          <td>${item.title || ""}</td>
          <td>${img}</td>
          <td>${item.fetched ? "Saved" : "Not fetched"}</td>
          <td><button class="btn ${item.fetched ? "" : "btn-fetch"}" data-asin="${item.asin}" ${disabled} onclick="fetchCatalog(this.dataset.asin, this)">${label}</button></td>
        </tr>`;
      }).join("");
    }

    async function fetchCatalog(asin, btnEl) {
      if (btnEl) {
        btnEl.disabled = true;
        btnEl.textContent = "Fetching...";
      }
      try {
        const resp = await fetch(`/api/catalog/fetch/${asin}`, { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        // Mark as fetched
        asinList = asinList.map(item => item.asin === asin ? { ...item, fetched: true } : item);
        filteredAsins = asinList;
        renderAsinList();
      } catch (err) {
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.textContent = "Fetch";
        }
        alert(`Failed to fetch catalog for ${asin}: ${err}`);
      }
    }

    async function editBarcode(asin, current) {
      if (!asin) return;
      const val = prompt("Enter barcode (12-digit UPC or 13-digit EAN)", current || "");
      if (val === null) return;
      const trimmed = (val || "").trim();
      if (!trimmed) return;
      if (!/^\d{12,13}$/.test(trimmed)) {
        alert("Barcode must be 12 or 13 digits (numeric).");
        return;
      }
      try {
        const resp = await fetch("/api/catalog/update-barcode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ asin, barcode: trimmed }),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          const msg = data.detail || `HTTP ${resp.status}`;
          alert(msg);
          return;
        }
        const data = await resp.json();
        const bcSpan = document.getElementById(`bc-${asin}`);
        if (bcSpan) bcSpan.textContent = data.barcode || trimmed;
        showToast("Barcode updated");
      } catch (err) {
        alert(`Failed to update barcode: ${err}`);
      }
    }

    function scheduleInitialAutoSync() {
      if (!nextAutoSyncAt) {
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
      }
      updateSyncInfo();
    }

    function addManualAsin() {
      const input = document.getElementById("manual-asin-input");
      const msg = document.getElementById("manual-asin-msg");
      const asin = (input?.value || "").trim().toUpperCase();
      if (!asin) {
        if (msg) msg.textContent = "Please enter an ASIN.";
        return;
      }
      if (asinList.find(a => a.asin === asin)) {
        if (msg) msg.textContent = "ASIN already listed.";
        return;
      }
      const newEntry = { asin, fetched: false };
      asinList = [newEntry, ...asinList];
      filteredAsins = asinList;
      renderAsinList();
      if (input) input.value = "";
      if (msg) msg.textContent = "Added. Click Fetch to pull catalog data.";
    }

    async function autoSyncIfDue() {
      if (!nextAutoSyncAt) return;
      if (Date.now() < nextAutoSyncAt) return;
      try {
        const resp = await fetch("/api/vendor-pos/sync", { method: "POST" });
        let fetched = 0;
        if (resp.ok) {
          const data = await resp.json();
          fetched = data.fetched || 0;
        }
        await loadPOs(false);
        lastSyncTime = new Date();
        lastSyncFromSpapi = true;
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
        updateSyncInfo();
        const hh = String(lastSyncTime.getHours()).padStart(2, "0");
        const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
        showToast(`Sync completed at ${hh}:${mi}, ${fetched} POs updated.`);
      } catch (err) {
        console.error("Auto-sync failed", err);
      }
    }

    async function openPicklistPreview() {
      if (!selectedPoNumbers.length) return;
      try {
        const resp = await fetch("/api/picklist/preview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ purchaseOrderNumbers: selectedPoNumbers }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const summary = data.summary || {};
        const items = (data.items || []);
        items.sort((a, b) => (b.totalQty || 0) - (a.totalQty || 0));
        const modal = document.getElementById("picklist-modal");
        const body = document.getElementById("picklist-body");
        const summaryHtml = `
          <div style="margin-bottom:10px;">
            <div><strong>POs:</strong> ${selectedPoNumbers.length}</div>
            <div><strong>Lines:</strong> ${summary.totalLines || 0}</div>
            <div><strong>Total Units:</strong> ${summary.totalUnits || 0}</div>
            ${summary.warning ? `<div style="color:#b91c1c;">Warning: ${summary.warning}</div>` : ""}
          </div>
        `;
        const rows = items.map(it => {
          const isOos = it.isOutOfStock;
          const rowStyle = isOos ? 'style="opacity:0.6; background:#fff5f5;"' : '';
          const qtyStyle = isOos ? 'style="font-weight:700; text-align:center; color:#b91c1c; text-decoration:line-through;"' : 'style="font-weight:700; text-align:center;"';
          const asinStyle = isOos ? 'style="text-decoration:line-through; color:#666;"' : '';
          const img = it.image ? `<img src="${it.image}" alt="" style="max-width:80px;max-height:80px;object-fit:contain;border-radius:6px;${isOos ? 'opacity:0.5;' : ''}" />` : "";
          const sku = it.sku || it.externalId || "";
          const oosLabel = isOos ? ' <span style="color:#b91c1c; font-size:11px; font-weight:700;">[OOS]</span>' : '';
          return `<tr ${rowStyle}>
            <td ${asinStyle}>${it.asin || ""}${oosLabel}</td>
            <td>${sku}</td>
            <td>${img}</td>
            <td style="width:240px;">${it.title || ""}</td>
            <td ${qtyStyle}>${it.totalQty ?? ""}</td>
          </tr>`;
        }).join("");

        body.innerHTML = `
          ${summaryHtml}
          <div style="overflow:auto; max-height:60vh;">
            <table>
              <thead>
                <tr>
                  <th>ASIN</th>
                  <th>External ID</th>
                  <th style="width:120px;">Image</th>
                  <th style="width:240px;">Title</th>
                  <th>Total Qty</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="5" class="empty">No items</td></tr>'}
              </tbody>
            </table>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn" style="background:#111827" onclick="downloadPicklistPdf()">Download PDF</button>
            <button class="btn" onclick="closePicklistModal()">Close</button>
          </div>
        `;
        modal.style.display = "flex";
      } catch (err) {
        console.error("Failed to load picklist preview", err);
        alert(`Failed to load picklist preview: ${err}`);
      }
    }

    function closePicklistModal() {
      const modal = document.getElementById("picklist-modal");
      if (modal) modal.style.display = "none";
    }

    function downloadPicklistPdf() {
      if (!selectedPoNumbers.length) {
        alert("Please select at least one PO to generate a pick list.");
        return;
      }
      const poParam = encodeURIComponent(selectedPoNumbers.join(","));
      const url = `/api/picklist/pdf?poNumbers=${poParam}`;
      window.open(url, "_blank");
    }

    async function markItemOos(event, poNumber, asin, vendorSku, poDate, shipTo, qty, encodedImage) {
      event.preventDefault();
      if (!poNumber || !asin) return;
      const ok = confirm(`Mark this item as OUT OF STOCK?\nPO: ${poNumber}\nASIN: ${asin}`);
      if (!ok) return;
      const image = encodedImage ? decodeURIComponent(encodedImage) : null;
      try {
        await fetch("/api/oos-items/mark", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            poNumber,
            asin,
            vendorSku,
            purchaseOrderDate: poDate,
            shipToPartyId: shipTo,
            qty,
            image: image || null,
          }),
        });
        if (activeTab === "oos") {
          await loadOosItems();
        }
      } catch (err) {
        console.error("Failed to mark OOS", err);
        alert(`Failed to mark OOS: ${err}`);
      }
    }

    // ========================================
    // Vendor Real Time Sales functions
    // ========================================
    let currentRtSalesWindow = "last_24h";
    const RTS_SORT_STORAGE_KEY = "vendor_rt_sales_sort";
    const RTS_WINDOW_STORAGE_KEY = "rtSalesWindow";

    function formatNumberWithCommas(num) {
      return (Math.round(num * 100) / 100).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Vendor Real Time Sales sorting state
    let rtSalesData = [];
    let rtSalesSortState = {
      column: null,
      direction: "asc"  // "asc" or "desc"
    };

    // ========== FEATURE 1: Window Selection Storage ==========
    function saveRtSalesWindowSelection() {
      const windowSelect = document.getElementById("rt-sales-window");
      if (windowSelect) {
        try {
          localStorage.setItem(RTS_WINDOW_STORAGE_KEY, windowSelect.value);
        } catch (e) {
          console.warn("Failed to save RT sales window selection:", e);
        }
      }
    }

    function loadRtSalesWindowSelection() {
      const windowSelect = document.getElementById("rt-sales-window");
      if (windowSelect) {
        try {
          const saved = localStorage.getItem(RTS_WINDOW_STORAGE_KEY);
          if (saved) {
            windowSelect.value = saved;
          }
        } catch (e) {
          console.warn("Failed to load RT sales window selection:", e);
        }
      }
    }

    function onRtSalesWindowChange() {
      saveRtSalesWindowSelection();
      updateRtSalesWindowInfo();
      loadVendorRtSalesSummary();
    }

    // ========== FEATURE 2: Window Info Label ==========
    function updateRtSalesWindowInfo() {
      const windowSelect = document.getElementById("rt-sales-window");
      const infoEl = document.getElementById("rt-sales-window-info");
      if (!windowSelect || !infoEl) return;

      const window = windowSelect.value;
      const now = new Date();
      const uaeTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dubai' }));
      
      let startTime, endTime, label;

      if (window === "last_1h") {
        startTime = new Date(uaeTime.getTime() - 60 * 60 * 1000);
        endTime = uaeTime;
        label = "Last 1 hour";
      } else if (window === "last_3h") {
        startTime = new Date(uaeTime.getTime() - 3 * 60 * 60 * 1000);
        endTime = uaeTime;
        label = "Last 3 hours";
      } else if (window === "last_24h") {
        startTime = new Date(uaeTime.getTime() - 24 * 60 * 60 * 1000);
        endTime = uaeTime;
        label = "Last 24 hours";
      } else if (window === "today") {
        startTime = new Date(uaeTime);
        startTime.setHours(0, 0, 0, 0);
        endTime = uaeTime;
        label = "Today";
      } else if (window === "yesterday") {
        const yesterday = new Date(uaeTime);
        yesterday.setDate(yesterday.getDate() - 1);
        startTime = new Date(yesterday);
        startTime.setHours(0, 0, 0, 0);
        endTime = new Date(yesterday);
        endTime.setHours(23, 59, 59, 999);
        label = "Yesterday";
      } else if (window === "custom") {
        const startInput = document.getElementById("rt-sales-start").value;
        const endInput = document.getElementById("rt-sales-end").value;
        if (startInput && endInput) {
          startTime = new Date(startInput);
          endTime = new Date(endInput);
          label = "Custom range";
        } else {
          infoEl.textContent = "Window: Custom range (no dates selected)";
          return;
        }
      } else {
        infoEl.textContent = "";
        return;
      }

      const startStr = startTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
      const endStr = endTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
      infoEl.textContent = `Window: ${label} (${startStr} → ${endStr} UAE)`;
    }

    function saveRtSalesSortState() {
      try {
        localStorage.setItem(RTS_SORT_STORAGE_KEY, JSON.stringify(rtSalesSortState));
      } catch (e) {
        console.warn("Failed to save sort state to localStorage", e);
      }
    }

    function loadRtSalesSortState() {
      try {
        const stored = localStorage.getItem(RTS_SORT_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          rtSalesSortState.column = parsed.column || null;
          rtSalesSortState.direction = parsed.direction || "asc";
        }
      } catch (e) {
        console.warn("Failed to load sort state from localStorage", e);
      }
    }

    function updateRtSalesArrows() {
      document.getElementById("rt-sales-sort-asin").textContent = "";
      document.getElementById("rt-sales-sort-units").textContent = "";
      document.getElementById("rt-sales-sort-revenue").textContent = "";

      if (rtSalesSortState.column === "asin") {
        document.getElementById("rt-sales-sort-asin").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
      } else if (rtSalesSortState.column === "units") {
        document.getElementById("rt-sales-sort-units").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
      } else if (rtSalesSortState.column === "revenue") {
        document.getElementById("rt-sales-sort-revenue").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
      }
    }

    function onRtSalesHeaderClick(column) {
      // If clicking the same column, toggle direction
      if (rtSalesSortState.column === column) {
        rtSalesSortState.direction = rtSalesSortState.direction === "asc" ? "desc" : "asc";
      } else {
        // New column, set default direction based on column type
        rtSalesSortState.column = column;
        rtSalesSortState.direction = (column === "asin") ? "asc" : "desc";
      }

      // Save sort state
      saveRtSalesSortState();

      // Re-sort and render
      sortRtSalesTable(column);
    }

    function sortRtSalesTable(column) {
      if (!rtSalesData || rtSalesData.length === 0) {
        renderRtSalesTable(rtSalesData);
        return;
      }

      // Sort the data
      const sorted = [...rtSalesData].sort((a, b) => {
        let aVal, bVal;

        if (column === "asin") {
          aVal = a.asin.toLowerCase();
          bVal = b.asin.toLowerCase();
          // String comparison
          const cmp = aVal.localeCompare(bVal);
          return rtSalesSortState.direction === "asc" ? cmp : -cmp;
        } else if (column === "units") {
          aVal = parseFloat(a.units) || 0;
          bVal = parseFloat(b.units) || 0;
        } else if (column === "revenue") {
          aVal = parseFloat(a.revenue) || 0;
          bVal = parseFloat(b.revenue) || 0;
        }

        // Numeric comparison
        if (rtSalesSortState.direction === "asc") {
          return aVal - bVal;
        } else {
          return bVal - aVal;
        }
      });

      // Update sort indicators
      updateRtSalesArrows();

      // Re-render the sorted data
      renderRtSalesTable(sorted);
    }

    function renderRtSalesTable(data) {
      const tbody = document.getElementById("rt-sales-top-asins-rows");
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(asin_row => {
        const imageHtml = asin_row.imageUrl
          ? `<img src="${asin_row.imageUrl}" alt="${asin_row.asin}" style="max-width:40px; max-height:40px; object-fit:contain; border-radius:4px;" />`
          : '—';
        return `
          <tr style="cursor:pointer;" onclick="openRtSalesAsinDetail('${asin_row.asin}')">
            <td><strong>${asin_row.asin}</strong></td>
            <td style="text-align:center;">${imageHtml}</td>
            <td style="text-align:right;"><strong>${(asin_row.units || 0).toLocaleString()}</strong></td>
            <td style="text-align:right;"><strong>${asin_row.currency_code ? asin_row.currency_code + ' ' : ''}${formatNumberWithCommas(asin_row.revenue || 0)}</strong></td>
          </tr>
        `;
      }).join("");
    }

    async function refreshVendorRtSales() {
      const btn = document.querySelector("button[onclick='refreshVendorRtSales()']");
      const status = document.getElementById("rt-sales-status");
      if (btn) btn.disabled = true;
      if (status) status.textContent = "Refreshing...";

      try {
        const window = document.getElementById("rt-sales-window").value;
        const body = {
          window: window
        };

        if (window === "custom") {
          const start = document.getElementById("rt-sales-start").value;
          const end = document.getElementById("rt-sales-end").value;
          if (!start || !end) {
            if (status) status.textContent = "Please select start and end times for custom range";
            if (btn) btn.disabled = false;
            return;
          }
          body.start_utc = new Date(start).toISOString();
          body.end_utc = new Date(end).toISOString();
        }

        const resp = await fetch("/api/vendor-realtime-sales/refresh", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: `HTTP ${resp.status}` }));
          throw new Error(err.error || err.detail || `HTTP ${resp.status}`);
        }

        const result = await resp.json();
        if (status) {
          status.textContent = `✓ Ingested ${result.ingest_summary.rows} rows (${result.ingest_summary.asins} ASINs, ${result.ingest_summary.hours} hours)`;
        }

        // Reload summary
        await loadVendorRtSalesSummary();
      } catch (err) {
        if (status) status.textContent = `✗ Failed: ${err.message}`;
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function loadVendorRtSalesSummary() {
      try {
        const window = document.getElementById("rt-sales-window").value;
        currentRtSalesWindow = window;

        let params = `?window=${encodeURIComponent(window)}`;

        if (window === "custom") {
          const start = document.getElementById("rt-sales-start").value;
          const end = document.getElementById("rt-sales-end").value;
          if (!start || !end) {
            document.getElementById("rt-sales-top-asins-rows").innerHTML =
              '<tr><td colspan="4" class="empty">Please select start and end times for custom range</td></tr>';
            return;
          }
          params += `&start_utc=${encodeURIComponent(new Date(start).toISOString())}`;
          params += `&end_utc=${encodeURIComponent(new Date(end).toISOString())}`;
        }

        const resp = await fetch("/api/vendor-realtime-sales/summary" + params);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();

        // Update window info label
        updateRtSalesWindowInfo();

        // Update summary cards
        document.getElementById("rt-sales-total-units").textContent = (data.total_units || 0).toLocaleString();
        document.getElementById("rt-sales-total-revenue").textContent =
          `${data.currency_code} ${formatNumberWithCommas(data.total_revenue || 0)}`;

        // Store data for sorting
        if (!data.top_asins || data.top_asins.length === 0) {
          rtSalesData = [];
          document.getElementById("rt-sales-top-asins-rows").innerHTML = '<tr><td colspan="4" class="empty">No data available</td></tr>';
          // Still update arrows even if no data
          updateRtSalesArrows();
          return;
        }

        rtSalesData = data.top_asins;
        
        // Load saved sort state from localStorage
        loadRtSalesSortState();
        
        // Update arrows to show current state
        updateRtSalesArrows();

        // Apply saved sort if one exists
        if (rtSalesSortState.column) {
          sortRtSalesTable(rtSalesSortState.column);
        } else {
          // No saved sort, just render as-is
          renderRtSalesTable(rtSalesData);
        }
      } catch (err) {
        console.error("Failed to load RT sales summary:", err);
        document.getElementById("rt-sales-top-asins-rows").innerHTML =
          `<tr><td colspan="4" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    async function openRtSalesAsinDetail(asin) {
      try {
        let params = `?window=${encodeURIComponent(currentRtSalesWindow)}`;

        if (currentRtSalesWindow === "custom") {
          const start = document.getElementById("rt-sales-start").value;
          const end = document.getElementById("rt-sales-end").value;
          if (start && end) {
            params += `&start_utc=${encodeURIComponent(new Date(start).toISOString())}`;
            params += `&end_utc=${encodeURIComponent(new Date(end).toISOString())}`;
          }
        }

        const resp = await fetch(`/api/vendor-realtime-sales/asin/${encodeURIComponent(asin)}` + params);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();

        // Show detail panel
        document.getElementById("rt-sales-asin-detail-title").textContent = asin;
        const tbody = document.getElementById("rt-sales-asin-detail-rows");

        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty">No hourly data for this ASIN in selected window</td></tr>';
        } else {
          tbody.innerHTML = data.data.map(row => `
            <tr>
              <td>${row.hour_start_utc}</td>
              <td style="text-align:right;">${(row.ordered_units || 0).toLocaleString()}</td>
              <td style="text-align:right;">${formatNumberWithCommas(row.ordered_revenue || 0)}</td>
            </tr>
          `).join("");
        }

        document.getElementById("rt-sales-asin-detail").style.display = "block";
      } catch (err) {
        alert("Failed to load ASIN detail: " + err.message);
      }
    }

    function closeRtSalesAsinDetail() {
      document.getElementById("rt-sales-asin-detail").style.display = "none";
      document.getElementById("rt-sales-asin-detail-rows").innerHTML = '<tr><td colspan="3" class="empty">—</td></tr>';
    }

    // Window selector handler
    document.getElementById("rt-sales-window").addEventListener("change", async (e) => {
      const customInputs = [
        document.getElementById("rt-sales-start"),
        document.getElementById("rt-sales-end")
      ];
      const isCustom = e.target.value === "custom";
      customInputs.forEach(inp => inp.style.display = isCustom ? "block" : "none");
      
      if (!isCustom) {
        await loadVendorRtSalesSummary();
      }
    });

    document.getElementById("rt-sales-start").addEventListener("change", () => {
      if (document.getElementById("rt-sales-window").value === "custom") {
        loadVendorRtSalesSummary();
      }
    });

    document.getElementById("rt-sales-end").addEventListener("change", () => {
      if (document.getElementById("rt-sales-window").value === "custom") {
        loadVendorRtSalesSummary();
      }
    });

    document.getElementById("sync-btn").addEventListener("click", () => loadPOs(true));
    const rebuildBtn = document.getElementById("rebuild-btn");
    if (rebuildBtn) rebuildBtn.addEventListener("click", rebuildPOs);
    document.getElementById("po-search").addEventListener("input", filterPOs);
    document.getElementById("po-filter-fc").addEventListener("change", filterPOs);
    document.getElementById("po-filter-status").addEventListener("change", filterPOs);
    document.getElementById("po-start-days").addEventListener("change", filterPOs);
    loadPOs(false);
    showTab("pos");
    scheduleInitialAutoSync();
    setInterval(updateSyncInfo, 60 * 1000);
    setInterval(autoSyncIfDue, 5 * 60 * 1000);
  </script>
  <div class="backdrop" id="picklist-modal">
    <div class="modal" style="max-width:1000px;">
      <header>
        <div id="picklist-title">Pick List Preview</div>
        <button class="btn" style="background:#111827" onclick="closePicklistModal()">Close</button>
      </header>
      <div class="modal-body" id="picklist-body"></div>
    </div>
  </div>
  <div id="toast" style="
    position:fixed;
    right:16px;
    bottom:16px;
    background:#111827;
    color:#fff;
    padding:10px 14px;
    border-radius:8px;
    font-size:13px;
    box-shadow:0 10px 25px rgba(15,23,42,0.4);
    opacity:0;
    pointer-events:none;
    transition:opacity 0.25s ease;
    z-index:9999;
  "></div>
</body>
</html>
