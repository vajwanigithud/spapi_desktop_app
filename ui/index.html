<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SP-API Desktop App</title>
  <style>
    :root { --bg:#f8fafc; --panel:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --accent:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid var(--border); background:var(--panel); display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:5; }
    h1 { margin:0; font-size:18px; }
    .btn { border:none; background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .layout { padding:16px 20px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .panel h2 { margin:0; padding:14px 16px; border-bottom:1px solid var(--border); font-size:16px; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td { padding:8px 10px; border:1px solid var(--border); text-align:left; vertical-align: top; user-select: text; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    th, td { user-select: text; }
    tbody tr:hover { background:#f1f5f9; cursor:pointer; }
    .empty { padding:14px; color:var(--muted); text-align:center; }
    select.po-status-select { padding:8px 12px; border-radius:8px; font-size:15px; font-weight:700; min-width:170px; }
    input.po-date-input { padding:6px 10px; border-radius:8px; font-size:15px; font-weight:700; border:1px solid var(--border); }
    .rt-sales-sortable-header { cursor:pointer; user-select:none; transition: background-color 0.15s ease; }
    .rt-sales-sortable-header:hover { background-color:#f1f5f9; }
    .rt-sales-sort-arrow { display:inline-block; margin-left:4px; font-size:12px; transition:transform 0.2s ease, opacity 0.2s ease; }
    .rt-sales-window-info { font-size:12px; color:#666; margin-bottom:8px; }
    /* Row status colors */
    tr.po-status-preparing { background-color: #fef9c3; }
    tr.po-status-appointment { background-color: #e0f2fe; }
    tr.po-status-delivered { background-color: #dcfce7; }
    .po-status-chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      letter-spacing:0.03em;
      background:#e2e8f0;
      color:#0f172a;
    }
    .po-status-chip.po-status-open { background:#dcfce7; color:#166534; }
    .po-status-chip.po-status-closed { background:#dbeafe; color:#1d4ed8; }
    .po-status-chip.po-status-cancelled { background:#fee2e2; color:#b91c1c; }
    .po-money-footer {
      border-top:1px solid var(--border);
      margin-top:10px;
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:14px;
    }
    .po-money-row {
      display:flex;
      justify-content:space-between;
      font-weight:600;
    }
    .po-money-row span:last-child { font-variant-numeric: tabular-nums; }
    .po-money-delta-ok { color:#15803d; font-weight:700; }
    .po-money-delta-warn { color:#b91c1c; font-weight:700; }
    .modal header .modal-actions { display:flex; gap:8px; align-items:center; }
    #po-history-modal .modal { max-width:800px; }
    #po-history-body { padding:0; }
    .po-history-table { width:100%; border-collapse:collapse; }
    .po-history-table th, .po-history-table td { font-size:13px; }
    .po-history-table th { background:#f8fafc; position:sticky; top:0; }
    .po-history-note {
      padding:10px 12px;
      background:#f1f5f9;
      border-bottom:1px solid var(--border);
      font-size:13px;
      color:#0f172a;
    }
    /* Vendor PO tab: larger, clearer text without changing layout spacing */
    #pos-tab { font-size:14px; }
    #pos-tab table { font-size:14px; }
    #pos-tab th, #pos-tab td { font-size:14px; }
    #pos-tab input, #pos-tab select, #pos-tab button { font-size:14px; }
    /* Endpoint tester */
    #tester-tab { font-size:14px; }
    .tester-controls { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:10px; margin-bottom:10px; }
    .tester-log { background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:320px; overflow:auto; font-family: "SFMono-Regular", Consolas, monospace; font-size:13px; white-space:pre-wrap; }
    .tester-run-btn { background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    .tester-run-btn:disabled { background:#4b5563; cursor:not-allowed; }
    .tabs { display:flex; gap:8px; margin:6px 0 0; }
    .tab-btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600; }
    .tab-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .workers-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin-top:8px; }
    .worker-card { background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .worker-row { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; border-top:1px solid var(--border); padding-top:8px; margin-top:8px; }
    .worker-row:first-of-type { border-top:none; padding-top:0; margin-top:0; }
    .worker-title { font-weight:700; display:flex; align-items:center; gap:6px; }
    .worker-meta { font-size:12px; color:var(--muted); text-align:right; }
    .worker-what { font-size:12px; color:var(--muted); margin-top:2px; }
    .worker-details { font-size:12px; color:#b45309; margin-top:4px; }
<<<<<<< HEAD
    .worker-status-pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; margin-left:6px; }
    .worker-status-ok { background:#dcfce7; color:#166534; }
    .worker-status-waiting { background:#e5e7eb; color:#1d4ed8; }
    .worker-status-locked, .worker-status-cooldown { background:#e0f2fe; color:#0369a1; }
    .worker-status-overdue { background:#fef3c7; color:#b45309; }
    .worker-status-error { background:#fee2e2; color:#b91c1c; }
=======
    /* DF Payments */
    #df-payments-tab table { font-size:13px; }
    .dfp-controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:12px; }
    .dfp-controls select { padding:6px 10px; border-radius:8px; border:1px solid var(--border); }
    .dfp-status { font-size:12px; color:var(--muted); font-weight:600; }
    .dfp-dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; padding:0 12px 12px 12px; }
    .dfp-card { background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:10px; }
    .dfp-card-title { font-weight:700; font-size:14px; display:flex; align-items:center; gap:8px; }
    .dfp-badge-muted { font-size:12px; color:var(--muted); font-weight:600; }
    .dfp-mini-table { width:100%; border-collapse: collapse; }
    .dfp-mini-table th, .dfp-mini-table td { padding:6px 8px; border:1px solid var(--border); }
    .dfp-table-wrap { padding:12px; overflow:auto; }
    .dfp-sku { max-width:360px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:top; }
>>>>>>> origin/main
    /* modal */
    .backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:20; }
    .modal { background:#fff; width:90%; max-width:1100px; max-height:85vh; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
    .modal header { padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:12px 14px; overflow:auto; }
    .json-block { background:#f8fafc; border:1px solid var(--border); border-radius:8px; padding:10px; white-space:pre-wrap; word-break:break-word; font-family: monospace; font-size:12px; user-select:text; }
    .muted-text { color: #6b7280; }
    .printer-settings-field { margin-bottom: 12px; text-align:left; }
    .printer-settings-info {
      padding: 12px;
      border-radius: 10px;
      background: #ecfdf5;
      border: 1px solid #059669;
      color: #064e3b;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .printer-settings-info-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .printer-settings-field label { display:block; font-size:13px; font-weight:600; margin-bottom:4px; color:#111827; }
    .printer-settings-field select,
    .printer-settings-field input { width:100%; padding:6px 8px; border-radius:8px; border:1px solid #d1d5db; font-size:13px; background:#fff; }
    .printer-settings-warning { font-size:12px; color:#b91c1c; min-height:18px; margin-top:4px; }
    .printer-settings-status { font-size:12px; min-height:18px; }
  </style>
  <style>
      .btn-fetch {
        background: #dc2626;
        color: #fff;
      }
      .btn-fetch:disabled {
        background: #9ca3af;
        color: #fff;
        cursor: not-allowed;
      }
      .btn-outline-secondary {
        background: #fff;
        border: 1px solid var(--border);
        color: var(--text);
      }
    .btn-outline-secondary:hover {
      background: #f1f5f9;
    }
    .btn-sm {
      padding: 6px 10px;
      font-size: 13px;
    }
    .catalog-source-badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 4px;
      background: #e2e8f0;
      margin-right: 4px;
      margin-top: 4px;
    }
    .catalog-health-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .catalog-health-badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .catalog-health-badge.health-catalog {
      background: #dcfce7;
      color: #166534;
    }
    .catalog-health-badge.health-barcode {
      background: #e0f2fe;
      color: #075985;
    }
    .catalog-health-badge.health-operational {
      background: #fef9c3;
      color: #92400e;
    }
    .catalog-health-badge.health-dormant {
      background: #fee2e2;
      color: #b91c1c;
    }
    .catalog-bucket-badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 4px;
      background: #e5e7eb;
      color: #1f2937;
      margin-top: 4px;
    }
    #catalog-coverage-summary {
      padding: 0 12px 8px 12px;
      font-size: 13px;
      color: #111827;
      min-height: 18px;
    }
      #catalog-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      #catalog-table thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 2;
      }
      #catalog-table th,
      #catalog-table td {
        border: 1px solid var(--border);
        vertical-align: top;
        width: calc(100% / 6);
      }
      #catalog-table td:last-child {
        vertical-align: middle;
        text-align: center;
      }
      #catalog-barcode-filter {
        margin-left: 8px;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        height: 36px;
        background: #fff;
        font-size: 13px;
      }
      #catalog-context-menu {
        position: fixed;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.2);
        padding: 6px;
        z-index: 40;
        min-width: 210px;
        display: none;
      }
      #catalog-context-menu button {
        width: 100%;
        display: block;
        text-align: left;
        background: #fff;
        color: #0f172a;
        border: none;
        padding: 8px 10px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      #catalog-context-menu button:hover {
        background: #f1f5f9;
      }
      #catalog-context-menu button.danger {
        color: #b91c1c;
      }
      /* Conditional formatting for quantities */
      .qty-shortage { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
      .qty-pending { background-color: #fef3c7; color: #92400e; font-weight: 600; }
      .qty-good { background-color: #dcfce7; color: #166534; font-weight: 600; }
      .qty-neutral { color: #374151; }
      .shortage-icon::before { content: "‚ö†Ô∏è "; }
      .qty-detail-btn { background: #3b82f6; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
      .qty-detail-btn:hover { background: #2563eb; }
      /* PO items modal: rejected line highlighting */
      .po-line-rejected { background-color: #fee2e2; }
      /* PO items modal: received line highlighting */
      .po-line-received { background-color: #dcfce7; }
      /* PO items modal: summary row */
      .po-items-summary td { border-top: 2px solid #e5e7eb; background-color: #f9fafb; font-weight: 600; }
      /* Real-Time Sales status label */
      .rt-sales-status-label { font-size: 12px; margin-top: 4px; color: #666; }
      .rt-sales-status-busy { color: #d97706; font-weight: 500; }
      .rt-sales-status-cooldown { color: #b91c1c; font-weight: 500; }
      .rt-sales-status-idle { color: #059669; font-weight: 500; }
      .rt-sales-status-strip { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 13px; color: #475569; }
      .rt-sales-pill { padding: 4px 10px; border-radius: 999px; background: #e0f2fe; color: #0369a1; font-weight: 600; }
      .rt-sales-pill.alert { background: #fee2e2; color: #b91c1c; }
      .rt-sales-ledger-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 4px; }
      .rt-ledger-metric { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; }
      .rt-ledger-metric-title { font-size: 11px; text-transform: uppercase; color: #6b7280; margin-bottom: 4px; letter-spacing: 0.04em; }
      .rt-ledger-metric-value { font-size: 18px; font-weight: 700; color: #0f172a; }
      .rt-ledger-muted { font-size: 12px; color: #6b7280; font-weight: 500; }
      /* Vendor RT Summary layout */
      .rt-summary-layout { display: flex; gap: 16px; align-items: flex-start; padding: 12px; }
      .rt-summary-left { flex: 0 0 32%; max-width: 420px; display: flex; flex-direction: column; gap: 12px; }
      .rt-summary-right { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 12px; }
      .rt-summary-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); }
      .rt-summary-controls { display: flex; flex-direction: column; gap: 12px; }
      .rt-summary-controls-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
      .rt-summary-metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
      .rt-summary-table-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); display: flex; flex-direction: column; gap: 10px; }
      .rt-summary-table-head { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
      .rt-summary-table-wrapper { border: 1px solid var(--border); border-radius: 10px; overflow: auto; max-height: 60vh; position: relative; background: #fff; }
      .rt-summary-window-meta { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #475569; }
      .rt-summary-table-label { font-weight: 600; font-size: 14px; color: #0f172a; }
      .rt-summary-asin-image { width: 72px; height: 72px; object-fit: contain; border-radius: 10px; background: #f8fafc; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06); }
      #rt-sales-asin-table thead th,
      #rt-sales-time-table thead th { position: sticky; top: 0; background: #f8fafc; z-index: 2; }
      #rt-sales-asin-table th,
      #rt-sales-asin-table td,
      #rt-sales-time-table th,
      #rt-sales-time-table td { padding: 10px; }
      .rt-summary-detail-card { margin-top: 0; }
      @media (max-width: 1100px) {
        .rt-summary-layout { flex-direction: column; }
        .rt-summary-left,
        .rt-summary-right { max-width: none; width: 100%; }
        .rt-summary-table-wrapper { max-height: none; }
      }
      /* Out-of-Stock export status */
      .export-status-pending { font-weight: 600; color: #d97706; }
      .export-status-exported { opacity: 0.6; color: #6b7280; }
      .oos-row-exported { opacity: 0.7; }
      /* Sales Trends trend pills */
      .trend-pill { padding: 2px 6px; border-radius: 999px; font-size: 11px; text-transform: capitalize; text-align: center; display: inline-block; }
      .trend-rising, .trend-pill-rising { background-color: #e0f7e9; color: #1b7b33; }
      .trend-falling, .trend-pill-falling { background-color: #fde4e4; color: #b3261e; }
      .trend-flat, .trend-pill-flat { background-color: #eceff1; color: #455a64; }
      .trend-new, .trend-pill-new { background-color: #e3f2fd; color: #1565c0; }
      .trend-dead, .trend-pill-dead { background-color: #f3e5f5; color: #6a1b9a; }
      .trend-reviving, .trend-pill-reviving { background-color: #f3e5f5; color: #7b1fa2; }
      /* Sales Trends table and layout */
      .sales-trends-table { width: 100%; }
      .sales-trends-table tr { height: 100px; }
      .sales-trends-table th,
      .sales-trends-table td { padding: 12px 10px; vertical-align: middle; font-weight: 600; text-align: center; }
      .sales-trends-table th:first-child,
      .sales-trends-table td:first-child { text-align: center; }
      .sales-trends-table th:nth-child(2),
      .sales-trends-table td:nth-child(2) { text-align: center; font-weight: 700; }
      .sales-trends-img { width: 80px; height: 80px; object-fit: contain; border-radius: 6px; }
      .sales-trends-num-cell { font-size: 14px; font-weight: 700; text-align: center; }
      /* Trend pill styling */
      .sales-trend-cell { text-align: center; vertical-align: middle; }
      .sales-trend-pill { display: inline-flex; align-items: center; justify-content: center; padding: 6px 14px; border-radius: 999px; font-size: 1.2rem; font-weight: 700; min-width: 80px; text-align: center; }
      /* Battery styles for trailing week */
      .trend-battery { width: 80px; height: 14px; border-radius: 7px; border: 1px solid #ccc; overflow: hidden; background-color: #f5f5f5; margin: 0 auto 2px auto; }
      .trend-battery-fill { height: 100%; background: linear-gradient(to right, #4caf50, #81c784); transition: width 0.3s ease; }
      .trend-battery-label { font-size: 11px; text-align: center; font-weight: 600; }
      .trend-battery-badge { font-size: 11px; text-align: center; font-weight: 600; color: #1f2937; min-height: 16px; margin-top: 2px; }
      /* Week column sublabel */
      .sales-trends-week-sublabel { display: block; font-size: 0.75rem; font-weight: 700; color: #6b7280; margin-top: 2px; }
      /* Sales Trends controls */
      .sales-trends-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
      .sales-trends-controls label { display: flex; align-items: center; gap: 6px; font-size: 14px; }
      .sales-trends-controls input { padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; width: 120px; }
      .sales-trends-controls select { padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; }
      .sales-trends-window-info { font-size: 12px; color: #666; margin-bottom: 8px; }
      /* Inventory controls and subtabs */
      .inventory-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .inventory-controls .muted-text {
        margin-left: 8px;
        font-size: 0.9em;
        opacity: 0.8;
      }

      .inv-asof {
        text-decoration: underline dotted;
        cursor: help;
      }

      .inventory-mode-toggle {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      .inventory-mode-toggle .inventory-toggle-btn {
        border: 1px solid var(--border);
        background: #fff;
        color: #111827;
        padding: 6px 12px;
        border-radius: 999px;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .inventory-mode-toggle .inventory-toggle-btn.active {
        background: #111827;
        color: #fff;
        border-color: #111827;
      }
      .inventory-subtabs {
        margin: 8px 0 12px 0;
      }
      .inventory-subtab-button {
        margin-right: 6px;
        padding: 4px 8px;
        font-size: 0.9em;
        cursor: pointer;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .inventory-subtab-button.active {
        font-weight: bold;
        text-decoration: underline;
        background: #3498db;
        color: white;
      }
      /* Inventory row color coding */
      .inv-zero-sellable {
        background-color: #fff4e6 !important;
      }
      .inv-aged {
        background-color: #e8f0ff !important;
      }
      .inv-unhealthy {
        background-color: #ffeaea !important;
      }
      .inv-row-zero {
        /* placeholder for zero inventory rows */
      }
      .inv-row-aged {
        /* placeholder for aged rows */
      }
      .inv-row-unhealthy {
        /* placeholder for unhealthy rows */
      }
      .text-right {
        text-align: right;
      }
      /* Search and filter controls */
      .inv-search-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .inv-search-bar input {
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 13px;
        min-width: 200px;
      }
      .inv-quick-filters {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .inv-quick-filter-btn {
        padding: 4px 8px;
        font-size: 12px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
      }
      .inv-quick-filter-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }
      /* Sortable headers */
      #inv-table thead th {
        cursor: pointer;
        user-select: none;
      }
      #inv-table thead th:hover {
        background-color: #e8f1f8;
      }
      /* Image column */
      .inv-image-col {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
      }
      /* Title column - narrower with text wrap */
      .inv-title-col {
        max-width: 320px;
        white-space: normal;
        word-break: break-word;
      }
      /* Sticky footer */
      #inv-table tfoot {
        position: sticky;
        bottom: 0;
        background: #fafafa;
        font-weight: bold;
        border-top: 2px solid #ccc;
        z-index: 1;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .data-table thead th {
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 1;
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
      }
      .data-table tbody td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
      }
      .data-table tbody tr:hover {
        background: #f1f5f9;
      }
      .data-table tfoot tr {
        border-top: 2px solid #e5e7eb;
        background: #f9fafb;
        font-weight: 600;
      }
      .data-table tfoot td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
      }
      /* Inventory subtabs (old style - kept for backwards compat) */
      .subtab-bar {
        margin: 15px 0;
      }
      .subtab-btn {
        padding: 8px 14px;
        margin-right: 10px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
      }
      .subtab-btn.active {
        background: #3498db;
        color: white;
      }
      .inventory-subtab {
        margin-top: 20px;
      }
      .audit-calendar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .audit-calendar-day {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        background: #fff;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 6px;
        justify-content: flex-start;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .audit-calendar-day.full {
        border-color: #16a34a;
        background: #dcfce7;
      }
      .audit-calendar-day.partial {
        border-color: #f59e0b;
        background: #fef3c7;
      }
      .audit-calendar-day.missing {
        border-color: #dc2626;
        background: #fee2e2;
      }
      .audit-calendar-day.pending {
        border-color: #2563eb;
        background: #dbecff;
      }
      .audit-calendar-day.selected {
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4);
      }
      .audit-hour-status-ok {
        color: #059669;
        font-weight: 600;
      }
      .audit-hour-status-empty {
        color: #6b7280;
        font-weight: 600;
      }
      .audit-hour-status-missing {
        color: #b91c1c;
        font-weight: 600;
      }
      .audit-hour-status-pending {
        color: #2563eb;
        font-weight: 600;
      }
  </style>
</head>
<body>
  <header>
    <h1>Amazon SP-API Desktop</h1>
    <div style="display:flex; align-items:center; gap:10px;">
      <div id="sync-info" style="font-size:12px; color:#6b7280; display:flex; flex-direction:column; margin-right:12px;">
        <span id="sync-last">Last Sync: -</span>
        <span id="sync-next">Next Auto-Sync: -</span>
      </div>
      <div id="vendor-po-status" style="font-size:12px; color:#6b7280; margin-right:12px;">
        <span id="vendor-po-status-label">PO Sync: Loading...</span>
      </div>
      <button class="btn btn-outline-secondary" id="workers-status-btn" type="button" style="height:36px;">
        üõ† Workers: OK
      </button>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="sync-btn">Sync Vendor POs</button>
        <button class="btn" id="rebuild-btn" style="background:#111827;">Full Rebuild POs</button>
        <button class="btn" id="printer-settings-btn" style="background:#047857;">Printer Settings</button>
      </div>
    </div>
  </header>

  <div class="layout" style="padding-bottom:0;">
      <div class="tabs">
        <button class="tab-btn active" data-tab="pos" onclick="showTab('pos')">Vendor POs</button>
        <button class="tab-btn" data-tab="catalog" onclick="showTab('catalog')">Catalog Fetcher</button>
        <button class="tab-btn" data-tab="oos" onclick="showTab('oos')">Out-of-Stock Items</button>
        <button id="tab-btn-vrt-summary" class="tab-btn" data-tab="vrt-summary" onclick="showTab('vrt-summary')">Vendor Real Time Summary</button>
        <button id="tab-btn-vrt-trends" class="tab-btn" data-tab="vrt-trends" onclick="showTab('vrt-trends')">Vendor Real Time Trends</button>
        <button id="tab-btn-vrt-audit" class="tab-btn" data-tab="vrt-audit" onclick="showTab('vrt-audit')">Vendor Real Time Audit</button>
        <button class="tab-btn" data-tab="inventory" onclick="showTab('inventory')">Inventory</button>
        <button class="tab-btn" data-tab="df-payments" onclick="showTab('df-payments')">DF Payments</button>
        <!-- <button class="tab-btn" data-tab="tester" onclick="showTab('tester')">Endpoint Tester</button> -->
        <!-- <button class="tab-btn" data-tab="notifications" onclick="showTab('notifications')">Notifications</button> -->
      </div>
  </div>

  <div class="layout">
    <div class="panel" id="pos-tab">
      <h2>Vendor POs (raw Amazon fields)</h2>
      <div style="padding:10px 12px; display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="po-search" type="text" placeholder="Search PO / SKU / F/C / Status" style="flex:1; min-width:240px; padding:8px 10px; border-radius:8px; border:1px solid var(--border);" />
          <select id="po-start-days" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="60" selected>60 Days</option>
            <option value="30">30 Days</option>
            <option value="15">15 Days</option>
          </select>
          <select id="po-filter-fc" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="">All F/C</option>
          </select>
          <select id="po-filter-status" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Preparing">Preparing</option>
            <option value="Appointment Scheduled">Appointment Scheduled</option>
          </select>
          <button class="btn" id="picklist-btn" onclick="openPicklistPreview()" disabled style="background:#16a34a;">Export Pick List (PDF)</button>
        </div>
        <div id="inhouse-summary" style="font-size:12px; color:var(--muted); font-weight:600;"></div>
      </div>
      <div style="overflow:auto; max-height: calc(100vh - 200px);">
          <table>
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="po-select-all" onchange="toggleSelectAllPos(this)" /></th>
                <th>PO</th>
                <th style="text-align:center;">PO Items</th>
                <th>Order Date</th>
                <th style="text-align:center;">Requested Qty</th>
                <th style="text-align:center;">Accepted Qty</th>
                <th style="text-align:center;">Received Qty</th>
                <th style="text-align:center;">Remaining Qty</th>
                <th style="text-align:center;">Cancelled Qty</th>
                <th style="text-align:right;">Total Accepted Cost</th>
                <th>Status</th>
                <th>Status Date</th>
                <th>Amazon Status</th>
                <th>Ship To Location</th>
              </tr>
            </thead>
            <tbody id="po-rows"></tbody>
          </table>
        </div>
      </div>
    <div class="panel" id="catalog-tab" style="display:none; margin-top:14px;">
      <h2>ASIN Catalog Fetcher</h2>
      <div style="margin:10px 0; display:flex; gap:8px; align-items:center;">
        <input id="manual-asin-input" type="text" placeholder="Enter ASIN (e.g., B00XXXXXXX)" style="padding:8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px;" />
        <button class="btn" style="background:#111827" onclick="addManualAsin()">Add ASIN</button>
        <span id="manual-asin-msg" style="font-size:13px;color:#6b7280;"></span>
      </div>
      <div style="padding:12px; display:flex; gap:10px; align-items:center;">
        <button class="btn" onclick="loadAsinList(true)">Refresh</button>
        <button class="btn" style="background:#16a34a" onclick="fetchAllMissing()">Fetch All Missing</button>
        <input id="asin-search" type="text" placeholder="Search ASIN / SKU / Title" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--border);" oninput="filterAsins()" />
        <select id="catalog-barcode-filter" style="margin-left:8px;" onchange="filterAsins()">
          <option value="all">All</option>
          <option value="missing">Missing barcode</option>
          <option value="has">Has barcode</option>
        </select>
        <select id="catalog-bucket-filter" style="margin-left:8px;" onchange="filterAsins()">
          <option value="all">All Buckets</option>
          <option value="Terminal (Not Found/Invalid)">Terminal (Not Found/Invalid)</option>
          <option value="Ready (Commercial + Active)">Ready (Commercial + Active)</option>
          <option value="Ready (Commercial, No Activity)">Ready (Commercial, No Activity)</option>
          <option value="Needs Barcode">Needs Barcode</option>
          <option value="Needs Catalog (Active)">Needs Catalog (Active)</option>
          <option value="Blocked (Retries Exhausted)">Blocked (Retries Exhausted)</option>
          <option value="Needs Catalog (Inactive)">Needs Catalog (Inactive)</option>
        </select>
        <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#111827;">
          <input type="checkbox" id="catalog-actionable-only" onchange="toggleActionableOnly(this.checked)" />
          Actionable only
        </label>
        <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#111827;">
          Sort
          <select id="catalog-sort-mode" onchange="setCatalogSortMode(this.value)">
            <option value="bucket">Bucket (rank)</option>
            <option value="attempts">Attempts (desc)</option>
            <option value="operational">Operational first</option>
            <option value="barcode">Missing barcode first</option>
            <option value="catalog">Missing catalog first</option>
            <option value="asin">ASIN (A‚ÜíZ)</option>
          </select>
        </label>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportCatalogCsv()">Export CSV</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="resetAllCatalogFetchAttempts()">Reset All Fetch Attempts</button>
      </div>
      <div id="catalog-reset-status" style="padding:0 12px 8px 12px; font-size:12px; color:#6b7280; min-height:16px;"></div>
      <div id="catalog-coverage-summary" class="muted-text">Catalog: loading‚Ä¶</div>
      <div style="padding:0 12px 12px 12px;">
        <div style="overflow:auto; max-height: calc(100vh - 240px);">
          <table id="catalog-table">
            <thead>
              <tr>
                <th>ASIN</th>
                <th>SKU</th>
                <th>Barcode</th>
                <th>Title</th>
                <th>Image</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="asin-rows">
              <tr><td colspan="6" class="empty">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="panel" id="oos-tab" style="display:none; margin-top:14px;">
      <h2>Out-of-Stock Items</h2>
      <div style="padding:12px;">
        <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <button class="btn" onclick="loadOosItems()">Reload</button>
          <button class="btn" style="background:#111827;" onclick="downloadOosXls()">Export OOS (XLS)</button>
          <span id="oos-status" style="font-size:12px; color:var(--muted); margin-left:8px;"></span>
        </div>
        <div style="overflow:auto; max-height: calc(100vh - 260px);">
          <table>
            <thead>
            <tr>
              <th style="display:none;">PO Number</th>
              <th style="display:none;">PO Date</th>
              <th style="display:none;">Ship To</th>
              <th>ASIN</th>
              <th>Image</th>
              <th>Vendor SKU</th>
              <th>Qty</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="oos-rows">
              <tr><td colspan="8" class="empty">No OOS items</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
    <div class="panel" id="df-payments-tab" style="display:none; margin-top:14px;">
      <h2>DF Payments</h2>
      <div class="dfp-controls">
        <label style="display:flex; align-items:center; gap:6px; font-weight:600;">
          Lookback
          <select id="dfp-lookback">
            <option value="90" selected>90 days</option>
            <option value="60">60 days</option>
            <option value="30">30 days</option>
            <option value="7">7 days</option>
          </select>
        </label>
        <button class="btn" id="dfp-fetch-btn" type="button">Fetch Orders</button>
        <button class="btn btn-outline-secondary" id="dfp-incremental-btn" type="button">Incremental Scan</button>
        <button class="btn" id="dfp-reconcile-btn" type="button" style="background:#0f766e;">Reconcile Paid (Gmail)</button>
        <div id="dfp-status" class="dfp-status">Last fetch: ‚Äî UAE | Rows (90d): ‚Äî | Error: ‚Äî</div>
        <div id="dfp-range" class="dfp-status">Loaded: ‚Äî orders | Range: ‚Äî ‚Üí ‚Äî (UTC)</div>
        <div id="dfp-auto-status" class="dfp-status">Auto incremental: waiting‚Ä¶</div>
      </div>

      <div class="dfp-dashboard">
        <div class="dfp-card">
          <div class="dfp-card-title">Invoices (last 2 months)</div>
          <table class="dfp-mini-table">
            <thead>
              <tr><th>Month</th><th>Total Sales (incl VAT)</th></tr>
            </thead>
            <tbody id="dfp-invoices-body">
              <tr><td colspan="2" class="empty">No invoices yet</td></tr>
            </tbody>
          </table>
        </div>
        <div class="dfp-card">
          <div class="dfp-card-title">Cash Flow Projection (expected payments, 30d terms)</div>
          <table class="dfp-mini-table">
            <thead>
              <tr><th>Month</th><th>Expected payment</th></tr>
            </thead>
            <tbody id="dfp-cashflow-body">
              <tr><td colspan="2" class="empty">Projection unavailable</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="dfp-table-wrap">
        <table id="dfp-orders-table">
          <thead>
            <tr>
              <th>PO</th>
              <th>Order Date</th>
              <th>Status</th>
              <th style="text-align:right;">Units</th>
              <th style="text-align:right;">Subtotal</th>
              <th style="text-align:right;">VAT</th>
              <th>Currency</th>
              <th>Payment Status</th>
              <th>Payment Date</th>
              <th>Remittance IDs</th>
              <th>SKU List</th>
            </tr>
          </thead>
          <tbody id="dfp-orders-body">
            <tr><td colspan="11" class="empty">No DF orders yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <!--
    <div class="panel" id="tester-tab" style="display:none; margin-top:14px;">
      <h2>SP-API Endpoint Tester</h2>
      <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
        <div class="tester-controls">
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Preset Endpoint</label>
            <select id="tester-preset" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" onchange="applyTesterPreset()">
              <option value="">-- Select preset --</option>
            </select>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Method</label>
            <select id="tester-method" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
            </select>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Full GET Path (optional)</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="tester-fullpath" type="text" placeholder="/catalog/2022-04-01/items/{asin}?marketplaceIds=A2VIGQ35RCS4UG" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
              <button class="tester-run-btn" style="padding:10px 10px;" onclick="applyTesterFullPath()">Use</button>
            </div>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Endpoint Path (GET)</label>
            <input id="tester-endpoint" type="text" placeholder="/vendor/orders/v1/purchaseOrders" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Query string (key=value&key2=val)</label>
            <input id="tester-query" type="text" placeholder="marketplaceIds=A1F83G8C2ARO7P&limit=10" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="font-weight:700; display:block; margin-bottom:4px;">Request Body (JSON for POST)</label>
            <textarea id="tester-body" placeholder='{"example":"value"}' style="width:100%; min-height:140px; padding:10px; border-radius:8px; border:1px solid var(--border); font-family: monospace; font-size:13px;"></textarea>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="tester-run-btn" onclick="runTesterCall()">Run</button>
          <span id="tester-host" style="font-size:13px; color:#475569;"></span>
          <span id="tester-status" style="font-size:13px; color:#475569;"></span>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Amazon Response Log</div>
          <button class="tester-run-btn" style="margin-bottom:6px; padding:8px 12px;" onclick="copyTesterLog()">Copy Log</button>
          <pre id="tester-log" class="tester-log">No calls yet.</pre>
        </div>
      </div>
    </div>
  <!--
  <div class="panel" id="notifications-tab" style="display:none; margin-top:14px;">
    <h2>Notifications</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" onclick="loadNotifications()">Reload Notifications</button>
        <span id="notifications-status" style="font-size:12px; color:#6b7280;"></span>
      </div>
      <div style="overflow:auto; max-height:60vh;">
        <table>
          <thead>
            <tr>
              <th>TS</th>
              <th>Type</th>
              <th>PO</th>
              <th>Summary</th>
            </tr>
          </thead>
          <tbody id="notifications-rows">
            <tr><td colspan="4" class="empty">No notifications</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  -->


    <div class="panel" id="tab-vrt-summary" style="display:none; margin-top:14px;">
      <h2>Vendor Real Time Summary</h2>
      <div class="rt-summary-layout">
        <div class="rt-summary-left">
          <div class="rt-summary-card rt-summary-controls">
            <div class="rt-summary-controls-row">
              <label style="font-size:14px; font-weight:600;">Lookback:</label>
              <select id="rt-sales-lookback" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px;" onchange="onRtSalesLookbackChange()">
                <option value="2">Trailing 2 hours</option>
                <option value="4">Trailing 4 hours</option>
                <option value="8">Trailing 8 hours</option>
                <option value="12">Trailing 12 hours</option>
                <option value="24">Trailing 24 hours</option>
                <option value="48">Trailing 48 hours</option>
              </select>

              <label style="font-size:14px; font-weight:600;">View By:</label>
              <select id="rt-sales-view-by" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px;" onchange="onRtSalesViewByChange()">
                <option value="asin" selected>ASIN</option>
                <option value="time">Time</option>
              </select>

              <button id="rt-sales-refresh-btn" class="btn" onclick="refreshVendorRtSales()">Refresh Now</button>
            </div>
            <div class="rt-sales-status-strip">
              <div id="rt-sales-sync-status" class="rt-sales-status-label"></div>
              <div id="rt-sales-cooldown-pill" class="rt-sales-pill">Loading...</div>
            </div>
          </div>

          <div class="rt-summary-card">
            <div id="rt-sales-summary" class="rt-summary-metrics-grid">
              <div style="background:#f0f9ff; border:1px solid #0284c7; border-radius:8px; padding:12px;">
                <div style="font-size:12px; color:#0c4a6e; font-weight:600;">Total Units</div>
                <div id="rt-sales-total-units" style="font-size:24px; font-weight:700; color:#0369a1;">-</div>
              </div>
              <div style="background:#f0fdf4; border:1px solid #16a34a; border-radius:8px; padding:12px;">
                <div style="font-size:12px; color:#166534; font-weight:600;">Total Revenue</div>
                <div id="rt-sales-total-revenue" style="font-size:24px; font-weight:700; color:#15803d;">-</div>
              </div>
            </div>
          </div>

          <div class="rt-summary-card">
            <div style="font-weight:600; margin-bottom:6px;">Ledger</div>
            <div id="rt-sales-ledger-dashboard" class="rt-sales-ledger-dashboard">
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Missing</div>
                <div id="rt-ledger-missing" class="rt-ledger-metric-value">-</div>
              </div>
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Requested</div>
                <div id="rt-ledger-requested" class="rt-ledger-metric-value">-</div>
              </div>
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Downloaded</div>
                <div id="rt-ledger-downloaded" class="rt-ledger-metric-value">-</div>
              </div>
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Applied</div>
                <div id="rt-ledger-applied" class="rt-ledger-metric-value">-</div>
              </div>
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Failed</div>
                <div id="rt-ledger-failed" class="rt-ledger-metric-value">-</div>
              </div>
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Last Applied Hour</div>
                <div id="rt-ledger-last-applied" class="rt-ledger-metric-value rt-ledger-muted">-</div>
              </div>
              <div class="rt-ledger-metric">
                <div class="rt-ledger-metric-title">Next Claimable Hour</div>
                <div id="rt-ledger-next-claimable" class="rt-ledger-metric-value rt-ledger-muted">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="rt-summary-right">
          <div class="rt-summary-table-card">
            <div class="rt-summary-table-head">
              <div class="rt-summary-table-label" id="rt-sales-table-title">Top ASINs</div>
            </div>
            <div class="rt-summary-window-meta">
              <div id="rt-sales-window-info" class="rt-sales-window-info"></div>
              <div id="rt-sales-coverage-info" class="rt-sales-window-info" style="display:none;"></div>
            </div>
            <div class="rt-summary-table-wrapper">
              <table id="rt-sales-asin-table" style="table-layout:fixed; width:100%; display:none;">
                <thead>
                  <tr>
                    <th style="width:26%; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('asin')">ASIN <span id="rt-sales-sort-asin" class="rt-sales-sort-arrow"></span></th>
                    <th style="width:22%; text-align:center; word-break:break-word;">Image</th>
                    <th style="width:26%; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('units')">Units <span id="rt-sales-sort-units" class="rt-sales-sort-arrow"></span></th>
                    <th style="width:26%; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('revenue')">Revenue <span id="rt-sales-sort-revenue" class="rt-sales-sort-arrow"></span></th>
                  </tr>
                </thead>
                <tbody id="rt-sales-top-asins-rows">
                <tr><td colspan="4" class="empty">No data yet; use the Audit tab to request missing hours.</td></tr>
                </tbody>
              </table>
              <table id="rt-sales-time-table" style="table-layout:fixed; width:100%; display:none;">
                <thead>
                  <tr>
                    <th style="width:48%; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('bucket_time')">Time Bucket (UAE) <span id="rt-sales-sort-bucket-time" class="rt-sales-sort-arrow"></span></th>
                    <th style="width:26%; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('units')">Units <span id="rt-sales-sort-time-units" class="rt-sales-sort-arrow"></span></th>
                    <th style="width:26%; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('revenue')">Revenue <span id="rt-sales-sort-time-revenue" class="rt-sales-sort-arrow"></span></th>
                  </tr>
                </thead>
                <tbody id="rt-sales-time-rows">
                  <tr><td colspan="3" class="empty">No data available</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="rt-sales-asin-detail" class="rt-summary-card rt-summary-detail-card" style="display:none;">
            <div style="font-weight:600; margin-bottom:8px;">ASIN Hourly Detail: <span id="rt-sales-asin-detail-title">-</span></div>
            <div style="overflow:auto; max-height:35vh; border:1px solid var(--border); border-radius:8px;">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:160px;">Hour (UTC)</th>
                    <th style="text-align:right; width:80px;">Units</th>
                    <th style="text-align:right; width:100px;">Revenue</th>
                  </tr>
                </thead>
                <tbody id="rt-sales-asin-detail-rows">
                  <tr><td colspan="3" class="empty">-</td></tr>
                </tbody>
              </table>
            </div>
            <button class="btn" style="margin-top:8px; background:#111827;" onclick="closeRtSalesAsinDetail()">Close Detail</button>
          </div>
        </div>
      </div>
    </div>
    <div class="panel" id="tab-vrt-trends" style="display:none; margin-top:14px;">
      <h2>Vendor Real Time Trends (Last 4 Weeks)</h2>
      <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
        <div class="sales-trends-controls">
          <label>
            Min Total Units (4w):
            <input type="number" id="sales-trends-min-units" value="1" min="1" />
          </label>
          <label style="margin-left:12px;">Filter:
            <select id="sales-trends-filter">
              <option value="all">All</option>
              <option value="rising">Rising</option>
              <option value="falling">Falling</option>
              <option value="new">New</option>
              <option value="dead">Dead</option>
              <option value="flat">Flat</option>
            </select>
          </label>
          <button id="sales-trends-refresh-btn" class="btn" style="margin-left:12px;">Refresh</button>
        </div>
        <div id="sales-trends-window-info" class="sales-trends-window-info"></div>
        <div style="overflow:auto; max-height:60vh; border:1px solid var(--border); border-radius:8px;">
          <table id="sales-trends-table" style="width:100%;">
            <thead>
              <tr>
                <th style="width:90px; text-align:center;">Image</th>
                <th style="width:100px; text-align:center;">ASIN</th>
                <th id="st-th-w4" style="width:70px; text-align:center;">W4 Units</th>
                <th id="st-th-w3" style="width:70px; text-align:center;">W3 Units</th>
                <th id="st-th-w2" style="width:70px; text-align:center;">W2 Units</th>
                <th id="st-th-w1" style="width:70px; text-align:center;">W1 Units</th>
                <th id="st-th-trailing" style="width:100px; text-align:center;">This Week</th>
                <th style="width:80px; text-align:center;">Total 4W</th>
                <th style="width:80px; text-align:center;">√´ (W1-W2)</th>
                <th style="width:70px; text-align:center;">% Chg</th>
                <th style="width:80px; text-align:center;">Trend</th>
              </tr>
            </thead>
            <tbody id="sales-trends-rows">
              <tr><td colspan="11" class="empty">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="panel" id="tab-vrt-audit" style="display:none; margin-top:14px;">
      <h2>Vendor Real Time Audit</h2>
      <div style="padding:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div style="font-size:14px; font-weight:600;">Last 30 days</div>
        <button id="audit-refresh-btn" class="btn btn-outline-secondary" onclick="refreshAuditCalendar()">Refresh Audit (DB Only)</button>
        <button id="audit-repair-30d-btn" class="btn btn-outline-secondary" onclick="runAuditRepair30d()">Audit & Repair (Last 30 days)</button>
        <span id="audit-refresh-status" style="font-size:13px; color:#475569;"></span>
        <span id="audit-repair-status" style="font-size:13px; color:#475569;"></span>
      </div>
      <div id="audit-calendar-grid" class="audit-calendar-grid"></div>
      <div id="audit-calendar-meta" style="font-size:13px; color:#6b7280; margin-top:8px;"></div>
      <div id="audit-day-detail" style="margin-top:16px; display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div id="audit-day-title" style="font-weight:600;">Select a date to view hourly coverage</div>
          <button id="audit-fill-day-btn" class="btn btn-outline-secondary btn-sm" onclick="fillAuditDay()" disabled>Fill Day / Backfill</button>
          <span id="audit-fill-status" style="font-size:13px; color:#059669;"></span>
        </div>
        <div id="audit-day-summary" style="font-size:13px; color:#475569;"></div>
        <div style="overflow:auto; max-height:40vh; border:1px solid var(--border); border-radius:8px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="width:16%; text-align:left; padding:8px; border-bottom:1px solid var(--border);">Hour (UAE)</th>
                <th style="width:14%; text-align:left; padding:8px; border-bottom:1px solid var(--border);">Status</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Details</th>
              </tr>
            </thead>
            <tbody id="audit-day-hours-body">
              <tr><td colspan="3" class="empty">Select a date to load hourly coverage.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <div class="panel" id="inventory-tab" style="display:none; margin-top:14px;">
    <h2>Real-Time Inventory</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div class="inventory-mode-toggle">
<<<<<<< HEAD
        <div style="display:flex; flex-direction:column; gap:4px;">
          <span id="inv-week-label" class="muted-text"></span>
          <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
            <div id="inv-coverage-label" class="muted-text" style="font-size:12px; line-height:1.3;"></div>
            <a id="inv-coverage-why" href="#" style="font-size:12px; color:#2563eb; text-decoration:none; display:none;" onclick="openInventoryCoverageModal(); return false;">‚ìò Why coverage is low?</a>
          </div>
          <div id="inv-asof-helper" class="muted-text" style="font-size:12px; line-height:1.3;">
            Shows ASINs included in Amazon's Real-Time Inventory report window. This report is partial by design and may not include all catalog ASINs.
=======
          <div style="display:flex; flex-direction:column; gap:4px;">
            <span id="inv-week-label" class="muted-text">Accumulated Inventory | Loaded 0 ASINs</span>
            <div id="inv-asof-helper" class="muted-text" style="font-size:12px; line-height:1.3;">
              Accumulator model: ASINs never auto-delete; counts only grow.
            </div>
>>>>>>> origin/main
          </div>
        </div>

        <!-- Controls row -->
        <div class="inventory-controls">
          <button id="inv-refresh-btn" class="btn" onclick="refreshCurrentInventorySnapshot()">Refresh Inventory</button>
          <span id="inv-status-label" class="muted-text"></span>
        </div>

      <!-- Inner subtabs -->
      <div class="inventory-subtabs" style="display:none;">
        <button id="inv-subtab-snapshot" class="inventory-subtab-button active" onclick="setInventorySubtab('snapshot')">All ASINs</button>
      </div>

      <!-- Search and Quick Filters -->
      <div class="inv-search-bar">
        <input type="text" id="inv-search" placeholder="Search ASIN or title‚Ä¶" oninput="renderVendorInventoryCurrentSubtab()" />
        <div class="inv-quick-filters">
          <button id="inv-qf-all" class="inv-quick-filter-btn active" onclick="setQuickFilter('all')">All</button>
          <button id="inv-qf-zero" class="inv-quick-filter-btn" onclick="setQuickFilter('zero')">Zero Stock</button>
          <button id="inv-qf-aged" class="inv-quick-filter-btn" style="display:none;" onclick="setQuickFilter('aged')">Legacy 90 Days</button>
          <button id="inv-qf-unhealthy" class="inv-quick-filter-btn" style="display:none;" onclick="setQuickFilter('unhealthy')">Legacy Excess</button>
        </div>
      </div>

      <!-- Table -->
      <div id="inv-table-wrapper" style="overflow:auto; max-height: calc(100vh - 300px);">
        <table id="inv-table" class="data-table">
          <thead id="inv-table-head"></thead>
          <tbody id="inv-table-body"></tbody>
          <tfoot id="inv-table-foot"></tfoot>
        </table>
      </div>
    </div>
  </div>
  </div>

  <div class="backdrop" id="modal">
    <div class="modal">
      <header>
        <div id="modal-title">PO Items</div>
        <div class="modal-actions">
          <button class="btn btn-outline-secondary" id="modal-history-btn" style="display:none; background:#fff; color:#111827; border:1px solid var(--border);" onclick="openModalHistory()">View History</button>
          <button class="btn" style="background:#111827" onclick="closeModal()">Close</button>
        </div>
      </header>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Catalog detail modal -->
  <div class="backdrop" id="catalog-modal">
    <div class="modal" style="max-width:1000px;">
      <header>
        <div id="catalog-modal-title">Catalog Details</div>
        <button class="btn" style="background:#111827" onclick="closeCatalogModal()">Close</button>
      </header>
      <div class="modal-body" id="catalog-modal-body" style="font-family: monospace; white-space: pre-wrap; word-break: break-word; font-size:12px;"></div>
    </div>
  </div>

  <!-- PO Line Details Modal (NEW) -->
  <div class="backdrop" id="po-lines-modal">
    <div class="modal" style="max-width:1200px;">
      <header>
        <div id="po-lines-modal-title">PO Line Items - Inventory Breakdown</div>
        <button class="btn" style="background:#111827" onclick="closePoLinesModal()">Close</button>
      </header>
      <div class="modal-body" id="po-lines-modal-body" style="padding:0;"></div>
    </div>
  </div>

  <!-- PO Ledger Modal -->
  <div class="backdrop" id="po-history-modal">
    <div class="modal" style="max-width:900px;">
      <header>
        <div id="po-history-title">PO History</div>
        <button class="btn" style="background:#111827" onclick="closePoHistory()">Close</button>
      </header>
      <div class="modal-body" id="po-history-body" style="padding:0;"></div>
    </div>
  </div>

<<<<<<< HEAD
  <!-- Inventory coverage explainer modal -->
  <div class="backdrop" id="inventory-coverage-modal" style="display:none;">
    <div class="modal" style="max-width:720px;">
      <header>
        <div id="inventory-coverage-title">Why real-time coverage can look low</div>
        <button class="btn" style="background:#111827" onclick="closeInventoryCoverageModal()">Close</button>
      </header>
      <div class="modal-body" id="inventory-coverage-body"></div>
    </div>
  </div>
=======
>>>>>>> origin/main

  <div id="catalog-context-menu">
    <button class="danger" onclick="handleCatalogContextDelete()">Delete from Catalog List</button>
    <button onclick="closeCatalogContextMenu()">Cancel</button>
  </div>

  <script>
    let vendorPOs = [];
    let filteredPOs = [];
    let asinList = [];
    let filteredAsins = [];
    const CATALOG_SOURCE_LABELS = {
      "vendor_po": { label: "PO", title: "Vendor POs" },
      "realtime_inventory": { label: "RT-Inv", title: "Realtime Inventory" },
      "realtime_sales": { label: "RT-Sales", title: "Realtime Sales" },
      "manual": { label: "Manual", title: "Manual Add" },
      "other": { label: "Other", title: "Other" },
    };
    const VENDOR_PO_STATUS_POLL_MS = 4000;
    let vendorPoStatusData = null;
    let vendorPoStatusError = null;
    let vendorPoStatusTimer = null;
    let vendorPoManualAction = false;
    const CATALOG_BUCKET_DEFS = [
      { value: "Terminal (Not Found/Invalid)", short: "Terminal" },
      { value: "Ready (Commercial + Active)", short: "Ready Active" },
      { value: "Ready (Commercial, No Activity)", short: "Ready Quiet" },
      { value: "Needs Barcode", short: "Needs Barcode" },
      { value: "Needs Catalog (Active)", short: "Needs Catalog (Active)" },
      { value: "Blocked (Retries Exhausted)", short: "Blocked" },
      { value: "Needs Catalog (Inactive)", short: "Needs Catalog" },
    ];
    const CATALOG_ACTIONABLE_BUCKETS = new Set([
      "Needs Barcode",
      "Needs Catalog (Active)",
      "Blocked (Retries Exhausted)",
    ]);
    let activeTab = "pos";
    let oosItems = [];
    let selectedPoNumbers = [];
    let lastSyncTime = null;
    let lastSyncFromSpapi = false;
    let nextAutoSyncAt = null;
    let autoSyncIntervalMs = 2 * 60 * 60 * 1000; // 2 hours
    let testerMetaLoaded = false;
    let testerPresets = [];
    let testerHost = "";
    let catalogImageCache = {};
    let recentNotifications = [];
    let vendorInventorySnapshot = [];
    let vendorInventoryMeta = null;
    let inventoryMode = 'realtime';
    let currentInventorySubtab = 'snapshot';
    let invSortColumn = 'sellable';
    let invSortDirection = 'desc';
    let invQuickFilter = 'all';
    let invRealtimeRefreshInFlight = false;
    let inventoryAutoRefreshRequested = false;
    let inventoryFetchInFlight = false;
    let inventoryFetchPromise = null;
    let lastRealtimeFetchAt = 0;
    const INVENTORY_REFRESH_POLL_INTERVAL_MS = 5 * 60 * 1000;    const INVENTORY_FETCH_DEBOUNCE_MS = 60 * 1000;
    let inventoryRefreshPollTimer = null;
    let inventoryRefreshPollingActive = false;
    let catalogAsinMapCache = null;
    let catalogAsinMapKey = null;
    let catalogBucketSummary = null;
    let catalogCoverageSummary = null;
    let catalogHealthSummary = null;
    let catalogActionableOnly = false;
    let catalogSortMode = "bucket";
    let catalogContextMenuAsin = null;

    const INTERNAL_STATUS_OPTIONS = [
      "Pending",
      "Preparing",
      "Appointment Scheduled",
      "Delivered",
    ];

    function getRowColorForStatus(status) {
      switch (status) {
        case "Preparing":
          return "#fef9c3"; // light yellow
        case "Appointment Scheduled":
          return "#e0f2fe"; // light blue
        case "Delivered":
          return "#dcfce7"; // light green
        default:
          return ""; // Pending = no color
      }
    }

    function startDateIsoFromDays(days) {
      const d = new Date();
      d.setDate(d.getDate() - days);
      return d.toISOString().slice(0, 10);
    }

    function currentStartDateParam() {
      const sel = document.getElementById("po-start-days");
      const days = Number(sel?.value || 60);
      return startDateIsoFromDays(days);
    }

    function setVendorPoManualAction(inProgress) {
      vendorPoManualAction = inProgress;
      renderVendorPoStatus(vendorPoStatusData, vendorPoStatusError);
    }

    function ensureVendorPoStatusPoll() {
      if (vendorPoStatusTimer) return;
      vendorPoStatusTimer = setInterval(() => refreshVendorPoStatus(true), VENDOR_PO_STATUS_POLL_MS);
    }

    function stopVendorPoStatusPoll() {
      if (vendorPoStatusTimer) {
        clearInterval(vendorPoStatusTimer);
        vendorPoStatusTimer = null;
      }
    }

    function updateVendorPoActionButtons(statusRunning) {
      const syncBtn = document.getElementById("sync-btn");
      const rebuildBtn = document.getElementById("rebuild-btn");
      const shouldDisable = vendorPoManualAction || statusRunning;
      const reason = vendorPoManualAction
        ? "Vendor PO request is running..."
        : statusRunning
        ? "Vendor PO sync already running"
        : "";
      [syncBtn, rebuildBtn].forEach(btn => {
        if (!btn) return;
        btn.disabled = shouldDisable;
        btn.title = reason || "";
      });
    }

    function renderVendorPoStatus(data, error) {
      const statusEl = document.getElementById("vendor-po-status-label");
      if (!statusEl) return;
      let text = "PO Sync: Loading...";
      let statusRunning = false;
      if (error) {
        const msg = error?.message || "status failed";
        text = `PO Sync: Unknown (${msg})`;
      } else if (data && data.sync_state) {
        const state = data.sync_state;
        if (state.sync_in_progress) {
          statusRunning = true;
          const started = formatTs(state.sync_started_at) || "-";
          text = `PO Sync: Running‚Ä¶ started ${started}`;
        } else if (state.sync_last_error) {
          const finished = formatTs(state.sync_finished_at);
          text = `PO Sync Error: ${state.sync_last_error}${finished ? ` (last finished ${finished})` : ""}`;
        } else {
          const last = formatTs(state.sync_last_ok_at) || "-";
          text = `PO Sync: Idle | Last success: ${last}`;
        }
        text += " | Source: DB";
      } else if (data) {
        text = "PO Sync: Unknown";
      }
      statusEl.textContent = text;
      updateVendorPoActionButtons(statusRunning);
    }

    async function refreshVendorPoStatus(silent = false) {
      try {
        const resp = await fetch("/api/vendor-pos/status");
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        vendorPoStatusData = data;
        vendorPoStatusError = null;
        renderVendorPoStatus(data, null);
        if (data?.sync_state?.sync_in_progress) {
          ensureVendorPoStatusPoll();
        } else {
          stopVendorPoStatusPoll();
        }
      } catch (err) {
        vendorPoStatusData = null;
        vendorPoStatusError = err;
        renderVendorPoStatus(null, err);
        stopVendorPoStatusPoll();
        if (!silent) {
          console.warn("Failed to fetch Vendor PO status", err);
        }
      }
    }

    async function loadPOs(sync = false) {
      const btn = document.getElementById("sync-btn");
      if (btn && sync) { btn.disabled = true; btn.textContent = "Syncing..."; }
      if (sync) {
        setVendorPoManualAction(true);
        refreshVendorPoStatus(true);
      }
      try {
        const createdAfter = currentStartDateParam();
        if (sync) {
          const respSync = await fetch(`/api/vendor-pos/sync`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ createdAfter }),
          });
          let fetched = 0;
          if (respSync.ok) {
            const syncData = await respSync.json();
            fetched = syncData.fetched || 0;
          }
          lastSyncTime = new Date();
          lastSyncFromSpapi = true;
          nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
          updateSyncInfo();
          const hh = String(lastSyncTime.getHours()).padStart(2, "0");
          const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
          showToast(`Sync completed at ${hh}:${mi}, ${fetched} POs updated.`);
        }
        const resp = await fetch(`/api/vendor-pos?enrich=1&include_lines=true&createdAfter=${encodeURIComponent(createdAfter)}`);
        const data = await resp.json();
        vendorPOs = (data.items || []).sort((a, b) => getPoDate(b).localeCompare(getPoDate(a)));
        filteredPOs = vendorPOs;
        const poSet = new Set(vendorPOs.map(p => p.purchaseOrderNumber).filter(Boolean));
        selectedPoNumbers = selectedPoNumbers.filter(p => poSet.has(p));
        renderTable();
        updateInhouseSummary();
        populateFcFilterOptions();
        updatePicklistButtonState();
        if (!sync) {
          lastSyncTime = new Date();
          lastSyncFromSpapi = data.source === "spapi";
          if (!nextAutoSyncAt) {
            nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
          }
        }
        updateSyncInfo();
      } catch (err) {
        console.error(err);
        alert("Failed to load POs");
      } finally {
        if (btn && sync) { btn.disabled = false; btn.textContent = "Sync Vendor POs"; }
        if (sync) {
          setVendorPoManualAction(false);
          refreshVendorPoStatus();
        }
      }
    }

    async function loadNotifications() {
      const statusEl = document.getElementById("notifications-status");
      const tbody = document.getElementById("notifications-rows");
      if (statusEl) statusEl.textContent = "Loading...";
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="empty">Loading...</td></tr>';
      try {
        const resp = await fetch("/api/vendor-notifications/recent");
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        recentNotifications = data.items || [];
        if (!recentNotifications.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="empty">No notifications</td></tr>';
        } else {
          tbody.innerHTML = recentNotifications.map(n => {
            const poLink = n.po
              ? `<a href="#" onclick="openNotificationPo('${n.po}'); return false;">${escapeHtml(n.po)}</a>`
              : "";
            return `<tr>
              <td>${formatTs(n.ts)}</td>
              <td>${escapeHtml(n.notificationType || "")}</td>
              <td>${poLink}</td>
              <td>${escapeHtml(n.summary || "")}</td>
            </tr>`;
          }).join("");
        }
        if (statusEl) statusEl.textContent = `Loaded ${recentNotifications.length} notifications`;
      } catch (err) {
        console.error("Failed to load notifications", err);
        if (statusEl) statusEl.textContent = "Failed to load notifications";
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="empty">Failed to load notifications</td></tr>';
      }
    }

    function openNotificationPo(poNumber) {
      const po = vendorPOs.find(p => p.purchaseOrderNumber === poNumber);
      if (po) {
        openModal(po);
      } else {
        alert(`PO ${poNumber} not found in current list. Please sync or search.`);
      }
    }

    async function rebuildPOs() {
      const btn = document.getElementById("rebuild-btn");
      const syncBtn = document.getElementById("sync-btn");
      if (btn) { btn.disabled = true; btn.textContent = "Rebuilding..."; }
      if (syncBtn) syncBtn.disabled = true;
      setVendorPoManualAction(true);
      refreshVendorPoStatus(true);
      try {
        const resp = await fetch("/api/vendor-pos/rebuild", { method: "POST" });
        let fetched = 0;
        if (resp.ok) {
          const data = await resp.json();
          fetched = data.fetched || 0;
        } else {
          const txt = await resp.text();
          throw new Error(txt || `HTTP ${resp.status}`);
        }
        lastSyncTime = new Date();
        lastSyncFromSpapi = true;
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
        updateSyncInfo();
        const hh = String(lastSyncTime.getHours()).padStart(2, "0");
        const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
        showToast(`Full rebuild completed at ${hh}:${mi}, ${fetched} POs fetched.`);
        await loadPOs(false);
      } catch (err) {
        console.error(err);
        alert("Full rebuild failed");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Full Rebuild POs"; }
        if (syncBtn) syncBtn.disabled = false;
        setVendorPoManualAction(false);
        refreshVendorPoStatus();
      }
    }

    function getPoDate(po) {
      return po.purchaseOrderDate || po.orderDetails?.purchaseOrderDate || "";
    }

    function formatQtyWithUnits(qty) {
      qty = Number(qty) || 0;
      return qty === 0 ? "0 units" : `${qty} units`;
    }

    function formatCost(costObj) {
      if (!costObj) return "";
      if (typeof costObj === "string") return costObj;
      if (typeof costObj === "number") return costObj;
      if (costObj.amount !== undefined) {
        return `${costObj.currencyCode || "AED"} ${costObj.amount}`;
      }
      return "";
    }

    function applyStatusRowClass(row, status) {
      row.classList.remove("po-status-preparing", "po-status-appointment", "po-status-delivered");
      const s = (status || "").toLowerCase();
      if (s === "preparing") {
        row.classList.add("po-status-preparing");
      } else if (s === "appointment scheduled") {
        row.classList.add("po-status-appointment");
      } else if (s === "delivered") {
        row.classList.add("po-status-delivered");
      }
    }

    function toDateInputValue(isoDateStr) {
      if (!isoDateStr) return "";
      return isoDateStr.substring(0, 10);
    }

    function todayAsYyyyMmDd() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function isAppointmentStatus(status) {
      const s = (status || "").toLowerCase();
      return s === "appointment scheduled" || s === "appointment taken";
    }

    function updateLocalPoStatusData(poNumber, status, statusDate) {
      const item = vendorPOs.find(p => p.purchaseOrderNumber === poNumber);
      if (!item) return;
      
      if (status !== undefined && status !== null) {
        item._internalStatus = status;
      }
      item._appointmentDate = statusDate || null;
    }

    // Listen for date input changes in Status Date column
    document.addEventListener("change", async (e) => {
      const inp = e.target;
      if (!inp.classList.contains("po-status-date-input")) return;

      const row = inp.closest("tr");
      if (!row) return;

      const po = inp.getAttribute("data-po");
      const newDate = inp.value;
      const statusSelect = row.querySelector(".po-status-select");
      const currentStatus = statusSelect ? statusSelect.value : null;

      if (!po || !currentStatus || !newDate) return;

      // Only valid if status is Appointment Scheduled / Taken
      const sLower = currentStatus.toLowerCase();
      if (sLower !== "appointment scheduled" && sLower !== "appointment taken") return;

      try {
        const res = await fetch(`/api/po-status/${encodeURIComponent(po)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: currentStatus,
            appointmentDate: newDate
          }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Keep input synced with backend value
        if (data.appointmentDate) {
          inp.value = toDateInputValue(data.appointmentDate);
        }

        // Update local PO data
        updateLocalPoStatusData(po, data.status || currentStatus, data.appointmentDate);

        updateInhouseSummary();
      } catch (err) {
        console.error("Failed to update appointment date", err);
        alert("Failed to save appointment date. Please try again.");
      }
    }, true);

    function renderTable() {
      const tbody = document.getElementById("po-rows");
      tbody.innerHTML = "";
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="14" class="empty">No POs</td></tr>';
        return;
      }

      list.forEach(po => {
        const poNumber = po.purchaseOrderNumber || "";
        const flags = po.notificationFlags || {};
        const notifBadge = flags.has_recent_notifications
          ? `<span style="margin-left:6px; padding:2px 6px; border-radius:6px; background:#fef3c7; color:#92400e; font-size:11px;" title="Last notification: ${escapeHtml(flags.last_notification_summary || "")} at ${formatTs(flags.last_notification_ts || "")}${flags.needs_refresh ? ' ‚Ä¢ Needs refresh' : ''}">${flags.needs_refresh ? "Update Ready" : "Updated"}</span>`
          : "";
        const isChecked = selectedPoNumbers.includes(poNumber);
        const poStatusChip = renderPoStatusChip(po.po_status);

        const poItemsCount = Number(po.poItemsCount) || 0;
        const requestedQty = formatQtyWithUnits(po.requestedQty);
        const acceptedQty = formatQtyWithUnits(po.acceptedQty);
        const receivedQty = formatQtyWithUnits(po.receivedQty);
        const remainingQty = formatQtyWithUnits(po.remainingQty);
        const cancelledQty = formatQtyWithUnits(po.cancelledQty);
        
        // FIXED: Use corrected total_accepted_cost (accepted_qty * unit_price)
        const costAmount = po.total_accepted_cost ? po.total_accepted_cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0.00";
        const costCurrency = po.total_accepted_cost_currency || po.totalAcceptedCostCurrency || "AED";
        const totalAcceptedCost = `${costCurrency} ${costAmount}`;
        
        const internalStatus = po._internalStatus || "Pending";
        const amazonStatus = po.amazonStatus || "‚Äî";
        const shipToLocation = po.shipToText || (po.orderDetails?.shipToParty?.partyId ? `${po.orderDetails.shipToParty.partyId}` : "");

        const tr = document.createElement("tr");
        tr.ondblclick = () => openModal(po);
        applyStatusRowClass(tr, internalStatus);

        // Status column: dropdown only
        const statusDropdown = `<select class="po-status-select" data-po="${escapeAttr(poNumber)}" onchange="handleStatusChange('${escapeAttr(poNumber)}', this)">
          ${INTERNAL_STATUS_OPTIONS.map(opt => `<option value="${escapeAttr(opt)}" ${opt === internalStatus ? "selected" : ""}>${escapeHtml(opt)}</option>`).join("")}
        </select>`;

        // Status Date column: depends on status
        const statusLower = internalStatus.toLowerCase();
        const hasDate = !!po._appointmentDate;
        let statusDateCellHtml = "";

        if (statusLower === "appointment scheduled" || statusLower === "appointment taken") {
          // Editable date input
          const dateValue = hasDate ? toDateInputValue(po._appointmentDate) : todayAsYyyyMmDd();
          statusDateCellHtml = `<input type="date" class="po-status-date-input" data-po="${escapeAttr(poNumber)}" value="${dateValue}" />`;
        } else if (statusLower === "delivered" && hasDate) {
          // Read-only text for Delivered
          statusDateCellHtml = `<span data-col="status-date">${escapeHtml(fmtDate(po._appointmentDate))}</span>`;
        } else {
          // Pending/Preparing or no date
          statusDateCellHtml = `<span data-col="status-date">‚Äî</span>`;
        }

        tr.innerHTML = `
      <td><input type="checkbox" ${isChecked ? "checked" : ""} onchange="toggleSelectPo('${poNumber}', this.checked)" /></td>
      <td>
        <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
          <span>${poNumber}</span>
          ${poStatusChip ? `<span>${poStatusChip}</span>` : ""}
          ${notifBadge}
        </div>
      </td>
      <td style="text-align:center;">${poItemsCount}</td>
      <td>${fmtDate(getPoDate(po))}</td>
      <td style="text-align:center;">${requestedQty}</td>
      <td style="text-align:center;">${acceptedQty}</td>
      <td style="text-align:center;">${receivedQty}</td>
      <td style="text-align:center;">${remainingQty}</td>
      <td style="text-align:center;">${cancelledQty}</td>
      <td style="text-align:right; padding-right:16px;">${totalAcceptedCost}</td>
      <td>${statusDropdown}</td>
      <td>${statusDateCellHtml}</td>
      <td>${amazonStatus}</td>
      <td>${shipToLocation}</td>
    `;

        tbody.appendChild(tr);
      });
      updateSelectAllCheckbox();
    }

    async function syncRejectedLinesToOos(poNumber, items, poDate, shipTo) {
      if (!items || !items.length) return;
      const rejected = items.filter(it => {
        const ack = it.acknowledgementStatus || {};
        const conf = (ack.confirmationStatus || it.status || "").toUpperCase();
        return conf === "REJECTED";
      });
      if (!rejected.length) return;
      try {
        await Promise.all(rejected.map(it => {
          const qtyRaw = it.orderedQuantity || {};
          const qtyNum = toNum(qtyRaw.amount) || toNum(qtyRaw.value) || toNum(qtyRaw?.orderedQuantity?.amount);
          const payload = {
            poNumber,
            asin: it.amazonProductIdentifier || "",
            vendorSku: it.vendorProductIdentifier || "",
            purchaseOrderDate: poDate,
            shipToPartyId: shipTo,
            qty: qtyNum,
            image: resolveImage(it) || "",
          };
          if (!payload.poNumber || !payload.asin) return Promise.resolve();
          return fetch("/api/oos-items/mark", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }).catch(() => {});
        }));
      } catch (err) {
        console.warn("Failed syncing rejected lines to OOS", err);
      }
    }

    function normalizeBarcodeValue(value) {
      if (!value) return "";
      return String(value).replace(/[^0-9]/g, "").trim();
    }

    function resolveLineEan(item) {
      if (!item || typeof item !== "object") return "";
      const fields = ["ean", "barcode", "ean13", "upc", "gtin", "externalBarcode"];
      for (const field of fields) {
        const candidate = normalizeBarcodeValue(item[field]);
        if (/^\d{12,13}$/.test(candidate)) {
          return candidate;
        }
      }
      const nested = item.catalogEntry || item.catalog || item.payload;
      if (nested && typeof nested === "object") {
        const fallback = resolveLineEan(nested);
        if (fallback) {
          return fallback;
        }
      }
      return "";
    }

    async function openModal(po) {
      const modal = document.getElementById("modal");
      const body = document.getElementById("modal-body");
      const titleEl = document.getElementById("modal-title");
      const historyBtn = document.getElementById("modal-history-btn");

      const poNumber = po.purchaseOrderNumber || po.poNumber || "";
      if (!poNumber) {
        console.error("No purchaseOrderNumber on PO", po);
        return;
      }
      modal.dataset.poNumber = poNumber;
      if (historyBtn) {
        historyBtn.style.display = "inline-flex";
        historyBtn.disabled = false;
        historyBtn.dataset.poNumber = poNumber;
      }

      let enrichedPo = po;
      try {
        const resp = await fetch(`/api/vendor-pos/${encodeURIComponent(poNumber)}?enrich=1`);
        if (resp.ok) {
          const data = await resp.json();
          if (data && data.item) {
            enrichedPo = data.item;
          }
        }
        else {
          console.error("Failed to fetch enriched PO", resp.status, await resp.text());
        }
      } catch (e) {
        console.error("Failed to fetch enriched PO", e);
      }

      const poStatus = (enrichedPo.po_status || po.po_status || "").toUpperCase();
      const statusChip = renderPoStatusChip(poStatus);
      const d = enrichedPo.orderDetails || {};
      const items = d.items || [];
      const notifFlags = enrichedPo.notificationFlags || {};
      const notifLine = notifFlags.has_recent_notifications
        ? `<div style="font-size:12px; color:#0ea5e9; margin-bottom:8px;">Last Amazon notification: ${escapeHtml(notifFlags.last_notification_summary || "")} at ${formatTs(notifFlags.last_notification_ts || "")}${notifFlags.needs_refresh ? " ‚Ä¢ refresh applied" : ""}</div>`
        : `<div style="font-size:12px; color:#6b7280; margin-bottom:8px;">No recent notifications</div>`;
      await syncRejectedLinesToOos(poNumber, items, getPoDate(enrichedPo), d.shipToParty?.partyId || "");
      const poDate = getPoDate(enrichedPo);
      const shipTo = d.shipToParty?.partyId || "";
      const rows = items.map(it => {
        const qtyRaw = it.orderedQuantity || {};
        const qtyNum = toNum(qtyRaw.amount) || toNum(qtyRaw.value) || toNum(qtyRaw?.orderedQuantity?.amount);
        const qtyAmount = qtyNum || 0;
        const { netAmount, netCurrency } = resolveNet(it);
        const netNum = netAmount;
        
        // FIX: Use accepted_line_amount if available (computed by backend), else fall back to manual calculation
        let acceptedLineAmount = 0;
        if (it.accepted_line_amount !== undefined) {
          acceptedLineAmount = it.accepted_line_amount;
        } else {
          // Fallback calculation if not provided by backend
          const accAmt = toNum((it.acknowledgementStatus?.acceptedQuantity || {}).amount) || 0;
          acceptedLineAmount = Number.isFinite(accAmt * netNum) ? accAmt * netNum : 0;
        }
        
        const rawAsin = it.amazonProductIdentifier || it.buyerProductIdentifier || it.vendorProductIdentifier || "";
        const asin = qualifyAsin(rawAsin);
        const vendorSku = it.vendorProductIdentifier || "";
        const lineEan = resolveLineEan(it) || "";
        const seq = it.itemSequenceNumber || "";
        const ack = it.acknowledgementStatus || {};
        const currStatus = (ack.confirmationStatus || "ACCEPTED").toUpperCase();
        const accAmt = toNum((ack.acceptedQuantity || {}).amount) || (currStatus === "ACCEPTED" ? qtyAmount : 0);
        const rejAmt = toNum((ack.rejectedQuantity || {}).amount) || (currStatus === "REJECTED" ? qtyAmount : 0);
        
        // Get received quantity (from backend extraction of receivingStatus.receivedQuantity)
        const receivedQty = it.received_qty !== undefined ? it.received_qty : toNum(it.receivedQuantity?.amount) || 0;

        // Determine if this line is rejected or received
        const isRejected = (currStatus === "REJECTED") || (accAmt === 0 && rejAmt > 0);
        const isReceived = !isRejected && receivedQty > 0;
        let rowClass = '';
        if (isRejected) {
          rowClass = ' class="po-line-rejected"';
        } else if (isReceived) {
          rowClass = ' class="po-line-received"';
        }

        const rawImageUrl = resolveImage(it);
        const img = rawImageUrl
          ? `<img src="${rawImageUrl}" alt="" style="max-width:60px;max-height:60px;border-radius:6px;object-fit:contain;" />`
          : `<div class="img-placeholder" data-asin="${asin || ""}" data-sku="${vendorSku || ""}" style="width:60px; height:60px; background:#e5e7eb; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:11px;">No image</div>`;
        const encodedImage = encodeURIComponent(rawImageUrl || "");

        return `<tr${rowClass} data-ean="${escapeAttr(lineEan)}" data-sku="${escapeAttr(vendorSku)}" data-prompt-if-missing="true" oncontextmenu="markItemOos(event, '${poNumber}', '${asin}', '${vendorSku}', '${po.purchaseOrderDate || d.purchaseOrderDate || ""}', '${shipTo}', '${qtyAmount}', '${encodedImage}')">
          <td>${seq}</td>
          <td>${img}</td>
          <td data-col="ordered">${qtyAmount}</td>
          <td>${accAmt}</td>
          <td>${receivedQty}</td>
          <td>${rejAmt}</td>
          <td>${currStatus}</td>
          <td>${Number.isFinite(netNum) && netNum ? netNum.toFixed(2) : ""}</td>
          <td>${netCurrency || ""}</td>
          <td>
            ${Number.isFinite(acceptedLineAmount) && acceptedLineAmount > 0 ? acceptedLineAmount.toFixed(2) : "0.00"}
            <div style="margin-top:4px;">
              <button class="btn btn-sm" style="background:#15803d; color:#fff;" title="Print this line" onclick="barcodePrintFromRow(this)">Print</button>
            </div>
          </td>
        </tr>`;
      }).join("");

      // Compute PO-level accepted total (from backend if available, else sum items)
      let poAcceptedTotal = 0;
      let poAcceptedCurrency = "AED";
      if (enrichedPo.accepted_total_amount !== undefined) {
        poAcceptedTotal = enrichedPo.accepted_total_amount;
        poAcceptedCurrency = enrichedPo.accepted_total_currency || "AED";
      } else {
        // Fallback: sum up accepted_line_amount from all items
        items.forEach(it => {
          if (it.accepted_line_amount !== undefined) {
            poAcceptedTotal += it.accepted_line_amount;
          }
        });
        poAcceptedCurrency = items.length > 0 && items[0].netCost?.currencyCode ? items[0].netCost.currencyCode : "AED";
      }

      const formattedTotal = Number.isFinite(poAcceptedTotal) && poAcceptedTotal > 0
        ? `${poAcceptedCurrency} ${poAcceptedTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
        : `${poAcceptedCurrency} 0.00`;

      // Build summary row
      const summaryRow = `<tr class="po-items-summary">
        <td colspan="8"></td>
        <td style="text-align: right;">Accepted Total:</td>
        <td style="text-align: right; font-weight: 700;">${formattedTotal}</td>
      </tr>`;
      const amountRecon = enrichedPo.amount_reconciliation || null;
      let moneyFooter = "";
      if (amountRecon) {
        if (amountRecon.ok === false) {
          const err = escapeHtml(amountRecon.error || "Line totals unavailable");
          const currencies = Array.isArray(amountRecon.currencies) && amountRecon.currencies.length
            ? ` (${amountRecon.currencies.join(", ")})`
            : "";
          moneyFooter = `
            <div class="po-money-footer">
              <div class="po-money-row"><span>Line totals unavailable:</span><span class="po-money-delta-warn">${err}${escapeHtml(currencies)}</span></div>
            </div>
          `;
        } else {
          const currency = amountRecon.currency || enrichedPo.accepted_total_currency || enrichedPo.total_accepted_cost_currency || "AED";
          const lineTotalLabel = formatMoney(amountRecon.line_total, currency);
          const acceptedTotalLabel = formatMoney(amountRecon.accepted_total, currency);
          const deltaValue = Number(amountRecon.delta) || 0;
          const deltaLabel = formatMoney(deltaValue, currency);
          const deltaOk = Math.abs(deltaValue) < 0.01;
          const deltaClass = deltaOk ? "po-money-delta-ok" : "po-money-delta-warn";
          const deltaIcon = deltaOk ? "‚úÖ" : "‚ö†Ô∏è";
          moneyFooter = `
            <div class="po-money-footer">
              <div class="po-money-row"><span>Line Total (Œ£ qty √ó unit cost):</span><span>${lineTotalLabel}</span></div>
              <div class="po-money-row"><span>Accepted Total (Vendor Central):</span><span>${acceptedTotalLabel}</span></div>
              <div class="po-money-row"><span>Difference:</span><span class="${deltaClass}">${deltaLabel} ${deltaIcon}</span></div>
            </div>
          `;
        }
      }

      const titleChip = statusChip ? `<span style="margin-left:8px;">${statusChip}</span>` : "";
      titleEl.innerHTML = `PO ${escapeHtml(poNumber)} Items${titleChip}`;
      body.innerHTML = `
        <div style="overflow:auto; max-height:70vh;">
          ${notifLine}
          <table class="table">
            <thead>
              <tr>
                <th>Seq</th>
                <th>Image</th>
                <th>Ordered</th>
                <th>Accepted</th>
                <th>Received</th>
                <th>Rejected</th>
                <th>Status</th>
                <th>Net Amount</th>
                <th>Currency</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="10" class="empty">No items</td></tr>'}${rows ? summaryRow : ''}</tbody>
          </table>
          ${moneyFooter}
        </div>
      `;
      modal.style.display = "flex";
      populateMissingImages(items);
    }

    function closeModal() {
      const modalEl = document.getElementById("modal");
      modalEl.style.display = "none";
      delete modalEl.dataset.poNumber;
      const historyBtn = document.getElementById("modal-history-btn");
      if (historyBtn) {
        historyBtn.style.display = "none";
        historyBtn.dataset.poNumber = "";
      }
    }

    function openModalHistory() {
      const modalEl = document.getElementById("modal");
      const poNumber = modalEl?.dataset?.poNumber || document.getElementById("modal-history-btn")?.dataset?.poNumber;
      if (!poNumber) return;
      openPoHistory(poNumber);
    }

    async function openPoHistory(poNumber) {
      if (!poNumber) return;
      const historyModal = document.getElementById("po-history-modal");
      const body = document.getElementById("po-history-body");
      const title = document.getElementById("po-history-title");
      if (title) title.textContent = `PO ${poNumber} History`;
      body.innerHTML = '<div class="empty" style="padding:16px;">Loading history‚Ä¶</div>';
      historyModal.style.display = "flex";
      try {
        const resp = await fetch(`/api/vendor-pos/${encodeURIComponent(poNumber)}/ledger`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (!rows.length) {
          body.innerHTML = '<div class="empty" style="padding:16px;">No ledger events yet.</div>';
          return;
        }
        const tableRows = rows.map(ev => {
          const time = formatUaeTime(ev.timestamp) || "‚Äî";
          const event = escapeHtml(ev.event || "");
          const asin = escapeHtml(ev.asin || "");
          const change = (ev.old_qty !== undefined && ev.old_qty !== null) || (ev.new_qty !== undefined && ev.new_qty !== null)
            ? `${ev.old_qty ?? 0} ‚Üí ${ev.new_qty ?? 0}`
            : "";
          const source = escapeHtml(ev.source || "");
          return `<tr>
            <td>${time}</td>
            <td>${event}</td>
            <td>${asin}</td>
            <td>${escapeHtml(change)}</td>
            <td>${source}</td>
          </tr>`;
        }).join("");
        const note = escapeHtml(data.note || "Snapshot events from DB (not change log).");
        const ledgerType = escapeHtml(data.ledger_type || "snapshot");
        body.innerHTML = `
          <div class="po-history-note"><strong>${ledgerType}</strong> ‚Äî ${note}</div>
          <div style="overflow:auto; max-height:70vh;">
            <table class="po-history-table">
              <thead>
                <tr>
                  <th style="width:160px;">Time (UAE)</th>
                  <th style="width:160px;">Event</th>
                  <th style="width:140px;">ASIN / SKU</th>
                  <th style="width:140px;">Change</th>
                  <th>Source</th>
                </tr>
              </thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
        `;
      } catch (err) {
        console.error("Failed to load PO ledger", err);
        body.innerHTML = '<div class="empty" style="padding:16px;">Failed to load ledger history.</div>';
      }
    }

    function closePoHistory() {
      document.getElementById("po-history-modal").style.display = "none";
    }

    async function populateMissingImages(items) {
      const placeholders = Array.from(document.querySelectorAll(".img-placeholder[data-asin]"));
      const uniqueAsins = Array.from(new Set(placeholders.map(p => p.dataset.asin).filter(Boolean)));
      if (!uniqueAsins.length) return;

      for (const asin of uniqueAsins) {
        if (catalogImageCache.hasOwnProperty(asin)) continue;
        try {
          const resp = await fetch(`/api/catalog/item/${asin}`);
          if (!resp.ok) {
            catalogImageCache[asin] = null;
            continue;
          }
          const data = await resp.json();
          const payload = data.item || data.payload || data || {};
          const direct = data.image || payload.image;
          const candidate = direct || resolveImage(payload);
          catalogImageCache[asin] = candidate || null;
        } catch {
          catalogImageCache[asin] = null;
        }
      }

      placeholders.forEach(ph => {
        const asin = ph.dataset.asin;
        const cached = catalogImageCache[asin];
        if (cached) {
          ph.outerHTML = `<img src="${cached}" alt="" style="max-width:60px;max-height:60px;border-radius:6px;object-fit:contain;" />`;
        }
      });
    }

    function qualifyAsin(val) {
      if (!val) return "";
      const v = String(val).trim();
      const re = /^[A-Z0-9]{8,15}$/i;
      if (re.test(v)) return v.toUpperCase();
      return "";
    }


    async function handleStatusChange(poNumber, selectEl) {
      const newStatus = selectEl.value;
      const row = selectEl.closest("tr");
      let statusDateToSend = null;

      const statusLower = newStatus.toLowerCase();

      if (statusLower === "appointment scheduled" || statusLower === "appointment taken") {
        // Appointment: use existing date or default to today
        const existingInput = row ? row.querySelector(".po-status-date-input") : null;
        if (existingInput && existingInput.value) {
          statusDateToSend = existingInput.value;
        } else {
          statusDateToSend = todayAsYyyyMmDd();
        }
      } else if (statusLower === "delivered") {
        // Delivered: keep existing date if present
        const existingInput = row ? row.querySelector(".po-status-date-input") : null;
        const existingSpan = row ? row.querySelector("[data-col='status-date']") : null;
        if (existingInput && existingInput.value) {
          statusDateToSend = existingInput.value;
        } else if (existingSpan && existingSpan.textContent && existingSpan.textContent !== "‚Äî") {
          statusDateToSend = toDateInputValue(existingSpan.textContent);
        } else {
          statusDateToSend = todayAsYyyyMmDd();
        }
      } else {
        // Pending / Preparing: no date
        statusDateToSend = null;
      }

      try {
        const res = await fetch(`/api/po-status/${encodeURIComponent(poNumber)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: newStatus,
            appointmentDate: statusDateToSend || null,
          }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Update Status Date cell based on returned status and date
        const statusDateCell = row ? row.querySelector("[data-col='status-date']") : null;
        if (statusDateCell || row) {
          const statusLower2 = (data.status || newStatus).toLowerCase();
          const hasDate = !!data.appointmentDate;
          let newCellHtml = "";

          if (statusLower2 === "appointment scheduled" || statusLower2 === "appointment taken") {
            // Render editable date input
            const dateValue = hasDate ? toDateInputValue(data.appointmentDate) : todayAsYyyyMmDd();
            newCellHtml = `<input type="date" class="po-status-date-input" data-po="${escapeAttr(poNumber)}" value="${dateValue}" />`;
          } else if (statusLower2 === "delivered" && hasDate) {
            // Render read-only text
            newCellHtml = `<span data-col="status-date">${escapeHtml(fmtDate(data.appointmentDate))}</span>`;
          } else {
            // Pending/Preparing or no date
            newCellHtml = `<span data-col="status-date">‚Äî</span>`;
          }

          // Find the Status Date cell and replace its content
          const cellIndex = 11; // Status Date is 12th column (0-indexed)
          const cells = row.querySelectorAll("td");
          if (cells[cellIndex]) {
            cells[cellIndex].innerHTML = newCellHtml;
          }
        }

        // Update local PO data
        updateLocalPoStatusData(poNumber, data.status || newStatus, data.appointmentDate);

        // Apply row highlight
        if (row) {
          applyStatusRowClass(row, data.status || newStatus);
        }

        // Update summary
        updateInhouseSummary();
        filterPOs();
      } catch (err) {
        console.error("Failed to save PO status", err);
        alert("Failed to update status. Please try again.");
      }
    }

    async function updateAppointmentDate(poNumber, inputEl) {
      const newDate = inputEl.value || null;
      const tr = inputEl.closest("tr");
      let status = "Pending";

      if (tr) {
        const select = tr.querySelector("select.po-status-select");
        if (select) {
          status = select.value;
        }
      }

      try {
        await fetch(`/api/po-status/${encodeURIComponent(poNumber)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: status,
            appointmentDate: newDate,
          }),
        });
        updateLocalPoStatus(poNumber, status, newDate);
        updateInhouseSummary();
        filterPOs();
      } catch (err) {
        console.error("Failed to save appointment date", err);
        alert("Failed to save appointment date. Check console for details.");
      }
    }

    function updateLocalPoStatus(poNumber, status, appointmentDate) {
      const lists = [vendorPOs, filteredPOs];
      lists.forEach(list => {
        if (!list) return;
        const po = list.find(p => p.purchaseOrderNumber === poNumber);
        if (po) {
          po._internalStatus = status;
          if (appointmentDate) {
            po._appointmentDate = appointmentDate;
          } else {
            delete po._appointmentDate;
          }
        }
      });
    }

    function filterPOs() {
      const searchInput = document.getElementById("po-search");
      const fcSelect    = document.getElementById("po-filter-fc");
      const statusSelect = document.getElementById("po-filter-status");
      const dateWindowSelect = document.getElementById("po-start-days");

      const qRaw = (searchInput?.value || "").trim().toLowerCase();
      const fcFilter = (fcSelect?.value || "").trim().toLowerCase();
      const statusFilter = (statusSelect?.value || "").trim();
      const daysWindow = Number(dateWindowSelect?.value || 60);

      // Calculate date cutoff
      const now = new Date();
      const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysWindow);

      filteredPOs = (vendorPOs || []).filter(po => {
        const d = po.orderDetails || {};
        const items = d.items || [];
        const shipTo = (d.shipToParty?.partyId || "").toLowerCase();
        const poNumber = (po.purchaseOrderNumber || "").toLowerCase();
        const state = (po.purchaseOrderState || "").toLowerCase();
        const inhouseStatus = (po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending").toLowerCase();

        // Date window filter
        const orderDateStr = po.purchaseOrderDate || d.purchaseOrderDate || "";
        if (orderDateStr) {
          const orderDate = new Date(orderDateStr);
          if (!Number.isNaN(orderDate.getTime()) && orderDate < cutoff) {
            return false;
          }
        }

        let asins = "";
        let skus = "";
        items.forEach(it => {
          asins += " " + String(it.amazonProductIdentifier || "").toLowerCase();
          skus  += " " + String(it.vendorProductIdentifier || "").toLowerCase();
        });

        const haystack = [
          poNumber,
          state,
          inhouseStatus,
          shipTo,
          asins,
          skus,
        ].join(" ");

        if (qRaw && !haystack.includes(qRaw)) {
          return false;
        }

        if (fcFilter && shipTo !== fcFilter) {
          return false;
        }

        const currentStatus = (po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending");
        if (statusFilter && currentStatus !== statusFilter) {
          return false;
        }

        return true;
      });

      renderTable();
      updateInhouseSummary();
    }

    function updateInhouseSummary() {
      const el = document.getElementById("inhouse-summary");
      if (!el) return;

      const list = filteredPOs && filteredPOs.length ? filteredPOs : vendorPOs;
      const counts = {
        "Pending": 0,
        "Preparing": 0,
        "Appointment Scheduled": 0,
        "Delivered": 0,
      };

      list.forEach(po => {
        const status = po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending";
        if (counts.hasOwnProperty(status)) {
          counts[status]++;
        }
      });

      el.textContent =
        `Pending: ${counts["Pending"]}  |  ` +
        `Preparing: ${counts["Preparing"]}  |  ` +
        `Appointment Scheduled: ${counts["Appointment Scheduled"]}  |  ` +
        `Delivered: ${counts["Delivered"]}`;
    }

    function populateFcFilterOptions() {
      const select = document.getElementById("po-filter-fc");
      if (!select) return;

      const values = new Set();
      (vendorPOs || []).forEach(po => {
        const d = po.orderDetails || {};
        const fc = d.shipToParty?.partyId || "";
        if (fc) values.add(fc);
      });

      const currentValue = select.value;
      select.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "All F/C";
      select.appendChild(optAll);

      Array.from(values).sort().forEach(fc => {
        const opt = document.createElement("option");
        opt.value = fc;
        opt.textContent = fc;
        select.appendChild(opt);
      });

      if (currentValue && values.has(currentValue)) {
        select.value = currentValue;
      }
    }

    async function showCatalogDetails(asin) {
      const modal = document.getElementById("catalog-modal");
      const body = document.getElementById("catalog-modal-body");
      const titleEl = document.getElementById("catalog-modal-title");
      titleEl.textContent = `Catalog Details: ${asin}`;
      body.innerHTML = '<div class="json-block">Loading...</div>';
      modal.style.display = "flex";
      try {
        const resp = await fetch(`/api/catalog/item/${asin}`);
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        body.innerHTML = `<pre id="catalog-json" class="json-block" ondblclick="copyCatalogJson()"></pre>`;
        document.getElementById("catalog-json").textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        body.innerHTML = `<div class="json-block">Failed to load catalog details: ${err}</div>`;
      }
    }

    function closeCatalogModal() {
      document.getElementById("catalog-modal").style.display = "none";
    }

    async function openPoLinesModal(poNumber) {
      const modal = document.getElementById("po-lines-modal");
      const titleEl = document.getElementById("po-lines-modal-title");
      const bodyEl = document.getElementById("po-lines-modal-body");

      titleEl.textContent = `PO ${poNumber} - Line Items Inventory Breakdown`;
      bodyEl.innerHTML = '<div style="padding:16px; text-align:center;">Loading line details...</div>';
      modal.style.display = "flex";

      try {
        const resp = await fetch(`/api/vendor-po-lines?po_number=${encodeURIComponent(poNumber)}`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const lines = data.items || [];

        if (!lines.length) {
          bodyEl.innerHTML = '<div style="padding:16px; text-align:center; color:#6b7280;">No line items found for this PO in the database.</div>';
          return;
        }

        // Build table
        const rows = lines.map(line => {
          const shortage = line.shortage_qty || 0;
          const pending = line.pending_qty || 0;
          const shortageClass = shortage > 0 ? "qty-shortage" : (pending > 0 ? "qty-pending" : "qty-good");
          
          return `<tr>
            <td>${line.asin || ""}</td>
            <td>${line.sku || ""}</td>
            <td style="text-align:center;">${line.ordered_qty || 0}</td>
            <td style="text-align:center;">${line.received_qty || 0}</td>
            <td class="${shortageClass}" style="text-align:center;">${line.pending_qty || 0}</td>
            <td class="${shortageClass}" style="text-align:center; font-weight:600;">${shortage > 0 ? '‚ö†Ô∏è ' + shortage : shortage}</td>
          </tr>`;
        }).join("");

        bodyEl.innerHTML = `
          <div style="padding:16px;">
            <div style="margin-bottom:16px; padding:12px; background:#f3f4f6; border-radius:8px;">
              <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Ordered</div>
                  <div style="font-size:18px; font-weight:700;">${lines.reduce((s, l) => s + (l.ordered_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Received</div>
                  <div style="font-size:18px; font-weight:700;">${lines.reduce((s, l) => s + (l.received_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Pending</div>
                  <div style="font-size:18px; font-weight:700; color:#b45309;">${lines.reduce((s, l) => s + (l.pending_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Shortage</div>
                  <div style="font-size:18px; font-weight:700; color:#dc2626;">${lines.reduce((s, l) => s + (l.shortage_qty || 0), 0)}</div>
                </div>
              </div>
            </div>
            <div style="overflow:auto; max-height:60vh;">
              <table>
                <thead>
                  <tr>
                    <th>ASIN</th>
                    <th>SKU</th>
                    <th style="text-align:center;">Ordered</th>
                    <th style="text-align:center;">Received</th>
                    <th style="text-align:center;">Pending</th>
                    <th style="text-align:center;">Shortage</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } catch (err) {
        console.error("Failed to load PO lines", err);
        bodyEl.innerHTML = `<div style="padding:16px; color:#dc2626;">‚ö†Ô∏è Failed to load line details: ${err.message || err}</div>`;
      }
    }

    function closePoLinesModal() {
      document.getElementById("po-lines-modal").style.display = "none";
    }

    function resolveImage(it) {
      const candidates = [];
      const pushCandidate = (obj) => {
        if (!obj || typeof obj !== "object") return;
        candidates.push(obj.image, obj.imageUrl, obj.detailPageImage, obj.thumbnail, obj.mainImage?.link, obj.mainImage?.url);
        if (Array.isArray(obj.summaries)) {
          obj.summaries.forEach(s => {
            if (!s || typeof s !== "object") return;
            candidates.push(s.mainImage?.link, s.mainImage?.url, s.image, s.imageUrl);
            if (Array.isArray(s.images)) {
              s.images.forEach(im => candidates.push(im && (im.link || im.url)));
            }
          });
        }
        if (Array.isArray(obj.images)) {
          obj.images.forEach(img => {
            if (!img) return;
            candidates.push(img.link, img.url);
            if (Array.isArray(img.variants)) {
              img.variants.forEach(v => candidates.push(v && (v.link || v.url)));
            }
            if (Array.isArray(img.images)) {
              img.images.forEach(v => candidates.push(v && (v.link || v.url)));
            }
          });
        }
      };

      pushCandidate(it);
      if (it && typeof it === "object") {
        pushCandidate(it.payload);
      }

      return candidates.find(Boolean) || "";
    }

    function resolveNet(it) {
      const nets = [it.netCost, it.listPrice, it.price, it.unitPrice];
      let amount = 0;
      let currency = "";
      for (const n of nets) {
        if (n && typeof n === "object") {
          amount = toNum(n.amount) || toNum(n.value) || toNum(n.price);
          currency = n.currencyCode || n.currency || n.code || currency;
          if (amount) break;
        }
      }
      if (!currency) {
        currency = it.currencyCode || it.currency || it.orderedQuantity?.currencyCode || "";
      }
      if (!currency && amount) {
        currency = "AED";
      }
      return { netAmount: amount, netCurrency: currency };
    }


    function copyCatalogJson() {
      const pre = document.getElementById("catalog-json");
      if (!pre) return;
      const text = pre.textContent || "";
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const range = document.createRange();
        range.selectNode(pre);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try { document.execCommand("copy"); } catch (e) {}
        sel.removeAllRanges();
      }
    }

    let toastTimeoutId = null;
    function showToast(message) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = message;
      el.style.opacity = "1";
      if (toastTimeoutId) clearTimeout(toastTimeoutId);
      toastTimeoutId = setTimeout(() => {
        el.style.opacity = "0";
      }, 4000);
    }

    function toggleSelectPo(poNumber, checked) {
      if (!poNumber) return;
      if (checked) {
        if (!selectedPoNumbers.includes(poNumber)) {
          selectedPoNumbers.push(poNumber);
        }
      } else {
        selectedPoNumbers = selectedPoNumbers.filter(p => p !== poNumber);
      }
      updateSelectAllCheckbox();
      updatePicklistButtonState();
    }

    function toggleSelectAllPos(headerCheckbox) {
      const checked = headerCheckbox?.checked;
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      if (checked) {
        selectedPoNumbers = Array.from(new Set([...selectedPoNumbers, ...list.map(p => p.purchaseOrderNumber).filter(Boolean)]));
      } else {
        const visibleSet = new Set(list.map(p => p.purchaseOrderNumber).filter(Boolean));
        selectedPoNumbers = selectedPoNumbers.filter(p => !visibleSet.has(p));
      }
      renderTable();
      updatePicklistButtonState();
    }

    function updateSelectAllCheckbox() {
      const headerCheckbox = document.getElementById("po-select-all");
      if (!headerCheckbox) return;
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      const visiblePos = list.map(p => p.purchaseOrderNumber).filter(Boolean);
      if (!visiblePos.length) {
        headerCheckbox.checked = false;
        headerCheckbox.indeterminate = false;
        return;
      }
      const selectedVisible = visiblePos.filter(p => selectedPoNumbers.includes(p));
      headerCheckbox.checked = selectedVisible.length === visiblePos.length;
      headerCheckbox.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visiblePos.length;
    }

    function updatePicklistButtonState() {
      const btn = document.getElementById("picklist-btn");
      if (!btn) return;
      btn.disabled = !selectedPoNumbers.length;
    }

    function aggregate(items) {
      let totalCost = 0;
      let currency = "";
      items.forEach(it => {
        const qty = toNum(it?.orderedQuantity?.amount);
        const unitCost = toNum(it?.netCost?.amount);
        totalCost += qty * unitCost;
        if (it?.netCost?.currencyCode) currency = it.netCost.currencyCode;
      });
      return { totalCost, currency };
    }

    function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function formatNum(v, cur = "") {
      const n = Number(v);
      if (!Number.isFinite(n)) return "";
      return (cur ? cur + " " : "") + n.toFixed(2);
    }

    function formatMoney(value, currency = "AED") {
      const n = Number(value);
      const safe = Number.isFinite(n) ? n : 0;
      return `${currency} ${safe.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function renderPoStatusChip(status) {
      let normalized = "";
      if (typeof status === "string") {
        normalized = status.trim().toUpperCase();
      }
      if (!normalized) normalized = "OPEN";
      const map = {
        "OPEN": { icon: "üü¢", cls: "po-status-open" },
        "CLOSED": { icon: "üîµ", cls: "po-status-closed" },
        "CANCELLED": { icon: "üî¥", cls: "po-status-cancelled" },
      };
      const meta = map[normalized] || map.OPEN;
      return `<span class="po-status-chip ${meta.cls}">${meta.icon} ${normalized}</span>`;
    }

    function fmtDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function formatTs(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function formatUaeTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      const uae = new Date(d.getTime() + 4 * 60 * 60 * 1000);
      const yyyy = uae.getUTCFullYear();
      const mm = String(uae.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(uae.getUTCDate()).padStart(2, "0");
      const hh = String(uae.getUTCHours()).padStart(2, "0");
      const mi = String(uae.getUTCMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeAttr(str) {
      if (str === undefined || str === null) return "";
      return String(str).replace(/"/g, "&quot;");
    }

    function formatSyncTime(d) {
      if (!d) return "‚Äî";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}-${mm}-${yyyy} ${hh}:${mi}`;
    }

    function formatEta(msDiff) {
      if (msDiff <= 0) return "soon";
      const totalMinutes = Math.floor(msDiff / 60000);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      if (h <= 0) return `in ${m}m`;
      return `in ${h}h ${m}m`;
    }

    function updateSyncInfo() {
      const lastEl = document.getElementById("sync-last");
      const nextEl = document.getElementById("sync-next");
      if (!lastEl || !nextEl) return;

      if (!lastSyncTime) {
        lastEl.textContent = "Last Sync: ‚Äî";
      } else {
        const src = lastSyncFromSpapi ? "(from SP-API)" : "(from cache)";
        lastEl.textContent = `Last Sync: ${formatSyncTime(lastSyncTime)} ${src}`;
      }

      if (!nextAutoSyncAt) {
        nextEl.textContent = "Next Auto-Sync: ‚Äî";
      } else {
        const diff = nextAutoSyncAt - Date.now();
        nextEl.textContent = `Next Auto-Sync: ${formatEta(diff)}`;
      }
    }


    async function loadTesterMeta() {
      if (testerMetaLoaded) return;
      try {
        const resp = await fetch("/api/spapi-tester/meta");
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        testerPresets = data.presets || [];
        testerHost = data.host || "";
        const presetSelect = document.getElementById("tester-preset");
        if (presetSelect) {
          testerPresets.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.group} ‚Äî ${p.label}`;
            opt.dataset.path = p.path || "";
            opt.dataset.method = p.method || "GET";
            opt.dataset.defaultQuery = p.default_query || "";
            opt.dataset.defaultBody = p.default_body ? JSON.stringify(p.default_body, null, 2) : "";
            opt.dataset.notes = p.notes || "";
            presetSelect.appendChild(opt);
          });
        }
        const hostLabel = document.getElementById("tester-host");
        if (hostLabel) {
          hostLabel.textContent = testerHost ? `Host: ${testerHost}` : "";
        }
        testerMetaLoaded = true;
      } catch (err) {
        const statusEl = document.getElementById("tester-status");
        if (statusEl) {
          statusEl.textContent = `Failed to load presets: ${err}`;
          statusEl.style.color = "#dc2626";
        }
      }
    }

    function applyTesterPreset() {
      const presetSelect = document.getElementById("tester-preset");
      const endpointInput = document.getElementById("tester-endpoint");
      const methodSelect = document.getElementById("tester-method");
      const statusEl = document.getElementById("tester-status");
      const queryInput = document.getElementById("tester-query");
      const bodyInput = document.getElementById("tester-body");
      if (!presetSelect || !endpointInput) return;
      const selectedOpt = presetSelect.options[presetSelect.selectedIndex];
      const path = selectedOpt?.dataset?.path || "";
      const method = selectedOpt?.dataset?.method || "GET";
      const defaultQuery = selectedOpt?.dataset?.defaultQuery || "";
      const defaultBody = selectedOpt?.dataset?.defaultBody || "";
      const notes = selectedOpt?.dataset?.notes || "";
      endpointInput.value = path;
      if (methodSelect) methodSelect.value = method;
      if (queryInput) queryInput.value = defaultQuery;
      if (bodyInput) bodyInput.value = defaultBody;
      if (statusEl) {
        statusEl.textContent = notes || "Preset applied";
        statusEl.style.color = "#475569";
      }
    }

    function parseFullPath(full) {
      if (!full) return { endpoint: "", query: "" };
      full = full.trim();
      try {
        if (full.startsWith("http")) {
          const u = new URL(full);
          return { endpoint: u.pathname, query: u.search ? u.search.substring(1) : "" };
        }
      } catch (e) {
        // fall through to manual split
      }
      const parts = full.split("?");
      const endpoint = parts[0] || "";
      const query = parts.slice(1).join("?") || "";
      return { endpoint, query };
    }

    function applyTesterFullPath() {
      const fullInput = document.getElementById("tester-fullpath");
      const endpointInput = document.getElementById("tester-endpoint");
      const queryInput = document.getElementById("tester-query");
      const statusEl = document.getElementById("tester-status");
      if (!fullInput || !endpointInput || !queryInput) return;
      const parsed = parseFullPath(fullInput.value || "");
      endpointInput.value = parsed.endpoint;
      queryInput.value = parsed.query;
      if (statusEl) {
        statusEl.textContent = parsed.endpoint ? "Applied full path" : "";
        statusEl.style.color = "#475569";
      }
    }

    async function runTesterCall() {
      const endpointInput = document.getElementById("tester-endpoint");
      const queryInput = document.getElementById("tester-query");
      const methodSelect = document.getElementById("tester-method");
      const bodyInput = document.getElementById("tester-body");
      const logEl = document.getElementById("tester-log");
      const statusEl = document.getElementById("tester-status");
      const btns = document.getElementsByClassName("tester-run-btn");
      if (!endpointInput || !logEl) return;
      const fullInput = document.getElementById("tester-fullpath");
      const fullVal = (fullInput?.value || "").trim();
      const method = (methodSelect?.value || "GET").toUpperCase();
      let endpoint = (endpointInput.value || "").trim();
      let query = (queryInput?.value || "").trim();
      if (fullVal) {
        const parsed = parseFullPath(fullVal);
        endpoint = parsed.endpoint || endpoint;
        query = parsed.query || query;
      }
      if (!endpoint) {
        alert("Please enter an endpoint path starting with /");
        return;
      }
      let bodyPayload = null;
      const bodyText = bodyInput?.value?.trim();
      if (method !== "GET" && bodyText) {
        try {
          bodyPayload = JSON.parse(bodyText);
        } catch (e) {
          if (statusEl) {
            statusEl.textContent = `Invalid JSON body: ${e}`;
            statusEl.style.color = "#dc2626";
          }
          return;
        }
      }
      if (statusEl) {
        statusEl.textContent = "Running...";
        statusEl.style.color = "#475569";
      }
      logEl.textContent = "Loading...";
      Array.from(btns).forEach(b => (b.disabled = true));
      try {
        const resp = await fetch("/api/spapi-tester/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            method,
            path: endpoint,
            query_string: query,
            body_json: bodyPayload,
          }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const body = data?.response?.body;
        const statusCode = data?.response?.status_code;
        const display = typeof body === "string" ? body : JSON.stringify(body, null, 2);
        logEl.textContent = display || "(empty body)";
        if (statusEl) {
          statusEl.textContent = `Status: ${statusCode ?? "?"} | ${method} ${endpoint}`;
          statusEl.style.color = "#166534";
        }
      } catch (err) {
        logEl.textContent = `Error: ${err}`;
        if (statusEl) {
          statusEl.textContent = `Error: ${err}`;
          statusEl.style.color = "#dc2626";
        }
      } finally {
        Array.from(btns).forEach(b => (b.disabled = false));
      }
    }

    function copyTesterLog() {
      const logEl = document.getElementById("tester-log");
      if (!logEl) return;
      const text = logEl.textContent || "";
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const range = document.createRange();
        range.selectNode(logEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try { document.execCommand("copy"); } catch (e) {}
        sel.removeAllRanges();
      }
      const statusEl = document.getElementById("tester-status");
      if (statusEl) {
        statusEl.textContent = "Log copied";
        statusEl.style.color = "#166534";
      }
    }

    async function loadAsinList(force = false) {
      closeCatalogContextMenu();
      const tbody = document.getElementById("asin-rows");
      tbody.innerHTML = '<tr><td colspan="6" class="empty">Loading...</td></tr>';
      try {
        const resp = await fetch("/api/catalog/asins");
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        asinList = data.items || [];
        catalogCoverageSummary = data.coverage_summary || null;
        catalogHealthSummary = data.coverage_health_summary || null;
        catalogBucketSummary = data.bucket_summary || null;
        updateCatalogSummaryStrip();
        filterAsins();
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Failed to load ASINs: ${err}</td></tr>`;
        catalogCoverageSummary = null;
        catalogHealthSummary = null;
        catalogBucketSummary = null;
        updateCatalogSummaryStrip();
      }
    }

    function toggleActionableOnly(isChecked) {
      catalogActionableOnly = !!isChecked;
      filterAsins();
    }

    function setCatalogSortMode(mode) {
      catalogSortMode = mode || "bucket";
      filterAsins();
    }

    function filterAsins() {
      const searchEl = document.getElementById("asin-search");
      const filterEl = document.getElementById("catalog-barcode-filter");
      const bucketFilterEl = document.getElementById("catalog-bucket-filter");

      const query = (searchEl ? searchEl.value : "").toLowerCase();
      const barcodeFilter = filterEl ? filterEl.value : "all";
      const bucketFilter = bucketFilterEl ? bucketFilterEl.value : "all";
      const barcodeRegex = /^\d{12,13}$/;

      let rows = asinList.filter(item => {
        const asinVal = (item.asin || "").toLowerCase();
        const skuVal = (item.sku || "").toLowerCase();
        const modelVal = (item.model || "").toLowerCase();
        const titleVal = (item.title || "").toLowerCase();

        const matchesText =
          !query ||
          asinVal.includes(query) ||
          skuVal.includes(query) ||
          modelVal.includes(query) ||
          titleVal.includes(query);

        const bcValue = (item.barcode || "").toString().trim();
        const hasValidBarcode = barcodeRegex.test(bcValue);

        let matchesBarcode = true;
        if (barcodeFilter === "missing") matchesBarcode = !hasValidBarcode;
        if (barcodeFilter === "has") matchesBarcode = hasValidBarcode;
        let matchesBucket = true;
        if (bucketFilter !== "all") {
          matchesBucket = (item.bucket || "") === bucketFilter;
        }
        let matchesActionable = true;
        if (catalogActionableOnly) {
          matchesActionable = CATALOG_ACTIONABLE_BUCKETS.has(item.bucket || "");
        }

        return matchesText && matchesBarcode && matchesBucket && matchesActionable;
      });

      rows = applyCatalogSort(rows);
      filteredAsins = rows;
      renderAsinList();
    }

    function applyCatalogSort(rows) {
      const compareAsin = (a, b) => (a.asin || "").localeCompare(b.asin || "");
      const list = rows.slice();
      list.sort((a, b) => {
        switch (catalogSortMode) {
          case "attempts": {
            const aAttempts = Number(a.fetch_attempts || 0);
            const bAttempts = Number(b.fetch_attempts || 0);
            if (bAttempts !== aAttempts) return bAttempts - aAttempts;
            return compareAsin(a, b);
          }
          case "operational": {
            const aOp = a.operationally_active ? 1 : 0;
            const bOp = b.operationally_active ? 1 : 0;
            if (bOp !== aOp) return bOp - aOp;
            return compareAsin(a, b);
          }
          case "barcode": {
            const aMissing = a.barcode_ready ? 0 : 1;
            const bMissing = b.barcode_ready ? 0 : 1;
            if (bMissing !== aMissing) return bMissing - aMissing;
            return compareAsin(a, b);
          }
          case "catalog": {
            const aMissing = a.catalog_ready ? 0 : 1;
            const bMissing = b.catalog_ready ? 0 : 1;
            if (bMissing !== aMissing) return bMissing - aMissing;
            return compareAsin(a, b);
          }
          case "asin": {
            return compareAsin(a, b);
          }
          case "bucket":
          default: {
            const aRank = Number(a.bucket_rank || 999);
            const bRank = Number(b.bucket_rank || 999);
            if (aRank !== bRank) return aRank - bRank;
            return compareAsin(a, b);
          }
        }
      });
      return list;
    }

    function exportCatalogCsv() {
      const rows = Array.isArray(filteredAsins) ? filteredAsins : [];
      if (!rows.length) {
        alert("No catalog rows to export.");
        return;
      }
      const headers = [
        "asin",
        "sku",
        "barcode",
        "title",
        "bucket",
        "bucket_rank",
        "catalog_ready",
        "barcode_ready",
        "commercial_ready",
        "operationally_active",
        "has_inventory",
        "has_sales",
        "fetch_attempts",
        "fetch_blocked",
        "fetch_terminal_code",
      ];
      const csvLines = [headers.join(",")];
      rows.forEach(item => {
        const line = [
          item.asin || "",
          item.sku || "",
          item.barcode || "",
          item.title || "",
          item.bucket || "",
          item.bucket_rank ?? "",
          item.catalog_ready ? "true" : "false",
          item.barcode_ready ? "true" : "false",
          item.commercial_ready ? "true" : "false",
          item.operationally_active ? "true" : "false",
          item.has_inventory ? "true" : "false",
          item.has_sales ? "true" : "false",
          item.fetch_attempts ?? 0,
          item.fetch_blocked ? "true" : "false",
          item.fetch_terminal_code || "",
        ].map(catalogCsvEscape);
        csvLines.push(line.join(","));
      });
      const csvContent = csvLines.join("\r\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = buildCatalogExportFilename();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function catalogCsvEscape(value) {
      if (value === null || value === undefined) return "";
      const str = String(value).replace(/\r?\n/g, " ").replace(/\r/g, " ");
      if (str.includes('"') || str.includes(",") ) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }

    function buildCatalogExportFilename() {
      const now = new Date();
      const pad = (num) => String(num).padStart(2, "0");
      const stamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
      return `catalog_audit_${stamp}.csv`;
    }

    async function fetchAllMissing() {
      const tbody = document.getElementById("asin-rows");
      tbody.innerHTML = '<tr><td colspan="6" class="empty">Fetching all missing... this may take time.</td></tr>';
      try {
        const resp = await fetch("/api/catalog/fetch-all", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        await loadAsinList(true);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Fetch-all failed: ${err}</td></tr>`;
      }
    }

    async function loadOosItems() {
      const tbody = document.getElementById("oos-rows");
      const statusEl = document.getElementById("oos-status");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Loading...</td></tr>';
      }
      try {
        const resp = await fetch("/api/oos-items");
        const data = await resp.json();
        oosItems = data.items || [];
        renderOosTable();
        if (statusEl) statusEl.textContent = `Loaded ${oosItems.length} OOS items`;
      } catch (err) {
        if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Failed to load: ${err}</td></tr>`;
        if (statusEl) statusEl.textContent = "Error loading OOS items";
      }
    }

    function downloadOosXls() {
      const statusEl = document.getElementById("oos-status");
      if (statusEl) statusEl.textContent = "Exporting...";
      
      try {
        // Download the file
        window.open("/api/oos-items/export", "_blank");
        
        // Wait a moment for export to complete on backend, then refresh the list
        setTimeout(async () => {
          await loadOosItems();
          
          // Count how many are now marked as exported
          const exportedCount = oosItems.filter(it => it.export_status === "exported").length;
          if (statusEl) {
            statusEl.textContent = `Export complete. ${exportedCount} total items marked as exported.`;
          }
        }, 1000);
      } catch (err) {
        if (statusEl) statusEl.textContent = "Export failed: " + err.message;
      }
    }

    function renderOosTable() {
      const tbody = document.getElementById("oos-rows");
      if (!tbody) return;
      if (!oosItems.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">No OOS items</td></tr>';
        return;
      }
      tbody.innerHTML = oosItems.map(it => {
        const poNumber = Array.isArray(it.poNumbers) ? it.poNumbers.join(", ") : (it.poNumber || "");
        const poDate = fmtDate(it.purchaseOrderDate || "");
        const shipTo = it.shipToPartyId || "";
        const asin = it.asin || "";
        const sku = it.vendorSku || "";
        const qty = it.qty ?? "";
        const exportStatus = it.export_status || "pending";
        const img = it.image
          ? `<img src="${it.image}" alt="" style="max-width:50px;max-height:50px;object-fit:contain;border-radius:6px;" />`
          : "";
        
        // Row styling: slightly grey out exported items
        const rowClass = exportStatus === "exported" ? ' class="oos-row-exported"' : '';
        
        // Status display
        const statusHTML = exportStatus === "exported"
          ? '<span class="export-status-exported">Exported</span>'
          : '<span class="export-status-pending">Pending for export</span>';
        
        return `
          <tr${rowClass}>
            <td style="display:none;">${poNumber}</td>
            <td style="display:none;">${poDate}</td>
            <td style="display:none;">${shipTo}</td>
            <td>${asin}</td>
            <td>${img}</td>
            <td>${sku}</td>
            <td>${qty}</td>
            <td>${statusHTML}</td>
          </tr>
        `;
      }).join("");
    }

    async function restockOosItem(poNumber, asin) {
      if (!asin) return;
      const statusEl = document.getElementById("oos-status");
      if (statusEl) statusEl.textContent = "Updating...";
      try {
        await fetch("/api/oos-items/restock", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ poNumber, asin }),
        });
        await loadOosItems();
        if (statusEl) statusEl.textContent = `Restocked ${asin}`;
      } catch (err) {
        if (statusEl) statusEl.textContent = `Failed to restock: ${err}`;
      }
    }

    function renderAsinList() {
      const tbody = document.getElementById("asin-rows");
      if (!tbody) return;

      if (!filteredAsins.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No ASINs found in Vendor POs</td></tr>';
        return;
      }

      tbody.innerHTML = filteredAsins.map(item => {
        const asin = (item.asin || "").trim();
        const sku = (item.sku || "").trim();
        const bc = (item.barcode || "").toString().trim();
        const isValidBarcode = /^\d{12,13}$/.test(bc);

        const eanValue = (item.ean || item.barcode || item.upc || item.ean13 || "").toString().trim();
        const rowSku = sku;

        const imageCell = item.image
          ? `<img src="${item.image}" alt="" style="width:80px;height:80px;object-fit:contain;border-radius:6px;" />`
          : "";

        const barcodeCell = isValidBarcode
          ? `<span id="bc-${asin}">${bc}</span>`
          : `<div style="display:flex; align-items:center; gap:6px;">
               <span id="bc-${asin}">${bc || "-"}</span>
               <button class="btn" style="padding:4px 8px; background:#0f172a;"
                 onclick="editBarcode('${asin}', '${bc}')">Edit</button>
             </div>`;

        const fetchButton = item.fetched
          ? ""
          : `<button class="btn btn-fetch" data-asin="${asin}" onclick="fetchCatalog(this.dataset.asin, this)">Fetch</button>`;

        const fetchAttempts = Number(item.fetch_attempts || 0);
        const fetchBlocked = Boolean(item.fetch_blocked);
        const fetchTerminalCode = item.fetch_terminal_code || "";
        const fetchTerminalMessage = item.fetch_terminal_message || "";
        const maxAttempts = 5;
        let statusText = "";
        if (fetchTerminalCode === "NOT_FOUND") {
          const match = fetchTerminalMessage.match(/marketplace\s+([A-Z0-9]+)/i);
          const marketplaceLabel = match && match[1] ? match[1] : "";
          statusText = marketplaceLabel ? `Not found (${marketplaceLabel})` : "Not found";
        } else if (fetchBlocked) {
          statusText = `Blocked (${fetchAttempts}x)`;
        } else if (fetchAttempts > 0) {
          const capped = Math.min(fetchAttempts, maxAttempts);
          statusText = `Retrying (${capped}/${maxAttempts})`;
        }
        const tooltipSource = fetchTerminalMessage || item.fetch_last_error || "";
        const errorPreview = tooltipSource.slice(0, 120);
        const statusTitle = errorPreview ? ` title="${escapeAttr(errorPreview)}"` : "";
        const statusHtml = statusText
          ? `<div class="catalog-fetch-status"${statusTitle} style="font-size:12px;color:#b45309;">${statusText}</div>`
          : "";
        const resetLabel = fetchTerminalCode === "NOT_FOUND" ? "Force Retry" : "Reset";
        const resetButton = fetchBlocked || fetchTerminalCode
          ? `<button class="btn btn-sm btn-outline-secondary" style="margin-top:6px;" onclick="resetCatalogFetchAttempts('${asin}')">${resetLabel}</button>`
          : "";

        const asinSources = Array.isArray(item.asin_sources) ? item.asin_sources : [];
        const sourceBadges = asinSources
          .map(src => {
            const meta = CATALOG_SOURCE_LABELS[src] || null;
            if (!meta) return "";
            return `<span class="catalog-source-badge" title="${meta.title}">${meta.label}</span>`;
          })
          .filter(Boolean)
          .join("");
        const healthBadges = [];
        if (item.catalog_ready) {
          healthBadges.push('<span class="catalog-health-badge health-catalog" title="Title and image present">Catalog</span>');
        }
        if (item.barcode_ready) {
          healthBadges.push('<span class="catalog-health-badge health-barcode" title="Barcode present">Barcode</span>');
        }
        if (item.operationally_active) {
          healthBadges.push('<span class="catalog-health-badge health-operational" title="Active in realtime inventory or sales">Operational</span>');
        }
        if (item.dormant) {
          healthBadges.push('<span class="catalog-health-badge health-dormant" title="Terminal + no catalog or activity">Dormant</span>');
        }
        const sourceBadgesHtml = sourceBadges ? `<div>${sourceBadges}</div>` : "";
        const healthBadgesHtml = healthBadges.length ? `<div class="catalog-health-badges">${healthBadges.join("")}</div>` : "";
        const bucketBadgeHtml = item.bucket
          ? `<div class="catalog-bucket-badge" title="Catalog readiness bucket">${escapeHtml(item.bucket)}</div>`
          : "";
        const asinCellParts = [`<div>${asin}</div>`];
        if (sourceBadgesHtml) asinCellParts.push(sourceBadgesHtml);
        if (healthBadgesHtml) asinCellParts.push(healthBadgesHtml);
        if (bucketBadgeHtml) asinCellParts.push(bucketBadgeHtml);
        const asinCellHtml = asinCellParts.join("");

        return `<tr data-ean="${escapeAttr(eanValue)}" data-sku="${escapeAttr(rowSku)}" ondblclick="showCatalogDetails('${asin}')" oncontextmenu="openCatalogContextMenu(event, '${asin}')">
          <td>${asinCellHtml}</td>
          <td>${sku}</td>
          <td>${barcodeCell}</td>
          <td>${item.title || ""}</td>
          <td>${imageCell}</td>
          <td style="text-align:center;">
            <div style="display:inline-flex; gap:8px; align-items:center; justify-content:center;">
              ${fetchButton}
              <button class="btn btn-sm" style="background:#15803d; color:#fff;" title="Print this catalog row" onclick="barcodePrintFromRow(this)">Print</button>
            </div>
            ${statusHtml}
            ${resetButton}
          </td>
        </tr>`;
      }).join("");
    }

    function openCatalogContextMenu(event, asin) {
      if (activeTab !== "catalog") return;
      event.preventDefault();
      event.stopPropagation();
      const menu = document.getElementById("catalog-context-menu");
      if (!menu) return;
      catalogContextMenuAsin = asin;
      menu.dataset.asin = asin;
      menu.style.display = "block";
      const padding = 8;
      const rect = menu.getBoundingClientRect();
      let left = event.clientX;
      let top = event.clientY;
      if (left + rect.width > window.innerWidth - padding) {
        left = window.innerWidth - rect.width - padding;
      }
      if (top + rect.height > window.innerHeight - padding) {
        top = window.innerHeight - rect.height - padding;
      }
      menu.style.left = `${Math.max(padding, left)}px`;
      menu.style.top = `${Math.max(padding, top)}px`;
    }

    function closeCatalogContextMenu() {
      const menu = document.getElementById("catalog-context-menu");
      if (menu) {
        menu.style.display = "none";
        menu.dataset.asin = "";
      }
      catalogContextMenuAsin = null;
    }

    async function handleCatalogContextDelete() {
      const asin = catalogContextMenuAsin || (document.getElementById("catalog-context-menu")?.dataset?.asin || "").trim();
      if (!asin) {
        closeCatalogContextMenu();
        return;
      }
      const ok = confirm(`Delete ${asin} from Catalog Fetcher list?\nThis removes it only from Catalog Fetcher.`);
      if (!ok) {
        closeCatalogContextMenu();
        return;
      }
      try {
        const resp = await fetch(`/api/catalog/asins/${asin}`, { method: "DELETE" });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || data.ok === false) {
          const msg = data.detail || data.error || `HTTP ${resp.status}`;
          throw new Error(msg);
        }
        showToast(`Removed ${asin} from Catalog list`);
        await loadAsinList(true);
      } catch (err) {
        alert(`Failed to delete ${asin}: ${err?.message || err}`);
      } finally {
        closeCatalogContextMenu();
      }
    }

    document.addEventListener("click", (event) => {
      const menu = document.getElementById("catalog-context-menu");
      if (!menu || menu.style.display === "none") return;
      if (!menu.contains(event.target)) {
        closeCatalogContextMenu();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeCatalogContextMenu();
      }
    });

    async function fetchCatalog(asin, btnEl) {
      if (btnEl) {
        btnEl.disabled = true;
        btnEl.textContent = "Fetching...";
      }
      try {
        const resp = await fetch(`/api/catalog/fetch/${asin}`, { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        // Mark as fetched
        asinList = asinList.map(item => item.asin === asin ? { ...item, fetched: true } : item);
        filteredAsins = asinList;
        renderAsinList();
      } catch (err) {
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.textContent = "Fetch";
        }
        alert(`Failed to fetch catalog for ${asin}: ${err}`);
      }
    }

    async function resetCatalogFetchAttempts(asin) {
      try {
        const resp = await fetch(`/api/catalog/reset-fetch-attempts/${asin}`, { method: "POST" });
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        await loadAsinList(true);
        setCatalogResetStatus(`Reset attempts for ${asin}.`);
      } catch (err) {
        setCatalogResetStatus(`Reset failed for ${asin}.`);
      }
    }

    async function resetAllCatalogFetchAttempts() {
      if (!confirm("Reset fetch attempts for all ASINs?")) return;
      try {
        const resp = await fetch("/api/catalog/reset-fetch-attempts", { method: "POST" });
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        await loadAsinList(true);
        setCatalogResetStatus("All fetch attempts reset.");
      } catch (err) {
        setCatalogResetStatus("Reset all failed.");
      }
    }

    function setCatalogResetStatus(message) {
      const el = document.getElementById("catalog-reset-status");
      if (el) {
        el.textContent = message || "";
      }
    }

    function updateCatalogSummaryStrip() {
      const el = document.getElementById("catalog-coverage-summary");
      if (!el) return;
      const healthSummary = catalogHealthSummary;
      if (!healthSummary || !healthSummary.total_asins) {
        el.textContent = "Catalog: no ASINs loaded.";
        el.classList.add("muted-text");
        return;
      }
      el.classList.remove("muted-text");
      const total = Number(healthSummary.total_asins) || 0;
      const formatNumber = (val) => Number(val || 0).toLocaleString();
      const formatPercent = (count) => {
        if (!total) return "0%";
        const pct = (Number(count || 0) / total) * 100;
        return `${Math.round(pct)}%`;
      };
      const parts = [
        `Catalog: ${formatNumber(total)} ASINs`,
        `Catalog Ready ${formatPercent(healthSummary.catalog_ready_count || 0)}`,
        `Barcode Ready ${formatPercent(healthSummary.barcode_ready_count || 0)}`,
        `Commercial ${formatPercent(healthSummary.commercial_ready_count || 0)}`,
        `Operational ${formatPercent(healthSummary.operationally_active_count || 0)}`,
        `Dormant ${Number(healthSummary.dormant_count || 0)}`
      ];
      const bucketSummary = catalogBucketSummary;
      if (bucketSummary && bucketSummary.by_bucket) {
        const ordered = [];
        const seenValues = new Set();
        CATALOG_BUCKET_DEFS.forEach(def => {
          const count = bucketSummary.by_bucket?.[def.value] || 0;
          if (count) {
            ordered.push({ label: def.short, count });
            seenValues.add(def.value);
          }
        });
        Object.entries(bucketSummary.by_bucket || {}).forEach(([name, count]) => {
          if (!count || seenValues.has(name)) return;
          ordered.push({ label: name, count });
        });
        if (ordered.length) {
          const maxDisplay = ordered.length;
          const shown = ordered.slice(0, maxDisplay);
          const hidden = ordered.length - shown.length;
          const bucketParts = shown.map(item => `${item.label} ${formatNumber(item.count)}`);
          if (hidden > 0) {
            bucketParts.push(`+${hidden} more`);
          }
          parts.push(`Buckets: ${bucketParts.join(" | ")}`);
        }
      }
      el.textContent = parts.join(" | ");
    }

    async function editBarcode(asin, current) {
      if (!asin) return;
      const val = prompt("Enter barcode (12-digit UPC or 13-digit EAN)", current || "");
      if (val === null) return;
      const trimmed = (val || "").trim();
      if (!trimmed) return;
      if (!/^\d{12,13}$/.test(trimmed)) {
        alert("Barcode must be 12 or 13 digits (numeric).");
        return;
      }
      try {
        const resp = await fetch("/api/catalog/update-barcode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ asin, barcode: trimmed }),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          const msg = data.detail || `HTTP ${resp.status}`;
          alert(msg);
          return;
        }
        const data = await resp.json();
        const bcSpan = document.getElementById(`bc-${asin}`);
        if (bcSpan) bcSpan.textContent = data.barcode || trimmed;
        showToast("Barcode updated");
      } catch (err) {
        alert(`Failed to update barcode: ${err}`);
      }
    }

    function scheduleInitialAutoSync() {
      if (!nextAutoSyncAt) {
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
      }
      updateSyncInfo();
    }

    async function addManualAsin() {
      const input = document.getElementById("manual-asin-input");
      const msg = document.getElementById("manual-asin-msg");
      const asin = (input?.value || "").trim().toUpperCase();
      if (!asin) {
        if (msg) msg.textContent = "Please enter an ASIN.";
        return;
      }
      if (!/^[A-Z0-9]{10}$/.test(asin)) {
        if (msg) msg.textContent = "ASIN must be 10 letters/numbers.";
        return;
      }
      if (msg) msg.textContent = "Saving...";
      try {
        const resp = await fetch("/api/catalog/add-asin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ asin }),
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          const detail = data?.detail || data?.error || `HTTP ${resp.status}`;
          throw new Error(detail);
        }
      } catch (err) {
        if (msg) msg.textContent = "Could not save ASIN.";
        return;
      }

      if (input) input.value = "";
      if (msg) msg.textContent = "Added. Fetching catalog...";

      let fetchError = null;
      try {
        const resp = await fetch(`/api/catalog/fetch/${asin}`, { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
      } catch (err) {
        fetchError = err;
      }

      await loadAsinList(true);
      if (msg) {
        msg.textContent = fetchError
          ? "ASIN saved; fetch queued (check logs)."
          : "ASIN saved. Fetch queued.";
      }
    }

    async function autoSyncIfDue() {
      if (!nextAutoSyncAt) return;
      if (Date.now() < nextAutoSyncAt) return;
      try {
        const resp = await fetch("/api/vendor-pos/sync", { method: "POST" });
        let fetched = 0;
        if (resp.ok) {
          const data = await resp.json();
          fetched = data.fetched || 0;
        }
        await loadPOs(false);
        lastSyncTime = new Date();
        lastSyncFromSpapi = true;
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
        updateSyncInfo();
        const hh = String(lastSyncTime.getHours()).padStart(2, "0");
        const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
        showToast(`Sync completed at ${hh}:${mi}, ${fetched} POs updated.`);
      } catch (err) {
        console.error("Auto-sync failed", err);
      }
    }

    async function openPicklistPreview() {
      if (!selectedPoNumbers.length) return;
      try {
        const resp = await fetch("/api/picklist/preview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ purchaseOrderNumbers: selectedPoNumbers }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const summary = data.summary || {};
        const items = (data.items || []);
        items.sort((a, b) => (b.totalQty || 0) - (a.totalQty || 0));
        const modal = document.getElementById("picklist-modal");
        const body = document.getElementById("picklist-body");
        const summaryHtml = `
          <div style="margin-bottom:10px;">
            <div><strong>POs:</strong> ${selectedPoNumbers.length}</div>
            <div><strong>Lines:</strong> ${summary.totalLines || 0}</div>
            <div><strong>Total Units:</strong> ${summary.totalUnits || 0}</div>
            ${summary.warning ? `<div style="color:#b91c1c;">Warning: ${summary.warning}</div>` : ""}
          </div>
        `;
        const rows = items.map(it => {
          const isOos = it.isOutOfStock;
          const rowStyle = isOos ? 'style="opacity:0.6; background:#fff5f5;"' : '';
          const qtyStyle = isOos ? 'style="font-weight:700; text-align:center; color:#b91c1c; text-decoration:line-through;"' : 'style="font-weight:700; text-align:center;"';
          const asinStyle = isOos ? 'style="text-decoration:line-through; color:#666;"' : '';
          const img = it.image ? `<img src="${it.image}" alt="" style="max-width:80px;max-height:80px;object-fit:contain;border-radius:6px;${isOos ? 'opacity:0.5;' : ''}" />` : "";
          const sku = it.sku || it.externalId || "";
          const oosLabel = isOos ? ' <span style="color:#b91c1c; font-size:11px; font-weight:700;">[OOS]</span>' : '';
          return `<tr ${rowStyle}>
            <td ${asinStyle}>${it.asin || ""}${oosLabel}</td>
            <td>${sku}</td>
            <td>${img}</td>
            <td style="width:240px;">${it.title || ""}</td>
            <td ${qtyStyle}>${it.totalQty ?? ""}</td>
          </tr>`;
        }).join("");

        body.innerHTML = `
          ${summaryHtml}
          <div style="overflow:auto; max-height:60vh;">
            <table>
              <thead>
                <tr>
                  <th>ASIN</th>
                  <th>External ID</th>
                  <th style="width:120px;">Image</th>
                  <th style="width:240px;">Title</th>
                  <th>Total Qty</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="5" class="empty">No items</td></tr>'}
              </tbody>
            </table>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn" style="background:#111827" onclick="downloadPicklistPdf()">Download PDF</button>
            <button class="btn" onclick="closePicklistModal()">Close</button>
          </div>
        `;
        modal.style.display = "flex";
      } catch (err) {
        console.error("Failed to load picklist preview", err);
        alert(`Failed to load picklist preview: ${err}`);
      }
    }

    function closePicklistModal() {
      const modal = document.getElementById("picklist-modal");
      if (modal) modal.style.display = "none";
    }

    function downloadPicklistPdf() {
      if (!selectedPoNumbers.length) {
        alert("Please select at least one PO to generate a pick list.");
        return;
      }
      const poParam = encodeURIComponent(selectedPoNumbers.join(","));
      const url = `/api/picklist/pdf?poNumbers=${poParam}`;
      window.open(url, "_blank");
    }

    async function markItemOos(event, poNumber, asin, vendorSku, poDate, shipTo, qty, encodedImage) {
      event.preventDefault();
      if (!poNumber || !asin) return;
      const ok = confirm(`Mark this item as OUT OF STOCK?\nPO: ${poNumber}\nASIN: ${asin}`);
      if (!ok) return;
      const image = encodedImage ? decodeURIComponent(encodedImage) : null;
      try {
        await fetch("/api/oos-items/mark", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            poNumber,
            asin,
            vendorSku,
            purchaseOrderDate: poDate,
            shipToPartyId: shipTo,
            qty,
            image: image || null,
          }),
        });
        if (activeTab === "oos") {
          await loadOosItems();
        }
      } catch (err) {
        console.error("Failed to mark OOS", err);
        alert(`Failed to mark OOS: ${err}`);
      }
    }

    // ========================================
    // Vendor Real Time Sales functions
    // ========================================
    const RTS_LOOKBACK_STORAGE_KEY = "rtSalesLookbackHours";
    const RTS_VIEW_BY_STORAGE_KEY = "rtSalesViewBy";
    const RTS_SORT_STORAGE_KEY = "vendor_rt_sales_sort";

    function formatNumberWithCommas(num) {
      return (Math.round(num * 100) / 100).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Vendor Real Time Sales state
    let rtSalesData = [];
    let rtSalesCurrentViewBy = "asin";
    let rtSalesSortState = {
      column: null,
      direction: "asc"  // "asc" or "desc"
    };
    let rtSalesWindowMeta = null;
    let rtSalesCoverageMeta = null;
    let auditCalendarCache = [];
    let auditDayCache = {};
    let auditSelectedDate = null;

    // ========== Storage Handlers: Lookback ==========
    function saveRtSalesLookback() {
      const lookbackSelect = document.getElementById("rt-sales-lookback");
      if (lookbackSelect) {
        try {
          localStorage.setItem(RTS_LOOKBACK_STORAGE_KEY, lookbackSelect.value);
        } catch (e) {
          console.warn("Failed to save RT sales lookback:", e);
        }
      }
    }

    function loadRtSalesLookback() {
      const lookbackSelect = document.getElementById("rt-sales-lookback");
      if (lookbackSelect) {
        try {
          const saved = localStorage.getItem(RTS_LOOKBACK_STORAGE_KEY);
          if (saved) {
            lookbackSelect.value = saved;
          } else {
            lookbackSelect.value = "2";  // Default: 2 hours
          }
        } catch (e) {
          console.warn("Failed to load RT sales lookback:", e);
        }
      }
    }

    function onRtSalesLookbackChange() {
      saveRtSalesLookback();
      updateRtSalesWindowInfo();
      loadVendorRtSalesSummary();
    }

    // ========== Storage Handlers: View By ==========
    function saveRtSalesViewBy() {
      const viewBySelect = document.getElementById("rt-sales-view-by");
      if (viewBySelect) {
        try {
          localStorage.setItem(RTS_VIEW_BY_STORAGE_KEY, viewBySelect.value);
        } catch (e) {
          console.warn("Failed to save RT sales view-by:", e);
        }
      }
    }

    function loadRtSalesViewBy() {
      const viewBySelect = document.getElementById("rt-sales-view-by");
      if (viewBySelect) {
        try {
          const saved = localStorage.getItem(RTS_VIEW_BY_STORAGE_KEY);
          if (saved && (saved === "asin" || saved === "time")) {
            viewBySelect.value = saved;
          } else {
            viewBySelect.value = "asin";  // Default: ASIN
          }
        } catch (e) {
          console.warn("Failed to load RT sales view-by:", e);
        }
      }
    }

    function onRtSalesViewByChange() {
      saveRtSalesViewBy();
      const viewBySelect = document.getElementById("rt-sales-view-by");
      rtSalesCurrentViewBy = viewBySelect.value;
      // Reset sort state when switching view
      rtSalesSortState.column = null;
      rtSalesSortState.direction = "asc";
      loadVendorRtSalesSummary();
    }

    // ========== Window Info Label (UAE Time) ==========
    function updateRtSalesWindowInfo() {
      const infoEl = document.getElementById("rt-sales-window-info");
      if (!infoEl) return;

      if (
        rtSalesWindowMeta &&
        rtSalesWindowMeta.start_uae &&
        rtSalesWindowMeta.end_uae
      ) {
        const formatter = new Intl.DateTimeFormat("en-US", {
          timeZone: "Asia/Dubai",
          month: "short",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
        const start = new Date(rtSalesWindowMeta.start_uae);
        const end = new Date(rtSalesWindowMeta.end_uae);
        infoEl.textContent = `Window: ${formatter.format(start)} ‚Äî ${formatter.format(end)} UAE`;
        return;
      }

      const lookbackSelect = document.getElementById("rt-sales-lookback");
      if (!lookbackSelect) return;
      const lookbackHours = parseInt(lookbackSelect.value, 10);
      const now = new Date();
      
      // Calculate start time (trailing window)
      const endTime = new Date(now);
      const startTime = new Date(endTime.getTime() - lookbackHours * 60 * 60 * 1000);
      
      // Format times in UAE timezone
      const uaeFormatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'Asia/Dubai',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      
      const startStr = uaeFormatter.format(startTime);
      const endStr = uaeFormatter.format(endTime);
      
      infoEl.textContent = `Trailing ${lookbackHours} hours (${startStr} - ${endStr} UAE)`;
    }

    function updateRtSalesCoverageInfo() {
      const coverageEl = document.getElementById("rt-sales-coverage-info");
      if (!coverageEl) return;

      const coverage = rtSalesCoverageMeta;
      const totalHours = Number(coverage?.total_hours || 0);
      if (!coverage || totalHours === 0) {
        coverageEl.style.display = "none";
        coverageEl.textContent = "";
        return;
      }

      const okHours = Number(coverage.ok_hours || 0);
      const percent = Number(coverage.coverage_percent || 0).toFixed(2);
      let text = `Coverage: ${percent}% (${okHours}/${totalHours} hrs OK)`;
      const notices = [];
      if (coverage.missing_hours) {
        notices.push(`${coverage.missing_hours} missing`);
      }
      if (coverage.pending_hours) {
        notices.push(`${coverage.pending_hours} pending`);
      }
      if (notices.length) {
        text += ` ¬∑ ${notices.join(", ")}`;
      }
      coverageEl.textContent = text;
      coverageEl.style.display = "block";
    }

    // ========== Sync Status Monitoring ==========
    let rtSalesStatusIntervalId = null;
    const RT_LEDGER_FIELDS = {
      missing: "rt-ledger-missing",
      requested: "rt-ledger-requested",
      downloaded: "rt-ledger-downloaded",
      applied: "rt-ledger-applied",
      failed: "rt-ledger-failed",
    };

    function formatRelativeMinutes(targetIso, referenceIso) {
      if (!targetIso) return null;
      const targetTs = Date.parse(targetIso);
      const referenceTs = referenceIso ? Date.parse(referenceIso) : Date.now();
      if (Number.isNaN(targetTs) || Number.isNaN(referenceTs)) return null;
      const diffMs = targetTs - referenceTs;
      if (diffMs <= 0) return null;
      const minutes = Math.max(1, Math.round(diffMs / 60000));
      return minutes === 1 ? "1 min" : `${minutes} mins`;
    }

    function formatShortTime(iso) {
      if (!iso) return null;
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return null;
      return dt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function formatIsoDisplay(iso) {
      if (!iso) return "-";
      try {
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) {
          return iso;
        }
        return dt.toISOString().replace(".000Z", "Z");
      } catch (err) {
        return iso;
      }
    }

    function renderRtSalesLedgerSummary(summary) {
      const safeSummary = summary || {};
      Object.entries(RT_LEDGER_FIELDS).forEach(([key, elId]) => {
        const el = document.getElementById(elId);
        if (!el) return;
        const value = safeSummary[key];
        el.textContent = Number.isFinite(value) ? value : "-";
      });
      const lastAppliedEl = document.getElementById("rt-ledger-last-applied");
      if (lastAppliedEl) {
        lastAppliedEl.textContent = formatIsoDisplay(safeSummary.last_applied_hour_utc);
      }
      const nextClaimableEl = document.getElementById("rt-ledger-next-claimable");
      if (nextClaimableEl) {
        nextClaimableEl.textContent = formatIsoDisplay(safeSummary.next_claimable_hour_utc);
      }
    }

    async function updateRtSalesSyncStatus() {
      const statusEl = document.getElementById("rt-sales-sync-status");
      const cooldownPill = document.getElementById("rt-sales-cooldown-pill");
      const refreshBtn = document.getElementById("rt-sales-refresh-btn");
      if (!statusEl || !refreshBtn) return;

      const disabledNote = "Manual refresh disabled; use Audit ‚Üí Fill Day.";
      refreshBtn.disabled = true;
      refreshBtn.title = disabledNote;

      try {
        const resp = await fetch("/api/vendor/rt-sales/status");
        if (!resp.ok) {
          statusEl.textContent = `${disabledNote} Status: unavailable.`;
          statusEl.className = "rt-sales-status-label";
          if (cooldownPill) {
            cooldownPill.textContent = "Status unavailable";
            cooldownPill.className = "rt-sales-pill alert";
          }
          renderRtSalesLedgerSummary(null);
          return;
        }

        const data = await resp.json();
        const workerLock = data.worker_lock || {};
        const cooldown = data.cooldown || { active: false, reason: "none" };
        const ledgerSummary = data.ledger_summary || {};

        const lockHeld = Boolean(workerLock.held);
        const nowIso = data.now_utc || null;
        let lockLabel = "RT Sales: Idle";
        statusEl.className = "rt-sales-status-label rt-sales-status-idle";

        if (lockHeld) {
          const owner = workerLock.owner || "unknown";
          const expiresIn = formatRelativeMinutes(workerLock.expires_utc, nowIso);
          const suffix = expiresIn ? ` (expires in ${expiresIn})` : "";
          lockLabel = `RT Sales: Locked by ${owner}${suffix}`;
          statusEl.className = "rt-sales-status-label rt-sales-status-busy";
        } else if (cooldown.active && cooldown.reason === "quota") {
          lockLabel = "RT Sales: Cooldown active";
          statusEl.className = "rt-sales-status-label rt-sales-status-cooldown";
        }
        statusEl.textContent = `${lockLabel}. ${disabledNote}`;

        if (cooldownPill) {
          if (cooldown.active) {
            let pillText = cooldown.reason === "quota" ? "Cooldown due to SP-API quota" : "Waiting for worker lock";
            const untilTime = formatShortTime(cooldown.until_utc);
            if (untilTime) {
              pillText += ` (until ${untilTime})`;
            }
            cooldownPill.textContent = pillText;
            cooldownPill.className = "rt-sales-pill alert";
          } else {
            cooldownPill.textContent = "No cooldown active";
            cooldownPill.className = "rt-sales-pill";
          }
        }

        renderRtSalesLedgerSummary(ledgerSummary);
      } catch (err) {
        console.error("[VendorRtSummary] Failed to update sync status", err);
        statusEl.textContent = `${disabledNote} Status inconclusive.`;
        statusEl.className = "rt-sales-status-label";
        if (cooldownPill) {
          cooldownPill.textContent = "Status unavailable";
          cooldownPill.className = "rt-sales-pill alert";
        }
        renderRtSalesLedgerSummary(null);
      }
    }

    function startRtSalesStatusPolling() {
      // Clear any existing interval
      if (rtSalesStatusIntervalId !== null) {
        clearInterval(rtSalesStatusIntervalId);
      }
      // Poll every 30 seconds
      updateRtSalesSyncStatus(); // Initial update
      rtSalesStatusIntervalId = setInterval(updateRtSalesSyncStatus, 30000);
    }

    function stopRtSalesStatusPolling() {
      if (rtSalesStatusIntervalId !== null) {
        clearInterval(rtSalesStatusIntervalId);
        rtSalesStatusIntervalId = null;
      }
    }

    function saveRtSalesSortState() {
      try {
        localStorage.setItem(RTS_SORT_STORAGE_KEY, JSON.stringify(rtSalesSortState));
      } catch (e) {
        console.warn("Failed to save sort state to localStorage", e);
      }
    }

    function loadRtSalesSortState() {
      try {
        const stored = localStorage.getItem(RTS_SORT_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          rtSalesSortState.column = parsed.column || null;
          rtSalesSortState.direction = parsed.direction || "asc";
        }
      } catch (e) {
        console.warn("Failed to load sort state from localStorage", e);
      }
    }

    function updateRtSalesArrows() {
      // Clear all arrows
      const arrows = [
        "rt-sales-sort-asin",
        "rt-sales-sort-units",
        "rt-sales-sort-revenue",
        "rt-sales-sort-bucket-time",
        "rt-sales-sort-time-units",
        "rt-sales-sort-time-revenue"
      ];
      arrows.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = "";
      });

      // Update relevant arrow based on current sort
      if (rtSalesCurrentViewBy === "asin") {
        if (rtSalesSortState.column === "asin") {
          document.getElementById("rt-sales-sort-asin").textContent = rtSalesSortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
        } else if (rtSalesSortState.column === "units") {
          document.getElementById("rt-sales-sort-units").textContent = rtSalesSortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
        } else if (rtSalesSortState.column === "revenue") {
          document.getElementById("rt-sales-sort-revenue").textContent = rtSalesSortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
        }
      } else if (rtSalesCurrentViewBy === "time") {
        if (rtSalesSortState.column === "bucket_time") {
          document.getElementById("rt-sales-sort-bucket-time").textContent = rtSalesSortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
        } else if (rtSalesSortState.column === "units") {
          document.getElementById("rt-sales-sort-time-units").textContent = rtSalesSortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
        } else if (rtSalesSortState.column === "revenue") {
          document.getElementById("rt-sales-sort-time-revenue").textContent = rtSalesSortState.direction === "asc" ? "‚ñ≤" : "‚ñº";
        }
      }
    }

    function onRtSalesHeaderClick(column) {
      // If clicking the same column, toggle direction
      if (rtSalesSortState.column === column) {
        rtSalesSortState.direction = rtSalesSortState.direction === "asc" ? "desc" : "asc";
      } else {
        // New column, set default direction
        rtSalesSortState.column = column;
        // For time, default to desc (newest first); for others, desc for numeric
        rtSalesSortState.direction = (column === "asin" || column === "bucket_time") ? "asc" : "desc";
      }

      saveRtSalesSortState();
      sortRtSalesTable(column);
    }

    function sortRtSalesTable(column) {
      if (!rtSalesData || rtSalesData.length === 0) {
        renderRtSalesTable(rtSalesData);
        return;
      }

      // Sort the data
      const sorted = [...rtSalesData].sort((a, b) => {
        let aVal, bVal;

        if (rtSalesCurrentViewBy === "asin") {
          // ASIN view sorting
          if (column === "asin") {
            aVal = a.asin.toLowerCase();
            bVal = b.asin.toLowerCase();
            const cmp = aVal.localeCompare(bVal);
            return rtSalesSortState.direction === "asc" ? cmp : -cmp;
          } else if (column === "units") {
            aVal = parseFloat(a.units) || 0;
            bVal = parseFloat(b.units) || 0;
          } else if (column === "revenue") {
            aVal = parseFloat(a.revenue) || 0;
            bVal = parseFloat(b.revenue) || 0;
          }
        } else if (rtSalesCurrentViewBy === "time") {
          // Time view sorting
          if (column === "bucket_time") {
            aVal = a.bucket_start_utc;
            bVal = b.bucket_start_utc;
            const cmp = aVal.localeCompare(bVal);
            return rtSalesSortState.direction === "asc" ? cmp : -cmp;
          } else if (column === "units") {
            aVal = parseFloat(a.units) || 0;
            bVal = parseFloat(b.units) || 0;
          } else if (column === "revenue") {
            aVal = parseFloat(a.revenue) || 0;
            bVal = parseFloat(b.revenue) || 0;
          }
        }

        // Numeric comparison
        if (rtSalesSortState.direction === "asc") {
          return aVal - bVal;
        } else {
          return bVal - aVal;
        }
      });

      updateRtSalesArrows();
      renderRtSalesTable(sorted);
    }

    function renderRtSalesTable(data) {
      // Show/hide appropriate table based on view_by
      const asinTable = document.getElementById("rt-sales-asin-table");
      const timeTable = document.getElementById("rt-sales-time-table");
      const tableTitle = document.getElementById("rt-sales-table-title");

      if (rtSalesCurrentViewBy === "asin") {
        asinTable.style.display = "table";
        timeTable.style.display = "none";
        tableTitle.textContent = "Top ASINs";
        renderAsinTable(data);
      } else if (rtSalesCurrentViewBy === "time") {
        asinTable.style.display = "none";
        timeTable.style.display = "table";
        tableTitle.textContent = "Sales by Time";
        renderTimeTable(data);
      }
    }

    function renderAsinTable(data) {
      const tbody = document.getElementById("rt-sales-top-asins-rows");
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(asin_row => {
        const imageHtml = asin_row.imageUrl
          ? `<img src="${asin_row.imageUrl}" alt="${asin_row.asin}" class="rt-summary-asin-image" loading="eager" decoding="sync" />`
          : '‚Äî';
        return `
          <tr style="cursor:pointer;" onclick="openRtSalesAsinDetail('${asin_row.asin}')">
            <td><strong>${asin_row.asin}</strong></td>
            <td style="text-align:center;">${imageHtml}</td>
            <td style="text-align:right;"><strong>${(asin_row.units || 0).toLocaleString()}</strong></td>
            <td style="text-align:right;"><strong>${asin_row.currency_code ? asin_row.currency_code + ' ' : ''}${formatNumberWithCommas(asin_row.revenue || 0)}</strong></td>
          </tr>
        `;
      }).join("");
    }

    function renderTimeTable(data) {
      const tbody = document.getElementById("rt-sales-time-rows");
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(time_row => {
        // Parse UAE start time for display
        let uaeDateStr = time_row.bucket_start_uae;
        try {
          const dt = new Date(uaeDateStr);
          // Extract just time part HH:MM in UAE
          const uaeTime = dt.toLocaleTimeString('en-US', {
            timeZone: 'Asia/Dubai',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
          // Get date
          const uaeDate = dt.toLocaleDateString('en-US', {
            timeZone: 'Asia/Dubai',
            month: '2-digit',
            day: '2-digit'
          });
          uaeDateStr = `${uaeDate} ${uaeTime} UAE`;
        } catch (e) {
          // Fallback
          uaeDateStr = time_row.bucket_start_uae;
        }

        return `
          <tr>
            <td><strong>${uaeDateStr}</strong></td>
            <td style="text-align:right;"><strong>${(time_row.units || 0).toLocaleString()}</strong></td>
            <td style="text-align:right;"><strong>${time_row.currency_code ? time_row.currency_code + ' ' : ''}${formatNumberWithCommas(time_row.revenue || 0)}</strong></td>
          </tr>
        `;
      }).join("");
    }

    async function refreshVendorRtSales() {
      console.warn("[VendorRtSummary] Manual refresh is disabled; use Audit ‚Üí Fill Day.");
      await updateRtSalesSyncStatus();
    }

    async function loadVendorRtSalesSummary() {
      try {
        const lookbackHours = parseInt(document.getElementById("rt-sales-lookback").value, 10);
        const viewBy = document.getElementById("rt-sales-view-by").value;
        rtSalesCurrentViewBy = viewBy;

        let params = `?lookback_hours=${lookbackHours}&view_by=${viewBy}`;

        // Read-only summary fetch; repairs run through Audit ‚Üí Fill Day.
        const resp = await fetch("/api/vendor-realtime-sales/summary" + params);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();
        rtSalesWindowMeta = data.window || null;
        rtSalesCoverageMeta = data.coverage || null;

        updateRtSalesWindowInfo();
        updateRtSalesCoverageInfo();

        // Update summary cards
        document.getElementById("rt-sales-total-units").textContent = (data.total_units || 0).toLocaleString();
        document.getElementById("rt-sales-total-revenue").textContent =
          `${data.currency_code} ${formatNumberWithCommas(data.total_revenue || 0)}`;

        let rows = Array.isArray(data.rows) ? data.rows.slice() : [];

        // Store data for sorting
        if (!rows.length) {
          rtSalesData = [];
          updateRtSalesArrows();
          renderRtSalesTable([]);
          return;
        }

        rtSalesData = rows;

        // Load saved sort state from localStorage
        loadRtSalesSortState();
        
        // Update arrows to show current state
        updateRtSalesArrows();

        // Apply saved sort if one exists
        if (rtSalesSortState.column) {
          sortRtSalesTable(rtSalesSortState.column);
        } else {
          // No saved sort, default sort by:
          // - ASIN view: units descending
          // - Time view: time descending (newest first)
          if (viewBy === "time") {
            rtSalesSortState.column = "bucket_time";
            rtSalesSortState.direction = "desc";
          } else {
            rtSalesSortState.column = "units";
            rtSalesSortState.direction = "desc";
          }
          sortRtSalesTable(rtSalesSortState.column);
        }
      } catch (err) {
        console.error("Failed to load RT sales summary:", err);
        rtSalesWindowMeta = null;
        rtSalesCoverageMeta = null;
        updateRtSalesWindowInfo();
        updateRtSalesCoverageInfo();
        renderRtSalesTable([]);
        const tbody = rtSalesCurrentViewBy === "asin" 
          ? document.getElementById("rt-sales-top-asins-rows")
          : document.getElementById("rt-sales-time-rows");
        if (tbody) tbody.innerHTML = `<tr><td colspan="${rtSalesCurrentViewBy === 'asin' ? 4 : 3}" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    async function openRtSalesAsinDetail(asin) {
      // This function is only for ASIN view; get the window params
      try {
        const lookbackHours = parseInt(document.getElementById("rt-sales-lookback").value, 10);
        let params = `?lookback_hours=${lookbackHours}`;

        const resp = await fetch(`/api/vendor-realtime-sales/asin/${encodeURIComponent(asin)}` + params);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();

        // Show detail panel
        document.getElementById("rt-sales-asin-detail-title").textContent = asin;
        const tbody = document.getElementById("rt-sales-asin-detail-rows");

        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty">No hourly data for this ASIN in selected window</td></tr>';
        } else {
          tbody.innerHTML = data.data.map(row => `
            <tr>
              <td>${row.hour_start_utc}</td>
              <td style="text-align:right;">${(row.ordered_units || 0).toLocaleString()}</td>
              <td style="text-align:right;">${formatNumberWithCommas(row.ordered_revenue || 0)}</td>
            </tr>
          `).join("");
        }

        document.getElementById("rt-sales-asin-detail").style.display = "block";
      } catch (err) {
        alert("Failed to load ASIN detail: " + err.message);
      }
    }

    function closeRtSalesAsinDetail() {
      document.getElementById("rt-sales-asin-detail").style.display = "none";
      document.getElementById("rt-sales-asin-detail-rows").innerHTML = '<tr><td colspan="3" class="empty">‚Äî</td></tr>';
    }

    // Initialize RT Sales preferences on page load
    function initRtSalesTab() {
      loadRtSalesLookback();
      loadRtSalesViewBy();
      loadRtSalesSortState();
      updateRtSalesWindowInfo();
    }

    // ========================================
    // Vendor Inventory Functions
    // ========================================

    function setInventoryStatus(text, color = '') {
      const statusEl = document.getElementById('inv-status-label');
      if (!statusEl) return;
      statusEl.textContent = text || '';
      statusEl.style.color = color || '';
    }

    function formatInventoryAsOf(meta) {
      if (!meta) return null;
      if (meta.as_of_uae) {
        return `${meta.as_of_uae}`;
      }
      if (meta.as_of) {
        const asOfDate = new Date(meta.as_of);
        if (!Number.isNaN(asOfDate.getTime())) {
          return asOfDate.toLocaleString(undefined, { hour12: false });
        }
        return meta.as_of;
      }
      return null;
    }

    function updateInventoryFreshnessLabel(meta) {
      const labelEl = document.getElementById('inv-week-label');
<<<<<<< HEAD
      const coverageEl = document.getElementById('inv-coverage-label');
      const coverageWhyEl = document.getElementById('inv-coverage-why');
=======
>>>>>>> origin/main
      if (!labelEl) return;
      const metaSafe = vendorInventoryMeta || meta || {};
      const count = Array.isArray(vendorInventorySnapshot) ? vendorInventorySnapshot.length : 0;
      const asOfLabel = formatInventoryAsOf({
<<<<<<< HEAD
        as_of: realtimeMeta.as_of || realtimeMeta.generated_at,
        as_of_uae: realtimeMeta.as_of_uae,
      });
      const coverageLabel = realtimeMeta.coverage_label;
      const scopeExplanation = realtimeMeta.inventory_scope_explanation;
      if (coverageEl) {
        if (coverageLabel) {
          const parts = [coverageLabel];
          if (scopeExplanation) {
            parts.push(scopeExplanation);
          }
          coverageEl.textContent = parts.join(' - ');
          coverageEl.style.display = 'block';
          if (coverageWhyEl) coverageWhyEl.style.display = 'inline-flex';
        } else {
          coverageEl.textContent = '';
          coverageEl.style.display = 'none';
          if (coverageWhyEl) coverageWhyEl.style.display = 'none';
        }
      }
      let labelParts = [`Real-Time | Loaded ${count} ASINs`];
      if (windowStart || windowEnd) {
        const windowSegments = [];
        if (windowStart) windowSegments.push(windowStart);
        if (windowEnd) windowSegments.push(windowEnd);
        const windowText = windowSegments.length === 2 ? `${windowSegments[0]} -> ${windowSegments[1]}` : windowSegments.join('');
        labelParts.push(`Window: ${windowText}`);
      } else if (asOfLabel) {
        labelParts.push(`As of ${asOfLabel}`);
      }
      labelEl.textContent = labelParts.join(' | ');
=======
        as_of: metaSafe.as_of_utc || metaSafe.as_of,
        as_of_uae: metaSafe.as_of_uae,
      }) || metaSafe.as_of_utc || '‚Äî';
      labelEl.textContent = `Accumulated Inventory | Loaded ${count} ASINs | As of ${asOfLabel}`;
>>>>>>> origin/main
    }

    function updateInventoryModeButtons() {
      const realtimeBtn = document.getElementById('inventory-toggle-realtime');
      if (realtimeBtn) {
        realtimeBtn.classList.add('active');
      }
    }

    function setInventoryMode(mode) {
      if (mode !== 'realtime' || inventoryMode === 'realtime') return;
      inventoryMode = 'realtime';
      updateInventoryModeButtons();
      updateInventoryRefreshButtonState();
      loadInventorySnapshotIfNeeded();
    }


    function updateInventoryRefreshButtonState() {
      const refreshBtn = document.getElementById('inv-refresh-btn');
      if (!refreshBtn) return;
      const refreshRunning = !!(
        vendorInventoryMeta?.refresh_in_progress || vendorInventoryMeta?.refresh?.in_progress
      );
      if (invRealtimeRefreshInFlight || refreshRunning) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = refreshRunning ? 'Refresh running‚Ä¶' : 'Refreshing inventory‚Ä¶';
      } else {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'Refresh Inventory';
      }
    }

    function stopInventoryRefreshPolling() {
      inventoryRefreshPollingActive = false;
      if (inventoryRefreshPollTimer) {
        clearTimeout(inventoryRefreshPollTimer);
        inventoryRefreshPollTimer = null;
      }
    }

    function startInventoryRefreshPolling({ immediate = false } = {}) {
      if (inventoryRefreshPollingActive) return;
      inventoryRefreshPollingActive = true;
      const poll = () => {
        fetchRealtimeInventorySnapshot({ silent: true, force: true }).finally(() => {
          if (!inventoryRefreshPollingActive) {
            inventoryRefreshPollTimer = null;
            return;
          }
          inventoryRefreshPollTimer = setTimeout(poll, INVENTORY_REFRESH_POLL_INTERVAL_MS);
        });
      };
      if (immediate) {
        poll();
      } else {
        inventoryRefreshPollTimer = setTimeout(poll, INVENTORY_REFRESH_POLL_INTERVAL_MS);
      }
    }

    function updateInventoryFreshnessUi(meta, { clearStatusWhenFresh = false } = {}) {
      updateInventoryModeButtons();
      updateInventoryFreshnessLabel(meta);
      const refreshRunning = !!(meta?.refresh_in_progress || meta?.refresh?.in_progress);
      if (refreshRunning) {
        setInventoryStatus('Refresh in progress‚Ä¶');
        inventoryAutoRefreshRequested = true;
        updateInventoryRefreshButtonState();
        startInventoryRefreshPolling({ immediate: true });
        return;
      }

      stopInventoryRefreshPolling();
      updateInventoryRefreshButtonState();
      inventoryAutoRefreshRequested = false;
      if (clearStatusWhenFresh) {
        setInventoryStatus('');
      }
    }

<<<<<<< HEAD
    function openInventoryCoverageModal() {
      const modal = document.getElementById('inventory-coverage-modal');
      const body = document.getElementById('inventory-coverage-body');
      if (!modal || !body) return;

      const meta = vendorInventoryMeta || realtimeInventoryMeta || {};
      const refreshMeta = meta.refresh || {};

      const uniqueCount = Number.isFinite(meta.unique_count) ? meta.unique_count : null;
      const catalogCount = Number.isFinite(meta.catalog_asin_count) ? meta.catalog_asin_count : null;
      const coverageRatio = Number.isFinite(meta.coverage_ratio) ? meta.coverage_ratio : null;

      const windowStart =
        meta.window_start_uae ||
        meta.report_window_start_uae ||
        meta.window_start_local ||
        meta.window_start_utc ||
        meta.report_window_start_utc ||
        meta.window_start ||
        refreshMeta.window_start_uae ||
        refreshMeta.report_window_start_uae ||
        refreshMeta.window_start_local ||
        refreshMeta.window_start_utc ||
        refreshMeta.report_window_start_utc ||
        refreshMeta.window_start;

      const windowEnd =
        meta.window_end_uae ||
        meta.report_window_end_uae ||
        meta.window_end_local ||
        meta.window_end_utc ||
        meta.report_window_end_utc ||
        meta.window_end ||
        refreshMeta.window_end_uae ||
        refreshMeta.report_window_end_uae ||
        refreshMeta.window_end_local ||
        refreshMeta.window_end_utc ||
        refreshMeta.report_window_end_utc ||
        refreshMeta.window_end;

      const asOfUae = meta.as_of_uae || refreshMeta.as_of_uae || null;

      const fmtNumber = (val) => (Number.isFinite(val) ? val.toLocaleString() : '‚Äî');
      const fmtPercent = (val) => (Number.isFinite(val) ? `${(val * 100).toFixed(1)}%` : '‚Äî');
      const fmtText = (val) => (val ? String(val) : '‚Äî');

      body.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; font-size:13px; color:#111827;">
          <div>Realtime inventory comes from <strong>GET_VENDOR_REAL_TIME_INVENTORY_REPORT</strong>.</div>
          <div>Amazon includes only ASINs present in that report window; Vendor Central exports can contain more ASINs.</div>
          <div>We intentionally prune vendor_inventory_asin to the latest snapshot so the DB matches what the UI shows.</div>
          <div style="border:1px solid var(--border); border-radius:10px; padding:10px; background:#f8fafc;">
            <div style="font-weight:700; margin-bottom:8px;">Current snapshot metrics</div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:8px;">
              <div><span class="muted-text">Unique ASINs in snapshot:</span> ${fmtNumber(uniqueCount)}</div>
              <div><span class="muted-text">Catalog ASINs (known):</span> ${fmtNumber(catalogCount)}</div>
              <div><span class="muted-text">Coverage ratio:</span> ${fmtPercent(coverageRatio)}</div>
              <div><span class="muted-text">Report start:</span> ${fmtText(windowStart)}</div>
              <div><span class="muted-text">Report end:</span> ${fmtText(windowEnd)}</div>
              <div><span class="muted-text">As of (UAE):</span> ${fmtText(asOfUae)}</div>
            </div>
          </div>
        </div>
      `;

      modal.style.display = 'flex';
    }

    function closeInventoryCoverageModal() {
      const modal = document.getElementById('inventory-coverage-modal');
      if (modal) modal.style.display = 'none';
    }
=======
>>>>>>> origin/main

    function loadInventorySnapshotIfNeeded(forceReload = false) {
      if (!forceReload && vendorInventorySnapshot.length > 0) {
        updateInventoryFreshnessUi(vendorInventoryMeta);
        renderVendorInventoryCurrentSubtab();
        return;
      }
      fetchRealtimeInventorySnapshot({ force: forceReload });
    }

    function fetchRealtimeInventorySnapshot({ silent = false, force = false } = {}) {
      const now = Date.now();
      if (inventoryFetchInFlight) {
        return inventoryFetchPromise || Promise.resolve();
      }
      if (!force && now - lastRealtimeFetchAt < INVENTORY_FETCH_DEBOUNCE_MS) {
        return Promise.resolve();
      }
      if (!silent) {
        setInventoryStatus('Loading inventory‚Ä¶');
      }
      inventoryFetchInFlight = true;
      const request = fetch('/api/vendor-inventory/realtime/accumulated')
        .then((resp) => {
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return resp.json();
        })
        .then((data) => {
          applyRealtimeInventoryPayload(data, { silent });
          lastRealtimeFetchAt = Date.now();
        })
        .catch((err) => {
          console.error(err);
          setInventoryStatus('Failed to load inventory: ' + (err?.message || err), '#b91c1c');
          vendorInventorySnapshot = [];
          vendorInventoryMeta = null;
          renderVendorInventoryCurrentSubtab();
        })
        .finally(() => {
          inventoryFetchInFlight = false;
          inventoryFetchPromise = null;
        });
      inventoryFetchPromise = request;
      return request;
    }

    function applyRealtimeInventoryPayload(data, { silent = false } = {}) {
      const rows = Array.isArray(data?.rows) ? data.rows : Array.isArray(data?.items) ? data.items : [];
      const refreshMeta = data?.refresh || {};
      const asOfUtc = data?.as_of_utc || data?.as_of || data?.generated_at || null;
      const meta = {
        as_of: asOfUtc,
        as_of_utc: asOfUtc,
        as_of_uae: data?.as_of_uae || null,
        stale_hours: Number.isFinite(data?.stale_hours) ? Number(data.stale_hours) : null,
        generated_at: data?.generated_at || null,
        refresh_in_progress: Boolean(data?.refresh_in_progress || refreshMeta?.in_progress),
        refresh: refreshMeta,
        count: Number.isFinite(data?.count) ? Number(data.count) : rows.length,
      };
      vendorInventorySnapshot = rows.slice();
      vendorInventoryMeta = meta;
      if (!silent) {
        setInventoryStatus(`Loaded ${rows.length} ASINs`);
      }
      updateInventoryFreshnessUi(meta, { clearStatusWhenFresh: silent });
      renderVendorInventoryCurrentSubtab();
      updateInventoryRefreshButtonState();
    }

    function refreshRealtimeInventorySnapshot(options = {}) {
      const { silent = false, force = false } = options;
      if (invRealtimeRefreshInFlight) {
        return;
      }
      invRealtimeRefreshInFlight = true;
      updateInventoryRefreshButtonState();
      if (!silent) {
        setInventoryStatus(force ? 'Force refreshing inventory‚Ä¶' : 'Refreshing inventory‚Ä¶');
      }

      fetch('/api/vendor-inventory/realtime/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      })
        .then((resp) => {
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return resp.json();
        })
        .then((data) => {
          if (data?.status === 'error' || data?.status === 'quota_error') {
            const message = data?.error || 'Refresh failed';
            setInventoryStatus('Failed to refresh inventory: ' + message, '#b91c1c');
            return;
          }
          if (data?.status === 'skipped') {
            setInventoryStatus('Force refresh skipped (cooldown active)', '#b45309');
            return;
          }
          applyRealtimeInventoryPayload(data, { silent });
        })
        .catch((err) => {
          console.error(err);
          if (!silent) {
            setInventoryStatus('Error refreshing inventory: ' + (err?.message || err), '#b91c1c');
          } else {
            inventoryAutoRefreshRequested = false;
          }
        })
        .finally(() => {
          invRealtimeRefreshInFlight = false;
          updateInventoryRefreshButtonState();
        });
    }

    function refreshCurrentInventorySnapshot(options = {}) {
      refreshRealtimeInventorySnapshot(options);
    }

    function setInventorySubtab(subtab) {
      currentInventorySubtab = subtab;

      const buttons = [
        'inv-subtab-snapshot',
        'inv-subtab-aged',
        'inv-subtab-unhealthy',
      ];

      buttons.forEach((id) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        if (
          (subtab === 'snapshot' && id === 'inv-subtab-snapshot') ||
          (subtab === 'aged' && id === 'inv-subtab-aged') ||
          (subtab === 'unhealthy' && id === 'inv-subtab-unhealthy')
        ) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      renderVendorInventoryCurrentSubtab();
    }

    function renderVendorInventoryCurrentSubtab() {
      if (currentInventorySubtab === 'aged') {
        renderVendorInventoryTable('aged');
      } else if (currentInventorySubtab === 'unhealthy') {
        renderVendorInventoryTable('unhealthy');
      } else {
        renderVendorInventoryTable('snapshot');
      }
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function getCatalogRowsArray() {
      if (Array.isArray(filteredAsins) && filteredAsins.length) {
        return filteredAsins;
      }
      return Array.isArray(filteredAsins) ? filteredAsins : [];
    }

    function getCatalogAsinMap() {
      const rows = getCatalogRowsArray();
      if (catalogAsinMapCache && catalogAsinMapKey === rows) {
        return catalogAsinMapCache;
      }
      const map = new Map();
      if (Array.isArray(rows)) {
        rows.forEach((item) => {
          const key = (item?.asin || '').trim().toUpperCase();
          if (key) {
            map.set(key, item);
          }
        });
      }
      catalogAsinMapCache = map;
      catalogAsinMapKey = rows;
      return map;
    }

    function getCatalogItemForAsin(asin) {
      if (!asin) return null;
      const map = getCatalogAsinMap();
      return map.get(asin.trim().toUpperCase()) || null;
    }

    function getInventoryDisplayTitle(row) {
      const asin = row?.asin || '';
      const catalogItem = getCatalogItemForAsin(asin);
      return (
        catalogItem?.title ||
        catalogItem?.product_title ||
        catalogItem?.name ||
        catalogItem?.productTitle ||
        row?.title ||
        row?.product_title ||
        ''
      );
    }

    function getInventoryImageUrl(row) {
      const asin = row?.asin || '';
      const catalogItem = getCatalogItemForAsin(asin);
      const candidates = [
        catalogItem?.image,
        catalogItem?.image_url,
        catalogItem?.imageUrl,
        catalogItem?.img,
        catalogItem?.main_image,
        catalogItem?.mainImage,
        row?.image_url,
        row?.image,
      ];
      for (const candidate of candidates) {
        if (typeof candidate === 'string') {
          const trimmed = candidate.trim();
          if (trimmed && /^https?:/i.test(trimmed)) {
            return trimmed;
          }
        }
      }
      return '';
    }

    function getSales30dValue(row) {
      const value = row?.sales_30d;
      if (value === null || value === undefined) return 0;
      const num = Number(value);
      return Number.isFinite(num) ? num : 0;
    }

    function parseInventoryTimestamp(row) {
      if (!row) return null;
      const fields = [
        'last_end_time',
        'lastEndTime',
        'updated_at',
        'updatedAt',
        'endTime',
        'endDateTime',
        'endDate',
        'intervalEndTime',
        'startTime',
        'startDateTime',
        'startDate',
        'intervalStartTime',
      ];
      for (const field of fields) {
        const value = row[field];
        if (typeof value === 'string' && value.trim()) {
          const ts = Date.parse(value);
          if (!Number.isNaN(ts)) {
            return ts;
          }
        }
      }
      return null;
    }

    function dedupeInventoryRowsByAsin(rows) {
      if (!Array.isArray(rows) || rows.length <= 1) return rows;
      const map = new Map();
      rows.forEach((row) => {
        const asin = (row?.asin || '').trim();
        if (!asin) return;
        const existing = map.get(asin);
        const currentTs = parseInventoryTimestamp(row);
        if (!existing) {
          map.set(asin, { row, ts: currentTs });
          return;
        }
        if (currentTs === null && existing.ts === null) {
          return;
        }
        if (currentTs !== null && (existing.ts === null || currentTs >= existing.ts)) {
          map.set(asin, { row, ts: currentTs });
        }
      });
      return Array.from(map.values()).map((entry) => entry.row);
    }

    function buildInventoryRowsUnionWithCatalog(inventoryRows) {
      const rows = Array.isArray(inventoryRows) ? inventoryRows : [];
      const inventoryMap = new Map();
      rows.forEach((row) => {
        const asin = (row?.asin || '').trim();
        if (!asin) return;
        inventoryMap.set(asin.toUpperCase(), row);
      });

      const finalRows = [];
      const catalogRows = getCatalogRowsArray();
      if (Array.isArray(catalogRows)) {
        catalogRows.forEach((item) => {
          const asin = (item?.asin || '').trim();
          if (!asin) return;
          const key = asin.toUpperCase();
          const existing = inventoryMap.get(key);
          if (existing) {
            finalRows.push(existing);
            inventoryMap.delete(key);
          } else {
            finalRows.push({
              asin,
              sellable: 0,
              sales_30d: null,
            });
          }
        });
      }

      inventoryMap.forEach((row) => {
        finalRows.push(row);
      });

      if (typeof console !== 'undefined' && console.log) {
        console.log('[InventoryUnion]', {
          inventoryCount: rows.length,
          unionCount: finalRows.length,
          catalogCount: Array.isArray(catalogRows) ? catalogRows.length : 0,
        });
      }

      return finalRows;
    }

    function sortInventoryTableBy(col) {
      if (invSortColumn === col) {
        invSortDirection = invSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        invSortColumn = col;
        invSortDirection = 'desc';
      }
      renderVendorInventoryCurrentSubtab();
    }

    function setQuickFilter(f) {
      invQuickFilter = f;
      const buttons = ['inv-qf-all', 'inv-qf-zero'];
      buttons.forEach((id) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        const isActive =
          (f === 'all' && id === 'inv-qf-all') ||
          (f === 'zero' && id === 'inv-qf-zero');
        btn.classList.toggle('active', isActive);
      });
      renderVendorInventoryCurrentSubtab();
    }

    function renderVendorInventoryTable(mode) {
      const headEl = document.getElementById('inv-table-head');
      const bodyEl = document.getElementById('inv-table-body');
      const footEl = document.getElementById('inv-table-foot');

      if (!headEl || !bodyEl || !footEl) return;

      let rows = vendorInventorySnapshot || [];
      rows = dedupeInventoryRowsByAsin(rows);

      const getSellableUnits = (row) => {
        const candidates = [
          row.sellable,
          row.sellable_onhand_units,
          row.sellableOnHandInventoryUnits,
        ];
        for (const value of candidates) {
          if (value !== undefined && value !== null) {
            const num = Number(value);
            if (!Number.isNaN(num)) {
              return num;
            }
          }
        }
        return 0;
      };

      // Filter per subtab
      if (mode === 'aged') {
        rows = rows.filter((r) => {
          const aged = r.aged90plus_sellable_units ?? r.aged90PlusDaysSellableInventoryUnits ?? 0;
          return aged > 0;
        });
      } else if (mode === 'unhealthy') {
        rows = rows.filter((r) => {
          const unhealthy = r.unhealthy_units ?? r.unhealthyInventoryUnits ?? 0;
          return unhealthy > 0;
        });
      }

      // Search filter
      const q = (document.getElementById('inv-search')?.value || '').toLowerCase();
      if (q) {
        rows = rows.filter((r) =>
          (r.asin || '').toLowerCase().includes(q) ||
          getInventoryDisplayTitle(r).toLowerCase().includes(q)
        );
      }

      // Quick filters
      if (invQuickFilter === 'zero') {
        rows = rows.filter((r) => getSellableUnits(r) === 0);
      }

      // Sort rows
      rows.sort((a, b) => {
        let aVal, bVal;

        if (invSortColumn === 'asin') {
          aVal = (a.asin || '').toLowerCase();
          bVal = (b.asin || '').toLowerCase();
        } else if (invSortColumn === 'title') {
          aVal = getInventoryDisplayTitle(a).toLowerCase();
          bVal = getInventoryDisplayTitle(b).toLowerCase();
        } else if (invSortColumn === 'sellable') {
          aVal = getSellableUnits(a);
          bVal = getSellableUnits(b);
        } else if (invSortColumn === 'sales30d') {
          aVal = getSales30dValue(a);
          bVal = getSales30dValue(b);
        }

        if (typeof aVal === 'string') {
          return invSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
          return invSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        }
      });

      // Clear
      headEl.innerHTML = '';
      bodyEl.innerHTML = '';
      footEl.innerHTML = '';

      // Build header with sortable columns
      const arrow = (col) => {
        if (invSortColumn === col) {
          return invSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
        }
        return '‚ñ≤‚ñº';
      };

      headEl.innerHTML = `
        <tr>
          <th onclick="sortInventoryTableBy('asin')">ASIN ${arrow('asin')}</th>
          <th class="inv-image-col">Image</th>
          <th onclick="sortInventoryTableBy('title')">Title ${arrow('title')}</th>
          <th onclick="sortInventoryTableBy('sellable')">Sellable ${arrow('sellable')}</th>
          <th onclick="sortInventoryTableBy('sales30d')">Last 30d Sales ${arrow('sales30d')}</th>
        </tr>
      `;

      // Accumulators for totals
      let totalSellable = 0;
      let totalSales30d = 0;

      // Build rows HTML
      let bodyHtml = '';

      rows.forEach((r) => {
        const asin = r.asin || '';
        const title = getInventoryDisplayTitle(r);

        const sellable = getSellableUnits(r);
        const unsellable = r.unsellable_onhand_units ?? r.unsellableOnHandInventoryUnits ?? 0;
        const total = sellable + unsellable;

        const aged = r.aged90plus_sellable_units ?? r.aged90PlusDaysSellableInventoryUnits ?? 0;
        const unhealthy = r.unhealthy_units ?? r.unhealthyInventoryUnits ?? 0;
        totalSellable += sellable;
        const sales30dValue = getSales30dValue(r);
        totalSales30d += sales30dValue;

        // Color coding
        let rowClass = '';
        if (sellable === 0 && total > 0) {
          rowClass = 'inv-zero-sellable';
        } else if (aged > 0) {
          rowClass = 'inv-aged';
        } else if (unhealthy > 0) {
          rowClass = 'inv-unhealthy';
        }

        const asinLink = `<a href="https://vendorcentral.amazon.ae/hz/vendor/members/catalogue?ref=vcnav&asin=${encodeURIComponent(asin)}" target="_blank" style="color:#0284c7; text-decoration:none;">${escapeHtml(asin)}</a>`;

        const imgUrl = getInventoryImageUrl(r);
        const imgHtml = imgUrl
          ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(asin)}" style="max-width:50px; max-height:50px; object-fit:contain; border-radius:6px;" />`
          : '';

        bodyHtml += `
          <tr class="${rowClass}">
            <td>${asinLink}</td>
            <td class="inv-image-col">${imgHtml}</td>
            <td class="inv-title-col">${escapeHtml(title)}</td>
            <td class="text-right">${sellable}</td>
            <td class="text-right">${sales30dValue}</td>
          </tr>
        `;
      });

      bodyEl.innerHTML = bodyHtml;

      // Footer totals
      const footerRow = document.createElement('tr');
      footerRow.innerHTML = `
        <td colspan="3"><strong>Totals (${rows.length} ASINs)</strong></td>
        <td class="text-right"><strong>${totalSellable}</strong></td>
        <td class="text-right"><strong>${totalSales30d}</strong></td>
      `;
      footEl.appendChild(footerRow);
    }

    document.getElementById("sync-btn").addEventListener("click", () => loadPOs(true));
    const rebuildBtn = document.getElementById("rebuild-btn");
    if (rebuildBtn) rebuildBtn.addEventListener("click", rebuildPOs);
    document.getElementById("po-search").addEventListener("input", filterPOs);
    document.getElementById("po-filter-fc").addEventListener("change", filterPOs);
    document.getElementById("po-filter-status").addEventListener("change", filterPOs);
    document.getElementById("po-start-days").addEventListener("change", filterPOs);

    // ====== SALES TRENDS FUNCTIONS ======
    async function loadSalesTrends() {
      try {
        const minUnitsInput = document.getElementById('sales-trends-min-units');
        const minUnits = parseInt(minUnitsInput?.value || '1', 10);
        window.salesTrendsMinUnitsFilter = minUnits;
        
        // Read-only trends fetch; coverage data only.
        const resp = await fetch(`/api/vendor-sales-trends?lookback_weeks=4&min_total_units=${minUnits}`);
        if (!resp.ok) {
          console.error('Failed to load sales trends', resp.status);
          document.getElementById('sales-trends-rows').innerHTML = '<tr><td colspan="11" class="empty">Error loading data</td></tr>';
          return;
        }
        
        const data = await resp.json();
        renderSalesTrends(data);
      } catch (err) {
        console.error('Error loading sales trends:', err);
        document.getElementById('sales-trends-rows').innerHTML = '<tr><td colspan="11" class="empty">Error: ' + err.message + '</td></tr>';
      }
    }

    function renderSalesTrends(data) {
      const tbody = document.getElementById('sales-trends-rows');
      const windowInfo = document.getElementById('sales-trends-window-info');
      const filterSelect = document.getElementById('sales-trends-filter');
      
      tbody.innerHTML = '';
      
      if (!data || !data.rows) {
        windowInfo.textContent = 'No data available.';
        tbody.innerHTML = '<tr><td colspan="11" class="empty">No data</td></tr>';
        return;
      }
      
      // Cache for filter re-render
      window.salesTrendsCache = data;
      
      const windowStartLabel = data.window.start_uae.substring(0, 10);
      const windowEndLabel = data.window.end_uae.substring(0, 10);
      const baseWindowText = `Window: ${windowStartLabel} ‚Üí ${windowEndLabel} (UAE)`;
      const coverage = data.coverage;
      if (coverage && coverage.total_hours) {
        const coverageText = `Coverage: ${coverage.coverage_percent}% OK (${coverage.covered_hours}/${coverage.total_hours}h, ${coverage.missing_hours} missing, ${coverage.pending_hours} pending)`;
        windowInfo.textContent = `${baseWindowText} | ${coverageText}`;
      } else {
        windowInfo.textContent = baseWindowText;
      }
      
      // Update headers using week_ranges_uae from the API
      if (data.week_ranges_uae) {
        updateSalesTrendsWeekHeaders(data.week_ranges_uae);
      }
      
      // Update trailing week header with date range
      if (data.trailing_window) {
        updateTrailingWeekHeader(data.trailing_window);
      }
      
      let rows = Array.isArray(data.rows) ? data.rows.slice() : [];
      const filterValue = filterSelect?.value || 'all';
        if (filterValue && filterValue !== 'all') {
          rows = rows.filter(r => r.trend === filterValue);
        }
      
      renderFilteredRows(rows);
    }

    function formatDateFromISO(isoStr) {
      // Extract YYYY-MM-DD from ISO string like "2025-01-12T00:00:00+04:00"
      return isoStr.split('T')[0];
    }

    function updateTrailingWeekHeader(trailingWindow) {
      // Update the "This Week" header with date range from trailing window
      const el = document.getElementById('st-th-trailing');
      if (!el || !trailingWindow) return;
      
      const startDate = formatDateFromISO(trailingWindow.start_uae);
      const endDate = formatDateFromISO(trailingWindow.end_uae);
      const rangeText = `${startDate} ‚Äì ${endDate}`;
      
      el.title = rangeText + " (UAE time, current partial week)";
      el.innerHTML = `
        This Week
        <span class="sales-trends-week-sublabel">${rangeText}</span>
      `;
    }

    function updateSalesTrendsWeekHeaders(weekRanges) {
      // weekRanges is the data.week_ranges_uae array from the API
      if (!weekRanges || weekRanges.length === 0) return;
      
      const labelMap = {
        "W4": { id: "st-th-w4", label: "W4 Units" },
        "W3": { id: "st-th-w3", label: "W3 Units" },
        "W2": { id: "st-th-w2", label: "W2 Units" },
        "W1": { id: "st-th-w1", label: "W1 Units" },
      };
      
      weekRanges.forEach(wr => {
        const info = labelMap[wr.label];
        if (!info) return;
        
        const el = document.getElementById(info.id);
        if (!el) return;
        
        const startDate = formatDateFromISO(wr.start_uae);
        const endDate = formatDateFromISO(wr.end_uae);
        const rangeText = `${startDate} ‚Äì ${endDate}`;
        
        el.title = rangeText + " (UAE time)";
        el.innerHTML = `
          ${info.label}
          <span class="sales-trends-week-sublabel">${rangeText}</span>
        `;
      });
    }

    // Hook Sales Trends controls
    document.getElementById('sales-trends-refresh-btn').addEventListener('click', () => {
      loadSalesTrends().catch(err => console.error(err));
    });
    
    document.getElementById('sales-trends-filter').addEventListener('change', () => {
      // Re-render with current data (don't reload from API)
      const tbody = document.getElementById('sales-trends-rows');
      const filterSelect = document.getElementById('sales-trends-filter');
      const filterValue = filterSelect.value;
      
      // Get all current rows data
      const allRows = tbody.querySelectorAll('tr');
      if (allRows.length === 0) return;
      
      // Store original data if not already stored
      if (!window.salesTrendsCache) {
        return; // Need to load first
      }
      
      const data = window.salesTrendsCache;
      let rows = data.rows.slice();
      if (filterValue && filterValue !== 'all') {
        rows = rows.filter(r => r.trend === filterValue);
      }
      
      renderFilteredRows(rows);
    });
    
    function renderFilteredRows(rows) {
      const tbody = document.getElementById('sales-trends-rows');
      tbody.innerHTML = '';
      
      if (!rows || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="empty">No data matches filter</td></tr>';
        return;
      }

      const isMissingValue = value => value === null || value === undefined;
      const minUnitsFilter = window.salesTrendsMinUnitsFilter || 0;
      let renderedCount = 0;
      
      rows.sort((a, b) => (b.total_units_4w || 0) - (a.total_units_4w || 0));
      
      for (const r of rows) {
        const w4Units = r.w4_units;
        const w3Units = r.w3_units;
        const w2Units = r.w2_units;
        const w1Units = r.w1_units;
        const buckets = [w4Units, w3Units, w2Units, w1Units];
        
        if (buckets.some(isMissingValue)) {
          continue;
        }

        const totalUnits4w = typeof r.total_units_4w === 'number'
          ? r.total_units_4w
          : buckets.reduce((sum, value) => sum + (value ?? 0), 0);

        if (totalUnits4w < minUnitsFilter) {
          continue;
        }

        const tr = document.createElement('tr');
        
        const tdImg = document.createElement('td');
        tdImg.style.textAlign = 'center';
        if (r.imageUrl) {
          const img = document.createElement('img');
          img.src = r.imageUrl;
          img.alt = r.asin;
          img.className = 'sales-trends-img';
          tdImg.appendChild(img);
        }
        tr.appendChild(tdImg);
        
        const tdAsin = document.createElement('td');
        tdAsin.textContent = r.asin;
        tdAsin.style.fontWeight = '700';
        tdAsin.style.textAlign = 'center';
        tr.appendChild(tdAsin);
        
        function addNumCell(value) {
          const td = document.createElement('td');
          td.textContent = (value != null) ? value.toString() : '';
          td.style.textAlign = 'center';
          td.className = 'sales-trends-num-cell';
          return td;
        }
        
        tr.appendChild(addNumCell(w4Units));
        tr.appendChild(addNumCell(w3Units));
        tr.appendChild(addNumCell(w2Units));
        tr.appendChild(addNumCell(w1Units));
        
        // PART 4.1: Add "This Week" battery column
        const tdTrailing = document.createElement('td');
        tdTrailing.style.textAlign = 'center';
        const trailingContainer = document.createElement('div');
        
        const baselineUnits = w1Units || 0;
        const thisWeekUnits = r.this_week_units || 0;

        // Raw units label
        const unitsLine = document.createElement('div');
        unitsLine.style.fontSize = '12px';
        unitsLine.style.marginBottom = '4px';
        unitsLine.textContent = thisWeekUnits + ' units';
        trailingContainer.appendChild(unitsLine);

        // Battery bar (display based on this week vs W1)
        let progressPercent;
        if (baselineUnits > 0) {
          progressPercent = (thisWeekUnits / baselineUnits) * 100;
        } else {
          progressPercent = thisWeekUnits > 0 ? 100 : 0;
        }
        progressPercent = Math.max(0, progressPercent);
        const displayPercent = Math.min(Math.round(progressPercent), 300);

        const batteryDiv = document.createElement('div');
        batteryDiv.className = 'trend-battery';
        const fillDiv = document.createElement('div');
        fillDiv.className = 'trend-battery-fill';
        fillDiv.style.width = displayPercent + '%';
        batteryDiv.appendChild(fillDiv);
        trailingContainer.appendChild(batteryDiv);

        const labelDiv = document.createElement('div');
        labelDiv.className = 'trend-battery-label';
        labelDiv.textContent = displayPercent + '%';
        trailingContainer.appendChild(labelDiv);

        const badgeDiv = document.createElement('div');
        badgeDiv.className = 'trend-battery-badge';
        const deltaUnits = thisWeekUnits - baselineUnits;
        if (baselineUnits <= 0 && thisWeekUnits > 0) {
          badgeDiv.textContent = 'New this week üöÄ';
        } else if (
          baselineUnits > 0 &&
          progressPercent >= 100 &&
          progressPercent < 150 &&
          deltaUnits > 0
        ) {
          badgeDiv.textContent = `üî• +${deltaUnits} vs last week`;
        } else if (baselineUnits > 0 && progressPercent >= 150 && deltaUnits > 0) {
          badgeDiv.textContent = `üöÄ +${deltaUnits} vs last week`;
        } else {
          badgeDiv.textContent = '';
        }
        trailingContainer.appendChild(badgeDiv);
        
        tdTrailing.appendChild(trailingContainer);
        tr.appendChild(tdTrailing);
        
        tr.appendChild(addNumCell(totalUnits4w));
        tr.appendChild(addNumCell(r.delta_units));
        
        // % Chg column (using new pct_change and pct_change_from_zero)
        const tdPct = document.createElement('td');
        let pctText;
        if (r.pct_change_from_zero) {
          pctText = "Up from 0";
        } else if (r.pct_change === null || r.pct_change === undefined) {
          pctText = "‚Äî";
        } else {
          const pct = Math.round(r.pct_change * 100);
          pctText = pct.toString() + "%";
        }
        tdPct.textContent = pctText;
        tdPct.style.textAlign = 'center';
        tdPct.className = 'sales-trends-num-cell';
        tr.appendChild(tdPct);
        
        // Trend badge (using backend trend string)
        const tdTrend = document.createElement('td');
        tdTrend.className = 'sales-trend-cell';
        tdTrend.style.textAlign = 'center';
        const pill = document.createElement('span');
        const trend = (r.trend || "").toLowerCase();
        let trendClass = "trend-pill-flat";
        
        if (trend === "rising") trendClass = "trend-pill-rising";
        else if (trend === "falling") trendClass = "trend-pill-falling";
        else if (trend === "new") trendClass = "trend-pill-new";
        else if (trend === "dead") trendClass = "trend-pill-dead";
        else if (trend === "reviving") trendClass = "trend-pill-reviving";
        
        pill.className = "trend-pill " + trendClass;
        pill.textContent = r.trend || "";
        tdTrend.appendChild(pill);
        tr.appendChild(tdTrend);
        
        tbody.appendChild(tr);
        renderedCount += 1;
      }

      if (renderedCount === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="empty">No data matches filter</td></tr>';
      }
    }

    async function refreshAuditCalendar() {
      const statusEl = document.getElementById("audit-refresh-status");
      const refreshBtn = document.getElementById("audit-refresh-btn");
      if (statusEl) statusEl.textContent = "Refreshing audit coverage...";
      if (refreshBtn) refreshBtn.disabled = true;

      try {
        const resp = await fetch("/api/vendor-realtime-sales/audit-calendar?days=30");
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        auditCalendarCache = Array.isArray(data) ? data : [];

        if (!auditSelectedDate || !auditCalendarCache.some(day => day.date === auditSelectedDate)) {
          auditSelectedDate = auditCalendarCache.length ? auditCalendarCache[auditCalendarCache.length - 1].date : null;
        }

        renderAuditCalendar();

        if (auditSelectedDate) {
          await loadAuditDay(auditSelectedDate);
        } else {
          clearAuditDayDetail();
        }

        if (statusEl) {
          statusEl.textContent = auditCalendarCache.length
            ? `Showing ${auditCalendarCache.length} days`
            : "No audit coverage found";
        }
      } catch (err) {
        console.error("Failed to refresh audit calendar:", err);
        if (statusEl) {
          statusEl.textContent = `Error: ${err.message}`;
        }
        clearAuditDayDetail();
      } finally {
        if (refreshBtn) refreshBtn.disabled = false;
      }
    }

    function renderAuditCalendar() {
      const grid = document.getElementById("audit-calendar-grid");
      const meta = document.getElementById("audit-calendar-meta");
      if (!grid) return;
      grid.innerHTML = "";

      if (!auditCalendarCache.length) {
        grid.innerHTML = '<div class="empty">No audit data available.</div>';
        if (meta) meta.textContent = "";
        return;
      }

      auditCalendarCache.forEach(day => {
        const dayButton = document.createElement("button");
        dayButton.type = "button";
        const statusClass = (day.status || "missing").toLowerCase();
        dayButton.className = `audit-calendar-day ${statusClass}${day.date === auditSelectedDate ? " selected" : ""}`;
        dayButton.innerHTML = `
          <strong>${day.date}</strong>
          <span style="font-size:12px; color:#475569;">${getAuditStatusLabel(day.status)}</span>
          <span style="font-size:11px; color:#6b7280;">${day.ok_hours || 0} of 24 hrs</span>
        `;
        dayButton.addEventListener("click", async () => {
          auditSelectedDate = day.date;
          renderAuditCalendar();
          await loadAuditDay(day.date);
        });
        grid.appendChild(dayButton);
      });

      if (meta) {
        const first = auditCalendarCache[0];
        const last = auditCalendarCache[auditCalendarCache.length - 1];
        meta.textContent = `Window: ${first?.date || ""} ‚Äì ${last?.date || ""}`;
      }
    }

    function clearAuditDayDetail() {
      const titleEl = document.getElementById("audit-day-title");
      const summaryEl = document.getElementById("audit-day-summary");
      const tbody = document.getElementById("audit-day-hours-body");
      const fillBtn = document.getElementById("audit-fill-day-btn");
      if (titleEl) titleEl.textContent = "Select a date to view hourly coverage";
      if (summaryEl) summaryEl.textContent = "";
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No date selected.</td></tr>';
      }
      if (fillBtn) fillBtn.disabled = true;
    }

    async function loadAuditDay(date) {
      if (!date) {
        clearAuditDayDetail();
        return;
      }
      const cached = auditDayCache[date];
      if (cached) {
        renderAuditDayDetail(cached);
        return;
      }

      const summaryEl = document.getElementById("audit-day-summary");
      const tbody = document.getElementById("audit-day-hours-body");
      if (summaryEl) summaryEl.textContent = "Loading hourly coverage...";
      if (tbody) tbody.innerHTML = '<tr><td colspan="3" class="empty">Loading...</td></tr>';

      try {
        const resp = await fetch(`/api/vendor-realtime-sales/audit-day?date=${encodeURIComponent(date)}`);
        if (!resp.ok) {
          const errText = await resp.text().catch(() => null);
          throw new Error(errText || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        auditDayCache[date] = data;
        renderAuditDayDetail(data);
      } catch (err) {
        console.error("Failed to load audit day:", err);
        if (summaryEl) summaryEl.textContent = `Error: ${err.message}`;
        if (tbody) tbody.innerHTML = '<tr><td colspan="3" class="empty">Failed to load hourly coverage.</td></tr>';
        const fillBtn = document.getElementById("audit-fill-day-btn");
        if (fillBtn) fillBtn.disabled = true;
      }
    }

    function renderAuditDayDetail(detail) {
      const titleEl = document.getElementById("audit-day-title");
      const summaryEl = document.getElementById("audit-day-summary");
      const tbody = document.getElementById("audit-day-hours-body");
      const fillBtn = document.getElementById("audit-fill-day-btn");
      if (titleEl) titleEl.textContent = detail ? `${detail.date} hourly coverage` : "Select a date to view hourly coverage";
      if (summaryEl) summaryEl.textContent = detail ? `Missing: ${detail.missing_hours?.length || 0} | Pending: ${detail.pending_hours?.length || 0}` : "";
      if (!tbody) return;
      if (!detail || !detail.hours) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No hourly data.</td></tr>';
        if (fillBtn) fillBtn.disabled = true;
        return;
      }
      tbody.innerHTML = detail.hours.map(row => {
        const status = (row.status || "unknown").toLowerCase();
        const statusLabel = row.status ? row.status.toUpperCase() : "UNKNOWN";
        const detailText = row.audited_status ? `Audited: ${row.audited_status}` : "";
        return `
          <tr>
            <td style="padding:8px;">${String(row.hour).padStart(2, "0")}:00</td>
            <td style="padding:8px;"><span class="audit-hour-status-${status}">${statusLabel}</span></td>
            <td style="padding:8px;">${detailText}</td>
          </tr>
        `;
      }).join("");
      if (fillBtn) {
        fillBtn.disabled = !(detail.missing_hours && detail.missing_hours.length);
      }
    }

    function getAuditStatusLabel(status) {
      if (!status) return "Unknown";
      const value = status.toLowerCase();
      if (value === "full") return "Full";
      if (value === "partial") return "Partial";
      if (value === "missing") return "Missing";
      if (value === "pending") return "Pending";
      return value.charAt(0).toUpperCase() + value.slice(1);
    }

    async function fillAuditDay() {
      if (!auditSelectedDate) return;
      const detail = auditDayCache[auditSelectedDate];
      if (!detail || !detail.missing_hours?.length) return;
      const btn = document.getElementById("audit-fill-day-btn");
      const statusEl = document.getElementById("audit-fill-status");
      if (btn) {
        btn.disabled = true;
        btn.textContent = "Scheduling...";
      }
      if (statusEl) {
        statusEl.textContent = "";
      }
      try {
        const resp = await fetch("/api/vendor-realtime-sales/fill-day", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            date: auditSelectedDate,
            missing_hours: detail.missing_hours,
          }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.detail || data.error || `HTTP ${resp.status}`);
        }
        if (statusEl) {
          let message = `Scheduled ${data.scheduled_tasks?.length || 0} hour(s).`;
          if (data.cooldown_active) {
            message += ` Quota cooldown until ${data.cooldown_until || "unknown"}.`;
            statusEl.style.color = "#b91c1c";
          } else {
            statusEl.style.color = "#059669";
          }
          statusEl.textContent = message;
        }
        delete auditDayCache[auditSelectedDate];
        await refreshAuditCalendar();
        setTimeout(() => loadAuditDay(auditSelectedDate), 1200);
      } catch (err) {
        console.error("Fill day failed:", err);
        if (statusEl) {
          statusEl.textContent = `Fill failed: ${err.message}`;
          statusEl.style.color = "#b91c1c";
        }
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = "Fill Day / Backfill";
        }
      }
    }

    async function runAuditRepair30d() {
      const btn = document.getElementById("audit-repair-30d-btn");
      const statusEl = document.getElementById("audit-repair-status");
      if (btn) btn.disabled = true;
      if (statusEl) {
        statusEl.textContent = "Running 30-day repair...";
        statusEl.style.color = "#0f172a";
      }
      try {
        const resp = await fetch("/api/vendor/rt-sales/repair-30d", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            report_window_hours: 6,
            max_runtime_seconds: 600,
            max_reports: 50
          })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.detail || data.error || `HTTP ${resp.status}`);
        }
        if (statusEl) {
          const reason = data.stopped_reason || "unknown";
          const applied = data.hours_applied || 0;
          const reports = data.reports_created || 0;
          const remaining = data.remaining_missing ?? "?";
          statusEl.textContent = `Repair stop: ${reason} | applied ${applied} hrs | reports ${reports} | remaining ${remaining}`;
          statusEl.style.color = data.ok ? "#059669" : "#b91c1c";
        }
        await refreshAuditCalendar();
      } catch (err) {
        console.error("Repair 30d failed:", err);
        if (statusEl) {
          statusEl.textContent = `Repair failed: ${err.message}`;
          statusEl.style.color = "#b91c1c";
        }
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function showTab(tabName) {
      closeCatalogContextMenu();
      activeTab = tabName;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });

      const panels = [
        { id: "pos-tab", tab: "pos" },
        { id: "catalog-tab", tab: "catalog" },
        { id: "oos-tab", tab: "oos" },
        { id: "tab-vrt-summary", tab: "vrt-summary" },
        { id: "tab-vrt-trends", tab: "vrt-trends" },
        { id: "tab-vrt-audit", tab: "vrt-audit" },
        { id: "inventory-tab", tab: "inventory" },
        { id: "df-payments-tab", tab: "df-payments" },
      ];
      panels.forEach(({ id, tab }) => {
        const panelEl = document.getElementById(id);
        if (!panelEl) return;
        panelEl.style.display = tab === tabName ? "block" : "none";
      });

      if (tabName === "catalog" && !asinList.length) {
        loadAsinList();
      }
      if (tabName === "oos") {
        loadOosItems();
      }
      if (tabName === "inventory") {
        loadInventorySnapshotIfNeeded();
      }
      if (tabName === "vrt-summary") {
        initRtSalesTab();
        loadVendorRtSalesSummary();
        startRtSalesStatusPolling();
      } else {
        stopRtSalesStatusPolling();
      }
      if (tabName === "vrt-trends") {
        loadSalesTrends();
      }
      if (tabName === "vrt-audit") {
        refreshAuditCalendar();
      }
      if (tabName === "df-payments") {
        if (typeof initDfPaymentsTab === "function") {
          initDfPaymentsTab();
        }
        if (typeof loadDfPaymentsState === "function") {
          loadDfPaymentsState();
        }
      }
      if (tabName === "pos") {
        refreshVendorPoStatus();
      }
    }

    function handleInventoryTabFocus() {
      if (activeTab !== "inventory") return;
      if (!vendorInventorySnapshot || vendorInventorySnapshot.length === 0) {
        loadInventorySnapshotIfNeeded(true);
        return;
      }
      updateInventoryFreshnessUi(vendorInventoryMeta);
      if (Date.now() - lastRealtimeFetchAt > INVENTORY_FETCH_DEBOUNCE_MS) {
        fetchRealtimeInventorySnapshot({ silent: true });
      }
    }

    window.addEventListener("focus", handleInventoryTabFocus);
    updateInventoryModeButtons();
    updateInventoryRefreshButtonState();
    updateInventoryFreshnessLabel();

    showTab("pos");
    loadPOs(false);
    refreshVendorPoStatus();
    scheduleInitialAutoSync();
    setInterval(updateSyncInfo, 60 * 1000);
    setInterval(autoSyncIfDue, 5 * 60 * 1000);
  </script>
  <div class="backdrop" id="workers-modal" style="display:none;">
    <div class="modal" style="max-width:960px;">
      <header>
        <div style="display:flex; flex-direction:column; gap:4px;">
          <div>Background Workers</div>
          <div id="workers-last-checked" class="muted-text" style="font-size:12px;">Last checked: -</div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline-secondary" id="workers-refresh-btn" type="button">Refresh Status</button>
          <button class="btn" id="workers-close-btn" type="button">Close</button>
        </div>
      </header>
      <div class="modal-body" id="workers-modal-body">
        <div id="workers-heartbeat" style="font-weight:700; margin-bottom:6px;">System heartbeat: OK</div>
        <div id="workers-error" style="font-size:12px; color:#b91c1c; margin-bottom:8px; display:none;"></div>
        <div class="workers-grid">
          <div class="worker-card" id="workers-section-inventory"></div>
          <div class="worker-card" id="workers-section-rt-sales"></div>
          <div class="worker-card" id="workers-section-vendor-po"></div>
          <div class="worker-card" id="workers-section-df-payments"></div>
        </div>
      </div>
    </div>
  </div>
  <script src="/ui/js/df_payments.js"></script>
  <script src="/ui/js/workers_status.js"></script>
  <div class="backdrop" id="printer-settings-modal" style="display:none;">
    <div class="modal" style="max-width:720px;">
      <header>
        <div>Printer Settings</div>
        <button class="btn" id="printer-settings-close-btn" type="button">Close</button>
      </header>

      <div class="modal-body">

        <div id="printer-health-indicator" style="margin-bottom:12px;"></div>

        <div class="printer-settings-field">
          <label for="printer-settings-select">Default Printer</label>
          <select id="printer-settings-select"></select>
        </div>

        <div class="printer-settings-field">
          <label for="printer-setting-label_width_mm">Label Width (mm)</label>
          <input id="printer-setting-label_width_mm" type="number" step="0.1" />
        </div>

        <div class="printer-settings-field">
          <label for="printer-setting-label_height_mm">Label Height (mm)</label>
          <input id="printer-setting-label_height_mm" type="number" step="0.1" />
        </div>

        <div class="printer-settings-field">
          <label for="printer-setting-gap_mm">Gap (mm)</label>
          <input id="printer-setting-gap_mm" type="number" step="0.1" />
        </div>

        <div id="printer-settings-warning"></div>
        <div id="printer-settings-status"></div>

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button class="btn" id="printer-settings-save-btn" type="button">Save</button>
          <button class="btn" id="printer-test-print-btn" type="button">Test Print</button>
        </div>

        <div style="margin-top:16px;">
          <div style="font-weight:600; margin-bottom:6px;">Recent Prints</div>
          <div id="recent-prints-list"></div>
          <button class="btn" id="recent-prints-refresh-btn" type="button" style="margin-top:6px;">
            Refresh
          </button>
        </div>

      </div>
    </div>
  </div>
  <script src="/ui/js/printer_settings.js"></script>
  <script src="/ui/js/barcode_print.js"></script>
  <div class="backdrop" id="picklist-modal">
    <div class="modal" style="max-width:1000px;">
      <header>
        <div id="picklist-title">Pick List Preview</div>
        <button class="btn" style="background:#111827" onclick="closePicklistModal()">Close</button>
      </header>
      <div class="modal-body" id="picklist-body"></div>
    </div>
  </div>
  <div id="toast" style="
    position:fixed;
    right:16px;
    bottom:16px;
    background:#111827;
    color:#fff;
    padding:10px 14px;
    border-radius:8px;
    font-size:13px;
    box-shadow:0 10px 25px rgba(15,23,42,0.4);
    opacity:0;
    pointer-events:none;
    transition:opacity 0.25s ease;
    z-index:9999;
  "></div>
</body>
</html>
