<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SP-API Desktop App</title>
  <style>
    :root { --bg:#f8fafc; --panel:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --accent:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid var(--border); background:var(--panel); display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:5; }
    h1 { margin:0; font-size:18px; }
    .btn { border:none; background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .layout { padding:16px 20px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .panel h2 { margin:0; padding:14px 16px; border-bottom:1px solid var(--border); font-size:16px; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td { padding:8px 10px; border:1px solid var(--border); text-align:left; vertical-align: top; user-select: text; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    th, td { user-select: text; }
    tbody tr:hover { background:#f1f5f9; cursor:pointer; }
    .empty { padding:14px; color:var(--muted); text-align:center; }
    select.po-status-select { padding:8px 12px; border-radius:8px; font-size:15px; font-weight:700; min-width:170px; }
    input.po-date-input { padding:6px 10px; border-radius:8px; font-size:15px; font-weight:700; border:1px solid var(--border); }
    .rt-sales-sortable-header { cursor:pointer; user-select:none; transition: background-color 0.15s ease; }
    .rt-sales-sortable-header:hover { background-color:#f1f5f9; }
    .rt-sales-sort-arrow { display:inline-block; margin-left:4px; font-size:12px; transition:transform 0.2s ease, opacity 0.2s ease; }
    .rt-sales-window-info { font-size:12px; color:#666; margin-bottom:8px; }
    /* Row status colors */
    tr.po-status-preparing { background-color: #fef9c3; }
    tr.po-status-appointment { background-color: #e0f2fe; }
    tr.po-status-delivered { background-color: #dcfce7; }
    /* Vendor PO tab: larger, clearer text without changing layout spacing */
    #pos-tab { font-size:14px; }
    #pos-tab table { font-size:14px; }
    #pos-tab th, #pos-tab td { font-size:14px; }
    #pos-tab input, #pos-tab select, #pos-tab button { font-size:14px; }
    /* Endpoint tester */
    #tester-tab { font-size:14px; }
    .tester-controls { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:10px; margin-bottom:10px; }
    .tester-log { background:#0f172a; color:#e2e8f0; padding:10px; border-radius:8px; max-height:320px; overflow:auto; font-family: "SFMono-Regular", Consolas, monospace; font-size:13px; white-space:pre-wrap; }
    .tester-run-btn { background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    .tester-run-btn:disabled { background:#4b5563; cursor:not-allowed; }
    .tabs { display:flex; gap:8px; margin:6px 0 0; }
    .tab-btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:600; }
    .tab-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    /* modal */
    .backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:20; }
    .modal { background:#fff; width:90%; max-width:1100px; max-height:85vh; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
    .modal header { padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:12px 14px; overflow:auto; }
    .json-block { background:#f8fafc; border:1px solid var(--border); border-radius:8px; padding:10px; white-space:pre-wrap; word-break:break-word; font-family: monospace; font-size:12px; user-select:text; }
    </style>
  <style>
      .btn-fetch {
        background: #dc2626;
        color: #fff;
      }
      .btn-fetch:disabled {
        background: #9ca3af;
        color: #fff;
        cursor: not-allowed;
      }
      .btn-outline-secondary {
        background: #fff;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .btn-outline-secondary:hover {
        background: #f1f5f9;
      }
      .btn-sm {
        padding: 6px 10px;
        font-size: 13px;
      }
      /* Conditional formatting for quantities */
      .qty-shortage { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
      .qty-pending { background-color: #fef3c7; color: #92400e; font-weight: 600; }
      .qty-good { background-color: #dcfce7; color: #166534; font-weight: 600; }
      .qty-neutral { color: #374151; }
      .shortage-icon::before { content: "⚠️ "; }
      .qty-detail-btn { background: #3b82f6; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
      .qty-detail-btn:hover { background: #2563eb; }
      /* PO items modal: rejected line highlighting */
      .po-line-rejected { background-color: #fee2e2; }
      /* PO items modal: received line highlighting */
      .po-line-received { background-color: #dcfce7; }
      /* PO items modal: summary row */
      .po-items-summary td { border-top: 2px solid #e5e7eb; background-color: #f9fafb; font-weight: 600; }
      /* Real-Time Sales status label */
      .rt-sales-status-label { font-size: 12px; margin-top: 4px; color: #666; }
      .rt-sales-status-busy { color: #d97706; font-weight: 500; }
      .rt-sales-status-cooldown { color: #b91c1c; font-weight: 500; }
      .rt-sales-status-idle { color: #059669; font-weight: 500; }
      /* Out-of-Stock export status */
      .export-status-pending { font-weight: 600; color: #d97706; }
      .export-status-exported { opacity: 0.6; color: #6b7280; }
      .oos-row-exported { opacity: 0.7; }
      /* Sales Trends trend pills */
      .trend-pill { padding: 2px 6px; border-radius: 999px; font-size: 11px; text-transform: capitalize; text-align: center; display: inline-block; }
      .trend-rising, .trend-pill-rising { background-color: #e0f7e9; color: #1b7b33; }
      .trend-falling, .trend-pill-falling { background-color: #fde4e4; color: #b3261e; }
      .trend-flat, .trend-pill-flat { background-color: #eceff1; color: #455a64; }
      .trend-new, .trend-pill-new { background-color: #e3f2fd; color: #1565c0; }
      .trend-dead, .trend-pill-dead { background-color: #f3e5f5; color: #6a1b9a; }
      .trend-reviving, .trend-pill-reviving { background-color: #f3e5f5; color: #7b1fa2; }
      /* Sales Trends table and layout */
      .sales-trends-table { width: 100%; }
      .sales-trends-table tr { height: 100px; }
      .sales-trends-table th,
      .sales-trends-table td { padding: 12px 10px; vertical-align: middle; font-weight: 600; text-align: center; }
      .sales-trends-table th:first-child,
      .sales-trends-table td:first-child { text-align: center; }
      .sales-trends-table th:nth-child(2),
      .sales-trends-table td:nth-child(2) { text-align: center; font-weight: 700; }
      .sales-trends-img { width: 80px; height: 80px; object-fit: contain; border-radius: 6px; }
      .sales-trends-num-cell { font-size: 14px; font-weight: 700; text-align: center; }
      /* Trend pill styling */
      .sales-trend-cell { text-align: center; vertical-align: middle; }
      .sales-trend-pill { display: inline-flex; align-items: center; justify-content: center; padding: 6px 14px; border-radius: 999px; font-size: 1.2rem; font-weight: 700; min-width: 80px; text-align: center; }
      /* Battery styles for trailing week */
      .trend-battery { width: 80px; height: 14px; border-radius: 7px; border: 1px solid #ccc; overflow: hidden; background-color: #f5f5f5; margin: 0 auto 2px auto; }
      .trend-battery-fill { height: 100%; background: linear-gradient(to right, #4caf50, #81c784); transition: width 0.3s ease; }
      .trend-battery-label { font-size: 11px; text-align: center; font-weight: 600; }
      /* Week column sublabel */
      .sales-trends-week-sublabel { display: block; font-size: 0.75rem; font-weight: 700; color: #6b7280; margin-top: 2px; }
      /* Sales Trends controls */
      .sales-trends-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
      .sales-trends-controls label { display: flex; align-items: center; gap: 6px; font-size: 14px; }
      .sales-trends-controls input { padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; width: 120px; }
      .sales-trends-controls select { padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; }
      .sales-trends-window-info { font-size: 12px; color: #666; margin-bottom: 8px; }
      /* Inventory controls and subtabs */
      .inventory-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .inventory-controls .muted-text {
        margin-left: 8px;
        font-size: 0.9em;
        opacity: 0.8;
      }
      .inventory-subtabs {
        margin: 8px 0 12px 0;
      }
      .inventory-subtab-button {
        margin-right: 6px;
        padding: 4px 8px;
        font-size: 0.9em;
        cursor: pointer;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .inventory-subtab-button.active {
        font-weight: bold;
        text-decoration: underline;
        background: #3498db;
        color: white;
      }
      /* Inventory row color coding */
      .inv-zero-sellable {
        background-color: #fff4e6 !important;
      }
      .inv-aged {
        background-color: #e8f0ff !important;
      }
      .inv-unhealthy {
        background-color: #ffeaea !important;
      }
      .inv-row-zero {
        /* placeholder for zero inventory rows */
      }
      .inv-row-aged {
        /* placeholder for aged rows */
      }
      .inv-row-unhealthy {
        /* placeholder for unhealthy rows */
      }
      .text-right {
        text-align: right;
      }
      /* Search and filter controls */
      .inv-search-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .inv-search-bar input {
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 13px;
        min-width: 200px;
      }
      .inv-quick-filters {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .inv-quick-filter-btn {
        padding: 4px 8px;
        font-size: 12px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
      }
      .inv-quick-filter-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }
      /* Sortable headers */
      #inv-table thead th {
        cursor: pointer;
        user-select: none;
      }
      #inv-table thead th:hover {
        background-color: #e8f1f8;
      }
      /* Image column */
      .inv-image-col {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
      }
      /* Title column - narrower with text wrap */
      .inv-title-col {
        max-width: 320px;
        white-space: normal;
        word-break: break-word;
      }
      /* Sticky footer */
      #inv-table tfoot {
        position: sticky;
        bottom: 0;
        background: #fafafa;
        font-weight: bold;
        border-top: 2px solid #ccc;
        z-index: 1;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .data-table thead th {
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 1;
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
      }
      .data-table tbody td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
      }
      .data-table tbody tr:hover {
        background: #f1f5f9;
      }
      .data-table tfoot tr {
        border-top: 2px solid #e5e7eb;
        background: #f9fafb;
        font-weight: 600;
      }
      .data-table tfoot td {
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
      }
      /* Inventory subtabs (old style - kept for backwards compat) */
      .subtab-bar {
        margin: 15px 0;
      }
      .subtab-btn {
        padding: 8px 14px;
        margin-right: 10px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
      }
      .subtab-btn.active {
        background: #3498db;
        color: white;
      }
      .inventory-subtab {
        margin-top: 20px;
      }
  </style>
</head>
<body>
  <header>
    <h1>Amazon SP-API Desktop</h1>
    <div style="display:flex; align-items:center; gap:10px;">
      <div id="sync-info" style="font-size:12px; color:#6b7280; display:flex; flex-direction:column; margin-right:12px;">
        <span id="sync-last">Last Sync: -</span>
        <span id="sync-next">Next Auto-Sync: -</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="sync-btn">Sync Vendor POs</button>
        <button class="btn" id="rebuild-btn" style="background:#111827;">Full Rebuild POs</button>
      </div>
    </div>
  </header>

  <div class="layout" style="padding-bottom:0;">
      <div class="tabs">
        <button class="tab-btn active" data-tab="pos" onclick="showTab('pos')">Vendor POs</button>
        <button class="tab-btn" data-tab="catalog" onclick="showTab('catalog')">Catalog Fetcher</button>
        <button class="tab-btn" data-tab="oos" onclick="showTab('oos')">Out-of-Stock Items</button>
        <button class="tab-btn" data-tab="vendor-rt-sales" onclick="showTab('vendor-rt-sales')">Vendor Real Time Sales</button>
        <button class="tab-btn" data-tab="sales-trends" onclick="showTab('sales-trends')">Sales Trends</button>
        <button class="tab-btn" data-tab="inventory" onclick="showTab('inventory')">Inventory</button>
        <button class="tab-btn" data-tab="tester" onclick="showTab('tester')">Endpoint Tester</button>
        <button class="tab-btn" data-tab="notifications" onclick="showTab('notifications')">Notifications</button>
      </div>
  </div>

  <div class="layout">
    <div class="panel" id="pos-tab">
      <h2>Vendor POs (raw Amazon fields)</h2>
      <div style="padding:10px 12px; display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="po-search" type="text" placeholder="Search PO / SKU / F/C / Status" style="flex:1; min-width:240px; padding:8px 10px; border-radius:8px; border:1px solid var(--border);" />
          <select id="po-start-days" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="60" selected>60 Days</option>
            <option value="30">30 Days</option>
            <option value="15">15 Days</option>
          </select>
          <select id="po-filter-fc" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="">All F/C</option>
          </select>
          <select id="po-filter-status" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border); font-size:13px;">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Preparing">Preparing</option>
            <option value="Appointment Scheduled">Appointment Scheduled</option>
          </select>
          <button class="btn" id="picklist-btn" onclick="openPicklistPreview()" disabled style="background:#16a34a;">Export Pick List (PDF)</button>
        </div>
        <div id="inhouse-summary" style="font-size:12px; color:var(--muted); font-weight:600;"></div>
      </div>
      <div style="overflow:auto; max-height: calc(100vh - 200px);">
          <table>
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="po-select-all" onchange="toggleSelectAllPos(this)" /></th>
                <th>PO</th>
                <th style="text-align:center;">PO Items</th>
                <th>Order Date</th>
                <th style="text-align:center;">Requested Qty</th>
                <th style="text-align:center;">Accepted Qty</th>
                <th style="text-align:center;">Received Qty</th>
                <th style="text-align:center;">Remaining Qty</th>
                <th style="text-align:center;">Cancelled Qty</th>
                <th style="text-align:right;">Total Accepted Cost</th>
                <th>Status</th>
                <th>Status Date</th>
                <th>Amazon Status</th>
                <th>Ship To Location</th>
              </tr>
            </thead>
            <tbody id="po-rows"></tbody>
          </table>
        </div>
      </div>
    <div class="panel" id="catalog-tab" style="display:none; margin-top:14px;">
      <h2>ASIN Catalog Fetcher</h2>
      <div style="margin:10px 0; display:flex; gap:8px; align-items:center;">
        <input id="manual-asin-input" type="text" placeholder="Enter ASIN (e.g., B00XXXXXXX)" style="padding:8px; border-radius:6px; border:1px solid #d1d5db; min-width:220px;" />
        <button class="btn" style="background:#111827" onclick="addManualAsin()">Add ASIN</button>
        <span id="manual-asin-msg" style="font-size:13px;color:#6b7280;"></span>
      </div>
      <div style="padding:12px; display:flex; gap:10px; align-items:center;">
        <button class="btn" onclick="loadAsinList(true)">Refresh</button>
        <button class="btn" style="background:#16a34a" onclick="fetchAllMissing()">Fetch All Missing</button>
        <input id="asin-search" type="text" placeholder="Search ASIN / SKU / Title" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--border);" oninput="filterAsins()" />
      </div>
      <div style="padding:0 12px 12px 12px;">
        <div style="overflow:auto; max-height: calc(100vh - 240px);">
          <table>
            <thead>
              <tr>
                <th style="width:22%;">ASIN</th>
                <th style="width:22%;">SKU</th>
                <th style="width:18%;">Barcode</th>
                <th style="width:26%;">Title</th>
                <th style="width:12%;">Image</th>
                <th style="width:10%;">Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="asin-rows">
              <tr><td colspan="7" class="empty">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="panel" id="oos-tab" style="display:none; margin-top:14px;">
      <h2>Out-of-Stock Items</h2>
      <div style="padding:12px;">
        <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <button class="btn" onclick="loadOosItems()">Reload</button>
          <button class="btn" style="background:#111827;" onclick="downloadOosXls()">Export OOS (XLS)</button>
          <span id="oos-status" style="font-size:12px; color:var(--muted); margin-left:8px;"></span>
        </div>
        <div style="overflow:auto; max-height: calc(100vh - 260px);">
          <table>
            <thead>
            <tr>
              <th style="display:none;">PO Number</th>
              <th style="display:none;">PO Date</th>
              <th style="display:none;">Ship To</th>
              <th>ASIN</th>
              <th>Image</th>
              <th>Vendor SKU</th>
              <th>Qty</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="oos-rows">
              <tr><td colspan="8" class="empty">No OOS items</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
    <div class="panel" id="tester-tab" style="display:none; margin-top:14px;">
      <h2>SP-API Endpoint Tester</h2>
      <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
        <div class="tester-controls">
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Preset Endpoint</label>
            <select id="tester-preset" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" onchange="applyTesterPreset()">
              <option value="">-- Select preset --</option>
            </select>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Method</label>
            <select id="tester-method" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
            </select>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Full GET Path (optional)</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="tester-fullpath" type="text" placeholder="/catalog/2022-04-01/items/{asin}?marketplaceIds=A2VIGQ35RCS4UG" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
              <button class="tester-run-btn" style="padding:10px 10px;" onclick="applyTesterFullPath()">Use</button>
            </div>
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Endpoint Path (GET)</label>
            <input id="tester-endpoint" type="text" placeholder="/vendor/orders/v1/purchaseOrders" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
          </div>
          <div>
            <label style="font-weight:700; display:block; margin-bottom:4px;">Query string (key=value&key2=val)</label>
            <input id="tester-query" type="text" placeholder="marketplaceIds=A1F83G8C2ARO7P&limit=10" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);" />
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="font-weight:700; display:block; margin-bottom:4px;">Request Body (JSON for POST)</label>
            <textarea id="tester-body" placeholder='{"example":"value"}' style="width:100%; min-height:140px; padding:10px; border-radius:8px; border:1px solid var(--border); font-family: monospace; font-size:13px;"></textarea>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="tester-run-btn" onclick="runTesterCall()">Run</button>
          <span id="tester-host" style="font-size:13px; color:#475569;"></span>
          <span id="tester-status" style="font-size:13px; color:#475569;"></span>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Amazon Response Log</div>
          <button class="tester-run-btn" style="margin-bottom:6px; padding:8px 12px;" onclick="copyTesterLog()">Copy Log</button>
          <pre id="tester-log" class="tester-log">No calls yet.</pre>
        </div>
      </div>
    </div>
  <div class="panel" id="notifications-tab" style="display:none; margin-top:14px;">
    <h2>Notifications</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" onclick="loadNotifications()">Reload Notifications</button>
        <span id="notifications-status" style="font-size:12px; color:#6b7280;"></span>
      </div>
      <div style="overflow:auto; max-height:60vh;">
        <table>
          <thead>
            <tr>
              <th>TS</th>
              <th>Type</th>
              <th>PO</th>
              <th>Summary</th>
            </tr>
          </thead>
          <tbody id="notifications-rows">
            <tr><td colspan="4" class="empty">No notifications</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="panel" id="vendor-rt-sales-tab" style="display:none; margin-top:14px;">
    <h2>Vendor Real Time Sales</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label style="font-size:14px; font-weight:600;">Lookback:</label>
        <select id="rt-sales-lookback" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px;" onchange="onRtSalesLookbackChange()">
          <option value="2">Trailing 2 hours</option>
          <option value="4">Trailing 4 hours</option>
          <option value="8">Trailing 8 hours</option>
          <option value="12">Trailing 12 hours</option>
          <option value="24">Trailing 24 hours</option>
          <option value="48">Trailing 48 hours</option>
        </select>
        
        <label style="font-size:14px; font-weight:600; margin-left:12px;">View By:</label>
        <select id="rt-sales-view-by" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px;" onchange="onRtSalesViewByChange()">
          <option value="asin" selected>ASIN</option>
          <option value="time">Time</option>
        </select>
        
        <button id="rt-sales-refresh-btn" class="btn" onclick="refreshVendorRtSales()" style="margin-left:12px;">Refresh Now</button>
      </div>
      <div id="rt-sales-sync-status" class="rt-sales-status-label"></div>

      <div id="rt-sales-summary" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
        <div style="background:#f0f9ff; border:1px solid #0284c7; border-radius:8px; padding:12px;">
          <div style="font-size:12px; color:#0c4a6e; font-weight:600;">Total Units</div>
          <div id="rt-sales-total-units" style="font-size:24px; font-weight:700; color:#0369a1;">—</div>
        </div>
        <div style="background:#f0fdf4; border:1px solid #16a34a; border-radius:8px; padding:12px;">
          <div style="font-size:12px; color:#166534; font-weight:600;">Total Revenue</div>
          <div id="rt-sales-total-revenue" style="font-size:24px; font-weight:700; color:#15803d;">—</div>
        </div>
      </div>

      <div style="font-weight:600; margin-top:8px;" id="rt-sales-table-title">Top ASINs</div>
      <div id="rt-sales-window-info" class="rt-sales-window-info"></div>
      <div style="overflow:auto; max-height:50vh; border:1px solid var(--border); border-radius:8px;">
        <!-- ASIN View Table -->
        <table id="rt-sales-asin-table" style="table-layout:fixed; width:100%; display:none;">
          <thead>
            <tr>
              <th style="flex:1; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('asin')">ASIN <span id="rt-sales-sort-asin" class="rt-sales-sort-arrow"></span></th>
              <th style="flex:1; text-align:center; word-break:break-word;">Image</th>
              <th style="flex:1; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('units')">Units <span id="rt-sales-sort-units" class="rt-sales-sort-arrow"></span></th>
              <th style="flex:1; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('revenue')">Revenue <span id="rt-sales-sort-revenue" class="rt-sales-sort-arrow"></span></th>
            </tr>
          </thead>
          <tbody id="rt-sales-top-asins-rows">
            <tr><td colspan="4" class="empty">No data. Click "Refresh Now" to fetch.</td></tr>
          </tbody>
        </table>
        
        <!-- Time View Table -->
        <table id="rt-sales-time-table" style="table-layout:fixed; width:100%; display:none;">
          <thead>
            <tr>
              <th style="flex:2; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('bucket_time')">Time Bucket (UAE) <span id="rt-sales-sort-bucket-time" class="rt-sales-sort-arrow"></span></th>
              <th style="flex:1; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('units')">Units <span id="rt-sales-sort-time-units" class="rt-sales-sort-arrow"></span></th>
              <th style="flex:1; text-align:right; word-break:break-word;" class="rt-sales-sortable-header" onclick="onRtSalesHeaderClick('revenue')">Revenue <span id="rt-sales-sort-time-revenue" class="rt-sales-sort-arrow"></span></th>
            </tr>
          </thead>
          <tbody id="rt-sales-time-rows">
            <tr><td colspan="3" class="empty">No data available</td></tr>
          </tbody>
        </table>
      </div>

      <div id="rt-sales-asin-detail" style="margin-top:16px; display:none;">
        <div style="font-weight:600; margin-bottom:8px;">ASIN Hourly Detail: <span id="rt-sales-asin-detail-title">—</span></div>
        <div style="overflow:auto; max-height:35vh; border:1px solid var(--border); border-radius:8px;">
          <table>
            <thead>
              <tr>
                <th style="min-width:160px;">Hour (UTC)</th>
                <th style="text-align:right; width:80px;">Units</th>
                <th style="text-align:right; width:100px;">Revenue</th>
              </tr>
            </thead>
            <tbody id="rt-sales-asin-detail-rows">
              <tr><td colspan="3" class="empty">—</td></tr>
            </tbody>
          </table>
        </div>
        <button class="btn" style="margin-top:8px; background:#111827;" onclick="closeRtSalesAsinDetail()">Close Detail</button>
      </div>
    </div>
  </div>

  <div class="panel" id="sales-trends-tab" style="display:none; margin-top:14px;">
    <h2>Sales Trends (Last 4 Weeks)</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <div class="sales-trends-controls">
        <label>
          Min Total Units (4w):
          <input type="number" id="sales-trends-min-units" value="1" min="1" />
        </label>
        <label style="margin-left:12px;">Filter:
          <select id="sales-trends-filter">
            <option value="all">All</option>
            <option value="rising">Rising</option>
            <option value="falling">Falling</option>
            <option value="new">New</option>
            <option value="dead">Dead</option>
            <option value="flat">Flat</option>
          </select>
        </label>
        <button id="sales-trends-refresh-btn" class="btn" style="margin-left:12px;">Refresh</button>
        <button id="rt-sales-backfill-4w-btn"
                class="btn btn-outline-secondary btn-sm"
                style="margin-left: 8px;"
                onclick="runFourWeekBackfill()">
          4W Backfill (One-time)
        </button>
      </div>
      <div id="sales-trends-window-info" class="sales-trends-window-info"></div>
      <div style="overflow:auto; max-height:60vh; border:1px solid var(--border); border-radius:8px;">
        <table id="sales-trends-table" style="width:100%;">
          <thead>
            <tr>
              <th style="width:90px; text-align:center;">Image</th>
              <th style="width:100px; text-align:center;">ASIN</th>
              <th id="st-th-w4" style="width:70px; text-align:center;">W4 Units</th>
              <th id="st-th-w3" style="width:70px; text-align:center;">W3 Units</th>
              <th id="st-th-w2" style="width:70px; text-align:center;">W2 Units</th>
              <th id="st-th-w1" style="width:70px; text-align:center;">W1 Units</th>
              <th id="st-th-trailing" style="width:100px; text-align:center;">This Week</th>
              <th style="width:80px; text-align:center;">Total 4W</th>
              <th style="width:80px; text-align:center;">Δ (W1−W2)</th>
              <th style="width:70px; text-align:center;">% Chg</th>
              <th style="width:80px; text-align:center;">Trend</th>
            </tr>
          </thead>
          <tbody id="sales-trends-rows">
            <tr><td colspan="11" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="panel" id="inventory-tab" style="display:none; margin-top:14px;">
    <h2>Vendor Inventory – Latest Week</h2>
    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
      <!-- Controls row -->
      <div class="inventory-controls">
        <button id="inv-refresh-btn" class="btn" onclick="refreshVendorInventorySnapshot()">Refresh Inventory Snapshot</button>
        <button id="inv-download-btn" class="btn" style="background:#16a34a;" onclick="downloadVendorInventorySnapshotCsv()">Download CSV (current view)</button>
        <span id="inv-week-label" class="muted-text"></span>
        <span id="inv-status-label" class="muted-text"></span>
      </div>

      <!-- Inner subtabs -->
      <div class="inventory-subtabs">
        <button id="inv-subtab-snapshot" class="inventory-subtab-button active" onclick="setInventorySubtab('snapshot')">Snapshot (All ASINs)</button>
        <button id="inv-subtab-aged" class="inventory-subtab-button" onclick="setInventorySubtab('aged')">Aged 90+ Days</button>
        <button id="inv-subtab-unhealthy" class="inventory-subtab-button" onclick="setInventorySubtab('unhealthy')">Unhealthy / Excess</button>
      </div>

      <!-- Search and Quick Filters -->
      <div class="inv-search-bar">
        <input type="text" id="inv-search" placeholder="Search ASIN or title…" oninput="renderVendorInventoryCurrentSubtab()" />
        <div class="inv-quick-filters">
          <button id="inv-qf-all" class="inv-quick-filter-btn active" onclick="setQuickFilter('all')">All</button>
          <button id="inv-qf-zero" class="inv-quick-filter-btn" onclick="setQuickFilter('zero')">Zero Stock</button>
          <button id="inv-qf-aged" class="inv-quick-filter-btn" onclick="setQuickFilter('aged')">Aged 90+</button>
          <button id="inv-qf-unhealthy" class="inv-quick-filter-btn" onclick="setQuickFilter('unhealthy')">Unhealthy</button>
        </div>
      </div>

      <!-- Table -->
      <div id="inv-table-wrapper" style="overflow:auto; max-height: calc(100vh - 300px);">
        <table id="inv-table" class="data-table">
          <thead id="inv-table-head"></thead>
          <tbody id="inv-table-body"></tbody>
          <tfoot id="inv-table-foot"></tfoot>
        </table>
      </div>
    </div>
  </div>
  </div>

  <div class="backdrop" id="modal">
    <div class="modal">
      <header>
        <div id="modal-title">PO Items</div>
        <button class="btn" style="background:#111827" onclick="closeModal()">Close</button>
      </header>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Catalog detail modal -->
  <div class="backdrop" id="catalog-modal">
    <div class="modal" style="max-width:1000px;">
      <header>
        <div id="catalog-modal-title">Catalog Details</div>
        <button class="btn" style="background:#111827" onclick="closeCatalogModal()">Close</button>
      </header>
      <div class="modal-body" id="catalog-modal-body" style="font-family: monospace; white-space: pre-wrap; word-break: break-word; font-size:12px;"></div>
    </div>
  </div>

  <!-- PO Line Details Modal (NEW) -->
  <div class="backdrop" id="po-lines-modal">
    <div class="modal" style="max-width:1200px;">
      <header>
        <div id="po-lines-modal-title">PO Line Items - Inventory Breakdown</div>
        <button class="btn" style="background:#111827" onclick="closePoLinesModal()">Close</button>
      </header>
      <div class="modal-body" id="po-lines-modal-body" style="padding:0;"></div>
    </div>
  </div>

  <script>
    let vendorPOs = [];
    let filteredPOs = [];
    let asinList = [];
    let filteredAsins = [];
    let activeTab = "pos";
    let oosItems = [];
    let selectedPoNumbers = [];
    let lastSyncTime = null;
    let lastSyncFromSpapi = false;
    let nextAutoSyncAt = null;
    let autoSyncIntervalMs = 2 * 60 * 60 * 1000; // 2 hours
    let testerMetaLoaded = false;
    let testerPresets = [];
    let testerHost = "";
    let catalogImageCache = {};
    let recentNotifications = [];
    let vendorInventorySnapshot = [];
    let currentInventorySubtab = 'snapshot';
    let invSortColumn = 'sellable';
    let invSortDirection = 'desc';
    let invQuickFilter = 'all';

    const INTERNAL_STATUS_OPTIONS = [
      "Pending",
      "Preparing",
      "Appointment Scheduled",
      "Delivered",
    ];

    function getRowColorForStatus(status) {
      switch (status) {
        case "Preparing":
          return "#fef9c3"; // light yellow
        case "Appointment Scheduled":
          return "#e0f2fe"; // light blue
        case "Delivered":
          return "#dcfce7"; // light green
        default:
          return ""; // Pending = no color
      }
    }

    function startDateIsoFromDays(days) {
      const d = new Date();
      d.setDate(d.getDate() - days);
      return d.toISOString().slice(0, 10);
    }

    function currentStartDateParam() {
      const sel = document.getElementById("po-start-days");
      const days = Number(sel?.value || 60);
      return startDateIsoFromDays(days);
    }

    async function loadPOs(sync = false) {
      const btn = document.getElementById("sync-btn");
      if (btn && sync) { btn.disabled = true; btn.textContent = "Syncing..."; }
      try {
        const createdAfter = currentStartDateParam();
        if (sync) {
          const respSync = await fetch(`/api/vendor-pos/sync`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ createdAfter }),
          });
          let fetched = 0;
          if (respSync.ok) {
            const syncData = await respSync.json();
            fetched = syncData.fetched || 0;
          }
          lastSyncTime = new Date();
          lastSyncFromSpapi = true;
          nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
          updateSyncInfo();
          const hh = String(lastSyncTime.getHours()).padStart(2, "0");
          const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
          showToast(`Sync completed at ${hh}:${mi}, ${fetched} POs updated.`);
        }
        const resp = await fetch(`/api/vendor-pos?enrich=1&include_lines=true&createdAfter=${encodeURIComponent(createdAfter)}`);
        const data = await resp.json();
        vendorPOs = (data.items || []).sort((a, b) => getPoDate(b).localeCompare(getPoDate(a)));
        filteredPOs = vendorPOs;
        const poSet = new Set(vendorPOs.map(p => p.purchaseOrderNumber).filter(Boolean));
        selectedPoNumbers = selectedPoNumbers.filter(p => poSet.has(p));
        renderTable();
        updateInhouseSummary();
        populateFcFilterOptions();
        updatePicklistButtonState();
        if (!sync) {
          lastSyncTime = new Date();
          lastSyncFromSpapi = data.source === "spapi";
          if (!nextAutoSyncAt) {
            nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
          }
        }
        updateSyncInfo();
      } catch (err) {
        console.error(err);
        alert("Failed to load POs");
      } finally {
        if (btn && sync) { btn.disabled = false; btn.textContent = "Sync Vendor POs"; }
      }
    }

    async function loadNotifications() {
      const statusEl = document.getElementById("notifications-status");
      const tbody = document.getElementById("notifications-rows");
      if (statusEl) statusEl.textContent = "Loading...";
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="empty">Loading...</td></tr>';
      try {
        const resp = await fetch("/api/vendor-notifications/recent");
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        recentNotifications = data.items || [];
        if (!recentNotifications.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="empty">No notifications</td></tr>';
        } else {
          tbody.innerHTML = recentNotifications.map(n => {
            const poLink = n.po
              ? `<a href="#" onclick="openNotificationPo('${n.po}'); return false;">${escapeHtml(n.po)}</a>`
              : "";
            return `<tr>
              <td>${formatTs(n.ts)}</td>
              <td>${escapeHtml(n.notificationType || "")}</td>
              <td>${poLink}</td>
              <td>${escapeHtml(n.summary || "")}</td>
            </tr>`;
          }).join("");
        }
        if (statusEl) statusEl.textContent = `Loaded ${recentNotifications.length} notifications`;
      } catch (err) {
        console.error("Failed to load notifications", err);
        if (statusEl) statusEl.textContent = "Failed to load notifications";
        if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="empty">Failed to load notifications</td></tr>';
      }
    }

    function openNotificationPo(poNumber) {
      const po = vendorPOs.find(p => p.purchaseOrderNumber === poNumber);
      if (po) {
        openModal(po);
      } else {
        alert(`PO ${poNumber} not found in current list. Please sync or search.`);
      }
    }

    async function rebuildPOs() {
      const btn = document.getElementById("rebuild-btn");
      const syncBtn = document.getElementById("sync-btn");
      if (btn) { btn.disabled = true; btn.textContent = "Rebuilding..."; }
      if (syncBtn) syncBtn.disabled = true;
      try {
        const resp = await fetch("/api/vendor-pos/rebuild", { method: "POST" });
        let fetched = 0;
        if (resp.ok) {
          const data = await resp.json();
          fetched = data.fetched || 0;
        } else {
          const txt = await resp.text();
          throw new Error(txt || `HTTP ${resp.status}`);
        }
        lastSyncTime = new Date();
        lastSyncFromSpapi = true;
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
        updateSyncInfo();
        const hh = String(lastSyncTime.getHours()).padStart(2, "0");
        const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
        showToast(`Full rebuild completed at ${hh}:${mi}, ${fetched} POs fetched.`);
        await loadPOs(false);
      } catch (err) {
        console.error(err);
        alert("Full rebuild failed");
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = "Full Rebuild POs"; }
        if (syncBtn) syncBtn.disabled = false;
      }
    }

    function getPoDate(po) {
      return po.purchaseOrderDate || po.orderDetails?.purchaseOrderDate || "";
    }

    function formatQtyWithUnits(qty) {
      qty = Number(qty) || 0;
      return qty === 0 ? "0 units" : `${qty} units`;
    }

    function formatCost(costObj) {
      if (!costObj) return "";
      if (typeof costObj === "string") return costObj;
      if (typeof costObj === "number") return costObj;
      if (costObj.amount !== undefined) {
        return `${costObj.currencyCode || "AED"} ${costObj.amount}`;
      }
      return "";
    }

    function applyStatusRowClass(row, status) {
      row.classList.remove("po-status-preparing", "po-status-appointment", "po-status-delivered");
      const s = (status || "").toLowerCase();
      if (s === "preparing") {
        row.classList.add("po-status-preparing");
      } else if (s === "appointment scheduled") {
        row.classList.add("po-status-appointment");
      } else if (s === "delivered") {
        row.classList.add("po-status-delivered");
      }
    }

    function toDateInputValue(isoDateStr) {
      if (!isoDateStr) return "";
      return isoDateStr.substring(0, 10);
    }

    function todayAsYyyyMmDd() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function isAppointmentStatus(status) {
      const s = (status || "").toLowerCase();
      return s === "appointment scheduled" || s === "appointment taken";
    }

    function updateLocalPoStatusData(poNumber, status, statusDate) {
      const item = vendorPOs.find(p => p.purchaseOrderNumber === poNumber);
      if (!item) return;
      
      if (status !== undefined && status !== null) {
        item._internalStatus = status;
      }
      item._appointmentDate = statusDate || null;
    }

    // Listen for date input changes in Status Date column
    document.addEventListener("change", async (e) => {
      const inp = e.target;
      if (!inp.classList.contains("po-status-date-input")) return;

      const row = inp.closest("tr");
      if (!row) return;

      const po = inp.getAttribute("data-po");
      const newDate = inp.value;
      const statusSelect = row.querySelector(".po-status-select");
      const currentStatus = statusSelect ? statusSelect.value : null;

      if (!po || !currentStatus || !newDate) return;

      // Only valid if status is Appointment Scheduled / Taken
      const sLower = currentStatus.toLowerCase();
      if (sLower !== "appointment scheduled" && sLower !== "appointment taken") return;

      try {
        const res = await fetch(`/api/po-status/${encodeURIComponent(po)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: currentStatus,
            appointmentDate: newDate
          }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Keep input synced with backend value
        if (data.appointmentDate) {
          inp.value = toDateInputValue(data.appointmentDate);
        }

        // Update local PO data
        updateLocalPoStatusData(po, data.status || currentStatus, data.appointmentDate);

        updateInhouseSummary();
      } catch (err) {
        console.error("Failed to update appointment date", err);
        alert("Failed to save appointment date. Please try again.");
      }
    }, true);

    function renderTable() {
      const tbody = document.getElementById("po-rows");
      tbody.innerHTML = "";
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="14" class="empty">No POs</td></tr>';
        return;
      }

      list.forEach(po => {
        const poNumber = po.purchaseOrderNumber || "";
        const flags = po.notificationFlags || {};
        const notifBadge = flags.has_recent_notifications
          ? `<span style="margin-left:6px; padding:2px 6px; border-radius:6px; background:#fef3c7; color:#92400e; font-size:11px;" title="Last notification: ${escapeHtml(flags.last_notification_summary || "")} at ${formatTs(flags.last_notification_ts || "")}${flags.needs_refresh ? ' • Needs refresh' : ''}">${flags.needs_refresh ? "Update Ready" : "Updated"}</span>`
          : "";
        const isChecked = selectedPoNumbers.includes(poNumber);

        const poItemsCount = Number(po.poItemsCount) || 0;
        const requestedQty = formatQtyWithUnits(po.requestedQty);
        const acceptedQty = formatQtyWithUnits(po.acceptedQty);
        const receivedQty = formatQtyWithUnits(po.receivedQty);
        const remainingQty = formatQtyWithUnits(po.remainingQty);
        const cancelledQty = formatQtyWithUnits(po.cancelledQty);
        
        // FIXED: Use corrected total_accepted_cost (accepted_qty * unit_price)
        const costAmount = po.total_accepted_cost ? po.total_accepted_cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "0.00";
        const costCurrency = po.total_accepted_cost_currency || po.totalAcceptedCostCurrency || "AED";
        const totalAcceptedCost = `${costCurrency} ${costAmount}`;
        
        const internalStatus = po._internalStatus || "Pending";
        const amazonStatus = po.amazonStatus || "—";
        const shipToLocation = po.shipToText || (po.orderDetails?.shipToParty?.partyId ? `${po.orderDetails.shipToParty.partyId}` : "");

        const tr = document.createElement("tr");
        tr.ondblclick = () => openModal(po);
        applyStatusRowClass(tr, internalStatus);

        // Status column: dropdown only
        const statusDropdown = `<select class="po-status-select" data-po="${escapeAttr(poNumber)}" onchange="handleStatusChange('${escapeAttr(poNumber)}', this)">
          ${INTERNAL_STATUS_OPTIONS.map(opt => `<option value="${escapeAttr(opt)}" ${opt === internalStatus ? "selected" : ""}>${escapeHtml(opt)}</option>`).join("")}
        </select>`;

        // Status Date column: depends on status
        const statusLower = internalStatus.toLowerCase();
        const hasDate = !!po._appointmentDate;
        let statusDateCellHtml = "";

        if (statusLower === "appointment scheduled" || statusLower === "appointment taken") {
          // Editable date input
          const dateValue = hasDate ? toDateInputValue(po._appointmentDate) : todayAsYyyyMmDd();
          statusDateCellHtml = `<input type="date" class="po-status-date-input" data-po="${escapeAttr(poNumber)}" value="${dateValue}" />`;
        } else if (statusLower === "delivered" && hasDate) {
          // Read-only text for Delivered
          statusDateCellHtml = `<span data-col="status-date">${escapeHtml(fmtDate(po._appointmentDate))}</span>`;
        } else {
          // Pending/Preparing or no date
          statusDateCellHtml = `<span data-col="status-date">—</span>`;
        }

        tr.innerHTML = `
      <td><input type="checkbox" ${isChecked ? "checked" : ""} onchange="toggleSelectPo('${poNumber}', this.checked)" /></td>
      <td><div style="display:flex; align-items:center; gap:6px;">${poNumber}${notifBadge}</div></td>
      <td style="text-align:center;">${poItemsCount}</td>
      <td>${fmtDate(getPoDate(po))}</td>
      <td style="text-align:center;">${requestedQty}</td>
      <td style="text-align:center;">${acceptedQty}</td>
      <td style="text-align:center;">${receivedQty}</td>
      <td style="text-align:center;">${remainingQty}</td>
      <td style="text-align:center;">${cancelledQty}</td>
      <td style="text-align:right; padding-right:16px;">${totalAcceptedCost}</td>
      <td>${statusDropdown}</td>
      <td>${statusDateCellHtml}</td>
      <td>${amazonStatus}</td>
      <td>${shipToLocation}</td>
    `;

        tbody.appendChild(tr);
      });
      updateSelectAllCheckbox();
    }

    async function syncRejectedLinesToOos(poNumber, items, poDate, shipTo) {
      if (!items || !items.length) return;
      const rejected = items.filter(it => {
        const ack = it.acknowledgementStatus || {};
        const conf = (ack.confirmationStatus || it.status || "").toUpperCase();
        return conf === "REJECTED";
      });
      if (!rejected.length) return;
      try {
        await Promise.all(rejected.map(it => {
          const qtyRaw = it.orderedQuantity || {};
          const qtyNum = toNum(qtyRaw.amount) || toNum(qtyRaw.value) || toNum(qtyRaw?.orderedQuantity?.amount);
          const payload = {
            poNumber,
            asin: it.amazonProductIdentifier || "",
            vendorSku: it.vendorProductIdentifier || "",
            purchaseOrderDate: poDate,
            shipToPartyId: shipTo,
            qty: qtyNum,
            image: resolveImage(it) || "",
          };
          if (!payload.poNumber || !payload.asin) return Promise.resolve();
          return fetch("/api/oos-items/mark", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }).catch(() => {});
        }));
      } catch (err) {
        console.warn("Failed syncing rejected lines to OOS", err);
      }
    }

    async function openModal(po) {
      const modal = document.getElementById("modal");
      const body = document.getElementById("modal-body");
      const titleEl = document.getElementById("modal-title");

      const poNumber = po.purchaseOrderNumber || po.poNumber || "";
      if (!poNumber) {
        console.error("No purchaseOrderNumber on PO", po);
        return;
      }

      let enrichedPo = po;
      try {
        const resp = await fetch(`/api/vendor-pos/${encodeURIComponent(poNumber)}?enrich=1`);
        if (resp.ok) {
          const data = await resp.json();
          if (data && data.item) {
            enrichedPo = data.item;
          }
        }
        else {
          console.error("Failed to fetch enriched PO", resp.status, await resp.text());
        }
      } catch (e) {
        console.error("Failed to fetch enriched PO", e);
      }

      const d = enrichedPo.orderDetails || {};
      const items = d.items || [];
      const notifFlags = enrichedPo.notificationFlags || {};
      const notifLine = notifFlags.has_recent_notifications
        ? `<div style="font-size:12px; color:#0ea5e9; margin-bottom:8px;">Last Amazon notification: ${escapeHtml(notifFlags.last_notification_summary || "")} at ${formatTs(notifFlags.last_notification_ts || "")}${notifFlags.needs_refresh ? " • refresh applied" : ""}</div>`
        : `<div style="font-size:12px; color:#6b7280; margin-bottom:8px;">No recent notifications</div>`;
      await syncRejectedLinesToOos(poNumber, items, getPoDate(enrichedPo), d.shipToParty?.partyId || "");
      const poDate = getPoDate(enrichedPo);
      const shipTo = d.shipToParty?.partyId || "";
      const rows = items.map(it => {
        const qtyRaw = it.orderedQuantity || {};
        const qtyNum = toNum(qtyRaw.amount) || toNum(qtyRaw.value) || toNum(qtyRaw?.orderedQuantity?.amount);
        const qtyAmount = qtyNum || 0;
        const { netAmount, netCurrency } = resolveNet(it);
        const netNum = netAmount;
        
        // FIX: Use accepted_line_amount if available (computed by backend), else fall back to manual calculation
        let acceptedLineAmount = 0;
        if (it.accepted_line_amount !== undefined) {
          acceptedLineAmount = it.accepted_line_amount;
        } else {
          // Fallback calculation if not provided by backend
          const accAmt = toNum((it.acknowledgementStatus?.acceptedQuantity || {}).amount) || 0;
          acceptedLineAmount = Number.isFinite(accAmt * netNum) ? accAmt * netNum : 0;
        }
        
        const rawAsin = it.amazonProductIdentifier || it.buyerProductIdentifier || it.vendorProductIdentifier || "";
        const asin = qualifyAsin(rawAsin);
        const vendorSku = it.vendorProductIdentifier || "";
        const seq = it.itemSequenceNumber || "";
        const ack = it.acknowledgementStatus || {};
        const currStatus = (ack.confirmationStatus || "ACCEPTED").toUpperCase();
        const accAmt = toNum((ack.acceptedQuantity || {}).amount) || (currStatus === "ACCEPTED" ? qtyAmount : 0);
        const rejAmt = toNum((ack.rejectedQuantity || {}).amount) || (currStatus === "REJECTED" ? qtyAmount : 0);
        
        // Get received quantity (from backend extraction of receivingStatus.receivedQuantity)
        const receivedQty = it.received_qty !== undefined ? it.received_qty : toNum(it.receivedQuantity?.amount) || 0;

        // Determine if this line is rejected or received
        const isRejected = (currStatus === "REJECTED") || (accAmt === 0 && rejAmt > 0);
        const isReceived = !isRejected && receivedQty > 0;
        let rowClass = '';
        if (isRejected) {
          rowClass = ' class="po-line-rejected"';
        } else if (isReceived) {
          rowClass = ' class="po-line-received"';
        }

        const rawImageUrl = resolveImage(it);
        const img = rawImageUrl
          ? `<img src="${rawImageUrl}" alt="" style="max-width:60px;max-height:60px;border-radius:6px;object-fit:contain;" />`
          : `<div class="img-placeholder" data-asin="${asin || ""}" data-sku="${vendorSku || ""}" style="width:60px; height:60px; background:#e5e7eb; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:11px;">No image</div>`;
        const encodedImage = encodeURIComponent(rawImageUrl || "");

        return `<tr${rowClass} oncontextmenu="markItemOos(event, '${poNumber}', '${asin}', '${vendorSku}', '${po.purchaseOrderDate || d.purchaseOrderDate || ""}', '${shipTo}', '${qtyAmount}', '${encodedImage}')">
          <td>${seq}</td>
          <td>${img}</td>
          <td data-col="ordered">${qtyAmount}</td>
          <td>${accAmt}</td>
          <td>${receivedQty}</td>
          <td>${rejAmt}</td>
          <td>${currStatus}</td>
          <td>${Number.isFinite(netNum) && netNum ? netNum.toFixed(2) : ""}</td>
          <td>${netCurrency || ""}</td>
          <td>${Number.isFinite(acceptedLineAmount) && acceptedLineAmount > 0 ? acceptedLineAmount.toFixed(2) : "0.00"}</td>
        </tr>`;
      }).join("");

      // Compute PO-level accepted total (from backend if available, else sum items)
      let poAcceptedTotal = 0;
      let poAcceptedCurrency = "AED";
      if (enrichedPo.accepted_total_amount !== undefined) {
        poAcceptedTotal = enrichedPo.accepted_total_amount;
        poAcceptedCurrency = enrichedPo.accepted_total_currency || "AED";
      } else {
        // Fallback: sum up accepted_line_amount from all items
        items.forEach(it => {
          if (it.accepted_line_amount !== undefined) {
            poAcceptedTotal += it.accepted_line_amount;
          }
        });
        poAcceptedCurrency = items.length > 0 && items[0].netCost?.currencyCode ? items[0].netCost.currencyCode : "AED";
      }

      const formattedTotal = Number.isFinite(poAcceptedTotal) && poAcceptedTotal > 0
        ? `${poAcceptedCurrency} ${poAcceptedTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
        : `${poAcceptedCurrency} 0.00`;

      // Build summary row
      const summaryRow = `<tr class="po-items-summary">
        <td colspan="8"></td>
        <td style="text-align: right;">Accepted Total:</td>
        <td style="text-align: right; font-weight: 700;">${formattedTotal}</td>
      </tr>`;

      titleEl.textContent = `PO ${poNumber} Items`;
      body.innerHTML = `
        <div style="overflow:auto; max-height:70vh;">
          ${notifLine}
          <table class="table">
            <thead>
              <tr>
                <th>Seq</th>
                <th>Image</th>
                <th>Ordered</th>
                <th>Accepted</th>
                <th>Received</th>
                <th>Rejected</th>
                <th>Status</th>
                <th>Net Amount</th>
                <th>Currency</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="10" class="empty">No items</td></tr>'}${rows ? summaryRow : ''}</tbody>
          </table>
        </div>
      `;
      modal.style.display = "flex";
      populateMissingImages(items);
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    async function populateMissingImages(items) {
      const placeholders = Array.from(document.querySelectorAll(".img-placeholder[data-asin]"));
      const uniqueAsins = Array.from(new Set(placeholders.map(p => p.dataset.asin).filter(Boolean)));
      if (!uniqueAsins.length) return;

      for (const asin of uniqueAsins) {
        if (catalogImageCache.hasOwnProperty(asin)) continue;
        try {
          const resp = await fetch(`/api/catalog/item/${asin}`);
          if (!resp.ok) {
            catalogImageCache[asin] = null;
            continue;
          }
          const data = await resp.json();
          const payload = data.item || data.payload || data || {};
          const direct = data.image || payload.image;
          const candidate = direct || resolveImage(payload);
          catalogImageCache[asin] = candidate || null;
        } catch {
          catalogImageCache[asin] = null;
        }
      }

      placeholders.forEach(ph => {
        const asin = ph.dataset.asin;
        const cached = catalogImageCache[asin];
        if (cached) {
          ph.outerHTML = `<img src="${cached}" alt="" style="max-width:60px;max-height:60px;border-radius:6px;object-fit:contain;" />`;
        }
      });
    }

    function qualifyAsin(val) {
      if (!val) return "";
      const v = String(val).trim();
      const re = /^[A-Z0-9]{8,15}$/i;
      if (re.test(v)) return v.toUpperCase();
      return "";
    }


    async function handleStatusChange(poNumber, selectEl) {
      const newStatus = selectEl.value;
      const row = selectEl.closest("tr");
      let statusDateToSend = null;

      const statusLower = newStatus.toLowerCase();

      if (statusLower === "appointment scheduled" || statusLower === "appointment taken") {
        // Appointment: use existing date or default to today
        const existingInput = row ? row.querySelector(".po-status-date-input") : null;
        if (existingInput && existingInput.value) {
          statusDateToSend = existingInput.value;
        } else {
          statusDateToSend = todayAsYyyyMmDd();
        }
      } else if (statusLower === "delivered") {
        // Delivered: keep existing date if present
        const existingInput = row ? row.querySelector(".po-status-date-input") : null;
        const existingSpan = row ? row.querySelector("[data-col='status-date']") : null;
        if (existingInput && existingInput.value) {
          statusDateToSend = existingInput.value;
        } else if (existingSpan && existingSpan.textContent && existingSpan.textContent !== "—") {
          statusDateToSend = toDateInputValue(existingSpan.textContent);
        } else {
          statusDateToSend = todayAsYyyyMmDd();
        }
      } else {
        // Pending / Preparing: no date
        statusDateToSend = null;
      }

      try {
        const res = await fetch(`/api/po-status/${encodeURIComponent(poNumber)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: newStatus,
            appointmentDate: statusDateToSend || null,
          }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Update Status Date cell based on returned status and date
        const statusDateCell = row ? row.querySelector("[data-col='status-date']") : null;
        if (statusDateCell || row) {
          const statusLower2 = (data.status || newStatus).toLowerCase();
          const hasDate = !!data.appointmentDate;
          let newCellHtml = "";

          if (statusLower2 === "appointment scheduled" || statusLower2 === "appointment taken") {
            // Render editable date input
            const dateValue = hasDate ? toDateInputValue(data.appointmentDate) : todayAsYyyyMmDd();
            newCellHtml = `<input type="date" class="po-status-date-input" data-po="${escapeAttr(poNumber)}" value="${dateValue}" />`;
          } else if (statusLower2 === "delivered" && hasDate) {
            // Render read-only text
            newCellHtml = `<span data-col="status-date">${escapeHtml(fmtDate(data.appointmentDate))}</span>`;
          } else {
            // Pending/Preparing or no date
            newCellHtml = `<span data-col="status-date">—</span>`;
          }

          // Find the Status Date cell and replace its content
          const cellIndex = 11; // Status Date is 12th column (0-indexed)
          const cells = row.querySelectorAll("td");
          if (cells[cellIndex]) {
            cells[cellIndex].innerHTML = newCellHtml;
          }
        }

        // Update local PO data
        updateLocalPoStatusData(poNumber, data.status || newStatus, data.appointmentDate);

        // Apply row highlight
        if (row) {
          applyStatusRowClass(row, data.status || newStatus);
        }

        // Update summary
        updateInhouseSummary();
        filterPOs();
      } catch (err) {
        console.error("Failed to save PO status", err);
        alert("Failed to update status. Please try again.");
      }
    }

    async function updateAppointmentDate(poNumber, inputEl) {
      const newDate = inputEl.value || null;
      const tr = inputEl.closest("tr");
      let status = "Pending";

      if (tr) {
        const select = tr.querySelector("select.po-status-select");
        if (select) {
          status = select.value;
        }
      }

      try {
        await fetch(`/api/po-status/${encodeURIComponent(poNumber)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            status: status,
            appointmentDate: newDate,
          }),
        });
        updateLocalPoStatus(poNumber, status, newDate);
        updateInhouseSummary();
        filterPOs();
      } catch (err) {
        console.error("Failed to save appointment date", err);
        alert("Failed to save appointment date. Check console for details.");
      }
    }

    function updateLocalPoStatus(poNumber, status, appointmentDate) {
      const lists = [vendorPOs, filteredPOs];
      lists.forEach(list => {
        if (!list) return;
        const po = list.find(p => p.purchaseOrderNumber === poNumber);
        if (po) {
          po._internalStatus = status;
          if (appointmentDate) {
            po._appointmentDate = appointmentDate;
          } else {
            delete po._appointmentDate;
          }
        }
      });
    }

    function filterPOs() {
      const searchInput = document.getElementById("po-search");
      const fcSelect    = document.getElementById("po-filter-fc");
      const statusSelect = document.getElementById("po-filter-status");
      const dateWindowSelect = document.getElementById("po-start-days");

      const qRaw = (searchInput?.value || "").trim().toLowerCase();
      const fcFilter = (fcSelect?.value || "").trim().toLowerCase();
      const statusFilter = (statusSelect?.value || "").trim();
      const daysWindow = Number(dateWindowSelect?.value || 60);

      // Calculate date cutoff
      const now = new Date();
      const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysWindow);

      filteredPOs = (vendorPOs || []).filter(po => {
        const d = po.orderDetails || {};
        const items = d.items || [];
        const shipTo = (d.shipToParty?.partyId || "").toLowerCase();
        const poNumber = (po.purchaseOrderNumber || "").toLowerCase();
        const state = (po.purchaseOrderState || "").toLowerCase();
        const inhouseStatus = (po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending").toLowerCase();

        // Date window filter
        const orderDateStr = po.purchaseOrderDate || d.purchaseOrderDate || "";
        if (orderDateStr) {
          const orderDate = new Date(orderDateStr);
          if (!Number.isNaN(orderDate.getTime()) && orderDate < cutoff) {
            return false;
          }
        }

        let asins = "";
        let skus = "";
        items.forEach(it => {
          asins += " " + String(it.amazonProductIdentifier || "").toLowerCase();
          skus  += " " + String(it.vendorProductIdentifier || "").toLowerCase();
        });

        const haystack = [
          poNumber,
          state,
          inhouseStatus,
          shipTo,
          asins,
          skus,
        ].join(" ");

        if (qRaw && !haystack.includes(qRaw)) {
          return false;
        }

        if (fcFilter && shipTo !== fcFilter) {
          return false;
        }

        const currentStatus = (po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending");
        if (statusFilter && currentStatus !== statusFilter) {
          return false;
        }

        return true;
      });

      renderTable();
      updateInhouseSummary();
    }

    function updateInhouseSummary() {
      const el = document.getElementById("inhouse-summary");
      if (!el) return;

      const list = filteredPOs && filteredPOs.length ? filteredPOs : vendorPOs;
      const counts = {
        "Pending": 0,
        "Preparing": 0,
        "Appointment Scheduled": 0,
        "Delivered": 0,
      };

      list.forEach(po => {
        const status = po._internalStatus || po._inhouseStatus || po.inhouseStatus || "Pending";
        if (counts.hasOwnProperty(status)) {
          counts[status]++;
        }
      });

      el.textContent =
        `Pending: ${counts["Pending"]}  |  ` +
        `Preparing: ${counts["Preparing"]}  |  ` +
        `Appointment Scheduled: ${counts["Appointment Scheduled"]}  |  ` +
        `Delivered: ${counts["Delivered"]}`;
    }

    function populateFcFilterOptions() {
      const select = document.getElementById("po-filter-fc");
      if (!select) return;

      const values = new Set();
      (vendorPOs || []).forEach(po => {
        const d = po.orderDetails || {};
        const fc = d.shipToParty?.partyId || "";
        if (fc) values.add(fc);
      });

      const currentValue = select.value;
      select.innerHTML = "";

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "All F/C";
      select.appendChild(optAll);

      Array.from(values).sort().forEach(fc => {
        const opt = document.createElement("option");
        opt.value = fc;
        opt.textContent = fc;
        select.appendChild(opt);
      });

      if (currentValue && values.has(currentValue)) {
        select.value = currentValue;
      }
    }

    async function showCatalogDetails(asin) {
      const modal = document.getElementById("catalog-modal");
      const body = document.getElementById("catalog-modal-body");
      const titleEl = document.getElementById("catalog-modal-title");
      titleEl.textContent = `Catalog Details: ${asin}`;
      body.innerHTML = '<div class="json-block">Loading...</div>';
      modal.style.display = "flex";
      try {
        const resp = await fetch(`/api/catalog/item/${asin}`);
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        body.innerHTML = `<pre id="catalog-json" class="json-block" ondblclick="copyCatalogJson()"></pre>`;
        document.getElementById("catalog-json").textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        body.innerHTML = `<div class="json-block">Failed to load catalog details: ${err}</div>`;
      }
    }

    function closeCatalogModal() {
      document.getElementById("catalog-modal").style.display = "none";
    }

    async function openPoLinesModal(poNumber) {
      const modal = document.getElementById("po-lines-modal");
      const titleEl = document.getElementById("po-lines-modal-title");
      const bodyEl = document.getElementById("po-lines-modal-body");

      titleEl.textContent = `PO ${poNumber} - Line Items Inventory Breakdown`;
      bodyEl.innerHTML = '<div style="padding:16px; text-align:center;">Loading line details...</div>';
      modal.style.display = "flex";

      try {
        const resp = await fetch(`/api/vendor-po-lines?po_number=${encodeURIComponent(poNumber)}`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const lines = data.items || [];

        if (!lines.length) {
          bodyEl.innerHTML = '<div style="padding:16px; text-align:center; color:#6b7280;">No line items found for this PO in the database.</div>';
          return;
        }

        // Build table
        const rows = lines.map(line => {
          const shortage = line.shortage_qty || 0;
          const pending = line.pending_qty || 0;
          const shortageClass = shortage > 0 ? "qty-shortage" : (pending > 0 ? "qty-pending" : "qty-good");
          
          return `<tr>
            <td>${line.asin || ""}</td>
            <td>${line.sku || ""}</td>
            <td style="text-align:center;">${line.ordered_qty || 0}</td>
            <td style="text-align:center;">${line.received_qty || 0}</td>
            <td class="${shortageClass}" style="text-align:center;">${line.pending_qty || 0}</td>
            <td class="${shortageClass}" style="text-align:center; font-weight:600;">${shortage > 0 ? '⚠️ ' + shortage : shortage}</td>
          </tr>`;
        }).join("");

        bodyEl.innerHTML = `
          <div style="padding:16px;">
            <div style="margin-bottom:16px; padding:12px; background:#f3f4f6; border-radius:8px;">
              <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Ordered</div>
                  <div style="font-size:18px; font-weight:700;">${lines.reduce((s, l) => s + (l.ordered_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Received</div>
                  <div style="font-size:18px; font-weight:700;">${lines.reduce((s, l) => s + (l.received_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Pending</div>
                  <div style="font-size:18px; font-weight:700; color:#b45309;">${lines.reduce((s, l) => s + (l.pending_qty || 0), 0)}</div>
                </div>
                <div>
                  <div style="font-size:12px; color:#6b7280;">Total Shortage</div>
                  <div style="font-size:18px; font-weight:700; color:#dc2626;">${lines.reduce((s, l) => s + (l.shortage_qty || 0), 0)}</div>
                </div>
              </div>
            </div>
            <div style="overflow:auto; max-height:60vh;">
              <table>
                <thead>
                  <tr>
                    <th>ASIN</th>
                    <th>SKU</th>
                    <th style="text-align:center;">Ordered</th>
                    <th style="text-align:center;">Received</th>
                    <th style="text-align:center;">Pending</th>
                    <th style="text-align:center;">Shortage</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } catch (err) {
        console.error("Failed to load PO lines", err);
        bodyEl.innerHTML = `<div style="padding:16px; color:#dc2626;">⚠️ Failed to load line details: ${err.message || err}</div>`;
      }
    }

    function closePoLinesModal() {
      document.getElementById("po-lines-modal").style.display = "none";
    }

    function resolveImage(it) {
      const candidates = [];
      const pushCandidate = (obj) => {
        if (!obj || typeof obj !== "object") return;
        candidates.push(obj.image, obj.imageUrl, obj.detailPageImage, obj.thumbnail, obj.mainImage?.link, obj.mainImage?.url);
        if (Array.isArray(obj.summaries)) {
          obj.summaries.forEach(s => {
            if (!s || typeof s !== "object") return;
            candidates.push(s.mainImage?.link, s.mainImage?.url, s.image, s.imageUrl);
            if (Array.isArray(s.images)) {
              s.images.forEach(im => candidates.push(im && (im.link || im.url)));
            }
          });
        }
        if (Array.isArray(obj.images)) {
          obj.images.forEach(img => {
            if (!img) return;
            candidates.push(img.link, img.url);
            if (Array.isArray(img.variants)) {
              img.variants.forEach(v => candidates.push(v && (v.link || v.url)));
            }
            if (Array.isArray(img.images)) {
              img.images.forEach(v => candidates.push(v && (v.link || v.url)));
            }
          });
        }
      };

      pushCandidate(it);
      if (it && typeof it === "object") {
        pushCandidate(it.payload);
      }

      return candidates.find(Boolean) || "";
    }

    function resolveNet(it) {
      const nets = [it.netCost, it.listPrice, it.price, it.unitPrice];
      let amount = 0;
      let currency = "";
      for (const n of nets) {
        if (n && typeof n === "object") {
          amount = toNum(n.amount) || toNum(n.value) || toNum(n.price);
          currency = n.currencyCode || n.currency || n.code || currency;
          if (amount) break;
        }
      }
      if (!currency) {
        currency = it.currencyCode || it.currency || it.orderedQuantity?.currencyCode || "";
      }
      if (!currency && amount) {
        currency = "AED";
      }
      return { netAmount: amount, netCurrency: currency };
    }


    function copyCatalogJson() {
      const pre = document.getElementById("catalog-json");
      if (!pre) return;
      const text = pre.textContent || "";
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const range = document.createRange();
        range.selectNode(pre);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try { document.execCommand("copy"); } catch (e) {}
        sel.removeAllRanges();
      }
    }

    let toastTimeoutId = null;
    function showToast(message) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.textContent = message;
      el.style.opacity = "1";
      if (toastTimeoutId) clearTimeout(toastTimeoutId);
      toastTimeoutId = setTimeout(() => {
        el.style.opacity = "0";
      }, 4000);
    }

    function toggleSelectPo(poNumber, checked) {
      if (!poNumber) return;
      if (checked) {
        if (!selectedPoNumbers.includes(poNumber)) {
          selectedPoNumbers.push(poNumber);
        }
      } else {
        selectedPoNumbers = selectedPoNumbers.filter(p => p !== poNumber);
      }
      updateSelectAllCheckbox();
      updatePicklistButtonState();
    }

    function toggleSelectAllPos(headerCheckbox) {
      const checked = headerCheckbox?.checked;
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      if (checked) {
        selectedPoNumbers = Array.from(new Set([...selectedPoNumbers, ...list.map(p => p.purchaseOrderNumber).filter(Boolean)]));
      } else {
        const visibleSet = new Set(list.map(p => p.purchaseOrderNumber).filter(Boolean));
        selectedPoNumbers = selectedPoNumbers.filter(p => !visibleSet.has(p));
      }
      renderTable();
      updatePicklistButtonState();
    }

    function updateSelectAllCheckbox() {
      const headerCheckbox = document.getElementById("po-select-all");
      if (!headerCheckbox) return;
      const list = filteredPOs && Array.isArray(filteredPOs) ? filteredPOs : vendorPOs;
      const visiblePos = list.map(p => p.purchaseOrderNumber).filter(Boolean);
      if (!visiblePos.length) {
        headerCheckbox.checked = false;
        headerCheckbox.indeterminate = false;
        return;
      }
      const selectedVisible = visiblePos.filter(p => selectedPoNumbers.includes(p));
      headerCheckbox.checked = selectedVisible.length === visiblePos.length;
      headerCheckbox.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visiblePos.length;
    }

    function updatePicklistButtonState() {
      const btn = document.getElementById("picklist-btn");
      if (!btn) return;
      btn.disabled = !selectedPoNumbers.length;
    }

    function aggregate(items) {
      let totalCost = 0;
      let currency = "";
      items.forEach(it => {
        const qty = toNum(it?.orderedQuantity?.amount);
        const unitCost = toNum(it?.netCost?.amount);
        totalCost += qty * unitCost;
        if (it?.netCost?.currencyCode) currency = it.netCost.currencyCode;
      });
      return { totalCost, currency };
    }

    function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function formatNum(v, cur = "") {
      const n = Number(v);
      if (!Number.isFinite(n)) return "";
      return (cur ? cur + " " : "") + n.toFixed(2);
    }

    function fmtDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function formatTs(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return ts;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeAttr(str) {
      if (str === undefined || str === null) return "";
      return String(str).replace(/"/g, "&quot;");
    }

    function formatSyncTime(d) {
      if (!d) return "—";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}-${mm}-${yyyy} ${hh}:${mi}`;
    }

    function formatEta(msDiff) {
      if (msDiff <= 0) return "soon";
      const totalMinutes = Math.floor(msDiff / 60000);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      if (h <= 0) return `in ${m}m`;
      return `in ${h}h ${m}m`;
    }

    function updateSyncInfo() {
      const lastEl = document.getElementById("sync-last");
      const nextEl = document.getElementById("sync-next");
      if (!lastEl || !nextEl) return;

      if (!lastSyncTime) {
        lastEl.textContent = "Last Sync: —";
      } else {
        const src = lastSyncFromSpapi ? "(from SP-API)" : "(from cache)";
        lastEl.textContent = `Last Sync: ${formatSyncTime(lastSyncTime)} ${src}`;
      }

      if (!nextAutoSyncAt) {
        nextEl.textContent = "Next Auto-Sync: —";
      } else {
        const diff = nextAutoSyncAt - Date.now();
        nextEl.textContent = `Next Auto-Sync: ${formatEta(diff)}`;
      }
    }

    function showTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      document.getElementById("pos-tab").style.display = tab === "pos" ? "block" : "none";
      document.getElementById("catalog-tab").style.display = tab === "catalog" ? "block" : "none";
      document.getElementById("oos-tab").style.display = tab === "oos" ? "block" : "none";
      const testerEl = document.getElementById("tester-tab");
      if (testerEl) {
        testerEl.style.display = tab === "tester" ? "block" : "none";
      }
      const notifEl = document.getElementById("notifications-tab");
      if (notifEl) {
        notifEl.style.display = tab === "notifications" ? "block" : "none";
        if (tab === "notifications") {
          loadNotifications();
        }
      }
      const rtSalesEl = document.getElementById("vendor-rt-sales-tab");
      if (rtSalesEl) {
        rtSalesEl.style.display = tab === "vendor-rt-sales" ? "block" : "none";
        if (tab === "vendor-rt-sales") {
          initRtSalesTab();
          loadVendorRtSalesSummary();
          startRtSalesStatusPolling();
        } else {
          stopRtSalesStatusPolling();
        }
      }
      const inventoryEl = document.getElementById("inventory-tab");
      if (inventoryEl) {
        inventoryEl.style.display = tab === "inventory" ? "block" : "none";
        if (tab === "inventory") {
          loadVendorInventorySnapshotIfNeeded();
        }
      }
      const salesTrendsEl = document.getElementById("sales-trends-tab");
      if (salesTrendsEl) {
        salesTrendsEl.style.display = tab === "sales-trends" ? "block" : "none";
      }
      if (tab === "catalog" && !asinList.length) {
        loadAsinList();
      }
      if (tab === "oos") {
        loadOosItems();
      }
      if (tab === "tester") {
        loadTesterMeta();
      }
    }

    function showInventorySubtab(name) {
      const overviewSubtab = document.getElementById("inventory-overview-subtab");
      const asinSubtab = document.getElementById("inventory-asin-subtab");
      
      overviewSubtab.style.display = "none";
      asinSubtab.style.display = "none";

      if (name === "overview") {
        overviewSubtab.style.display = "block";
      } else if (name === "asin") {
        asinSubtab.style.display = "block";
      }

      document.querySelectorAll(".subtab-btn").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`.subtab-btn[onclick="showInventorySubtab('${name}')"]`).classList.add("active");
    }

    async function loadTesterMeta() {
      if (testerMetaLoaded) return;
      try {
        const resp = await fetch("/api/spapi-tester/meta");
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        testerPresets = data.presets || [];
        testerHost = data.host || "";
        const presetSelect = document.getElementById("tester-preset");
        if (presetSelect) {
          testerPresets.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.group} — ${p.label}`;
            opt.dataset.path = p.path || "";
            opt.dataset.method = p.method || "GET";
            opt.dataset.defaultQuery = p.default_query || "";
            opt.dataset.defaultBody = p.default_body ? JSON.stringify(p.default_body, null, 2) : "";
            opt.dataset.notes = p.notes || "";
            presetSelect.appendChild(opt);
          });
        }
        const hostLabel = document.getElementById("tester-host");
        if (hostLabel) {
          hostLabel.textContent = testerHost ? `Host: ${testerHost}` : "";
        }
        testerMetaLoaded = true;
      } catch (err) {
        const statusEl = document.getElementById("tester-status");
        if (statusEl) {
          statusEl.textContent = `Failed to load presets: ${err}`;
          statusEl.style.color = "#dc2626";
        }
      }
    }

    function applyTesterPreset() {
      const presetSelect = document.getElementById("tester-preset");
      const endpointInput = document.getElementById("tester-endpoint");
      const methodSelect = document.getElementById("tester-method");
      const statusEl = document.getElementById("tester-status");
      const queryInput = document.getElementById("tester-query");
      const bodyInput = document.getElementById("tester-body");
      if (!presetSelect || !endpointInput) return;
      const selectedOpt = presetSelect.options[presetSelect.selectedIndex];
      const path = selectedOpt?.dataset?.path || "";
      const method = selectedOpt?.dataset?.method || "GET";
      const defaultQuery = selectedOpt?.dataset?.defaultQuery || "";
      const defaultBody = selectedOpt?.dataset?.defaultBody || "";
      const notes = selectedOpt?.dataset?.notes || "";
      endpointInput.value = path;
      if (methodSelect) methodSelect.value = method;
      if (queryInput) queryInput.value = defaultQuery;
      if (bodyInput) bodyInput.value = defaultBody;
      if (statusEl) {
        statusEl.textContent = notes || "Preset applied";
        statusEl.style.color = "#475569";
      }
    }

    function parseFullPath(full) {
      if (!full) return { endpoint: "", query: "" };
      full = full.trim();
      try {
        if (full.startsWith("http")) {
          const u = new URL(full);
          return { endpoint: u.pathname, query: u.search ? u.search.substring(1) : "" };
        }
      } catch (e) {
        // fall through to manual split
      }
      const parts = full.split("?");
      const endpoint = parts[0] || "";
      const query = parts.slice(1).join("?") || "";
      return { endpoint, query };
    }

    function applyTesterFullPath() {
      const fullInput = document.getElementById("tester-fullpath");
      const endpointInput = document.getElementById("tester-endpoint");
      const queryInput = document.getElementById("tester-query");
      const statusEl = document.getElementById("tester-status");
      if (!fullInput || !endpointInput || !queryInput) return;
      const parsed = parseFullPath(fullInput.value || "");
      endpointInput.value = parsed.endpoint;
      queryInput.value = parsed.query;
      if (statusEl) {
        statusEl.textContent = parsed.endpoint ? "Applied full path" : "";
        statusEl.style.color = "#475569";
      }
    }

    async function runTesterCall() {
      const endpointInput = document.getElementById("tester-endpoint");
      const queryInput = document.getElementById("tester-query");
      const methodSelect = document.getElementById("tester-method");
      const bodyInput = document.getElementById("tester-body");
      const logEl = document.getElementById("tester-log");
      const statusEl = document.getElementById("tester-status");
      const btns = document.getElementsByClassName("tester-run-btn");
      if (!endpointInput || !logEl) return;
      const fullInput = document.getElementById("tester-fullpath");
      const fullVal = (fullInput?.value || "").trim();
      const method = (methodSelect?.value || "GET").toUpperCase();
      let endpoint = (endpointInput.value || "").trim();
      let query = (queryInput?.value || "").trim();
      if (fullVal) {
        const parsed = parseFullPath(fullVal);
        endpoint = parsed.endpoint || endpoint;
        query = parsed.query || query;
      }
      if (!endpoint) {
        alert("Please enter an endpoint path starting with /");
        return;
      }
      let bodyPayload = null;
      const bodyText = bodyInput?.value?.trim();
      if (method !== "GET" && bodyText) {
        try {
          bodyPayload = JSON.parse(bodyText);
        } catch (e) {
          if (statusEl) {
            statusEl.textContent = `Invalid JSON body: ${e}`;
            statusEl.style.color = "#dc2626";
          }
          return;
        }
      }
      if (statusEl) {
        statusEl.textContent = "Running...";
        statusEl.style.color = "#475569";
      }
      logEl.textContent = "Loading...";
      Array.from(btns).forEach(b => (b.disabled = true));
      try {
        const resp = await fetch("/api/spapi-tester/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            method,
            path: endpoint,
            query_string: query,
            body_json: bodyPayload,
          }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const body = data?.response?.body;
        const statusCode = data?.response?.status_code;
        const display = typeof body === "string" ? body : JSON.stringify(body, null, 2);
        logEl.textContent = display || "(empty body)";
        if (statusEl) {
          statusEl.textContent = `Status: ${statusCode ?? "?"} | ${method} ${endpoint}`;
          statusEl.style.color = "#166534";
        }
      } catch (err) {
        logEl.textContent = `Error: ${err}`;
        if (statusEl) {
          statusEl.textContent = `Error: ${err}`;
          statusEl.style.color = "#dc2626";
        }
      } finally {
        Array.from(btns).forEach(b => (b.disabled = false));
      }
    }

    function copyTesterLog() {
      const logEl = document.getElementById("tester-log");
      if (!logEl) return;
      const text = logEl.textContent || "";
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const range = document.createRange();
        range.selectNode(logEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        try { document.execCommand("copy"); } catch (e) {}
        sel.removeAllRanges();
      }
      const statusEl = document.getElementById("tester-status");
      if (statusEl) {
        statusEl.textContent = "Log copied";
        statusEl.style.color = "#166534";
      }
    }

    async function loadAsinList(force = false) {
      const tbody = document.getElementById("asin-rows");
      tbody.innerHTML = '<tr><td colspan="6" class="empty">Loading...</td></tr>';
      try {
        const resp = await fetch("/api/catalog/asins");
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        asinList = data.items || [];
        filteredAsins = asinList;
        renderAsinList();
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Failed to load ASINs: ${err}</td></tr>`;
      }
    }

    function filterAsins() {
      const q = (document.getElementById("asin-search").value || "").toLowerCase();
      if (!q) {
        filteredAsins = asinList;
      } else {
        filteredAsins = asinList.filter(item => {
          return (item.asin || "").toLowerCase().includes(q) ||
                 (item.sku || "").toLowerCase().includes(q) ||
                 (item.model || "").toLowerCase().includes(q) ||
                 (item.title || "").toLowerCase().includes(q);
        });
      }
      renderAsinList();
    }

    async function fetchAllMissing() {
      const tbody = document.getElementById("asin-rows");
      tbody.innerHTML = '<tr><td colspan="6" class="empty">Fetching all missing... this may take time.</td></tr>';
      try {
        const resp = await fetch("/api/catalog/fetch-all", { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        await loadAsinList(true);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Fetch-all failed: ${err}</td></tr>`;
      }
    }

    async function loadOosItems() {
      const tbody = document.getElementById("oos-rows");
      const statusEl = document.getElementById("oos-status");
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Loading...</td></tr>';
      }
      try {
        const resp = await fetch("/api/oos-items");
        const data = await resp.json();
        oosItems = data.items || [];
        renderOosTable();
        if (statusEl) statusEl.textContent = `Loaded ${oosItems.length} OOS items`;
      } catch (err) {
        if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="empty">Failed to load: ${err}</td></tr>`;
        if (statusEl) statusEl.textContent = "Error loading OOS items";
      }
    }

    function downloadOosXls() {
      const statusEl = document.getElementById("oos-status");
      if (statusEl) statusEl.textContent = "Exporting...";
      
      try {
        // Download the file
        window.open("/api/oos-items/export", "_blank");
        
        // Wait a moment for export to complete on backend, then refresh the list
        setTimeout(async () => {
          await loadOosItems();
          
          // Count how many are now marked as exported
          const exportedCount = oosItems.filter(it => it.export_status === "exported").length;
          if (statusEl) {
            statusEl.textContent = `Export complete. ${exportedCount} total items marked as exported.`;
          }
        }, 1000);
      } catch (err) {
        if (statusEl) statusEl.textContent = "Export failed: " + err.message;
      }
    }

    function renderOosTable() {
      const tbody = document.getElementById("oos-rows");
      if (!tbody) return;
      if (!oosItems.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">No OOS items</td></tr>';
        return;
      }
      tbody.innerHTML = oosItems.map(it => {
        const poNumber = Array.isArray(it.poNumbers) ? it.poNumbers.join(", ") : (it.poNumber || "");
        const poDate = fmtDate(it.purchaseOrderDate || "");
        const shipTo = it.shipToPartyId || "";
        const asin = it.asin || "";
        const sku = it.vendorSku || "";
        const qty = it.qty ?? "";
        const exportStatus = it.export_status || "pending";
        const img = it.image
          ? `<img src="${it.image}" alt="" style="max-width:50px;max-height:50px;object-fit:contain;border-radius:6px;" />`
          : "";
        
        // Row styling: slightly grey out exported items
        const rowClass = exportStatus === "exported" ? ' class="oos-row-exported"' : '';
        
        // Status display
        const statusHTML = exportStatus === "exported"
          ? '<span class="export-status-exported">Exported</span>'
          : '<span class="export-status-pending">Pending for export</span>';
        
        return `
          <tr${rowClass}>
            <td style="display:none;">${poNumber}</td>
            <td style="display:none;">${poDate}</td>
            <td style="display:none;">${shipTo}</td>
            <td>${asin}</td>
            <td>${img}</td>
            <td>${sku}</td>
            <td>${qty}</td>
            <td>${statusHTML}</td>
          </tr>
        `;
      }).join("");
    }

    async function restockOosItem(poNumber, asin) {
      if (!asin) return;
      const statusEl = document.getElementById("oos-status");
      if (statusEl) statusEl.textContent = "Updating...";
      try {
        await fetch("/api/oos-items/restock", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ poNumber, asin }),
        });
        await loadOosItems();
        if (statusEl) statusEl.textContent = `Restocked ${asin}`;
      } catch (err) {
        if (statusEl) statusEl.textContent = `Failed to restock: ${err}`;
      }
    }

    function renderAsinList() {
      const tbody = document.getElementById("asin-rows");
      if (!filteredAsins.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">No ASINs found in Vendor POs</td></tr>';
        return;
      }
      tbody.innerHTML = filteredAsins.map(item => {
        const disabled = item.fetched ? "disabled" : "";
        const label = item.fetched ? "Fetched" : "Fetch";
        const img = item.image ? `<img src="${item.image}" alt="" style="max-width:50px;max-height:50px;object-fit:contain;border-radius:6px;" />` : "";
        const bc = item.barcode || "";
        const bcDisplay = bc || "—";
        return `<tr ondblclick="showCatalogDetails('${item.asin}')">
          <td>${item.asin}</td>
          <td>${item.sku || ""}</td>
          <td>
            <div style="display:flex; align-items:center; gap:6px;">
              <span id="bc-${item.asin}">${bcDisplay}</span>
              <button class="btn" style="padding:4px 8px; background:#0f172a;" onclick="editBarcode('${item.asin}', '${bc}')">Edit</button>
            </div>
          </td>
          <td>${item.title || ""}</td>
          <td>${img}</td>
          <td>${item.fetched ? "Saved" : "Not fetched"}</td>
          <td><button class="btn ${item.fetched ? "" : "btn-fetch"}" data-asin="${item.asin}" ${disabled} onclick="fetchCatalog(this.dataset.asin, this)">${label}</button></td>
        </tr>`;
      }).join("");
    }

    async function fetchCatalog(asin, btnEl) {
      if (btnEl) {
        btnEl.disabled = true;
        btnEl.textContent = "Fetching...";
      }
      try {
        const resp = await fetch(`/api/catalog/fetch/${asin}`, { method: "POST" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        // Mark as fetched
        asinList = asinList.map(item => item.asin === asin ? { ...item, fetched: true } : item);
        filteredAsins = asinList;
        renderAsinList();
      } catch (err) {
        if (btnEl) {
          btnEl.disabled = false;
          btnEl.textContent = "Fetch";
        }
        alert(`Failed to fetch catalog for ${asin}: ${err}`);
      }
    }

    async function editBarcode(asin, current) {
      if (!asin) return;
      const val = prompt("Enter barcode (12-digit UPC or 13-digit EAN)", current || "");
      if (val === null) return;
      const trimmed = (val || "").trim();
      if (!trimmed) return;
      if (!/^\d{12,13}$/.test(trimmed)) {
        alert("Barcode must be 12 or 13 digits (numeric).");
        return;
      }
      try {
        const resp = await fetch("/api/catalog/update-barcode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ asin, barcode: trimmed }),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          const msg = data.detail || `HTTP ${resp.status}`;
          alert(msg);
          return;
        }
        const data = await resp.json();
        const bcSpan = document.getElementById(`bc-${asin}`);
        if (bcSpan) bcSpan.textContent = data.barcode || trimmed;
        showToast("Barcode updated");
      } catch (err) {
        alert(`Failed to update barcode: ${err}`);
      }
    }

    function scheduleInitialAutoSync() {
      if (!nextAutoSyncAt) {
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
      }
      updateSyncInfo();
    }

    function addManualAsin() {
      const input = document.getElementById("manual-asin-input");
      const msg = document.getElementById("manual-asin-msg");
      const asin = (input?.value || "").trim().toUpperCase();
      if (!asin) {
        if (msg) msg.textContent = "Please enter an ASIN.";
        return;
      }
      if (asinList.find(a => a.asin === asin)) {
        if (msg) msg.textContent = "ASIN already listed.";
        return;
      }
      const newEntry = { asin, fetched: false };
      asinList = [newEntry, ...asinList];
      filteredAsins = asinList;
      renderAsinList();
      if (input) input.value = "";
      if (msg) msg.textContent = "Added. Click Fetch to pull catalog data.";
    }

    async function autoSyncIfDue() {
      if (!nextAutoSyncAt) return;
      if (Date.now() < nextAutoSyncAt) return;
      try {
        const resp = await fetch("/api/vendor-pos/sync", { method: "POST" });
        let fetched = 0;
        if (resp.ok) {
          const data = await resp.json();
          fetched = data.fetched || 0;
        }
        await loadPOs(false);
        lastSyncTime = new Date();
        lastSyncFromSpapi = true;
        nextAutoSyncAt = Date.now() + autoSyncIntervalMs;
        updateSyncInfo();
        const hh = String(lastSyncTime.getHours()).padStart(2, "0");
        const mi = String(lastSyncTime.getMinutes()).padStart(2, "0");
        showToast(`Sync completed at ${hh}:${mi}, ${fetched} POs updated.`);
      } catch (err) {
        console.error("Auto-sync failed", err);
      }
    }

    async function openPicklistPreview() {
      if (!selectedPoNumbers.length) return;
      try {
        const resp = await fetch("/api/picklist/preview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ purchaseOrderNumbers: selectedPoNumbers }),
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const data = await resp.json();
        const summary = data.summary || {};
        const items = (data.items || []);
        items.sort((a, b) => (b.totalQty || 0) - (a.totalQty || 0));
        const modal = document.getElementById("picklist-modal");
        const body = document.getElementById("picklist-body");
        const summaryHtml = `
          <div style="margin-bottom:10px;">
            <div><strong>POs:</strong> ${selectedPoNumbers.length}</div>
            <div><strong>Lines:</strong> ${summary.totalLines || 0}</div>
            <div><strong>Total Units:</strong> ${summary.totalUnits || 0}</div>
            ${summary.warning ? `<div style="color:#b91c1c;">Warning: ${summary.warning}</div>` : ""}
          </div>
        `;
        const rows = items.map(it => {
          const isOos = it.isOutOfStock;
          const rowStyle = isOos ? 'style="opacity:0.6; background:#fff5f5;"' : '';
          const qtyStyle = isOos ? 'style="font-weight:700; text-align:center; color:#b91c1c; text-decoration:line-through;"' : 'style="font-weight:700; text-align:center;"';
          const asinStyle = isOos ? 'style="text-decoration:line-through; color:#666;"' : '';
          const img = it.image ? `<img src="${it.image}" alt="" style="max-width:80px;max-height:80px;object-fit:contain;border-radius:6px;${isOos ? 'opacity:0.5;' : ''}" />` : "";
          const sku = it.sku || it.externalId || "";
          const oosLabel = isOos ? ' <span style="color:#b91c1c; font-size:11px; font-weight:700;">[OOS]</span>' : '';
          return `<tr ${rowStyle}>
            <td ${asinStyle}>${it.asin || ""}${oosLabel}</td>
            <td>${sku}</td>
            <td>${img}</td>
            <td style="width:240px;">${it.title || ""}</td>
            <td ${qtyStyle}>${it.totalQty ?? ""}</td>
          </tr>`;
        }).join("");

        body.innerHTML = `
          ${summaryHtml}
          <div style="overflow:auto; max-height:60vh;">
            <table>
              <thead>
                <tr>
                  <th>ASIN</th>
                  <th>External ID</th>
                  <th style="width:120px;">Image</th>
                  <th style="width:240px;">Title</th>
                  <th>Total Qty</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="5" class="empty">No items</td></tr>'}
              </tbody>
            </table>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn" style="background:#111827" onclick="downloadPicklistPdf()">Download PDF</button>
            <button class="btn" onclick="closePicklistModal()">Close</button>
          </div>
        `;
        modal.style.display = "flex";
      } catch (err) {
        console.error("Failed to load picklist preview", err);
        alert(`Failed to load picklist preview: ${err}`);
      }
    }

    function closePicklistModal() {
      const modal = document.getElementById("picklist-modal");
      if (modal) modal.style.display = "none";
    }

    function downloadPicklistPdf() {
      if (!selectedPoNumbers.length) {
        alert("Please select at least one PO to generate a pick list.");
        return;
      }
      const poParam = encodeURIComponent(selectedPoNumbers.join(","));
      const url = `/api/picklist/pdf?poNumbers=${poParam}`;
      window.open(url, "_blank");
    }

    async function markItemOos(event, poNumber, asin, vendorSku, poDate, shipTo, qty, encodedImage) {
      event.preventDefault();
      if (!poNumber || !asin) return;
      const ok = confirm(`Mark this item as OUT OF STOCK?\nPO: ${poNumber}\nASIN: ${asin}`);
      if (!ok) return;
      const image = encodedImage ? decodeURIComponent(encodedImage) : null;
      try {
        await fetch("/api/oos-items/mark", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            poNumber,
            asin,
            vendorSku,
            purchaseOrderDate: poDate,
            shipToPartyId: shipTo,
            qty,
            image: image || null,
          }),
        });
        if (activeTab === "oos") {
          await loadOosItems();
        }
      } catch (err) {
        console.error("Failed to mark OOS", err);
        alert(`Failed to mark OOS: ${err}`);
      }
    }

    // ========================================
    // Vendor Real Time Sales functions
    // ========================================
    const RTS_LOOKBACK_STORAGE_KEY = "rtSalesLookbackHours";
    const RTS_VIEW_BY_STORAGE_KEY = "rtSalesViewBy";
    const RTS_SORT_STORAGE_KEY = "vendor_rt_sales_sort";

    function formatNumberWithCommas(num) {
      return (Math.round(num * 100) / 100).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Vendor Real Time Sales state
    let rtSalesData = [];
    let rtSalesCurrentViewBy = "asin";
    let rtSalesSortState = {
      column: null,
      direction: "asc"  // "asc" or "desc"
    };

    // ========== Storage Handlers: Lookback ==========
    function saveRtSalesLookback() {
      const lookbackSelect = document.getElementById("rt-sales-lookback");
      if (lookbackSelect) {
        try {
          localStorage.setItem(RTS_LOOKBACK_STORAGE_KEY, lookbackSelect.value);
        } catch (e) {
          console.warn("Failed to save RT sales lookback:", e);
        }
      }
    }

    function loadRtSalesLookback() {
      const lookbackSelect = document.getElementById("rt-sales-lookback");
      if (lookbackSelect) {
        try {
          const saved = localStorage.getItem(RTS_LOOKBACK_STORAGE_KEY);
          if (saved) {
            lookbackSelect.value = saved;
          } else {
            lookbackSelect.value = "2";  // Default: 2 hours
          }
        } catch (e) {
          console.warn("Failed to load RT sales lookback:", e);
        }
      }
    }

    function onRtSalesLookbackChange() {
      saveRtSalesLookback();
      updateRtSalesWindowInfo();
      loadVendorRtSalesSummary();
    }

    // ========== Storage Handlers: View By ==========
    function saveRtSalesViewBy() {
      const viewBySelect = document.getElementById("rt-sales-view-by");
      if (viewBySelect) {
        try {
          localStorage.setItem(RTS_VIEW_BY_STORAGE_KEY, viewBySelect.value);
        } catch (e) {
          console.warn("Failed to save RT sales view-by:", e);
        }
      }
    }

    function loadRtSalesViewBy() {
      const viewBySelect = document.getElementById("rt-sales-view-by");
      if (viewBySelect) {
        try {
          const saved = localStorage.getItem(RTS_VIEW_BY_STORAGE_KEY);
          if (saved && (saved === "asin" || saved === "time")) {
            viewBySelect.value = saved;
          } else {
            viewBySelect.value = "asin";  // Default: ASIN
          }
        } catch (e) {
          console.warn("Failed to load RT sales view-by:", e);
        }
      }
    }

    function onRtSalesViewByChange() {
      saveRtSalesViewBy();
      const viewBySelect = document.getElementById("rt-sales-view-by");
      rtSalesCurrentViewBy = viewBySelect.value;
      // Reset sort state when switching view
      rtSalesSortState.column = null;
      rtSalesSortState.direction = "asc";
      loadVendorRtSalesSummary();
    }

    // ========== Window Info Label (UAE Time) ==========
    function updateRtSalesWindowInfo() {
      const lookbackSelect = document.getElementById("rt-sales-lookback");
      const infoEl = document.getElementById("rt-sales-window-info");
      if (!lookbackSelect || !infoEl) return;

      const lookbackHours = parseInt(lookbackSelect.value, 10);
      const now = new Date();
      
      // Calculate start time (trailing window)
      const endTime = new Date(now);
      const startTime = new Date(endTime.getTime() - lookbackHours * 60 * 60 * 1000);
      
      // Format times in UAE timezone
      const uaeFormatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'Asia/Dubai',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      
      const startStr = uaeFormatter.format(startTime);
      const endStr = uaeFormatter.format(endTime);
      
      infoEl.textContent = `Trailing ${lookbackHours} hours (${startStr} → ${endStr} UAE)`;
    }

    // ========== Sync Status Monitoring ==========
    let rtSalesStatusIntervalId = null;

    async function updateRtSalesSyncStatus() {
      const statusEl = document.getElementById("rt-sales-sync-status");
      const refreshBtn = document.getElementById("rt-sales-refresh-btn");
      if (!statusEl || !refreshBtn) return;

      try {
        const resp = await fetch("/api/vendor-realtime-sales/status");
        if (!resp.ok) {
          statusEl.textContent = "Status: unavailable";
          statusEl.className = "rt-sales-status-label";
          refreshBtn.disabled = false;
          return;
        }

        const data = await resp.json();

        const busy = !!data.busy;
        const cooldown = !!data.cooldown_active;
        const cooldownUntilUae = data.cooldown_until_uae || null;

        // Reset base class
        statusEl.className = "rt-sales-status-label";

        if (busy) {
          statusEl.textContent = "🔵 Auto-sync running… (Real-time sales backfill in progress)";
          statusEl.classList.add("rt-sales-status-busy");
          refreshBtn.disabled = true;
        } else if (cooldown) {
          let label = "🟡 In quota cooldown (Refresh temporarily disabled)";
          if (cooldownUntilUae) {
            try {
              const dt = new Date(cooldownUntilUae);
              const hh = dt.getHours().toString().padStart(2, "0");
              const mm = dt.getMinutes().toString().padStart(2, "0");
              label = `🟡 In quota cooldown until ${hh}:${mm} UAE (Refresh temporarily disabled)`;
            } catch (e) {
              // ignore parse errors, keep generic label
            }
          }
          statusEl.textContent = label;
          statusEl.classList.add("rt-sales-status-cooldown");
          refreshBtn.disabled = true;
        } else {
          statusEl.textContent = "🟢 Idle (Auto-sync OK — you can refresh now)";
          statusEl.classList.add("rt-sales-status-idle");
          refreshBtn.disabled = false;
        }
      } catch (err) {
        console.error("[RtSales] Failed to update sync status", err);
        statusEl.textContent = "Status: unavailable";
        statusEl.className = "rt-sales-status-label";
        refreshBtn.disabled = false;
      }
    }

    function startRtSalesStatusPolling() {
      // Clear any existing interval
      if (rtSalesStatusIntervalId !== null) {
        clearInterval(rtSalesStatusIntervalId);
      }
      // Poll every 30 seconds
      updateRtSalesSyncStatus(); // Initial update
      rtSalesStatusIntervalId = setInterval(updateRtSalesSyncStatus, 30000);
    }

    function stopRtSalesStatusPolling() {
      if (rtSalesStatusIntervalId !== null) {
        clearInterval(rtSalesStatusIntervalId);
        rtSalesStatusIntervalId = null;
      }
    }

    function saveRtSalesSortState() {
      try {
        localStorage.setItem(RTS_SORT_STORAGE_KEY, JSON.stringify(rtSalesSortState));
      } catch (e) {
        console.warn("Failed to save sort state to localStorage", e);
      }
    }

    function loadRtSalesSortState() {
      try {
        const stored = localStorage.getItem(RTS_SORT_STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          rtSalesSortState.column = parsed.column || null;
          rtSalesSortState.direction = parsed.direction || "asc";
        }
      } catch (e) {
        console.warn("Failed to load sort state from localStorage", e);
      }
    }

    function updateRtSalesArrows() {
      // Clear all arrows
      const arrows = [
        "rt-sales-sort-asin",
        "rt-sales-sort-units",
        "rt-sales-sort-revenue",
        "rt-sales-sort-bucket-time",
        "rt-sales-sort-time-units",
        "rt-sales-sort-time-revenue"
      ];
      arrows.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = "";
      });

      // Update relevant arrow based on current sort
      if (rtSalesCurrentViewBy === "asin") {
        if (rtSalesSortState.column === "asin") {
          document.getElementById("rt-sales-sort-asin").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
        } else if (rtSalesSortState.column === "units") {
          document.getElementById("rt-sales-sort-units").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
        } else if (rtSalesSortState.column === "revenue") {
          document.getElementById("rt-sales-sort-revenue").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
        }
      } else if (rtSalesCurrentViewBy === "time") {
        if (rtSalesSortState.column === "bucket_time") {
          document.getElementById("rt-sales-sort-bucket-time").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
        } else if (rtSalesSortState.column === "units") {
          document.getElementById("rt-sales-sort-time-units").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
        } else if (rtSalesSortState.column === "revenue") {
          document.getElementById("rt-sales-sort-time-revenue").textContent = rtSalesSortState.direction === "asc" ? "▲" : "▼";
        }
      }
    }

    function onRtSalesHeaderClick(column) {
      // If clicking the same column, toggle direction
      if (rtSalesSortState.column === column) {
        rtSalesSortState.direction = rtSalesSortState.direction === "asc" ? "desc" : "asc";
      } else {
        // New column, set default direction
        rtSalesSortState.column = column;
        // For time, default to desc (newest first); for others, desc for numeric
        rtSalesSortState.direction = (column === "asin" || column === "bucket_time") ? "asc" : "desc";
      }

      saveRtSalesSortState();
      sortRtSalesTable(column);
    }

    function sortRtSalesTable(column) {
      if (!rtSalesData || rtSalesData.length === 0) {
        renderRtSalesTable(rtSalesData);
        return;
      }

      // Sort the data
      const sorted = [...rtSalesData].sort((a, b) => {
        let aVal, bVal;

        if (rtSalesCurrentViewBy === "asin") {
          // ASIN view sorting
          if (column === "asin") {
            aVal = a.asin.toLowerCase();
            bVal = b.asin.toLowerCase();
            const cmp = aVal.localeCompare(bVal);
            return rtSalesSortState.direction === "asc" ? cmp : -cmp;
          } else if (column === "units") {
            aVal = parseFloat(a.units) || 0;
            bVal = parseFloat(b.units) || 0;
          } else if (column === "revenue") {
            aVal = parseFloat(a.revenue) || 0;
            bVal = parseFloat(b.revenue) || 0;
          }
        } else if (rtSalesCurrentViewBy === "time") {
          // Time view sorting
          if (column === "bucket_time") {
            aVal = a.bucket_start_utc;
            bVal = b.bucket_start_utc;
            const cmp = aVal.localeCompare(bVal);
            return rtSalesSortState.direction === "asc" ? cmp : -cmp;
          } else if (column === "units") {
            aVal = parseFloat(a.units) || 0;
            bVal = parseFloat(b.units) || 0;
          } else if (column === "revenue") {
            aVal = parseFloat(a.revenue) || 0;
            bVal = parseFloat(b.revenue) || 0;
          }
        }

        // Numeric comparison
        if (rtSalesSortState.direction === "asc") {
          return aVal - bVal;
        } else {
          return bVal - aVal;
        }
      });

      updateRtSalesArrows();
      renderRtSalesTable(sorted);
    }

    function renderRtSalesTable(data) {
      // Show/hide appropriate table based on view_by
      const asinTable = document.getElementById("rt-sales-asin-table");
      const timeTable = document.getElementById("rt-sales-time-table");
      const tableTitle = document.getElementById("rt-sales-table-title");

      if (rtSalesCurrentViewBy === "asin") {
        asinTable.style.display = "table";
        timeTable.style.display = "none";
        tableTitle.textContent = "Top ASINs";
        renderAsinTable(data);
      } else if (rtSalesCurrentViewBy === "time") {
        asinTable.style.display = "none";
        timeTable.style.display = "table";
        tableTitle.textContent = "Sales by Time";
        renderTimeTable(data);
      }
    }

    function renderAsinTable(data) {
      const tbody = document.getElementById("rt-sales-top-asins-rows");
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(asin_row => {
        const imageHtml = asin_row.imageUrl
          ? `<img src="${asin_row.imageUrl}" alt="${asin_row.asin}" style="max-width:40px; max-height:40px; object-fit:contain; border-radius:4px;" />`
          : '—';
        return `
          <tr style="cursor:pointer;" onclick="openRtSalesAsinDetail('${asin_row.asin}')">
            <td><strong>${asin_row.asin}</strong></td>
            <td style="text-align:center;">${imageHtml}</td>
            <td style="text-align:right;"><strong>${(asin_row.units || 0).toLocaleString()}</strong></td>
            <td style="text-align:right;"><strong>${asin_row.currency_code ? asin_row.currency_code + ' ' : ''}${formatNumberWithCommas(asin_row.revenue || 0)}</strong></td>
          </tr>
        `;
      }).join("");
    }

    function renderTimeTable(data) {
      const tbody = document.getElementById("rt-sales-time-rows");
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(time_row => {
        // Parse UAE start time for display
        let uaeDateStr = time_row.bucket_start_uae;
        try {
          const dt = new Date(uaeDateStr);
          // Extract just time part HH:MM in UAE
          const uaeTime = dt.toLocaleTimeString('en-US', {
            timeZone: 'Asia/Dubai',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
          // Get date
          const uaeDate = dt.toLocaleDateString('en-US', {
            timeZone: 'Asia/Dubai',
            month: '2-digit',
            day: '2-digit'
          });
          uaeDateStr = `${uaeDate} ${uaeTime} UAE`;
        } catch (e) {
          // Fallback
          uaeDateStr = time_row.bucket_start_uae;
        }

        return `
          <tr>
            <td><strong>${uaeDateStr}</strong></td>
            <td style="text-align:right;"><strong>${(time_row.units || 0).toLocaleString()}</strong></td>
            <td style="text-align:right;"><strong>${time_row.currency_code ? time_row.currency_code + ' ' : ''}${formatNumberWithCommas(time_row.revenue || 0)}</strong></td>
          </tr>
        `;
      }).join("");
    }

    async function refreshVendorRtSales() {
      const btn = document.getElementById("rt-sales-refresh-btn");
      if (btn) btn.disabled = true;

      try {
        const lookbackHours = document.getElementById("rt-sales-lookback").value;
        const body = {
          window: `trailing_${lookbackHours}h`  // Use a window value for backward compat
        };

        const resp = await fetch("/api/vendor-realtime-sales/refresh", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: `HTTP ${resp.status}` }));
          throw new Error(err.error || err.detail || `HTTP ${resp.status}`);
        }

        const result = await resp.json();
        
        if (result.status === "error") {
          if (result.error === "QuotaExceeded") {
            console.warn("[VendorRtSales] Quota exceeded; using cached data");
            await loadVendorRtSalesSummary();
          } else {
            throw new Error(result.message || result.error || "Unknown error");
          }
        } else if (result.status === "success" && result.ingest_summary) {
          await loadVendorRtSalesSummary();
        } else {
          throw new Error("Invalid response from server");
        }
      } catch (err) {
        console.error("[VendorRtSales] Refresh failed:", err.message);
      } finally {
        // Let status endpoint decide whether button can be re-enabled
        await updateRtSalesSyncStatus();
      }
    }

    async function loadVendorRtSalesSummary() {
      try {
        const lookbackHours = parseInt(document.getElementById("rt-sales-lookback").value, 10);
        const viewBy = document.getElementById("rt-sales-view-by").value;
        rtSalesCurrentViewBy = viewBy;

        let params = `?lookback_hours=${lookbackHours}&view_by=${viewBy}`;

        const resp = await fetch("/api/vendor-realtime-sales/summary" + params);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();

        // Update window info label
        updateRtSalesWindowInfo();

        // Update summary cards
        document.getElementById("rt-sales-total-units").textContent = (data.total_units || 0).toLocaleString();
        document.getElementById("rt-sales-total-revenue").textContent =
          `${data.currency_code} ${formatNumberWithCommas(data.total_revenue || 0)}`;

        // Store data for sorting
        if (!data.rows || data.rows.length === 0) {
          rtSalesData = [];
          updateRtSalesArrows();
          renderRtSalesTable([]);
          return;
        }

        rtSalesData = data.rows;
        
        // Load saved sort state from localStorage
        loadRtSalesSortState();
        
        // Update arrows to show current state
        updateRtSalesArrows();

        // Apply saved sort if one exists
        if (rtSalesSortState.column) {
          sortRtSalesTable(rtSalesSortState.column);
        } else {
          // No saved sort, default sort by:
          // - ASIN view: units descending
          // - Time view: time descending (newest first)
          if (viewBy === "time") {
            rtSalesSortState.column = "bucket_time";
            rtSalesSortState.direction = "desc";
          } else {
            rtSalesSortState.column = "units";
            rtSalesSortState.direction = "desc";
          }
          sortRtSalesTable(rtSalesSortState.column);
        }
      } catch (err) {
        console.error("Failed to load RT sales summary:", err);
        renderRtSalesTable([]);
        const tbody = rtSalesCurrentViewBy === "asin" 
          ? document.getElementById("rt-sales-top-asins-rows")
          : document.getElementById("rt-sales-time-rows");
        if (tbody) tbody.innerHTML = `<tr><td colspan="${rtSalesCurrentViewBy === 'asin' ? 4 : 3}" class="empty">Error: ${err.message}</td></tr>`;
      }
    }

    async function openRtSalesAsinDetail(asin) {
      // This function is only for ASIN view; get the window params
      try {
        const lookbackHours = parseInt(document.getElementById("rt-sales-lookback").value, 10);
        let params = `?lookback_hours=${lookbackHours}`;

        const resp = await fetch(`/api/vendor-realtime-sales/asin/${encodeURIComponent(asin)}` + params);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();

        // Show detail panel
        document.getElementById("rt-sales-asin-detail-title").textContent = asin;
        const tbody = document.getElementById("rt-sales-asin-detail-rows");

        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty">No hourly data for this ASIN in selected window</td></tr>';
        } else {
          tbody.innerHTML = data.data.map(row => `
            <tr>
              <td>${row.hour_start_utc}</td>
              <td style="text-align:right;">${(row.ordered_units || 0).toLocaleString()}</td>
              <td style="text-align:right;">${formatNumberWithCommas(row.ordered_revenue || 0)}</td>
            </tr>
          `).join("");
        }

        document.getElementById("rt-sales-asin-detail").style.display = "block";
      } catch (err) {
        alert("Failed to load ASIN detail: " + err.message);
      }
    }

    function closeRtSalesAsinDetail() {
      document.getElementById("rt-sales-asin-detail").style.display = "none";
      document.getElementById("rt-sales-asin-detail-rows").innerHTML = '<tr><td colspan="3" class="empty">—</td></tr>';
    }

    // Initialize RT Sales preferences on page load
    function initRtSalesTab() {
      loadRtSalesLookback();
      loadRtSalesViewBy();
      loadRtSalesSortState();
      updateRtSalesWindowInfo();
    }

    // ========================================
    // Vendor Inventory Functions
    // ========================================

    function loadVendorInventorySnapshotIfNeeded(forceReload = false) {
      if (!forceReload && vendorInventorySnapshot && vendorInventorySnapshot.length > 0) {
        renderVendorInventoryCurrentSubtab();
        return;
      }

      const statusEl = document.getElementById('inv-status-label');
      if (statusEl) statusEl.textContent = 'Loading inventory snapshot…';

      fetch('/api/vendor-inventory/snapshot')
        .then((resp) => resp.json())
        .then((data) => {
          if (data.status !== 'ok') {
            if (statusEl) statusEl.textContent = 'Error loading inventory: ' + (data.error || data.status);
            vendorInventorySnapshot = [];
            renderVendorInventoryCurrentSubtab();
            return;
          }

          vendorInventorySnapshot = data.items || [];
          if (statusEl) statusEl.textContent = `Loaded ${vendorInventorySnapshot.length} ASINs`;

          updateInventoryWeekLabelFromSnapshot(vendorInventorySnapshot);
          renderVendorInventoryCurrentSubtab();
        })
        .catch((err) => {
          console.error(err);
          if (statusEl) statusEl.textContent = 'Error loading inventory: ' + err;
          vendorInventorySnapshot = [];
          renderVendorInventoryCurrentSubtab();
        });
    }

    function refreshVendorInventorySnapshot() {
      const refreshBtn = document.getElementById('inv-refresh-btn');
      const statusEl = document.getElementById('inv-status-label');

      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Refreshing…';
      }
      if (statusEl) statusEl.textContent = 'Refreshing inventory via SP-API…';

      fetch('/api/vendor-inventory/refresh', {
        method: 'POST',
      })
        .then((resp) => resp.json())
        .then((data) => {
          if (data.status === 'quota_error') {
            if (statusEl) statusEl.textContent = 'Quota error while refreshing inventory: ' + (data.error || '');
          } else if (data.status !== 'ok') {
            if (statusEl) statusEl.textContent = 'Error refreshing inventory: ' + (data.error || data.status);
          } else {
            if (statusEl) statusEl.textContent = `Inventory refreshed. Ingested ${data.ingested_asins || 0} ASINs. Reloading…`;
            loadVendorInventorySnapshotIfNeeded(true);
          }
        })
        .catch((err) => {
          console.error(err);
          if (statusEl) statusEl.textContent = 'Error refreshing inventory: ' + err;
        })
        .finally(() => {
          if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'Refresh Inventory Snapshot';
          }
        });
    }

    function setInventorySubtab(subtab) {
      currentInventorySubtab = subtab;

      const buttons = [
        'inv-subtab-snapshot',
        'inv-subtab-aged',
        'inv-subtab-unhealthy',
      ];

      buttons.forEach((id) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        if (
          (subtab === 'snapshot' && id === 'inv-subtab-snapshot') ||
          (subtab === 'aged' && id === 'inv-subtab-aged') ||
          (subtab === 'unhealthy' && id === 'inv-subtab-unhealthy')
        ) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      renderVendorInventoryCurrentSubtab();
    }

    function renderVendorInventoryCurrentSubtab() {
      if (currentInventorySubtab === 'aged') {
        renderVendorInventoryTable('aged');
      } else if (currentInventorySubtab === 'unhealthy') {
        renderVendorInventoryTable('unhealthy');
      } else {
        renderVendorInventoryTable('snapshot');
      }
    }

    function updateInventoryWeekLabelFromSnapshot(rows) {
      const labelEl = document.getElementById('inv-week-label');
      if (!labelEl) return;
      if (!rows || rows.length === 0) {
        labelEl.textContent = '';
        return;
      }

      const first = rows[0];
      const start = first.start_date || first.startDate;
      const end = first.end_date || first.endDate;

      if (start && end) {
        labelEl.textContent = `Week: ${start} → ${end} (latest week)`;
      } else {
        labelEl.textContent = '';
      }
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function sortInventoryTableBy(col) {
      if (invSortColumn === col) {
        invSortDirection = invSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        invSortColumn = col;
        invSortDirection = 'desc';
      }
      renderVendorInventoryCurrentSubtab();
    }

    function setQuickFilter(f) {
      invQuickFilter = f;
      const buttons = ['inv-qf-all', 'inv-qf-zero', 'inv-qf-aged', 'inv-qf-unhealthy'];
      buttons.forEach((id) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        if (
          (f === 'all' && id === 'inv-qf-all') ||
          (f === 'zero' && id === 'inv-qf-zero') ||
          (f === 'aged' && id === 'inv-qf-aged') ||
          (f === 'unhealthy' && id === 'inv-qf-unhealthy')
        ) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      renderVendorInventoryCurrentSubtab();
    }

    function renderVendorInventoryTable(mode) {
      const headEl = document.getElementById('inv-table-head');
      const bodyEl = document.getElementById('inv-table-body');
      const footEl = document.getElementById('inv-table-foot');

      if (!headEl || !bodyEl || !footEl) return;

      let rows = vendorInventorySnapshot || [];

      // Filter per subtab
      if (mode === 'aged') {
        rows = rows.filter((r) => {
          const aged = r.aged90plus_sellable_units ?? r.aged90PlusDaysSellableInventoryUnits ?? 0;
          return aged > 0;
        });
      } else if (mode === 'unhealthy') {
        rows = rows.filter((r) => {
          const unhealthy = r.unhealthy_units ?? r.unhealthyInventoryUnits ?? 0;
          return unhealthy > 0;
        });
      }

      // Search filter
      const q = (document.getElementById('inv-search')?.value || '').toLowerCase();
      if (q) {
        rows = rows.filter((r) =>
          (r.asin || '').toLowerCase().includes(q) ||
          (r.title || r.product_title || '').toLowerCase().includes(q)
        );
      }

      // Quick filters
      if (invQuickFilter === 'zero') {
        rows = rows.filter((r) => {
          const sellable = r.sellable_onhand_units ?? r.sellableOnHandInventoryUnits ?? 0;
          const unsellable = r.unsellable_onhand_units ?? r.unsellableOnHandInventoryUnits ?? 0;
          const total = sellable + unsellable;
          return sellable === 0 && total > 0;
        });
      } else if (invQuickFilter === 'aged') {
        rows = rows.filter((r) => {
          const aged = r.aged90plus_sellable_units ?? r.aged90PlusDaysSellableInventoryUnits ?? 0;
          return aged > 0;
        });
      } else if (invQuickFilter === 'unhealthy') {
        rows = rows.filter((r) => {
          const unhealthy = r.unhealthy_units ?? r.unhealthyInventoryUnits ?? 0;
          return unhealthy > 0;
        });
      }

      // Sort rows
      rows.sort((a, b) => {
        let aVal, bVal;

        if (invSortColumn === 'asin') {
          aVal = (a.asin || '').toLowerCase();
          bVal = (b.asin || '').toLowerCase();
        } else if (invSortColumn === 'title') {
          aVal = (a.title || a.product_title || '').toLowerCase();
          bVal = (b.title || b.product_title || '').toLowerCase();
        } else if (invSortColumn === 'sellable') {
          aVal = a.sellable_onhand_units ?? a.sellableOnHandInventoryUnits ?? 0;
          bVal = b.sellable_onhand_units ?? b.sellableOnHandInventoryUnits ?? 0;
        } else if (invSortColumn === 'unsellable') {
          aVal = a.unsellable_onhand_units ?? a.unsellableOnHandInventoryUnits ?? 0;
          bVal = b.unsellable_onhand_units ?? b.unsellableOnHandInventoryUnits ?? 0;
        } else if (invSortColumn === 'total') {
          const aTotal = (a.sellable_onhand_units ?? a.sellableOnHandInventoryUnits ?? 0) + (a.unsellable_onhand_units ?? a.unsellableOnHandInventoryUnits ?? 0);
          const bTotal = (b.sellable_onhand_units ?? b.sellableOnHandInventoryUnits ?? 0) + (b.unsellable_onhand_units ?? b.unsellableOnHandInventoryUnits ?? 0);
          aVal = aTotal;
          bVal = bTotal;
        } else if (invSortColumn === 'openpo') {
          aVal = a.open_po_units ?? a.openPurchaseOrderUnits ?? 0;
          bVal = b.open_po_units ?? b.openPurchaseOrderUnits ?? 0;
        } else if (invSortColumn === 'aged') {
          aVal = a.aged90plus_sellable_units ?? a.aged90PlusDaysSellableInventoryUnits ?? 0;
          bVal = b.aged90plus_sellable_units ?? b.aged90PlusDaysSellableInventoryUnits ?? 0;
        } else if (invSortColumn === 'unhealthy') {
          aVal = a.unhealthy_units ?? a.unhealthyInventoryUnits ?? 0;
          bVal = b.unhealthy_units ?? b.unhealthyInventoryUnits ?? 0;
        } else if (invSortColumn === 'netreceived') {
          aVal = a.net_received_units ?? a.netReceivedInventoryUnits ?? 0;
          bVal = b.net_received_units ?? b.netReceivedInventoryUnits ?? 0;
        } else if (invSortColumn === 'sellthrough') {
          aVal = a.sell_through_rate ?? a.sellThroughRate ?? 0;
          bVal = b.sell_through_rate ?? b.sellThroughRate ?? 0;
        }

        if (typeof aVal === 'string') {
          return invSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
          return invSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        }
      });

      // Clear
      headEl.innerHTML = '';
      bodyEl.innerHTML = '';
      footEl.innerHTML = '';

      // Build header with sortable columns
      const arrow = (col) => {
        if (invSortColumn === col) {
          return invSortDirection === 'asc' ? '▲' : '▼';
        }
        return '▲▼';
      };

      headEl.innerHTML = `
        <tr>
          <th onclick="sortInventoryTableBy('asin')">ASIN ${arrow('asin')}</th>
          <th class="inv-image-col">Image</th>
          <th onclick="sortInventoryTableBy('title')">Title ${arrow('title')}</th>
          <th onclick="sortInventoryTableBy('sellable')">Sellable ${arrow('sellable')}</th>
          <th onclick="sortInventoryTableBy('unsellable')">Unsellable ${arrow('unsellable')}</th>
          <th onclick="sortInventoryTableBy('openpo')">Open PO ${arrow('openpo')}</th>
          <th onclick="sortInventoryTableBy('aged')" title="Units that are at least 90 days old and still sellable in Amazon FCs. Highlighted in blue when > 0.">Aged 90+ Units ${arrow('aged')}</th>
          <th onclick="sortInventoryTableBy('unhealthy')" title="Excess inventory versus forecasted demand on the last day of the week. Highlighted in red when > 0.">Unhealthy Units ${arrow('unhealthy')}</th>
          <th onclick="sortInventoryTableBy('netreceived')">Net Received Units ${arrow('netreceived')}</th>
          <th onclick="sortInventoryTableBy('sellthrough')" title="Net units shipped during the week (after returns) divided by starting on-hand units plus units received during the week. Example: 0.31 = 31% sell-through.">Sell-through Rate ${arrow('sellthrough')}</th>
        </tr>
      `;

      // Accumulators for totals
      let totalSellable = 0;
      let totalUnsellable = 0;
      let totalOnHand = 0;
      let totalOpenPo = 0;
      let totalAged = 0;
      let totalUnhealthy = 0;
      let totalNetReceived = 0;

      // Build rows HTML
      let bodyHtml = '';

      rows.forEach((r) => {
        const asin = r.asin || '';
        const title = r.title || r.product_title || '';

        const sellable = r.sellable_onhand_units ?? r.sellableOnHandInventoryUnits ?? 0;
        const unsellable = r.unsellable_onhand_units ?? r.unsellableOnHandInventoryUnits ?? 0;
        const total = sellable + unsellable;

        const openPo = r.open_po_units ?? r.openPurchaseOrderUnits ?? 0;
        const aged = r.aged90plus_sellable_units ?? r.aged90PlusDaysSellableInventoryUnits ?? 0;
        const unhealthy = r.unhealthy_units ?? r.unhealthyInventoryUnits ?? 0;
        const netReceived = r.net_received_units ?? r.netReceivedInventoryUnits ?? 0;
        const sellThrough = r.sell_through_rate ?? r.sellThroughRate ?? null;

        totalSellable += sellable;
        totalUnsellable += unsellable;
        totalOnHand += total;
        totalOpenPo += openPo;
        totalAged += aged;
        totalUnhealthy += unhealthy;
        totalNetReceived += netReceived;

        // Color coding
        let rowClass = '';
        if (sellable === 0 && total > 0) {
          rowClass = 'inv-zero-sellable';
        } else if (aged > 0) {
          rowClass = 'inv-aged';
        } else if (unhealthy > 0) {
          rowClass = 'inv-unhealthy';
        }

        const asinLink = `<a href="https://vendorcentral.amazon.ae/hz/vendor/members/catalogue?ref=vcnav&asin=${encodeURIComponent(asin)}" target="_blank" style="color:#0284c7; text-decoration:none;">${escapeHtml(asin)}</a>`;

        const imgUrl = r.image_url || r.image || '';
        const imgHtml = imgUrl
          ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(asin)}" style="max-width:50px; max-height:50px; object-fit:contain; border-radius:6px;" />`
          : '';

        bodyHtml += `
          <tr class="${rowClass}">
            <td>${asinLink}</td>
            <td class="inv-image-col">${imgHtml}</td>
            <td class="inv-title-col">${escapeHtml(title)}</td>
            <td class="text-right">${sellable}</td>
            <td class="text-right">${unsellable}</td>
            <td class="text-right">${openPo}</td>
            <td class="text-right">${aged}</td>
            <td class="text-right">${unhealthy}</td>
            <td class="text-right">${netReceived}</td>
            <td class="text-right">${sellThrough !== null ? sellThrough.toFixed(2) : ''}</td>
          </tr>
        `;
      });

      bodyEl.innerHTML = bodyHtml;

      // Footer totals
      const footerRow = document.createElement('tr');
      footerRow.innerHTML = `
        <td colspan="3"><strong>Totals (${rows.length} ASINs)</strong></td>
        <td class="text-right"><strong>${totalSellable}</strong></td>
        <td class="text-right"><strong>${totalUnsellable}</strong></td>
        <td class="text-right"><strong>${totalOpenPo}</strong></td>
        <td class="text-right"><strong>${totalAged}</strong></td>
        <td class="text-right"><strong>${totalUnhealthy}</strong></td>
        <td class="text-right"><strong>${totalNetReceived}</strong></td>
        <td></td>
      `;
      footEl.appendChild(footerRow);
    }

    function downloadVendorInventorySnapshotCsv() {
      if (!vendorInventorySnapshot || vendorInventorySnapshot.length === 0) {
        alert('No inventory data to download.');
        return;
      }

      // Reuse the same filtering logic as renderVendorInventoryTable()
      let rows = vendorInventorySnapshot || [];
      if (currentInventorySubtab === 'aged') {
        rows = rows.filter((r) => {
          const aged = r.aged90plus_sellable_units ?? r.aged90PlusDaysSellableInventoryUnits ?? 0;
          return aged > 0;
        });
      } else if (currentInventorySubtab === 'unhealthy') {
        rows = rows.filter((r) => {
          const unhealthy = r.unhealthy_units ?? r.unhealthyInventoryUnits ?? 0;
          return unhealthy > 0;
        });
      }

      const header = [
        'ASIN',
        'Title',
        'SellableUnits',
        'UnsellableUnits',
        'TotalOnHandUnits',
        'OpenPOUnits',
        'Aged90PlusUnits',
        'UnhealthyUnits',
        'NetReceivedUnits',
        'SellThroughRate',
      ];

      const lines = [];
      lines.push(header.join(','));

      rows.forEach((r) => {
        const asin = r.asin || '';
        const title = (r.title || r.product_title || '').replace(/"/g, '""');

        const sellable =
          r.sellable_onhand_units ??
          r.sellableOnHandInventoryUnits ??
          0;
        const unsellable =
          r.unsellable_onhand_units ??
          r.unsellableOnHandInventoryUnits ??
          0;
        const total = sellable + unsellable;

        const openPo = r.open_po_units ?? r.openPurchaseOrderUnits ?? 0;
        const aged =
          r.aged90plus_sellable_units ??
          r.aged90PlusDaysSellableInventoryUnits ??
          0;
        const unhealthy =
          r.unhealthy_units ??
          r.unhealthyInventoryUnits ??
          0;
        const netReceived =
          r.net_received_units ??
          r.netReceivedInventoryUnits ??
          0;
        const sellThrough = r.sell_through_rate ?? r.sellThroughRate ?? '';

        const row = [
          asin,
          `"${title}"`,
          sellable,
          unsellable,
          total,
          openPo,
          aged,
          unhealthy,
          netReceived,
          sellThrough,
        ];

        lines.push(row.join(','));
      });

      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      const weekLabel = document.getElementById('inv-week-label')?.textContent || '';
      const weekPart = weekLabel.replace(/[^\d\-]/g, '');
      a.download = weekPart ? `Inventory_${weekPart}.csv` : 'vendor_inventory_snapshot.csv';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById("sync-btn").addEventListener("click", () => loadPOs(true));
    const rebuildBtn = document.getElementById("rebuild-btn");
    if (rebuildBtn) rebuildBtn.addEventListener("click", rebuildPOs);
    document.getElementById("po-search").addEventListener("input", filterPOs);
    document.getElementById("po-filter-fc").addEventListener("change", filterPOs);
    document.getElementById("po-filter-status").addEventListener("change", filterPOs);
    document.getElementById("po-start-days").addEventListener("change", filterPOs);

    // ====== SALES TRENDS FUNCTIONS ======
    async function loadSalesTrends() {
      try {
        const minUnitsInput = document.getElementById('sales-trends-min-units');
        const minUnits = parseInt(minUnitsInput?.value || '1', 10);
        
        const resp = await fetch(`/api/vendor-sales-trends?lookback_weeks=4&min_total_units=${minUnits}`);
        if (!resp.ok) {
          console.error('Failed to load sales trends', resp.status);
          document.getElementById('sales-trends-rows').innerHTML = '<tr><td colspan="11" class="empty">Error loading data</td></tr>';
          return;
        }
        
        const data = await resp.json();
        renderSalesTrends(data);
      } catch (err) {
        console.error('Error loading sales trends:', err);
        document.getElementById('sales-trends-rows').innerHTML = '<tr><td colspan="11" class="empty">Error: ' + err.message + '</td></tr>';
      }
    }

    function renderSalesTrends(data) {
      const tbody = document.getElementById('sales-trends-rows');
      const windowInfo = document.getElementById('sales-trends-window-info');
      const filterSelect = document.getElementById('sales-trends-filter');
      
      tbody.innerHTML = '';
      
      if (!data || !data.rows) {
        windowInfo.textContent = 'No data available.';
        tbody.innerHTML = '<tr><td colspan="11" class="empty">No data</td></tr>';
        return;
      }
      
      // Cache for filter re-render
      window.salesTrendsCache = data;
      
      windowInfo.textContent = `Window: ${data.window.start_uae.substring(0, 10)} → ${data.window.end_uae.substring(0, 10)} (UAE)`;
      
      // Update headers using week_ranges_uae from the API
      if (data.week_ranges_uae) {
        updateSalesTrendsWeekHeaders(data.week_ranges_uae);
      }
      
      // Update trailing week header with date range
      if (data.trailing_window) {
        updateTrailingWeekHeader(data.trailing_window);
      }
      
      let rows = data.rows.slice();
      const filterValue = filterSelect?.value || 'all';
      if (filterValue && filterValue !== 'all') {
        rows = rows.filter(r => r.trend === filterValue);
      }
      
      renderFilteredRows(rows);
    }

    function formatDateFromISO(isoStr) {
      // Extract YYYY-MM-DD from ISO string like "2025-01-12T00:00:00+04:00"
      return isoStr.split('T')[0];
    }

    function updateTrailingWeekHeader(trailingWindow) {
      // Update the "This Week" header with date range from trailing window
      const el = document.getElementById('st-th-trailing');
      if (!el || !trailingWindow) return;
      
      const startDate = formatDateFromISO(trailingWindow.start_uae);
      const endDate = formatDateFromISO(trailingWindow.end_uae);
      const rangeText = `${startDate} – ${endDate}`;
      
      el.title = rangeText + " (UAE time, current partial week)";
      el.innerHTML = `
        This Week
        <span class="sales-trends-week-sublabel">${rangeText}</span>
      `;
    }

    function updateSalesTrendsWeekHeaders(weekRanges) {
      // weekRanges is the data.week_ranges_uae array from the API
      if (!weekRanges || weekRanges.length === 0) return;
      
      const labelMap = {
        "W4": { id: "st-th-w4", label: "W4 Units" },
        "W3": { id: "st-th-w3", label: "W3 Units" },
        "W2": { id: "st-th-w2", label: "W2 Units" },
        "W1": { id: "st-th-w1", label: "W1 Units" },
      };
      
      weekRanges.forEach(wr => {
        const info = labelMap[wr.label];
        if (!info) return;
        
        const el = document.getElementById(info.id);
        if (!el) return;
        
        const startDate = formatDateFromISO(wr.start_uae);
        const endDate = formatDateFromISO(wr.end_uae);
        const rangeText = `${startDate} – ${endDate}`;
        
        el.title = rangeText + " (UAE time)";
        el.innerHTML = `
          ${info.label}
          <span class="sales-trends-week-sublabel">${rangeText}</span>
        `;
      });
    }

    // Hook Sales Trends controls
    document.getElementById('sales-trends-refresh-btn').addEventListener('click', () => {
      loadSalesTrends().catch(err => console.error(err));
    });
    
    document.getElementById('sales-trends-filter').addEventListener('change', () => {
      // Re-render with current data (don't reload from API)
      const tbody = document.getElementById('sales-trends-rows');
      const filterSelect = document.getElementById('sales-trends-filter');
      const filterValue = filterSelect.value;
      
      // Get all current rows data
      const allRows = tbody.querySelectorAll('tr');
      if (allRows.length === 0) return;
      
      // Store original data if not already stored
      if (!window.salesTrendsCache) {
        return; // Need to load first
      }
      
      const data = window.salesTrendsCache;
      let rows = data.rows.slice();
      if (filterValue && filterValue !== 'all') {
        rows = rows.filter(r => r.trend === filterValue);
      }
      
      renderFilteredRows(rows);
    });
    
    function renderFilteredRows(rows) {
      const tbody = document.getElementById('sales-trends-rows');
      tbody.innerHTML = '';
      
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="empty">No data matches filter</td></tr>';
        return;
      }
      
      rows.sort((a, b) => (b.total_units_4w || 0) - (a.total_units_4w || 0));
      
      for (const r of rows) {
        const tr = document.createElement('tr');
        
        const tdImg = document.createElement('td');
        tdImg.style.textAlign = 'center';
        if (r.imageUrl) {
          const img = document.createElement('img');
          img.src = r.imageUrl;
          img.alt = r.asin;
          img.className = 'sales-trends-img';
          tdImg.appendChild(img);
        }
        tr.appendChild(tdImg);
        
        const tdAsin = document.createElement('td');
        tdAsin.textContent = r.asin;
        tdAsin.style.fontWeight = '700';
        tdAsin.style.textAlign = 'center';
        tr.appendChild(tdAsin);
        
        function addNumCell(value) {
          const td = document.createElement('td');
          td.textContent = (value != null) ? value.toString() : '';
          td.style.textAlign = 'center';
          td.className = 'sales-trends-num-cell';
          return td;
        }
        
        tr.appendChild(addNumCell(r.week4_units));
        tr.appendChild(addNumCell(r.week3_units));
        tr.appendChild(addNumCell(r.week2_units));
        tr.appendChild(addNumCell(r.week1_units));
        
        // PART 4.1: Add "This Week" battery column
        const tdTrailing = document.createElement('td');
        tdTrailing.style.textAlign = 'center';
        const trailingContainer = document.createElement('div');
        
        // Raw units
        const unitsLine = document.createElement('div');
        unitsLine.style.fontSize = '12px';
        unitsLine.style.marginBottom = '4px';
        unitsLine.textContent = (r.trailing_units != null ? r.trailing_units : 0) + ' units';
        trailingContainer.appendChild(unitsLine);
        
        // Battery bar (using trailing_vs_w1_ratio - now clamped 0-1)
        const batteryDiv = document.createElement('div');
        batteryDiv.className = 'trend-battery';
        let ratio = r.trailing_vs_w1_ratio || 0;
        let percent = Math.max(0, Math.min(100, Math.round(ratio * 100)));
        
        const fillDiv = document.createElement('div');
        fillDiv.className = 'trend-battery-fill';
        fillDiv.style.width = percent + '%';
        batteryDiv.appendChild(fillDiv);
        trailingContainer.appendChild(batteryDiv);
        
        // Percentage label
        const labelDiv = document.createElement('div');
        labelDiv.className = 'trend-battery-label';
        labelDiv.textContent = percent + '%';
        trailingContainer.appendChild(labelDiv);
        
        tdTrailing.appendChild(trailingContainer);
        tr.appendChild(tdTrailing);
        
        tr.appendChild(addNumCell(r.total_units_4w));
        tr.appendChild(addNumCell(r.delta_units));
        
        // % Chg column (using new pct_change and pct_change_from_zero)
        const tdPct = document.createElement('td');
        let pctText;
        if (r.pct_change_from_zero) {
          pctText = "Up from 0";
        } else if (r.pct_change === null || r.pct_change === undefined) {
          pctText = "—";
        } else {
          const pct = Math.round(r.pct_change * 100);
          pctText = pct.toString() + "%";
        }
        tdPct.textContent = pctText;
        tdPct.style.textAlign = 'center';
        tdPct.className = 'sales-trends-num-cell';
        tr.appendChild(tdPct);
        
        // Trend badge (using backend trend string)
        const tdTrend = document.createElement('td');
        tdTrend.className = 'sales-trend-cell';
        tdTrend.style.textAlign = 'center';
        const pill = document.createElement('span');
        const trend = (r.trend || "").toLowerCase();
        let trendClass = "trend-pill-flat";
        
        if (trend === "rising") trendClass = "trend-pill-rising";
        else if (trend === "falling") trendClass = "trend-pill-falling";
        else if (trend === "new") trendClass = "trend-pill-new";
        else if (trend === "dead") trendClass = "trend-pill-dead";
        else if (trend === "reviving") trendClass = "trend-pill-reviving";
        
        pill.className = "trend-pill " + trendClass;
        pill.textContent = r.trend || "";
        tdTrend.appendChild(pill);
        tr.appendChild(tdTrend);
        
        tbody.appendChild(tr);
      }
    }

    async function runFourWeekBackfill() {
      const btn = document.getElementById("rt-sales-backfill-4w-btn");
      if (!btn) return;

      if (!confirm("This will call Amazon RT-Sales API for the last 4 weeks. It is a heavy, one-time backfill.\n\nAre you sure you want to run it now?")) {
        return;
      }

      btn.disabled = true;
      const originalText = btn.innerText;
      btn.innerText = "Backfill running...";

      try {
        const resp = await fetch("/api/vendor-realtime-sales/backfill-4weeks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const data = await resp.json();

        if (resp.status === 200 && data.status === "success") {
          alert(
            "4-week backfill completed.\n" +
            "Rows: " + data.rows + "\n" +
            "ASINs: " + data.asins + "\n" +
            "Hours: " + data.hours
          );
          // After backfill, reload Sales Trends table
          await loadSalesTrends();
        } else if (resp.status === 200 && data.status === "skipped") {
          alert(data.message || "Backfill already completed earlier.");
        } else {
          alert(
            "Backfill failed: " +
            (data.message || ("HTTP " + resp.status))
          );
        }
      } catch (e) {
        console.error("4-week backfill error", e);
        alert("Error running 4-week backfill. Check logs for details.");
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }

    // Tab visibility and data loading
    const originalShowTab = window.showTab;
    window.showTab = function(tabName) {
      // Show/hide tab content divs
      const pos_tab = document.getElementById('pos-tab');
      const catalog_tab = document.getElementById('catalog-tab');
      const oos_tab = document.getElementById('oos-tab');
      const vendor_rt_sales_tab = document.getElementById('vendor-rt-sales-tab');
      const sales_trends_tab = document.getElementById('sales-trends-tab');
      const inventory_tab = document.getElementById('inventory-tab');
      const tester_tab = document.getElementById('tester-tab');
      const notifications_tab = document.getElementById('notifications-tab');
      
      if (pos_tab) pos_tab.style.display = tabName === 'pos' ? 'block' : 'none';
      if (catalog_tab) catalog_tab.style.display = tabName === 'catalog' ? 'block' : 'none';
      if (oos_tab) oos_tab.style.display = tabName === 'oos' ? 'block' : 'none';
      if (vendor_rt_sales_tab) vendor_rt_sales_tab.style.display = tabName === 'vendor-rt-sales' ? 'block' : 'none';
      if (sales_trends_tab) sales_trends_tab.style.display = tabName === 'sales-trends' ? 'block' : 'none';
      if (inventory_tab) inventory_tab.style.display = tabName === 'inventory' ? 'block' : 'none';
      if (tester_tab) tester_tab.style.display = tabName === 'tester' ? 'block' : 'none';
      if (notifications_tab) notifications_tab.style.display = tabName === 'notifications' ? 'block' : 'none';
      
      // Update active tab button styling
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Load tab-specific data
      if (tabName === 'sales-trends') {
        loadSalesTrends();
      } else if (tabName === 'vendor-rt-sales') {
        loadVendorRtSalesSummary();
      } else if (tabName === 'inventory') {
        loadVendorInventorySnapshotIfNeeded();
      }
    };

    loadPOs(false);
    showTab("pos");
    scheduleInitialAutoSync();
    setInterval(updateSyncInfo, 60 * 1000);
    setInterval(autoSyncIfDue, 5 * 60 * 1000);
  </script>
  <div class="backdrop" id="picklist-modal">
    <div class="modal" style="max-width:1000px;">
      <header>
        <div id="picklist-title">Pick List Preview</div>
        <button class="btn" style="background:#111827" onclick="closePicklistModal()">Close</button>
      </header>
      <div class="modal-body" id="picklist-body"></div>
    </div>
  </div>
  <div id="toast" style="
    position:fixed;
    right:16px;
    bottom:16px;
    background:#111827;
    color:#fff;
    padding:10px 14px;
    border-radius:8px;
    font-size:13px;
    box-shadow:0 10px 25px rgba(15,23,42,0.4);
    opacity:0;
    pointer-events:none;
    transition:opacity 0.25s ease;
    z-index:9999;
  "></div>
</body>
</html>
